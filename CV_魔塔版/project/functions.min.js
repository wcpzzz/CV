functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a={events:{initGame:function(){if(core.flags.bigKeyIsBox){core.material.items.bigKey={cls:"items",name:"钥匙盒"}}if(core.flags.pickaxeFourDirections){core.material.items.pickaxe.text="可以破坏勇士四周的墙"}if(core.flags.bombFourDirections){core.material.items.bomb.text="可以炸掉勇士四周的怪物"}if(core.flags.snowFourDirections){core.material.items.bomb.text="可以将四周的熔岩变成平地"}if(core.flags.equipboxButton){core.statusBar.image.fly.src=core.statusBar.icons.equipbox.src;core.flags.equipment=true}if(core.flags.equipment){core.material.items.sword1.cls="equips";core.material.items.sword2.cls="equips";core.material.items.sword3.cls="equips";core.material.items.sword4.cls="equips";core.material.items.sword5.cls="equips";core.material.items.shield1.cls="equips";core.material.items.shield2.cls="equips";core.material.items.shield3.cls="equips";core.material.items.shield4.cls="equips";core.material.items.shield5.cls="equips"}},setInitData:function(a){if(a=="Easy"){core.setFlag("hard",1)}if(a=="Normal"){core.setFlag("hard",2)}if(a=="Hard"){core.setFlag("hard",3)}if(a=="Hell"){core.setFlag("hard",4)}core.events.afterLoadData()},win:function(b,a){core.ui.closePanel();var c=core.status.replay.replaying;core.stopReplay();core.waitHeroToStop(function(){core.removeGlobalAnimate(0,0,true);core.clearMap("all");core.drawText(["\t["+(b||"恭喜通关")+"]你的分数是${status:hp}。"],function(){core.events.gameOver(b||"",c,a)})})},lose:function(a){core.ui.closePanel();var b=core.status.replay.replaying;core.stopReplay();core.waitHeroToStop(function(){core.drawText(["\t["+(a||"结局1")+"]你死了。\n如题。"],function(){core.events.gameOver(null,b)})})},afterChangeFloor:function(a,b){if(!core.hasFlag("visited_"+a)){core.insertAction(core.floors[a].firstArrive);core.setFlag("visited_"+a,true)}},addPoint:function(a){var b=a.point;if(!core.flags.enableAddPoint||!core.isset(b)||b<=0){return[]}return[{type:"choices",choices:[{text:"攻击+"+(1*b),action:[{type:"setValue",name:"status:atk",value:"status:atk+"+(1*b)}]},{text:"防御+"+(2*b),action:[{type:"setValue",name:"status:def",value:"status:def+"+(2*b)}]},{text:"生命+"+(200*b),action:[{type:"setValue",name:"status:hp",value:"status:hp+"+(200*b)}]},]}]},afterBattle:function(d,q,r,a){var c=core.material.enemys[d];var e="hand";if(core.flags.equipment){var f=(core.status.hero.equipment||[])[0];if(core.isset(core.material.items[f])&&core.isset(core.material.items[f].equip.animate)){e=core.material.items[f].equip.animate}}core.playSound("attack.mp3");core.drawAnimate(e,q,r);var b=core.enemys.getDamage(d,q,r);if(b==null){b=core.status.hero.hp+1}core.status.hero.hp-=b;core.status.hero.statistics.battleDamage+=b;core.status.hero.statistics.battle++;if(core.status.hero.hp<=0){core.status.hero.hp=0;core.updateStatusBar();core.events.lose("战斗失败");return}var j=c.money;if(core.hasItem("coin")){j*=2}if(core.hasFlag("curse")){j=0}core.status.hero.money+=j;var h=c.experience;if(core.hasFlag("curse")){h=0}core.status.hero.experience+=h;var i="打败 "+c.name;if(core.flags.enableMoney){i+="，金币+"+j}if(core.flags.enableExperience){i+="，经验+"+h}core.drawTip(i);if(core.isset(q)&&core.isset(r)){core.removeBlock(q,r)}var l=c.special;if(core.enemys.hasSpecial(l,12)&&!core.hasFlag("poison")){core.setFlag("poison",true)}if(core.enemys.hasSpecial(l,13)&&!core.hasFlag("weak")){core.setFlag("weak",true);var p=core.values.weakValue;var n=p>=1?p:Math.floor(p*core.status.hero.atk);var o=p>=1?p:Math.floor(p*core.status.hero.def);core.setFlag("weakAtk",n);core.setFlag("weakDef",o);core.status.hero.atk-=n;core.status.hero.def-=o}if(core.enemys.hasSpecial(l,14)&&!core.hasFlag("curse")){core.setFlag("curse",true)}if(core.flags.hatredDecrease&&core.enemys.hasSpecial(l,17)){core.setFlag("hatred",parseInt(core.getFlag("hatred",0)/2))}if(core.enemys.hasSpecial(l,19)){core.status.hero.hp=1}if(core.enemys.hasSpecial(l,21)){core.status.hero.atk-=(c.atkValue||0);core.status.hero.def-=(c.defValue||0);if(core.status.hero.atk<0){core.status.hero.atk=0}if(core.status.hero.def<0){core.status.hero.def=0}}core.setFlag("hatred",core.getFlag("hatred",0)+core.values.hatred);core.updateStatusBar();var m=[];if(!core.enemys.hasSpecial(l,18)&&core.isset(q)&&core.isset(r)){var g=core.floors[core.status.floorId].afterBattle[q+","+r];if(core.isset(g)){core.unshift(m,g)}}var k=core.material.enemys[d].point;if(core.isset(k)&&k>0){core.unshift(m,core.events.addPoint(core.material.enemys[d]))}if(m.length>0){core.events.insertAction(m,q,r)}if(core.status.event.id==null){core.continueAutomaticRoute()}else{core.clearContinueAutomaticRoute()}if(core.isset(a)){a()}},afterOpenDoor:function(b,e,f,a){var d=[];if(core.isset(e)&&core.isset(f)){var c=core.floors[core.status.floorId].afterOpenDoor[e+","+f];if(core.isset(c)){core.unshift(d,c)}}if(d.length>0){core.events.insertAction(d,e,f)}if(core.status.event.id==null){core.continueAutomaticRoute()}else{core.clearContinueAutomaticRoute()}if(core.isset(a)){a()}},afterGetItem:function(c,e,f,a){var d=[];if(core.isset(e)&&core.isset(f)){var b=core.floors[core.status.floorId].afterGetItem[e+","+f];if(core.isset(b)){core.unshift(d,b)}}if(d.length>0){core.events.insertAction(d,e,f)}if(core.isset(a)){a()}},afterChangeLight:function(a,b){},afterPushBox:function(){var a=function(){for(var c=0;c<core.status.thisMap.blocks.length;c++){var b=core.status.thisMap.blocks[c];if(core.isset(b.event)&&b.event.id=="box"){return false}}return true};if(a()){}},afterUseBomb:function(){},beforeSaveData:function(a){},afterLoadData:function(a){core.enemys.updateEnemys()},canUseQuickShop:function(a){if(core.status.thisMap.canUseQuickShop===false){return"当前楼层不能使用快捷商店。"}return null}},enemys:{getSpecials:function(){return[[1,"先攻","怪物首先攻击"],[2,"魔攻","怪物无视勇士的防御"],[3,"坚固","勇士每回合最多只能对怪物造成1点伤害"],[4,"2连击","怪物每回合攻击2次"],[5,"3连击","怪物每回合攻击3次"],[6,function(a){return(a.n||4)+"连击"},function(a){return"怪物每回合攻击"+(a.n||4)+"次"}],[7,"破甲","战斗前，怪物附加角色防御的"+Math.floor(100*core.values.breakArmor||0)+"%作为伤害"],[8,"反击","战斗时，怪物每回合附加角色攻击的"+Math.floor(100*core.values.counterAttack||0)+"%作为伤害，无视角色防御"],[9,"净化","战斗前，怪物附加勇士魔防的"+core.values.purify+"倍作为伤害"],[10,"模仿","怪物的攻防和勇士攻防相等"],[11,"吸血",function(a){return"战斗前，怪物首先吸取角色的"+Math.floor(100*a.value||0)+"%生命（约"+Math.floor((a.value||0)*core.getStatus("hp"))+"点）作为伤害"+(a.add?"，并把伤害数值加到自身生命上":"")}],[12,"中毒","战斗后，勇士陷入中毒状态，每一步损失生命"+core.values.poisonDamage+"点"],[13,"衰弱","战斗后，勇士陷入衰弱状态，攻防暂时下降"+(core.values.weakValue>=1?core.values.weakValue+"点":parseInt(core.values.weakValue*100)+"%")],[14,"诅咒","战斗后，勇士陷入诅咒状态，战斗无法获得金币和经验"],[15,"领域",function(a){return"经过怪物周围"+(a.range||1)+"格时自动减生命"+(a.value||0)+"点"}],[16,"夹击","经过两只相同的怪物中间，勇士生命值变成一半"],[17,"仇恨","战斗前，怪物附加之前积累的仇恨值作为伤害"+(core.flags.hatredDecrease?"；战斗后，释放一半的仇恨值":"")+"。（每杀死一个怪物获得"+(core.values.hatred||0)+"点仇恨值）"],[18,"阻击",function(a){return"经过怪物的十字领域时自动减生命"+(a.value||0)+"点，同时怪物后退一格"}],[19,"自爆","战斗后勇士的生命值变成1"],[20,"无敌","勇士无法打败怪物，除非拥有十字架"],[21,"退化",function(a){return"战斗后勇士永久下降"+(a.atkValue||0)+"点攻击和"+(a.defValue||0)+"点防御"}],[22,"固伤",function(a){return"战斗前，怪物对勇士造成"+(a.damage||0)+"点固定伤害，无视勇士魔防。"}],[23,"重生","怪物被击败后，角色转换楼层则怪物将再次出现"],[24,"激光",function(a){return"经过怪物同行或同列时自动减生命"+(a.value||0)+"点"}],[25,"光环",function(a){return"同楼层所有怪物生命提升"+(a.value||0)+"%，攻击提升"+(a.atkValue||0)+"%，防御提升"+(a.defValue||0)+"%，"+(a.add?"可叠加":"不可叠加")}]]},getEnemyInfo:function(d,h,f,g,i,r,s,e){e=e||core.status.floorId;var n=d.hp,k=d.atk,l=d.def,q=d.special;var o=d.money,m=d.experience,p=d.point;if(this.hasSpecial(q,10)){k=f;l=g}if(this.hasSpecial(q,3)&&l<f-1){l=f-1}var j=0,a=0,c=0,b=0;core.status.maps[e].blocks.forEach(function(t){if(core.isset(t.event)&&!t.disable){var v=t.event.id,u=core.material.enemys[v];if(core.isset(u)&&core.hasSpecial(u.special,25)){if(u.add||b==0){j+=u.value||0;a+=u.atkValue||0;c+=u.defValue||0;b++}}}});n*=(1+j/100);k*=(1+a/100);l*=(1+c/100);return{hp:Math.floor(n),atk:Math.floor(k),def:Math.floor(l),money:Math.floor(o),experience:Math.floor(m),point:Math.floor(p),special:q}},getDamageInfo:function(c,h,f,g,i,s,t,e){e=e||core.status.floorId;h=Math.max(0,h);f=Math.max(0,f);g=Math.max(0,g);i=Math.max(0,i);if(core.flags.equipPercentage){f=Math.floor(core.getFlag("equip_atk_buff",1)*f);g=Math.floor(core.getFlag("equip_def_buff",1)*g);i=Math.floor(core.getFlag("equip_mdef_buff",1)*i)}var d=core.enemys.getEnemyInfo(c,h,f,g,i,s,t,e);var n=d.hp,l=d.atk,m=d.def,o=d.special;if(this.hasSpecial(o,20)&&!core.hasItem("cross")){return null}var k=0;if(this.hasSpecial(o,11)){var r=h*c.value;r=Math.floor(r)||0;if(c.add){n+=r}k+=r}if(f<=m){return null}var p=l-g;if(this.hasSpecial(o,2)){p=l}if(p<0){p=0}if(this.hasSpecial(o,4)){p*=2}if(this.hasSpecial(o,5)){p*=3}if(this.hasSpecial(o,6)){p*=(c.n||4)}var a=0;if(this.hasSpecial(o,8)){a+=Math.floor(core.values.counterAttack*f)}if(this.hasSpecial(o,1)){k+=p}if(this.hasSpecial(o,7)){k+=Math.floor(core.values.breakArmor*g)}if(this.hasSpecial(o,9)){k+=Math.floor(core.values.purify*i)}var j=f-m;var q=Math.ceil(n/j);var b=k+(q-1)*p+q*a;b-=i;if(!core.flags.enableNegativeDamage){b=Math.max(0,b)}return{mon_hp:n,mon_atk:l,mon_def:m,init_damage:k,per_damage:p,hero_per_damage:j,turn:q,damage:b}},updateEnemys:function(){}},control:{flyTo:function(e,a){var b=core.status.floorId;if(!core.status.maps[b].canFlyTo||!core.status.maps[e].canFlyTo){core.drawTip("无法飞往"+core.status.maps[e].title+"！");return false}var c=core.floorIds.indexOf(b),f=core.floorIds.indexOf(e);var d=c<=f?"downFloor":"upFloor";if(c==f&&core.status.maps[b].underGround){d="upFloor"}core.status.route.push("fly:"+e);core.ui.closePanel();core.changeFloor(e,d,null,null,a);return true},updateStatusBar:function(){core.events.checkLvUp();if(core.flags.enableHPMax){core.setStatus("hp",Math.min(core.getStatus("hpmax"),core.getStatus("hp")))}core.events.setFloorName();core.statusBar.name.innerHTML=core.getStatus("name");var b=core.getLvName();core.statusBar.lv.innerHTML=b;if(/^[+-]?\d+$/.test(b)){core.statusBar.lv.style.fontStyle="italic"}else{core.statusBar.lv.style.fontStyle="normal"}var c=["hpmax","hp","atk","def","mdef","money","experience"];c.forEach(function(d){if(core.isset(core.status.hero[d])){core.status.hero[d]=Math.floor(core.status.hero[d])}core.statusBar[d].innerHTML=core.formatBigNumber(core.getStatus(d))});if(core.flags.equipPercentage){core.statusBar.atk.innerHTML=core.formatBigNumber(Math.floor(core.getFlag("equip_atk_buff",1)*core.getStatus("atk")));core.statusBar.def.innerHTML=core.formatBigNumber(Math.floor(core.getFlag("equip_def_buff",1)*core.getStatus("def")));core.statusBar.mdef.innerHTML=core.formatBigNumber(Math.floor(core.getFlag("equip_mdef_buff",1)*core.getStatus("mdef")))}if(core.flags.enableLevelUp&&core.status.hero.lv<core.firstData.levelUp.length){core.statusBar.up.innerHTML=core.firstData.levelUp[core.status.hero.lv].need||"?"}else{core.statusBar.up.innerHTML="?"}var a=["yellowKey","blueKey","redKey"];a.forEach(function(d){core.statusBar[d].innerHTML=core.setTwoDigits(core.status.hero.items.keys[d])});if(core.flags.enableDebuff){core.statusBar.poison.innerHTML=core.hasFlag("poison")?"毒":"";core.statusBar.weak.innerHTML=core.hasFlag("weak")?"衰":"";core.statusBar.curse.innerHTML=core.hasFlag("curse")?"咒":""}if(core.flags.enablePZF){core.statusBar.pickaxe.innerHTML="破"+core.itemCount("pickaxe");core.statusBar.bomb.innerHTML="炸"+core.itemCount("bomb");core.statusBar.fly.innerHTML="飞"+core.itemCount("centerFly")}core.statusBar.hard.innerHTML=core.status.hard;core.updateCheckBlock();core.updateDamage()},updateCheckBlock:function(){core.status.checkBlock={};if(!core.isset(core.status.thisMap)){return}var b=core.status.thisMap.blocks;core.status.checkBlock.map=[];for(var k=0;k<b.length;k++){var a=b[k];if(core.isset(a.event)&&!a.disable&&a.event.cls.indexOf("enemy")==0){var g=a.event.id,e=core.material.enemys[g];if(core.isset(e)){core.status.checkBlock.map[a.x+core.bigmap.width*a.y]=g}}if(core.isset(a.event)&&!a.disable&&a.event.id=="lavaNet"&&a.event.trigger=="passNet"&&!core.hasItem("shoes")){core.status.checkBlock.map[a.x+core.bigmap.width*a.y]="lavaNet"}}core.status.checkBlock.damage=[];for(var p=0;p<core.bigmap.width*core.bigmap.height;p++){core.status.checkBlock.damage[p]=0}for(var p=0;p<core.bigmap.width;p++){for(var q=0;q<core.bigmap.height;q++){var g=core.status.checkBlock.map[p+core.bigmap.width*q];if(core.isset(g)){if(g=="lavaNet"){core.status.checkBlock.damage[p+core.bigmap.width*q]+=core.values.lavaDamage||0;continue}var e=core.material.enemys[g];if(core.enemys.hasSpecial(e.special,15)&&!core.hasFlag("no_zone")){var o=e.range||1;var r=false;if(core.isset(e.zoneSquare)){r=e.zoneSquare}for(var c=-o;c<=o;c++){for(var d=-o;d<=o;d++){if(c==0&&d==0){continue}var l=p+c,m=q+d;if(l<0||l>=core.bigmap.width||m<0||m>=core.bigmap.height){continue}if(!r&&Math.abs(c)+Math.abs(d)>o){continue}core.status.checkBlock.damage[l+m*core.bigmap.width]+=e.value||0}}}if(core.enemys.hasSpecial(e.special,24)&&!core.hasFlag("no_laser")){for(var l=0;l<core.bigmap.width;l++){if(l!=p){core.status.checkBlock.damage[l+q*core.bigmap.width]+=e.value||0}}for(var m=0;m<core.bigmap.height;m++){if(m!=q){core.status.checkBlock.damage[p+m*core.bigmap.width]+=e.value||0}}}if(core.enemys.hasSpecial(e.special,18)&&!core.hasFlag("no_snipe")){for(var c=-1;c<=1;c++){for(var d=-1;d<=1;d++){if(c==0&&d==0){continue}var l=p+c,m=q+d;if(l<0||l>=core.bigmap.width||m<0||m>=core.bigmap.height||Math.abs(c)+Math.abs(d)>1){continue}core.status.checkBlock.damage[l+m*core.bigmap.width]+=e.value||0}}}}}}core.status.checkBlock.betweenAttack=[];if(!core.hasFlag("no_betweenAttack")){for(var p=0;p<core.bigmap.width;p++){for(var q=0;q<core.bigmap.height;q++){var f=false;if(p>0&&p<core.bigmap.width-1){var h=core.status.checkBlock.map[p-1+core.bigmap.width*q],i=core.status.checkBlock.map[p+1+core.bigmap.width*q];if(core.isset(h)&&core.isset(i)&&h==i){var e=core.material.enemys[h];if(core.isset(e)&&core.enemys.hasSpecial(e.special,16)){f=true}}}if(q>0&&q<core.bigmap.height-1){var h=core.status.checkBlock.map[p+core.bigmap.width*(q-1)],i=core.status.checkBlock.map[p+core.bigmap.width*(q+1)];if(core.isset(h)&&core.isset(i)&&h==i){var e=core.material.enemys[h];if(core.isset(e)&&core.enemys.hasSpecial(e.special,16)){f=true}}}if(f){core.status.checkBlock.betweenAttack[p+core.bigmap.width*q]=true;var j=core.status.hero.hp-core.status.checkBlock.damage[p+core.bigmap.width*q];if(j>1){core.status.checkBlock.damage[p+core.bigmap.width*q]+=Math.floor((j+(core.flags.betweenAttackCeil?0:1))/2)}}}}}}},ui:{drawStatistics:function(){return["yellowDoor","blueDoor","redDoor","greenDoor","steelDoor","yellowKey","blueKey","redKey","greenKey","steelKey","redJewel","blueJewel","greenJewel","yellowJewel","redPotion","bluePotion","greenPotion","yellowPotion","superPotion","pickaxe","bomb","centerFly","poisonWine","weakWine","curseWine","superWine","sword1","sword2","sword3","sword4","sword5","shield1","shield2","shield3","shield4","shield5",]},drawAbout:function(){if(!core.isPlaying()){core.status.event={id:null,data:null};core.dom.startPanel.style.display="none"}core.lockControl();core.status.event.id="about";core.clearMap("ui");var b=48,e=36,c=416-2*b,a=416-2*e;core.setAlpha("ui",0.85);core.fillRect("ui",b,e,c,a,"#000000");core.setAlpha("ui",1);core.strokeRect("ui",b-1,e-1,c+1,a+1,"#FFFFFF",2);var d=b+24;core.canvas.ui.textAlign="left";core.fillText("ui","HTML5 魔塔样板",d,e+35,"#FFD700","bold 22px Verdana");core.fillText("ui","版本： "+core.firstData.version,d,e+80,"#FFFFFF","bold 17px Verdana");core.fillText("ui","作者： 艾之葵",d,e+112);core.fillText("ui","HTML5魔塔交流群：539113091",d,e+112+32)}},plugins:{parallelDo:function(a){if(!core.isPlaying()){return}},plugin:function(){console.log("插件编写测试");this.test=function(){console.log("插件函数执行测试")};this.drawLight=function(a,d,c){var b=core.canvas.curtain;b.mozImageSmoothingEnabled=false;b.webkitImageSmoothingEnabled=false;b.msImageSmoothingEnabled=false;b.imageSmoothingEnabled=false;core.clearMap("curtain");core.setOpacity("curtain",1);core.setAlpha("curtain",1);if(!core.isset(a)){a=0.9}if(typeof a=="number"){a=[0,0,0,a]}core.fillRect("curtain",0,0,416,416,"rgba("+a[0]+","+a[1]+","+a[2]+","+core.clamp(a[3],0,1)+")");if(!core.isset(d)||d.length==0){return}c=core.clamp(c,0,1);d.forEach(function(t){var A=t[0],B=t[1],v=t[2],u=255*(1-core.clamp(t[3],0,1));var j=parseInt(v*c),s=v-j;var h=v*2,w=A-v,z=B-v;var p=b.getImageData(w,z,h,h);for(var n=0;n<p.data.length;n+=4){var q=n/4,f=parseInt(q/h),g=q%h;var l=v-f,m=v-g,k=Math.sqrt(l*l+m*m);if(k>=v){continue}var e=p.data[n+3]-(k<j?1:(v-k)/s)*u;p.data[n+3]=core.clamp(e,0,255)}b.putImageData(p,w,z)})}}}};