function loader(){this.init()}loader.prototype.init=function(){};loader.prototype.setStartProgressVal=function(a){core.dom.startTopProgress.style.width=a+"%"};loader.prototype.setStartLoadTipText=function(a){core.dom.startTopLoadTips.innerHTML=a};loader.prototype.load=function(a){core.loader.loadIcons();core.loader.loadImages(core.materials,core.material.images,function(){core.material.images.images={};var b=core.clone(core.images);if(b.indexOf("hero.png")<0){b.push("hero.png")}core.loader.loadImages(b,core.material.images.images,function(){core.material.images.autotile={};core.loader.loadImages(Object.keys(core.material.icons.autotile),core.material.images.autotile,function(){core.material.images.tilesets={};if(!core.isset(core.tilesets)){core.tilesets=[]}core.loader.loadImages(core.clone(core.tilesets),core.material.images.tilesets,function(){for(var d in core.material.images.tilesets){var c=core.material.images.tilesets[d];if(c.width%32!=0||c.height%32!=0){console.warn("警告！"+d+"的宽或高不是32的倍数！")}if(c.width*c.height>32*32*1000){console.warn("警告！"+d+"上的图块素材个数大于1000！")}}core.loader.loadAnimates();core.loader.loadMusic();if(core.isset(a)){a()}})})})})};loader.prototype.loadIcons=function(){this.loadImage("icons.png",function(a,b){var c=core.cropImage(b);for(var d in core.statusBar.icons){if(typeof core.statusBar.icons[d]=="number"){core.statusBar.icons[d]=c[core.statusBar.icons[d]];if(core.isset(core.statusBar.image[d])){core.statusBar.image[d].src=core.statusBar.icons[d].src}}}})};loader.prototype.loadImages=function(d,f,a){if(!core.isset(d)||d.length==0){if(core.isset(a)){a()}return}var c=0;for(var b=0;b<d.length;b++){this.loadImage(d[b],function(g,h){core.loader.setStartLoadTipText("正在加载图片 "+g+"...");f[g]=h;c++;core.loader.setStartProgressVal(c*(100/d.length));if(c==d.length){if(core.isset(a)){a()}}})}};loader.prototype.loadImage=function(d,a){try{var f=d;if(f.indexOf(".")<0){f=f+".png"}var c=new Image();c.src="project/images/"+f+"?v="+main.version;if(c.complete){a(d,c);return}c.onload=function(){a(d,c)}}catch(b){console.log(b)}};loader.prototype.loadAnimates=function(){core.animates.forEach(function(a){core.http("GET","project/animates/"+a+".animate",null,function(b){try{b=JSON.parse(b);var c={};c.ratio=b.ratio;c.se=b.se;c.images=[];c.images_rev=[];b.bitmaps.forEach(function(h){if(!core.isset(h)||h==""){c.images.push(null)}else{try{var g=new Image();g.src=h;c.images.push(g)}catch(f){c.images.push(null)}}});c.frame=b.frame_max;c.frames=[];b.frames.forEach(function(g){var f=[];g.forEach(function(h){f.push({index:h[0],x:h[1],y:h[2],zoom:h[3],opacity:h[4],mirror:h[5]||0,angle:h[6]||0,})});c.frames.push(f)});core.material.animates[a]=c}catch(d){console.log(d);core.material.animates[a]=null}},function(b){console.log(b);core.material.animates[a]=null},"text/plain; charset=x-user-defined")})};loader.prototype.loadMusic=function(){core.bgms.forEach(function(b){if(/^.*\.mid$/i.test(b)){if(core.musicStatus.audioContext!=null){core.material.bgms[b]="loading";core.http("GET","project/sounds/"+b,null,function(c){try{var f=[];var g=c.length;for(var i=0;i<g;i++){f[i]=String.fromCharCode(c.charCodeAt(i)&255)}var h=core.material.bgms[b]=="starting";core.material.bgms[b]=AudioPlayer(core.musicStatus.audioContext,Replayer(MidiFile(f.join("")),Synth(44100)),true);if(h){core.playBgm(b)}}catch(d){console.log(d);core.material.bgms[b]=null}},function(c){console.log(c);core.material.bgms[b]=null},"text/plain; charset=x-user-defined")}else{core.material.bgms[b]=null}}else{var a=new Audio();a.preload="none";if(main.bgmRemote){a.src=main.bgmRemoteRoot+core.firstData.name+"/"+b}else{a.src="project/sounds/"+b}a.loop="loop";core.material.bgms[b]=a}});core.sounds.forEach(function(b){if(core.musicStatus.audioContext!=null){core.http("GET","project/sounds/"+b,null,function(c){try{core.musicStatus.audioContext.decodeAudioData(c,function(f){core.material.sounds[b]=f},function(f){console.log(f);core.material.sounds[b]=null})}catch(d){console.log(d);core.material.sounds[b]=null}},function(){console.log(e);core.material.sounds[b]=null},null,"arraybuffer")}else{var a=new Audio();a.src="project/sounds/"+b;core.material.sounds[b]=a}});if(core.musicStatus.startDirectly&&core.bgms.length>0){core.playBgm(core.bgms[0])}};function control(){this.init()}control.prototype.init=function(){this.controldata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.control};control.prototype.setRequestAnimationFrame=function(){(function(){var c=0;var d=["webkit","moz"];for(var e=0;e<d.length&&!window.requestAnimationFrame;++e){window.requestAnimationFrame=window[d[e]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[d[e]+"CancelAnimationFrame"]||window[d[e]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(f,h){var g=new Date().getTime();var j=Math.max(0,16.7-(g-c));var i=window.setTimeout(function(){f(g+j)},j);c=g+j;return i}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(f){clearTimeout(f)}}}());core.animateFrame.speed=core.values.animateSpeed;core.animateFrame.background=core.canvas.ui.createPattern(core.material.ground,"repeat");var b={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var a=function(g){core.animateFrame.globalTime=core.animateFrame.globalTime||g;core.animateFrame.boxTime=core.animateFrame.boxTime||g;core.animateFrame.animateTime=core.animateFrame.animateTime||g;core.animateFrame.moveTime=core.animateFrame.moveTime||g;core.animateFrame.weather.time=core.animateFrame.weather.time||g;if(core.isPlaying()&&core.isset(core.status)&&core.isset(core.status.hero)&&core.isset(core.status.hero.statistics)){core.status.hero.statistics.totalTime+=g-(core.status.hero.statistics.start||g);core.status.hero.statistics.currTime+=g-(core.status.hero.statistics.start||g);core.status.hero.statistics.start=g}if(core.animateFrame.globalAnimate&&core.isPlaying()){if(g-core.animateFrame.globalTime>core.animateFrame.speed&&core.isset(core.status.globalAnimateObjs)){for(var c=0;c<core.status.globalAnimateObjs.length;c++){var f=core.status.globalAnimateObjs[c];f.status=(f.status+1)%(f.event.animate||1);core.drawBlock(f,f.status)}core.animateFrame.globalTime=g}}if(g-core.animateFrame.boxTime>core.animateFrame.speed&&core.isset(core.status.boxAnimateObjs)&&core.status.boxAnimateObjs.length>0){core.drawBoxAnimate();core.animateFrame.boxTime=g}if(g-core.animateFrame.animateTime>50&&core.isset(core.status.animateObjs)&&core.status.animateObjs.length>0){core.clearMap("animate");core.status.animateObjs=core.status.animateObjs.filter(function(j){return j.index<j.animate.frames.length});core.status.animateObjs.forEach(function(j){core.maps.drawAnimateFrame(j.animate,j.centerX,j.centerY,j.index++)});core.animateFrame.animateTime=g}if(g-core.animateFrame.moveTime>16&&core.isset(core.status.heroMoving)&&core.status.heroMoving>0){var h=core.getHeroLoc("x"),i=core.getHeroLoc("y"),e=core.getHeroLoc("direction");if(core.status.heroMoving<=4){core.drawHero(e,h,i,"leftFoot",4*core.status.heroMoving)}else{if(core.status.heroMoving<=8){core.drawHero(e,h,i,"rightFoot",4*core.status.heroMoving)}}core.animateFrame.moveTime=g}if(core.isPlaying()&&g-core.animateFrame.weather.time>30){if(core.animateFrame.weather.type=="rain"&&core.animateFrame.weather.level>0){core.clearMap("weather");core.canvas.weather.strokeStyle="rgba(174,194,224,0.8)";core.canvas.weather.lineWidth=1;core.canvas.weather.lineCap="round";core.animateFrame.weather.nodes.forEach(function(j){core.canvas.weather.beginPath();core.canvas.weather.moveTo(j.x,j.y);core.canvas.weather.lineTo(j.x+j.l*j.xs,j.y+j.l*j.ys);core.canvas.weather.stroke();j.x+=j.xs;j.y+=j.ys;if(j.x>416||j.y>416){j.x=Math.random()*416;j.y=-10}});core.canvas.weather.fill()}else{if(core.animateFrame.weather.type=="snow"&&core.animateFrame.weather.level>0){core.clearMap("weather");core.canvas.weather.fillStyle="rgba(255, 255, 255, 0.8)";core.canvas.weather.beginPath();if(!core.isset(core.animateFrame.weather.data)){core.animateFrame.weather.data=0}core.animateFrame.weather.data+=0.01;var d=core.animateFrame.weather.data;core.animateFrame.weather.nodes.forEach(function(j){core.canvas.weather.moveTo(j.x,j.y);core.canvas.weather.arc(j.x,j.y,j.r,0,Math.PI*2,true);j.x+=Math.sin(d)*2;j.y+=Math.cos(d+j.d)+1+j.r/2;if(j.x>416+5||j.x<-5||j.y>416){if(Math.random()>1/3){j.x=Math.random()*416;j.y=-10}else{if(Math.sin(d)>0){j.x=-5;j.y=Math.random()*416}else{j.x=416+5;j.y=Math.random()*416}}}});core.canvas.weather.fill()}}core.animateFrame.weather.time=g}functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.plugins.parallelDo(g);window.requestAnimationFrame(a)};window.requestAnimationFrame(a)};control.prototype.showStartAnimate=function(a){core.dom.startPanel.style.opacity=1;core.dom.startPanel.style.display="block";core.dom.startTop.style.opacity=1;core.dom.startTop.style.display="block";core.dom.startButtonGroup.style.display="none";core.dom.startButtons.style.display="block";core.dom.levelChooseButtons.style.display="none";core.status.played=false;core.clearStatus();core.clearMap("all");var b=1;var c=window.setInterval(function(){b-=0.03;if(b<0){clearInterval(c);core.dom.startTop.style.display="none";core.dom.startButtonGroup.style.display="block";if(core.isset(a)){a()}}core.dom.startTop.style.opacity=b},20)};control.prototype.hideStartAnimate=function(a){var b=1;var c=window.setInterval(function(){b-=0.03;if(b<0){clearInterval(c);core.dom.startPanel.style.display="none";if(core.isset(a)){a()}}core.dom.startPanel.style.opacity=b},20)};control.prototype.isPlaying=function(){return core.isset(core.status.played)&&core.status.played};control.prototype.clearStatus=function(){for(var a in core.timeout){clearTimeout(core.timeout[a]);core.timeout[a]=null}for(var a in core.interval){clearInterval(core.interval[a]);core.interval[a]=null}core.status={};core.clearStatusBar();core.status.played=false;core.events.setHeroIcon("hero.png",true)};control.prototype.resetStatus=function(c,b,a,e,d,g){var f=0;if(core.isset(core.status)&&core.isset(core.status.hero)&&core.isset(core.status.hero.statistics)&&core.isset(e)){f=core.status.hero.statistics.totalTime}core.clearStatus();core.status=core.clone(core.initStatus);core.status.floorId=a;core.status.maps=core.clone(d);core.material.enemys=core.clone(core.enemys.getEnemys());core.material.items=core.clone(core.items.getItems());core.status.hero=core.clone(c);core.events.setHeroIcon(core.getFlag("heroIcon","hero.png"),true);if(!core.isset(core.status.hero.statistics)){core.status.hero.statistics={totalTime:f,currTime:0,hp:0,battle:0,battleDamage:0,poisonDamage:0,extraDamage:0,moveDirectly:0,ignoreSteps:0,}}core.status.hero.statistics.totalTime=Math.max(core.status.hero.statistics.totalTime,f);core.status.hero.statistics.start=null;core.status.hard=b;if(core.isset(e)){core.status.route=e}core.status.saveIndex=core.getLocalStorage("saveIndex2",1);if(core.isset(g)){core.values=core.clone(g)}else{core.values=core.clone(core.data.values)}core.events.initGame();core.status.played=true};control.prototype.startGame=function(b,a){console.log("开始游戏");this.resetStatus(core.firstData.hero,b,core.firstData.floorId,null,core.initStatus.maps);core.changeFloor(core.status.floorId,null,core.firstData.hero.loc,null,function(){if(core.isset(a)){a()}},true);setTimeout(function(){var c=new FormData();c.append("type","people");c.append("name",core.firstData.name);c.append("version",core.firstData.version);c.append("platform",core.platform.isPC?"PC":core.platform.isAndroid?"Android":core.platform.isIOS?"iOS":"");c.append("hard",core.encodeBase64(b));c.append("hardCode",core.getFlag("hard",0));c.append("base64",1);core.utils.http("POST","/games/upload.php",c)})};control.prototype.restart=function(){this.showStartAnimate();if(core.bgms.length>0){core.playBgm(core.bgms[0])}};control.prototype.clearAutomaticRouteNode=function(a,b){if(core.status.event.id==null){core.canvas.route.clearRect(a*32+5,b*32+5,27,27)}};control.prototype.stopAutomaticRoute=function(){if(!core.status.played){return}core.status.automaticRoute.autoHeroMove=false;core.status.automaticRoute.autoStep=0;core.status.automaticRoute.destStep=0;core.status.automaticRoute.movedStep=0;core.status.automaticRoute.autoStepRoutes=[];core.status.automaticRoute.destX=null;core.status.automaticRoute.destY=null;core.status.automaticRoute.lastDirection=null;core.stopHero();if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.clearMap("route")}};control.prototype.continueAutomaticRoute=function(){var a=core.status.automaticRoute.moveStepBeforeStop;if(a.length===0||(a.length===1&&a[0].step===1)){core.status.automaticRoute.moveStepBeforeStop=[]}else{core.setAutoHeroMove(a)}};control.prototype.clearContinueAutomaticRoute=function(){core.clearMap("route");core.status.automaticRoute.moveStepBeforeStop=[]};control.prototype.moveDirectly=function(a,b){var c=core.canMoveDirectly(a,b);if(c>=0){core.clearMap("hero");var d=core.status.route[core.status.route.length-1];if(["left","right","up","down"].indexOf(d)>=0){core.setHeroLoc("direction",d)}core.setHeroLoc("x",a);core.setHeroLoc("y",b);core.drawHero();core.status.route.push("move:"+a+":"+b);core.status.hero.statistics.moveDirectly++;core.status.hero.statistics.ignoreSteps+=c;return true}return false};control.prototype.tryMoveDirectly=function(a,b){if(Math.abs(core.getHeroLoc("x")-a)+Math.abs(core.getHeroLoc("y")-b)<=1){return false}var c=function(e,f,d){if(e<0||e>=core.bigmap.width||f<0||f>=core.bigmap.height){return false}if(core.control.moveDirectly(e,f)){if(core.isset(d)){core.moveHero(d,function(){})}return true}return false};return c(a,b)||c(a-1,b,"right")||c(a,b-1,"down")||c(a,b+1,"up")||c(a+1,b,"left")};control.prototype.setAutomaticRoute=function(a,b,h){if(!core.status.played||core.status.lockControl){return}if(core.status.automaticRoute.autoHeroMove){var c=core.status.automaticRoute.destX,d=core.status.automaticRoute.destY;core.stopAutomaticRoute();if(c==a&&d==b){core.status.automaticRoute.moveDirectly=true;setTimeout(function(){if(core.status.automaticRoute.moveDirectly&&core.status.heroMoving==0){core.control.tryMoveDirectly(a,b)}core.status.automaticRoute.moveDirectly=false},100)}return}if(a==core.status.hero.loc.x&&b==core.status.hero.loc.y&&h.length==0){if(core.timeout.turnHeroTimeout==null){core.timeout.turnHeroTimeout=setTimeout(function(){core.turnHero();clearTimeout(core.timeout.turnHeroTimeout);core.timeout.turnHeroTimeout=null},250)}else{clearTimeout(core.timeout.turnHeroTimeout);core.timeout.turnHeroTimeout=null;core.getNextItem()}return}if(core.timeout.turnHeroTimeout!=null){return}if(core.flags.clickMoveDirectly&&core.status.heroStop){if(core.control.tryMoveDirectly(a,b)){return}}var g=0;var i=null;var f;if(!(f=core.automaticRoute(a,b))){if(a==core.status.hero.loc.x&&b==core.status.hero.loc.y){f=[]}else{core.clearMap("route");return}}f=f.concat(h);core.status.automaticRoute.destX=a;core.status.automaticRoute.destY=b;core.canvas.route.save();core.clearMap("route");core.canvas.route.fillStyle="#bfbfbf";core.canvas.route.strokeStyle="#bfbfbf";core.canvas.route.lineWidth=8;for(var e=0;e<f.length;e++){if(i==null){g++;i=f[e].direction}else{if(i==f[e].direction){g++}else{core.status.automaticRoute.autoStepRoutes.push({direction:i,step:g});g=1;i=f[e].direction}}if(e==f.length-1){core.status.automaticRoute.autoStepRoutes.push({direction:i,step:g});core.canvas.route.fillRect(f[e].x*32+10,f[e].y*32+10,12,12)}else{core.canvas.route.beginPath();if(core.isset(f[e+1])&&i!=f[e+1].direction){if(i=="up"&&f[e+1].direction=="left"||i=="right"&&f[e+1].direction=="down"){core.canvas.route.moveTo(f[e].x*32+5,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+27)}else{if(i=="up"&&f[e+1].direction=="right"||i=="left"&&f[e+1].direction=="down"){core.canvas.route.moveTo(f[e].x*32+27,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+27)}else{if(i=="left"&&f[e+1].direction=="up"||i=="down"&&f[e+1].direction=="right"){core.canvas.route.moveTo(f[e].x*32+27,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+5)}else{if(i=="right"&&f[e+1].direction=="up"||i=="down"&&f[e+1].direction=="left"){core.canvas.route.moveTo(f[e].x*32+5,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+5)}}}}core.canvas.route.stroke();continue}switch(i){case"up":case"down":core.canvas.route.beginPath();core.canvas.route.moveTo(f[e].x*32+16,f[e].y*32+5);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+27);core.canvas.route.stroke();break;case"left":case"right":core.canvas.route.beginPath();core.canvas.route.moveTo(f[e].x*32+5,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+27,f[e].y*32+16);core.canvas.route.stroke();break}}}core.canvas.route.restore();core.setAutoHeroMove()};control.prototype.automaticRoute=function(e,f){var j=core.bigmap.width,i=core.bigmap.height;var u=core.getHeroLoc("x");var v=core.getHeroLoc("y");var t={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};if(e==u&&f==v){return false}var s=[];var r=new PriorityQueue({comparator:function(w,x){return w.depth-x.depth}});var a=[];s[u+j*v]="";r.queue({depth:0,x:u,y:v});while(r.length!=0){var b=r.dequeue();var c=b.depth,n=b.x,o=b.y;for(var h in t){if(!core.canMoveHero(n,o,h)){continue}var p=n+t[h].x;var q=o+t[h].y;if(p<0||p>=j||q<0||q>=i){continue}var m=p+j*q;if(core.isset(s[m])){continue}var d=1;var l,k=core.getBlock(p,q);if(k!=null){l=k.block.event.id;if(l=="light"){d=100}if(!core.flags.potionWhileRouting&&l.substring(l.length-6)=="Potion"){d+=20}if(k.block.event.trigger=="changeFloor"){d+=10}}d+=core.status.checkBlock.damage[m]*10;if(p==e&&q==f){s[m]=h;break}if(core.noPassExists(p,q)){continue}s[m]=h;r.queue({depth:c+d,x:p,y:q})}if(core.isset(s[e+j*f])){break}}if(!core.isset(s[e+j*f])){return false}var n=e,o=f;while(n!=u||o!=v){var g=s[n+j*o];a.push({direction:g,x:n,y:o});n-=t[g].x;o-=t[g].y}a.reverse();return a};control.prototype.fillPosWithPoint=function(a){core.fillRect("route",a.x*32+12+core.bigmap.offsetX,a.y*32+12+core.bigmap.offsetY,8,8,"#bfbfbf")};control.prototype.setAutoHeroMove=function(a){a=a||core.status.automaticRoute.autoStepRoutes;if(a.length==0){return}core.status.automaticRoute.autoStepRoutes=a;core.status.automaticRoute.autoHeroMove=true;core.status.automaticRoute.autoStep=1;core.status.automaticRoute.destStep=a[0].step;core.moveHero(a[0].direction)};control.prototype.setHeroMoveInterval=function(b,e,f,a){if(core.status.heroMoving>0){return}core.status.heroMoving=1;var c={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var d=1;if(core.status.replay.speed>3){d=2}if(core.status.replay.speed>6){d=4}if(core.status.replay.speed>12){d=8}core.interval.heroMoveInterval=window.setInterval(function(){core.status.heroMoving+=d;if(core.status.heroMoving>=8){core.setHeroLoc("x",e+c[b].x,true);core.setHeroLoc("y",f+c[b].y,true);core.control.updateFollowers();core.moveOneStep();core.clearMap("hero");core.drawHero(b);clearInterval(core.interval.heroMoveInterval);core.status.heroMoving=0;if(core.isset(a)){a()}}},12.5*d/core.status.replay.speed)};control.prototype.moveAction=function(a){if(core.interval.openDoorAnimate!=null){return}if(core.status.heroMoving>0){return}var e={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var c=core.getHeroLoc("direction");var f=core.getHeroLoc("x");var g=core.getHeroLoc("y");var d=core.noPass(f+e[c].x,g+e[c].y),b=core.canMoveHero();if(d||!b){if(core.status.event.id!="ski"){core.status.route.push(c)}core.status.automaticRoute.moveStepBeforeStop=[];core.status.automaticRoute.lastDirection=core.getHeroLoc("direction");if(b){core.trigger(f+e[c].x,g+e[c].y)}core.drawHero(c,f,g);if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.clearContinueAutomaticRoute();core.stopAutomaticRoute()}if(core.isset(a)){a()}}else{core.setHeroMoveInterval(c,f,g,function(){if(core.status.automaticRoute.autoHeroMove){core.status.automaticRoute.movedStep++;core.status.automaticRoute.lastDirection=core.getHeroLoc("direction");if(core.status.automaticRoute.destStep==core.status.automaticRoute.movedStep){if(core.status.automaticRoute.autoStep==core.status.automaticRoute.autoStepRoutes.length){core.clearContinueAutomaticRoute();core.stopAutomaticRoute()}else{core.status.automaticRoute.movedStep=0;core.status.automaticRoute.destStep=core.status.automaticRoute.autoStepRoutes[core.status.automaticRoute.autoStep].step;core.setHeroLoc("direction",core.status.automaticRoute.autoStepRoutes[core.status.automaticRoute.autoStep].direction);core.status.automaticRoute.autoStep++}}}else{if(core.status.heroStop){core.drawHero()}}if(core.status.event.id!="ski"){core.status.route.push(c)}var j=core.getHeroLoc("x"),k=core.getHeroLoc("y");var h=core.getBlock(j,k);var i=false;if(h!=null&&h.block.event.trigger=="getItem"&&!core.isset(core.floors[core.status.floorId].afterGetItem[j+","+k])){i=true;core.trigger(j,k)}core.checkBlock();if(!i&&!core.status.gameOver){core.trigger(j,k)}if(core.isset(a)){a()}})}};control.prototype.turnHero=function(a){if(core.isset(a)){core.setHeroLoc("direction",a);core.drawHero();core.clearMap("route");core.status.route.push("turn:"+a);return}if(core.status.hero.loc.direction=="up"){core.status.hero.loc.direction="right"}else{if(core.status.hero.loc.direction=="right"){core.status.hero.loc.direction="down"}else{if(core.status.hero.loc.direction=="down"){core.status.hero.loc.direction="left"}else{if(core.status.hero.loc.direction=="left"){core.status.hero.loc.direction="up"}}}}core.drawHero();core.clearMap("route");core.status.route.push("turn")};control.prototype.moveHero=function(b,a){if(core.status.heroMoving!=0){return}if(core.isset(b)){core.setHeroLoc("direction",b)}if(!core.isset(a)){core.status.heroStop=false;core.status.automaticRoute.moveDirectly=false;var c=function(){if(!core.status.heroStop){if(core.hasFlag("debug")&&core.status.ctrlDown){if(core.status.heroMoving!=0){return}var f={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};b=core.getHeroLoc("direction");var d=core.getHeroLoc("x")+f[b].x,e=core.getHeroLoc("y")+f[b].y;if(d<0||d>=core.bigmap.width||e<0||e>=core.bigmap.height){return}core.status.heroMoving=-1;core.eventMoveHero([b],100,function(){core.status.heroMoving=0;c()})}else{core.moveAction();setTimeout(c,50)}}else{core.stopHero()}};c()}else{core.moveAction(function(){a()})}};control.prototype.eventMoveHero=function(f,g,b){g=g||100;core.clearMap("ui");core.setAlpha("ui",1);var c=[];f.forEach(function(h){if(typeof h=="string"){c.push(h)}else{if(!core.isset(h.value)){c.push(h.direction)}else{for(var j=0;j<h.value;j++){c.push(h.direction)}}}});var e=0;var d={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};core.status.replay.animate=true;var a=window.setInterval(function(){var i=core.getHeroLoc("x"),j=core.getHeroLoc("y");if(c.length==0){clearInterval(a);core.drawHero(null,i,j);core.status.replay.animate=false;if(core.isset(b)){b()}}else{var h=c[0];core.setHeroLoc("direction",h);e++;if(e<=4){core.drawHero(h,i,j,"leftFoot",4*e)}else{if(e<=8){core.drawHero(h,i,j,"rightFoot",4*e)}}if(e==8){e=0;core.setHeroLoc("x",i+d[h].x,true);core.setHeroLoc("y",j+d[h].y,true);core.control.updateFollowers();c.shift()}}},g/8/core.status.replay.speed)};control.prototype.jumpHero=function(j,k,s,b){var q=core.status.hero.loc.x,r=core.status.hero.loc.y;if(!core.isset(j)){j=q}if(!core.isset(k)){k=r}s=s||500;core.clearMap("ui");core.setAlpha("ui",1);core.status.replay.animate=true;core.playSound("jump.mp3");var h=j-q,i=k-r,e=Math.round(Math.sqrt(h*h+i*i));var o=6+e,n=o*2;var c=q,d=r;var m=core.material.icons.hero[core.getHeroLoc("direction")];var p="stop";var l=core.material.icons.hero.height;var f=function(){return c*32};var g=function(){var v=d*32;if(n>=o){var u=n-o}else{var u=o-n}return v-(o*o-u*u)/2};var t=function(){n--;c=(c*n+j)/(n+1);d=(d*n+k)/(n+1)};if(core.isset(core.status.hero.followers)&&core.status.hero.followers.length>0){core.clearMap("hero")}var a=window.setInterval(function(){if(n>0){core.clearMap("hero",f()-core.bigmap.offsetX,g()-l+32-core.bigmap.offsetY,32,l);t();var u=f(),v=g();core.bigmap.offsetX=core.clamp(u-32*6,0,32*core.bigmap.width-416);core.bigmap.offsetY=core.clamp(v-32*6,0,32*core.bigmap.height-416);core.control.updateViewport();core.canvas.hero.drawImage(core.material.images.hero,m[p]*32,m.loc*l,32,l,u-core.bigmap.offsetX,v+32-l-core.bigmap.offsetY,32,l)}else{clearInterval(a);core.setHeroLoc("x",j);core.setHeroLoc("y",k);core.drawHero();core.status.replay.animate=false;if(core.isset(b)){b()}}},s/16/core.status.replay.speed)};control.prototype.moveOneStep=function(){core.status.hero.steps++;if(core.hasFlag("poison")){core.status.hero.statistics.poisonDamage+=core.values.poisonDamage;core.status.hero.hp-=core.values.poisonDamage;if(core.status.hero.hp<=0){core.status.hero.hp=0;core.updateStatusBar();core.events.lose();return}core.updateStatusBar()}};control.prototype.waitHeroToStop=function(a){var b=core.status.automaticRoute.lastDirection;core.stopAutomaticRoute();core.clearContinueAutomaticRoute();if(core.isset(a)){core.status.replay.animate=true;core.lockControl();core.status.automaticRoute.moveDirectly=false;setTimeout(function(){core.status.replay.animate=false;if(core.isset(b)){core.setHeroLoc("direction",b)}core.drawHero();a()},30)}};control.prototype.stopHero=function(){core.status.heroStop=true};control.prototype.setGameCanvasTranslate=function(b,d,e){var a=core.dom.gameCanvas[b];d=d*core.domStyle.scale;e=e*core.domStyle.scale;a.style.transform="translate("+d+"px,"+e+"px)";a.style.webkitTransform="translate("+d+"px,"+e+"px)";a.style.OTransform="translate("+d+"px,"+e+"px)";a.style.MozTransform="translate("+d+"px,"+e+"px)";if(main.mode==="editor"&&editor.isMobile){a.style.transform="translate("+(d/416*96)+"vw,"+(e/416*96)+"vw)";a.style.webkitTransform="translate("+(d/416*96)+"vw,"+(e/416*96)+"vw)";a.style.OTransform="translate("+(d/416*96)+"vw,"+(e/416*96)+"vw)";a.style.MozTransform="translate("+(d/416*96)+"vw,"+(e/416*96)+"vw)"}};control.prototype.updateViewport=function(){core.bigmap.canvas.forEach(function(a){core.control.setGameCanvasTranslate(a,-core.bigmap.offsetX,-core.bigmap.offsetY)})};control.prototype.drawHero=function(a,m,n,k,g){if(!core.isPlaying()){return}var j={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};if(!core.isset(m)){m=core.getHeroLoc("x")}if(!core.isset(n)){n=core.getHeroLoc("y")}k=k||"stop";a=a||core.getHeroLoc("direction");g=g||0;var l=j[a];var h=l.x*g;var i=l.y*g;var c=h==0?0:h/Math.abs(h),d=i==0?0:i/Math.abs(i);core.bigmap.offsetX=core.clamp((m-6)*32+h,0,32*core.bigmap.width-416);core.bigmap.offsetY=core.clamp((n-6)*32+i,0,32*core.bigmap.height-416);core.clearAutomaticRouteNode(m+c,n+d);core.canvas.hero.clearRect(m*32-core.bigmap.offsetX-32,n*32-core.bigmap.offsetY-32,96,96);var e=core.material.icons.hero;var b=[];b.push({img:core.material.images.hero,height:core.material.icons.hero.height,heroIcon:e[a],posx:m*32-core.bigmap.offsetX+h,posy:n*32-core.bigmap.offsetY+i,status:k,index:0,});if(core.isset(core.status.hero.followers)){var f=1;core.status.hero.followers.forEach(function(o){core.canvas.hero.clearRect(32*o.x-core.bigmap.offsetX-32,32*o.y-core.bigmap.offsetY-32,96,96);if(core.isset(core.material.images.images[o.img])){b.push({img:core.material.images.images[o.img],height:core.material.images.images[o.img].height/4,heroIcon:e[o.direction],posx:32*o.x-core.bigmap.offsetX+(o.stop?0:j[o.direction].x*g),posy:32*o.y-core.bigmap.offsetY+(o.stop?0:j[o.direction].y*g),status:o.stop?"stop":k,index:f++})}})}b.sort(function(o,p){return o.posy==p.posy?p.index-o.index:o.posy-p.posy});b.forEach(function(o){core.canvas.hero.drawImage(o.img,o.heroIcon[o.status]*32,o.heroIcon.loc*o.height,32,o.height,o.posx,o.posy+32-o.height,32,o.height)});core.control.updateViewport()};control.prototype.setHeroLoc=function(a,b,c){core.status.hero.loc[a]=b;if((a=="x"||a=="y")&&!c){this.gatherFollowers()}};control.prototype.getHeroLoc=function(a){if(!core.isset(a)){return core.status.hero.loc}return core.status.hero.loc[a]};control.prototype.nextX=function(a){var b={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};return core.getHeroLoc("x")+b[core.getHeroLoc("direction")].x*(a||1)};control.prototype.nextY=function(a){var b={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};return core.getHeroLoc("y")+b[core.getHeroLoc("direction")].y*(a||1)};control.prototype.gatherFollowers=function(){if(!core.isset(core.status.hero.followers)||core.status.hero.followers.length==0){return}var b=core.getHeroLoc("x"),c=core.getHeroLoc("y"),a=core.getHeroLoc("direction");core.status.hero.followers.forEach(function(d){d.x=b;d.y=c;d.stop=true;d.direction=a})};control.prototype.updateFollowers=function(){if(!core.isset(core.status.hero.followers)||core.status.hero.followers.length==0){return}var c={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};core.status.hero.followers.forEach(function(d){if(!d.stop){d.x+=c[d.direction].x;d.y+=c[d.direction].y}});var a=core.getHeroLoc("x"),b=core.getHeroLoc("y");core.status.hero.followers.forEach(function(f){if(f.x==a&&f.y==b){f.stop=true}else{var d=a-f.x,e=b-f.y;if(d==-1){f.stop=false;f.direction="left"}else{if(d==1){f.stop=false;f.direction="right"}else{if(e==-1){f.stop=false;f.direction="up"}else{if(e==1){f.stop=false;f.direction="down"}}}}}a=f.x;b=f.y})};control.prototype.updateCheckBlock=function(){return this.controldata.updateCheckBlock()};control.prototype.checkBlock=function(){var i=core.getHeroLoc("x"),j=core.getHeroLoc("y");var a=core.status.checkBlock.damage[i+core.bigmap.width*j];if(a>0){core.status.hero.hp-=a;var h=[];if(!core.hasFlag("no_snipe")){var g={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};for(var b in g){var e=i+g[b].x,f=j+g[b].y;if(e<0||e>=core.bigmap.width||f<0||f>=core.bigmap.height){continue}var d=core.status.checkBlock.map[e+core.bigmap.width*f];if(core.isset(d)){var c=core.material.enemys[d];if(core.isset(c)&&core.enemys.hasSpecial(c.special,18)){h.push({direction:b,x:e,y:f})}}}}if(core.status.checkBlock.betweenAttack[i+core.bigmap.width*j]&&a>0){core.drawTip("受到夹击，生命变成一半")}else{if(core.status.checkBlock.map[i+core.bigmap.width*j]=="lavaNet"){core.drawTip("受到血网伤害"+a+"点")}else{if(h.length>0&&a>0){core.drawTip("受到阻击伤害"+a+"点")}else{if(a>0){core.drawTip("受到领域或激光伤害"+a+"点")}}}}if(a>0){core.playSound("zone.mp3");core.drawAnimate("zone",i,j)}core.status.hero.statistics.extraDamage+=a;if(core.status.hero.hp<=0){core.status.hero.hp=0;core.updateStatusBar();core.events.lose();return}h=h.filter(function(n){var o=n.x,p=n.y,k=n.direction;var l=o+g[k].x,m=p+g[k].y;return l>=0&&l<core.bigmap.width&&m>=0&&m<core.bigmap.height&&core.getBlock(l,m,null,true)==null});core.updateStatusBar();if(h.length>0){core.snipe(h)}}};control.prototype.snipe=function(c){var b={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};c.forEach(function(j){var k=j.x,l=j.y,h=j.direction;j.nx=k+b[j.direction].x;j.ny=l+b[j.direction].y;core.removeGlobalAnimate(k,l);var d=core.getBlock(k,l).block;var e=d.event.cls;var i=d.event.height||32;j.animate=d.event.animate||1;j.blockIcon=core.material.icons[e][d.event.id];j.blockImage=core.material.images[e];j.height=i;var g=core.enemys.getDamage(d.event.id,k,l);var f="#000000";if(g==null){g="???";f="#FF0000"}else{if(g<=0){f="#00FF00"}else{if(g<core.status.hero.hp/3){f="#FFFFFF"}else{if(g<core.status.hero.hp*2/3){f="#FFFF00"}else{if(g<core.status.hero.hp){f="#FF7F00"}else{f="#FF0000"}}}}g=core.formatBigNumber(g)}j.damage=g;j.color=f;j.block=core.clone(d)});var a=function(){c.forEach(function(e){core.removeBlock(e.x,e.y);var d=core.clone(e.block);d.x=e.nx;d.y=e.ny;core.status.thisMap.blocks.push(d);core.drawBlock(d);core.addGlobalAnimate(d)});core.syncGlobalAnimate();core.updateStatusBar();return};if(core.status.replay.replaying){a()}else{core.waitHeroToStop(function(){core.lockControl();var h=500,g=0;var e=0;var f=0;core.canvas.damage.textAlign="left";var d=window.setInterval(function(){g++;f+=h/16;if(f>=core.values.animateSpeed){e++;f=0}c.forEach(function(n){var o=n.x,p=n.y,i=n.direction;var j=b[i].x*2*g,k=b[i].y*2*g;var l=32*o+j,m=32*p+k;core.clearMap("damage",l-2*b[i].x,m-2*b[i].y,32,32);core.canvas.event.clearRect(l-2*b[i].x,m-2*b[i].y,32,32);core.canvas.event2.clearRect(l-2*b[i].x,m-2*b[i].y-32,32,32);core.drawBlock(n.block,e,j,k);if(core.hasItem("book")){core.setFillStyle("damage","#000000");core.canvas.damage.fillText(n.damage,l+2,m+30);core.canvas.damage.fillText(n.damage,l,m+30);core.canvas.damage.fillText(n.damage,l+2,m+32);core.canvas.damage.fillText(n.damage,l,m+32);core.setFillStyle("damage",n.color);core.canvas.damage.fillText(n.damage,l+1,m+31)}});if(g==16){clearInterval(d);a();if(core.status.event.id==null){core.unLockControl()}}},h/16)})}};control.prototype.setWeather=function(d,c){if(d!="rain"&&d!="snow"){core.clearMap("weather");core.animateFrame.weather.type=null;core.animateFrame.weather.level=0;core.animateFrame.weather.nodes=[];return}c=parseInt(c);if(d==core.animateFrame.weather.type&&(!core.isset(c)||20*c==core.animateFrame.weather.level)){return}if(!core.isset(c)){c=5}if(c<1){c=1}if(c>10){c=10}c*=20;core.clearMap("weather");core.animateFrame.weather.type=d;core.animateFrame.weather.level=c;core.animateFrame.weather.nodes=[];if(d=="rain"){for(var b=0;b<c;b++){core.animateFrame.weather.nodes.push({x:Math.random()*416,y:Math.random()*416,l:Math.random()*2.5,xs:-4+Math.random()*4+2,ys:Math.random()*10+10})}}else{if(d=="snow"){for(var b=0;b<c;b++){core.animateFrame.weather.nodes.push({x:Math.random()*416,y:Math.random()*416,r:Math.random()*5+1,d:Math.random()*c,})}}}};control.prototype.setFg=function(c,f,a){if(!core.isset(f)){f=750}if(f<=0){f=0}if(!core.isset(core.status.curtainColor)){core.status.curtainColor=[0,0,0,0]}var d=core.status.curtainColor;if(!core.isset(c)){c=[0,0,0,0]}if(c.length==3){c.push(1)}if(c[3]<0){c[3]=0}if(c[3]>1){c[3]=1}if(f==0){core.clearMap("curtain");core.setAlpha("curtain",c[3]);core.fillRect("curtain",0,0,416,416,core.arrayToRGB(c));core.status.curtainColor=c;if(core.isset(a)){a()}return}var e=0;core.status.replay.animate=true;var b=setInterval(function(){e++;var g=d[3]+(c[3]-d[3])*e/25;var j=parseInt(d[0]+(c[0]-d[0])*e/25);var i=parseInt(d[1]+(c[1]-d[1])*e/25);var h=parseInt(d[2]+(c[2]-d[2])*e/25);core.clearMap("curtain");core.setAlpha("curtain",g);core.fillRect("curtain",0,0,416,416,core.arrayToRGB([j,i,h]));if(e>=25){clearInterval(b);core.status.curtainColor=c;core.status.replay.animate=false;if(core.isset(a)){a()}}},f/25/core.status.replay.speed)};control.prototype.updateDamage=function(h,c){if(!core.isset(h)){h=core.status.floorId}if(!core.isset(c)){c=core.canvas.damage;core.clearMap("damage")}var k=core.status.maps[h].blocks;if(!core.hasItem("book")){return}c.font="bold 11px Arial";var i=core.status.hero.hp;if(core.flags.displayEnemyDamage||core.flags.displayCritical){c.textAlign="left";for(var a=0;a<k.length;a++){var m=k[a].x,n=k[a].y;if(core.isset(k[a].event)&&k[a].event.cls.indexOf("enemy")==0&&!k[a].disable){if(k[a].event.trigger!="battle"){var g=core.floors[h].events[m+","+n];if(core.isset(g)&&!(g instanceof Array)){if(g.displayDamage===false){continue}}}var j=k[a].event.id;if(core.flags.displayEnemyDamage){var f=core.enemys.getDamage(j,m,n);var d="#000000";if(f==null){f="???";d="#FF0000"}else{if(f<=0){d="#00FF00"}else{if(f<i/3){d="#FFFFFF"}else{if(f<i*2/3){d="#FFFF00"}else{if(f<i){d="#FF7F00"}else{d="#FF0000"}}}}f=core.formatBigNumber(f);if(core.enemys.hasSpecial(core.material.enemys[j],19)){f+="+"}if(core.enemys.hasSpecial(core.material.enemys[j],21)){f+="-"}}c.fillStyle="#000000";c.fillText(f,32*m+2,32*(n+1)-2);c.fillText(f,32*m,32*(n+1)-2);c.fillText(f,32*m+2,32*(n+1));c.fillText(f,32*m,32*(n+1));c.fillStyle=d;c.fillText(f,32*m+1,32*(n+1)-1)}if(core.flags.displayCritical){var e=core.enemys.nextCriticals(j);if(e.length>0){e=e[0]}e=core.formatBigNumber(e[0]);if(e=="???"){e="?"}c.fillStyle="#000000";c.fillText(e,32*m+2,32*(n+1)-2-10);c.fillText(e,32*m,32*(n+1)-2-10);c.fillText(e,32*m+2,32*(n+1)-10);c.fillText(e,32*m,32*(n+1)-10);c.fillStyle="#FFFFFF";c.fillText(e,32*m+1,32*(n+1)-1-10)}}}}if(core.flags.displayExtraDamage){c.textAlign="center";var l=null;if(h!=core.status.floorId){l=core.clone(core.status.checkBlock);core.status.thisMap=core.status.maps[h];core.bigmap.width=core.floors[h].width||13;core.bigmap.height=core.floors[h].height||13;core.updateCheckBlock()}for(var m=0;m<core.bigmap.width;m++){for(var n=0;n<core.bigmap.height;n++){var f=core.status.checkBlock.damage[m+core.bigmap.width*n];if(f>0){f=core.formatBigNumber(f);c.fillStyle="#000000";c.fillText(f,32*m+17,32*(n+1)-13);c.fillText(f,32*m+15,32*(n+1)-15);c.fillText(f,32*m+17,32*(n+1)-15);c.fillText(f,32*m+15,32*(n+1)-13);c.fillStyle="#FF7F00";c.fillText(f,32*m+16,32*(n+1)-14)}}}if(h!=core.status.floorId){core.status.thisMap=core.status.maps[core.status.floorId];core.status.checkBlock=l;core.bigmap.width=core.floors[core.status.floorId].width||13;core.bigmap.height=core.floors[core.status.floorId].height||13}}};control.prototype.doEffect=function(a){a.split(";").forEach(function(c){var b=c.split("+=");if(b.length!=2){return}var e=b[0],g=core.calValue(b[1]);if(e.indexOf("status:")==0){var f=e.substring(7);core.setStatus(f,core.getStatus(f)+g)}else{if(e.indexOf("item:")==0){var d=e.substring(5);core.setItem(d,core.itemCount(d)+g)}}})};control.prototype.debug=function(){core.setFlag("debug",true);core.insertAction(["\t[调试模式开启]此模式下按住Ctrl键（或Ctrl+Shift键）可以穿墙并忽略一切事件。\n同时，录像将失效，也无法上传成绩。"])};control.prototype.startReplay=function(a){core.status.replay.replaying=true;core.status.replay.pausing=false;core.status.replay.speed=1;core.status.replay.toReplay=core.clone(a);core.status.replay.totalList=core.clone(a);core.status.replay.steps=0;core.status.replay.save=[];core.updateStatusBar();core.drawTip("开始播放");this.replay();return};control.prototype.triggerReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(core.status.replay.pausing){this.resumeReplay()}else{this.pauseReplay()}};control.prototype.pauseReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}core.status.replay.pausing=true;core.updateStatusBar();core.drawTip("暂停播放")};control.prototype.resumeReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}core.status.replay.pausing=false;core.updateStatusBar();core.drawTip("恢复播放");core.replay()};control.prototype.speedUpReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}if(core.status.replay.speed==12){core.status.replay.speed=24}else{if(core.status.replay.speed==6){core.status.replay.speed=12}else{if(core.status.replay.speed==3){core.status.replay.speed=6}else{if(core.status.replay.speed<3){var a=core.status.replay.speed>=2?2:1;core.status.replay.speed=parseInt(10*core.status.replay.speed+a)/10}}}}core.drawTip("x"+core.status.replay.speed+"倍")};control.prototype.speedDownReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}if(core.status.replay.speed==24){core.status.replay.speed=12}else{if(core.status.replay.speed==12){core.status.replay.speed=6}else{if(core.status.replay.speed==6){core.status.replay.speed=3}else{var a=core.status.replay.speed>=2?2:1;core.status.replay.speed=parseInt(10*core.status.replay.speed-a)/10}}}if(core.status.replay.speed<0.3){core.status.replay.speed=0.3}core.drawTip("x"+core.status.replay.speed+"倍")};control.prototype.setReplaySpeed=function(a){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}core.status.replay.speed=a;core.drawTip("x"+core.status.replay.speed+"倍")};control.prototype.stopReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}core.status.replay.toReplay=[];core.status.replay.totalList=[];core.status.replay.replaying=false;core.status.replay.pausing=false;core.status.replay.speed=1;core.status.replay.steps=0;core.status.replay.save=[];core.updateStatusBar();core.drawTip("停止播放并恢复游戏")};control.prototype.rewindReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}if(!core.status.replay.pausing){core.drawTip("请先暂停录像");return}if(core.status.replay.animate){core.drawTip("请等待当前事件的处理结束");return}if(core.status.replay.save.length==0){core.drawTip("无法再回到上一个节点");return}var b=core.status.replay.save;var a=b.pop();core.loadData(a.data,function(){core.status.replay={replaying:true,pausing:true,animate:false,toReplay:a.replay.toReplay,totalList:a.replay.totalList,speed:a.replay.speed,steps:a.replay.steps,save:b};core.updateStatusBar();core.drawTip("成功回退到上一个节点")})};control.prototype.saveReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}if(!core.status.replay.pausing){core.drawTip("请先暂停录像");return}if(core.status.replay.animate||core.isset(core.status.event.id)){core.drawTip("请等待当前事件的处理结束");return}core.lockControl();core.status.event.id="save";var c=core.status.saveIndex;var b=parseInt((c-1)/5),a=c-5*b;core.ui.drawSLPanel(10*b+a)};control.prototype.bookReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0){return}if(!core.status.replay.replaying){return}if(!core.status.replay.pausing){core.drawTip("请先暂停录像");return}if(core.status.event.id=="viewMaps"){core.status.event.selection=core.status.event.data;core.status.event.id=null}if(core.status.replay.animate||core.isset(core.status.event.id)){core.drawTip("请等待当前事件的处理结束");return}core.lockControl();core.status.event.id="book";core.useItem("book")};control.prototype.viewMapReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}if(!core.status.replay.pausing){core.drawTip("请先暂停录像");return}if(core.status.replay.animate||core.isset(core.status.event.id)){core.drawTip("请等待当前事件的处理结束");return}core.lockControl();core.status.event.id="viewMaps";core.ui.drawMaps()};control.prototype.replay=function(){if(!core.status.replay.replaying){return}if(core.status.replay.pausing){return}if(core.status.replay.animate){return}if(core.status.replay.toReplay.length==0){core.stopReplay();core.insertAction("录像回放完毕！");return}core.status.replay.steps++;if(core.status.replay.steps%50==0){core.status.replay.save.push({data:core.saveData(),replay:{totalList:core.clone(core.status.replay.totalList),toReplay:core.clone(core.status.replay.toReplay),speed:core.status.replay.speed,steps:core.status.replay.steps}})}var a=core.status.replay.toReplay.shift();if(a=="up"||a=="down"||a=="left"||a=="right"){core.moveHero(a,function(){setTimeout(function(){core.replay()})});return}else{if(a.indexOf("item:")==0){var h=a.substring(5);if(core.canUseItem(h)){var t=Object.keys(core.status.hero.items.tools).sort();var c=Object.keys(core.status.hero.items.constants).sort();var g=-1;if((g=t.indexOf(h))>=0){core.status.event.data={toolsPage:Math.floor(g/12)+1,constantsPage:1,selectId:null};g=g%12}else{if(g=c.indexOf(h)>=0){core.status.event.data={toolsPage:1,constantsPage:Math.floor(g/12)+1,selectId:null};g=g%12+12}}if(g>=0){core.ui.drawToolbox(g);setTimeout(function(){core.ui.closePanel();core.useItem(h,function(){core.replay()})},750/Math.max(1,core.status.replay.speed));return}}}else{if(a.indexOf("unEquip:")==0){var e=parseInt(a.substring(8));if(core.isset(e)){core.ui.drawEquipbox(e);core.status.route.push(a);setTimeout(function(){core.ui.closePanel();core.unloadEquip(e,function(){core.replay()})},750/Math.max(1,core.status.replay.speed));return}}else{if(a.indexOf("equip:")==0){var d=a.substring(6);var l=Object.keys(core.status.hero.items.equips).sort();var g=l.indexOf(d);if(g>=0){core.status.route.push(a);core.status.event.data={page:Math.floor(g/12)+1,selectId:null};g=g%12+12;core.ui.drawEquipbox(g);setTimeout(function(){core.ui.closePanel();core.loadEquip(d,function(){core.replay()})},750/Math.max(1,core.status.replay.speed));return}}else{if(a.indexOf("fly:")==0){var f=a.substring(4);var s=core.status.hero.flyRange.indexOf(f);var i=core.status.hero.flyRange.indexOf(core.status.floorId);if(core.hasItem("fly")&&s>=0&&i>=0){core.ui.drawFly(s);setTimeout(function(){if(!core.control.flyTo(f,function(){core.replay()})){core.stopReplay();core.insertAction("录像文件出错")}},750/Math.max(1,core.status.replay.speed));return}}else{if(a.indexOf("shop:")==0){var r=a.substring(5).split(":");var p=r[0],n=r[1].split("");if(n.length>0){var o=core.status.shops[p];if(core.isset(o)&&o.visited){var b=o.choices;var u=6-parseInt(b.length/2);core.status.event.selection=parseInt(n.shift());core.events.openShop(p,false);var q=setInterval(function(){if(!core.actions.clickShop(6,u+core.status.event.selection)){clearInterval(q);core.stopReplay();core.drawTip("录像文件出错");return}if(n.length==0){clearInterval(q);core.actions.clickShop(6,u+b.length);core.replay();return}core.status.event.selection=parseInt(n.shift());core.events.openShop(p,false)},750/Math.max(1,core.status.replay.speed));return}}}else{if(a=="turn"){core.turnHero();core.replay();return}else{if(a.indexOf("turn:")==0){core.turnHero(a.substring(5));core.replay();return}else{if(a=="getNext"){if(core.getNextItem()){core.replay();return}}else{if(a.indexOf("move:")==0){while(core.status.replay.toReplay.length>0&&core.status.replay.toReplay[0].indexOf("move:")==0){a=core.status.replay.toReplay.shift()}var m=a.substring(5).split(":");var v=parseInt(m[0]),w=parseInt(m[1]);var j=core.getHeroLoc("x"),k=core.getHeroLoc("y");if(core.control.moveDirectly(v,w)){core.ui.drawArrow("route",32*j+16,32*k+16,32*v+16,32*w+16,"#FF0000",3);setTimeout(function(){core.clearMap("route");core.replay()},750/Math.max(1,core.status.replay.speed));return}}else{if(a.indexOf("key:")==0){core.actions.keyUp(parseInt(a.substring(4)),true);core.replay();return}}}}}}}}}}}core.stopReplay();core.insertAction("录像文件出错")};control.prototype.checkStatus=function(b,c,a){if(c&&core.status.event.id==b){core.ui.closePanel();return false}if(c&&core.status.lockControl){return false}if(core.isset(a)&&a&&!core.hasItem(b)){core.drawTip("你没有"+core.material.items[b].name);return false}if(!core.status.heroStop){core.drawTip("请先停止勇士行动");return false}core.lockControl();core.status.event.id=b;return true};control.prototype.openBook=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(core.status.event.id=="book"&&core.isset(core.status.event.selection)){core.status.boxAnimateObjs=[];core.ui.drawMaps(core.status.event.selection);return}if(core.status.event.id=="viewMaps"){a=false;core.status.event.selection=core.status.event.data}if(!core.checkStatus("book",a,true)){return}core.useItem("book")};control.prototype.useFly=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("fly",a,true)){return}if(core.flags.flyNearStair&&!core.nearStair()){core.drawTip("只有在楼梯边才能使用传送器");core.unLockControl();core.status.event.data=null;core.status.event.id=null;return}if(!core.canUseItem("fly")){core.drawTip("楼层传送器好像失效了");core.unLockControl();core.status.event.data=null;core.status.event.id=null;return}core.useItem("fly");return};control.prototype.flyTo=function(b,a){return this.controldata.flyTo(b,a)};control.prototype.openEquipbox=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("equipbox",a)){return}core.ui.drawEquipbox()};control.prototype.openToolbox=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("toolbox",a)){return}core.ui.drawToolbox()};control.prototype.openQuickShop=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("selectShop",a)){return}core.ui.drawQuickShop()};control.prototype.save=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("save",a)){return}var d=core.status.saveIndex;var c=parseInt((d-1)/5),b=d-5*c;core.ui.drawSLPanel(10*c+b)};control.prototype.load=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}var d=core.getLocalStorage("saveIndex2",1);var c=parseInt((d-1)/5),b=d-5*c;if(!core.isPlaying()){core.status.event={id:"load",data:null};core.status.lockControl=true;core.dom.startPanel.style.display="none";core.ui.drawSLPanel(10*c+b);return}if(!core.checkStatus("load",a)){return}core.ui.drawSLPanel(10*c+b)};control.prototype.openSettings=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("settings",a)){return}core.ui.drawSettings()};control.prototype.autosave=function(a){if(core.status.event.id!=null){return}var b=null;if(a){b=core.status.route.pop()}core.status.route.push("turn:"+core.getHeroLoc("direction"));core.setLocalForage("autoSave",core.saveData());core.status.route.pop();if(a&&core.isset(b)){core.status.route.push(b)}};control.prototype.doSL=function(a,b){if(b=="save"){if(a=="autoSave"){core.drawTip("不能覆盖自动存档！");return}core.setLocalForage("save"+a,core.saveData(),function(){core.ui.closePanel();core.drawTip("存档成功！");if(a!="autoSave"){core.status.saveIndex=a;core.setLocalStorage("saveIndex2",core.status.saveIndex)}},function(c){console.info(c);core.drawTip("存档失败，请将控制台的报错信息反馈给管理员。")});return}else{if(b=="load"){core.getLocalForage(a=="autoSave"?a:"save"+a,null,function(c){if(!core.isset(c)){core.drawTip("无效的存档");return}if(c.version!=core.firstData.version){if(confirm("存档版本不匹配！\n你想回放此存档的录像吗？\n可以随时停止录像播放以继续游戏。")){core.dom.startPanel.style.display="none";var d=c.hero.flags.seed;core.resetStatus(core.firstData.hero,c.hard,core.firstData.floorId,null,core.initStatus.maps);core.events.setInitData(c.hard);core.setFlag("seed",d);core.setFlag("rand",d);core.changeFloor(core.status.floorId,null,core.firstData.hero.loc,null,function(){core.startReplay(core.decodeRoute(c.route))},true)}return}core.ui.closePanel();core.loadData(c,function(){core.drawTip("读档成功");if(a!="autoSave"){core.status.saveIndex=a;core.setLocalStorage("saveIndex2",core.status.saveIndex)}})},function(c){console.log(c);core.drawTip("无效的存档")});return}else{if(b=="replayLoad"){core.getLocalForage(a=="autoSave"?a:"save"+a,null,function(c){if(!core.isset(c)){core.drawTip("无效的存档");return}if(c.version!=core.firstData.version){core.drawTip("存档版本不匹配");return}if(c.hard!=core.status.hard){core.drawTip("游戏难度不匹配！");return}var d=core.subarray(core.status.route,core.decodeRoute(c.route));if(!core.isset(d)||c.hero.flags.seed!=core.getFlag("seed")){core.drawTip("无法从此存档回放录像");return}core.loadData(c,function(){core.startReplay(d);core.drawTip("回退到存档节点")})},function(c){console.log(c);core.drawTip("无效的存档")})}}}};control.prototype.syncSave=function(a){core.ui.drawWaiting("正在同步，请稍后...");core.control.getSaves(a=="all"?null:core.status.saveIndex,function(d){if(!core.isset(d)){core.drawText("没有要同步的存档");return}var b=new FormData();b.append("type","save");b.append("name",core.firstData.name);var c=JSON.stringify(d);b.append("data",c);core.http("POST","/games/sync.php",b,function(e){var f=JSON.parse(e);if(f.code<0){core.drawText("出错啦！\n无法同步存档到服务器。\n错误原因："+f.msg)}else{core.drawText((a=="all"?"所有存档":"存档"+core.status.saveIndex)+"同步成功！\n\n您的存档编号： "+f.code+"\n您的存档密码： "+f.msg+"\n\n请牢记以上两个信息（如截图等），在从服务器\n同步存档时使用。")}},function(f){core.drawText("出错啦！\n无法同步存档到服务器。\n错误原因："+f)})})};control.prototype.syncLoad=function(){core.interval.onDownInterval="tmp";var b=prompt("请输入存档编号：");if(b==null||b==""){core.ui.drawSyncSave();return}core.interval.onDownInterval="tmp";var c=prompt("请输入存档密码：");if(c==null||c==""){core.ui.drawSyncSave();return}core.ui.drawWaiting("正在同步，请稍后...");var a=new FormData();a.append("type","load");a.append("name",core.firstData.name);a.append("id",b);a.append("password",c);core.http("POST","/games/sync.php",a,function(d){var e=JSON.parse(d);switch(e.code){case 0:var d=JSON.parse(e.msg);if(d instanceof Array){core.status.event.selection=1;core.ui.drawConfirmBox("所有本地存档都将被覆盖，确认？",function(){for(var f=1;f<=5*(main.savePages||30);f++){if(f<=d.length){core.setLocalForage("save"+f,d[f-1])}else{core.removeLocalForage("save"+f)}}core.drawText("同步成功！\n你的本地所有存档均已被覆盖。")},function(){core.status.event.selection=0;core.ui.drawSyncSave()})}else{core.setLocalForage("save"+core.status.saveIndex,d,function(){core.drawText("同步成功！\n单存档已覆盖至存档"+core.status.saveIndex)})}break;case -1:core.drawText("出错啦！\n存档编号"+b+"不存在！");break;case -2:core.drawText("出错啦！\n存档密码错误！");break;default:core.drawText("出错啦！\n无法从服务器同步存档。\n错误原因："+e.msg);break}},function(d){core.drawText("出错啦！\n无法从服务器同步存档。\n错误原因："+d)})};control.prototype.saveData=function(){var a={floorId:core.status.floorId,hero:core.clone(core.status.hero),hard:core.status.hard,maps:core.maps.save(core.status.maps),route:core.encodeRoute(core.status.route),values:core.clone(core.values),shops:{},version:core.firstData.version,time:new Date().getTime()};for(var b in core.status.shops){a.shops[b]={times:core.status.shops[b].times||0,visited:core.status.shops[b].visited||false}}core.events.beforeSaveData(a);return a};control.prototype.loadData=function(b,a){core.resetStatus(b.hero,b.hard,b.floorId,core.decodeRoute(b.route),core.maps.load(b.maps),b.values);for(var d in core.status.shops){if(core.isset(b.shops[d])){core.status.shops[d].times=b.shops[d].times;core.status.shops[d].visited=b.shops[d].visited}}core.status.textAttribute=core.getFlag("textAttribute",core.status.textAttribute);var c=core.getFlag("heroIcon","hero.png");if(core.isset(core.material.images.images[c])){core.material.images.hero.src=core.material.images.images[c].src;core.material.icons.hero.height=core.material.images.images[c].height/4}core.events.afterLoadData(b);core.changeFloor(b.floorId,null,b.hero.loc,0,function(){if(core.isset(a)){a()}},true)};control.prototype.getSaves=function(b,a){if(core.isset(b)){core.getLocalForage("save"+b,null,function(f){if(core.isset(a)){a(f)}},function(f){console.log(f);if(core.isset(a)){a(null)}});return}var d=5*(main.savePages||30);var e=[];var c=function(g,f){if(g>d){if(core.isset(f)){f(e)}return}core.getLocalForage("save"+g,null,function(h){e.push(h);c(g+1,f)},function(h){console.log(h);c(g+1,f)})};c(1,a)};control.prototype.setStatus=function(a,b){if(a=="exp"){a="experience"}if(core.isset(core.status.hero.loc[a])){core.status.hero.loc[a]=b}else{core.status.hero[a]=b}};control.prototype.getStatus=function(a){if(core.isset(core.status.hero.loc[a])){return core.status.hero.loc[a]}if(a=="exp"){a="experience"}return core.status.hero[a]};control.prototype.getLvName=function(){return((core.firstData.levelUp||[])[core.status.hero.lv-1]||{}).name||core.status.hero.lv};control.prototype.setFlag=function(a,b){if(!core.isset(core.status.hero)){return}core.status.hero.flags[a]=b};control.prototype.getFlag=function(b,a){if(!core.isset(core.status.hero)){return a}var c=core.status.hero.flags[b];if(core.isset(c)){return c}return a};control.prototype.hasFlag=function(a){if(core.getFlag(a)){return true}return false};control.prototype.lockControl=function(){core.status.lockControl=true};control.prototype.unLockControl=function(){core.status.lockControl=false};control.prototype.playBgm=function(a){if(main.mode!="play"){return}if(!core.musicStatus.bgmStatus){return}if(!core.isset(core.material.bgms[a])){return}if(core.material.bgms[a]=="loading"){core.material.bgms[a]="starting";return}try{if(core.musicStatus.playingBgm==a&&core.musicStatus.isPlaying){return}if(core.isset(core.musicStatus.playingBgm)&&core.musicStatus.isPlaying){core.material.bgms[core.musicStatus.playingBgm].pause()}core.material.bgms[a].volume=core.musicStatus.volume;core.material.bgms[a].currentTime=0;core.material.bgms[a].play();core.musicStatus.playingBgm=a;core.musicStatus.isPlaying=true}catch(b){console.log("无法播放BGM "+a);console.log(b);core.musicStatus.playingBgm=null}};control.prototype.pauseBgm=function(){try{if(core.isset(core.musicStatus.playingBgm)){core.material.bgms[core.musicStatus.playingBgm].pause()}core.musicStatus.isPlaying=false}catch(a){console.log("无法暂停BGM "+bgm);console.log(a)}};control.prototype.resumeBgm=function(){if(main.mode!="play"){return}if(!core.musicStatus.bgmStatus){return}try{if(core.isset(core.musicStatus.playingBgm)){core.material.bgms[core.musicStatus.playingBgm].play();core.musicStatus.isPlaying=true}else{if(core.bgms.length>0){if(core.isset(core.status.thisMap.bgm)){core.playBgm(core.status.thisMap.bgm)}else{core.playBgm(core.bgms[0])}}}}catch(a){console.log("无法恢复BGM "+bgm);console.log(a)}};control.prototype.playSound=function(d){if(main.mode!="play"){return}if(!core.musicStatus.soundStatus){return}if(!core.isset(core.material.sounds[d])){return}try{if(core.musicStatus.audioContext!=null){var f=core.musicStatus.audioContext.createBufferSource();f.buffer=core.material.sounds[d];f.connect(core.musicStatus.gainNode);try{f.start(0)}catch(a){try{f.noteOn(0)}catch(b){}}}else{core.material.sounds[d].volume=core.musicStatus.volume;core.material.sounds[d].play()}}catch(c){console.log("无法播放SE "+d);console.log(c)}};control.prototype.clearStatusBar=function(){Object.keys(core.statusBar).forEach(function(a){if(core.isset(core.statusBar[a].innerHTML)){core.statusBar[a].innerHTML="&nbsp;"}});core.statusBar.image.book.style.opacity=0.3;if(!core.flags.equipboxButton){core.statusBar.image.fly.style.opacity=0.3}};control.prototype.updateStatusBar=function(){this.controldata.updateStatusBar();if(core.status.replay.replaying){core.statusBar.image.book.src=core.status.replay.pausing?core.statusBar.icons.play.src:core.statusBar.icons.pause.src;core.statusBar.image.book.style.opacity=1;core.statusBar.image.fly.src=core.statusBar.icons.stop.src;core.statusBar.image.fly.style.opacity=1;core.statusBar.image.toolbox.src=core.statusBar.icons.rewind.src;core.statusBar.image.shop.src=core.statusBar.icons.book.src;core.statusBar.image.save.src=core.statusBar.icons.speedDown.src;core.statusBar.image.load.src=core.statusBar.icons.speedUp.src;core.statusBar.image.settings.src=core.statusBar.icons.save.src}else{core.statusBar.image.book.src=core.statusBar.icons.book.src;core.statusBar.image.book.style.opacity=core.hasItem("book")?1:0.3;if(!core.flags.equipboxButton){core.statusBar.image.fly.src=core.statusBar.icons.fly.src;core.statusBar.image.fly.style.opacity=core.hasItem("fly")?1:0.3}else{core.statusBar.image.fly.src=core.statusBar.icons.equipbox.src;core.statusBar.image.fly.style.opacity=1}core.statusBar.image.toolbox.src=core.statusBar.icons.toolbox.src;core.statusBar.image.shop.src=core.statusBar.icons.shop.src;core.statusBar.image.save.src=core.statusBar.icons.save.src;core.statusBar.image.load.src=core.statusBar.icons.load.src;core.statusBar.image.settings.src=core.statusBar.icons.settings.src}};control.prototype.updateHeroIcon=function(f){f=f||"hero.png";if(core.statusBar.icons.name==f){return}core.statusBar.icons.name=f;var d=core.material.images.hero;var c=core.material.icons.hero.height;var g=32/c,h=32*g,e=16-h/2;var a=document.createElement("canvas");var b=a.getContext("2d");a.width=32;a.height=32;b.drawImage(d,0,0,32,c,e,0,h,32);core.statusBar.image.name.src=a.toDataURL("image/png")};control.prototype.resize=function(j,i){if(main.mode=="editor"){return}var n=422;var m=132;var c=32;var w=3;var o=16;var a=n;var h=n+m;var V=j;var s=false;if(j>i&&i<a){s=true;V=i}var r,q,e,g,f,A,z,y,G,B,F,C,O,M,N,K,T,Q,R,S,p,L,t,x,P;var l=core.dom.statusBar.children.length;if(!core.flags.enableFloor){l--}if(!core.flags.enableLv){l--}if(!core.flags.enableHPMax){l--}if(!core.flags.enableMDef){l--}if(!core.flags.enableMoney){l--}if(!core.flags.enableExperience){l--}if(!core.flags.enableLevelUp){l--}if(!core.flags.enableDebuff){l--}if(!core.flags.enableKeys){l--}if(!core.flags.enablePZF){l--}if(!core.flags.enableName){l--}var E=c*9/l;var D=o;if(l>9){D=D*9/l}var v;var d=main.borderColor||"white";y="3px "+d+" solid";K="3px "+d+" solid";var W=(a-V)/4.22;var b=1-W/100;if(V<h){if(V<a){core.domStyle.scale=b;g=V}else{g=n;core.domStyle.scale=1}var u=core.domStyle.scale;var J=n*u;if(!s){core.domStyle.screenMode="vertical";v="block";var k=parseInt((l-1)/3)+1;var I=u*(c*k+w*2)+6;var H=u*(c+w*4)+6;q=J+I+H;r=J;f=I;O=A=g;z=I;y="3px "+d+" solid";B=u*c*0.8;C=0.8*c*u;F=u*m*0.95;x=main.statusTopBackground;M=H;N=z+g;K="3px "+d+" solid";Q=u*c;S=u*m*0.4;P=main.toolsBackground;e="3px "+d+" solid";t=u*w*2;R=u*w*4;p=o*u;L=o*u}else{core.domStyle.screenMode="horizontal";v="none";r=J+m*u;q=J;f=0;O=A=m*u;z=q-w;y="3px "+d+" solid";x=main.statusLeftBackground;B=u*E*0.8;C=0.8*E*u;N=u*E*l+w*2;M=g-N;K="3px "+d+" solid";Q=u*c;P="transparent";p=D*u;L=o*u;e="";F=u*m;S=u*m;t=u*w*2;R=2*w*u}}else{core.domStyle.scale=1;core.domStyle.screenMode="bigScreen";v="none";r=n+m;q=n;g=n;f=0;O=A=m;x=main.statusLeftBackground;z=q-w;B=E*0.8;C=0.8*E;N=E*l+w*2;M=n-N;P="transparent";Q=c;e="";p=D;L=o;F=m;S=m*0.9;t=w*2;R=2*w}var U="px";core.domStyle.styles=[{id:"gameGroup",rules:{width:r+U,height:q+U,top:(i-q)/2+U,left:(j-r)/2+U,}},{className:"gameCanvas",rules:{width:(g-w*2)+U,height:(g-w*2)+U,}},{id:"gif",rules:{width:(g-w*2)+U,height:(g-w*2)+U,}},{id:"gif2",rules:{width:(g-w*2)+U,height:(g-w*2)+U,}},{id:"gameDraw",rules:{width:(g-w*2)+U,height:(g-w*2)+U,top:f+U,right:0,border:y}},{id:"floorMsgGroup",rules:{width:(g-w*2)+U,height:(q-w*2)+U,top:w+U,right:w+U,}},{id:"statusBar",rules:{width:A+U,height:z+U,top:0,left:0,padding:w+U,borderTop:y,borderLeft:y,borderRight:e,fontSize:p+U,background:x,}},{className:"status",rules:{width:"100%",maxWidth:F+U,height:B+U,margin:t/2+U}},{className:"statusLabels",rules:{marginLeft:t+U,lineHeight:C+U,}},{id:"toolBar",rules:{width:O+U,height:M+U,top:N+U,left:0,padding:w+U,borderBottom:K,borderLeft:K,borderRight:e,fontSize:L+U,background:P,}},{className:"tools",rules:{height:Q+U,maxWidth:S+U,marginLeft:R+U,marginTop:t+U,}},{imgId:"shop",rules:{display:v}},{id:"floorCol",rules:{display:core.flags.enableFloor?"block":"none"}},{id:"nameCol",rules:{display:core.flags.enableName?"block":"none"}},{id:"lvCol",rules:{display:core.flags.enableLv?"block":"none"}},{id:"hpmaxCol",rules:{display:core.flags.enableHPMax?"block":"none"}},{id:"mdefCol",rules:{display:core.flags.enableMDef?"block":"none"}},{id:"moneyCol",rules:{display:core.flags.enableMoney?"block":"none"}},{id:"expCol",rules:{display:core.flags.enableExperience?"block":"none"}},{id:"upCol",rules:{display:core.flags.enableLevelUp?"block":"none"}},{id:"keyCol",rules:{display:!core.isset(core.flags.enableKeys)||core.flags.enableKeys?"block":"none"}},{id:"pzfCol",rules:{display:core.flags.enablePZF?"block":"none"}},{id:"debuffCol",rules:{display:core.flags.enableDebuff?"block":"none"}},{id:"hard",rules:{lineHeight:Q+U}}];core.domRenderer()};control.prototype.domRenderer=function(){core.dom.statusBar.style.display="block";core.dom.toolBar.style.display="block";var l=core.domStyle.styles;for(var b=0;b<l.length;b++){if(l[b].hasOwnProperty("rules")){var g=l[b].rules;var h=Object.keys(g);if(l[b].hasOwnProperty("className")){var a=l[b].className;for(var e=0;e<core.dom[a].length;e++){for(var f=0;f<h.length;f++){core.dom[a][e].style[h[f]]=g[h[f]]}}}if(l[b].hasOwnProperty("id")){var c=l[b].id;for(var e=0;e<h.length;e++){core.dom[c].style[h[e]]=g[h[e]]}}if(l[b].hasOwnProperty("imgId")){var d=l[b].imgId;for(var e=0;e<h.length;e++){core.statusBar.image[d].style[h[e]]=g[h[e]]}}}}if(core.isPlaying()&&core.isset(core.status)&&core.isset(core.bigmap)){core.bigmap.canvas.forEach(function(i){core.canvas[i].canvas.style.width=core.bigmap.width*32*core.domStyle.scale+"px";core.canvas[i].canvas.style.height=core.bigmap.height*32*core.domStyle.scale+"px"})}};function utils(){}utils.prototype.init=function(){};utils.prototype.replaceText=function(a){return a.replace(/\${([^}]+)}/g,function(c,b){return core.calValue(b)})};utils.prototype.calValue=function(value){if(typeof value=="number"){return value}if(value instanceof Function){return value()}value=value.replace(/status:([\w\d_]+)/g,"core.getStatus('$1')");value=value.replace(/item:([\w\d_]+)/g,"core.itemCount('$1')");value=value.replace(/flag:([\w\d_]+)/g,"core.getFlag('$1', 0)");return eval(value)};utils.prototype.splitLines=function(a,g,f,c){if(core.isset(c)){core.setFont(a,c)}var b=[];var e=0;for(var d=0;d<g.length;d++){if(g.charAt(d)=="\n"){b.push(g.substring(e,d));e=d+1}else{if(g.charAt(d)=="\\"&&g.charAt(d+1)=="n"){b.push(g.substring(e,d));e=d+2}else{var h=g.substring(e,d+1);var j=core.canvas[a].measureText(h).width;if(j>f){b.push(g.substring(e,d));e=d}}}}b.push(g.substring(e));return b};utils.prototype.unshift=function(c,d){if(!(c instanceof Array)||!core.isset(d)){return}if(d instanceof Array){core.clone(d).reverse().forEach(function(a){c.unshift(a)})}else{c.unshift(d)}return c};utils.prototype.setLocalStorage=function(c,f){try{var d=JSON.stringify(f);var a=LZString.compress(d);localStorage.setItem("__tmp__",a);if(LZString.decompress(localStorage.getItem("__tmp__"))==d){localStorage.setItem(core.firstData.name+"_"+c,a)}else{localStorage.setItem(core.firstData.name+"_"+c,d)}localStorage.removeItem("__tmp__");return true}catch(b){console.log(b);return false}};utils.prototype.getLocalStorage=function(d,a){try{var g=localStorage.getItem(core.firstData.name+"_"+d);if(core.isset(g)){var f=LZString.decompress(g);if(core.isset(f)&&f.length>0){try{return JSON.parse(f)}catch(c){}}return JSON.parse(g)}return a}catch(b){console.log(b);return a}};utils.prototype.removeLocalStorage=function(a){localStorage.removeItem(core.firstData.name+"_"+a)};utils.prototype.setLocalForage=function(c,e,d,b){if(!core.platform.useLocalForage){this.setLocalStorage(c,e);if(core.isset(d)){d()}return}var a=LZString.compress(JSON.stringify(e));localforage.setItem(core.firstData.name+"_"+c,a,function(f){if(core.isset(f)){if(core.isset(b)){b(f)}}else{if(core.isset(d)){d()}}})};utils.prototype.getLocalForage=function(c,a,d,b){if(!core.platform.useLocalForage){var e=this.getLocalStorage(c,a);if(core.isset(d)){d(e)}return}localforage.getItem(core.firstData.name+"_"+c,function(g,i){if(core.isset(g)){if(core.isset(b)){b(g)}}else{if(core.isset(i)){var h=LZString.decompress(i);if(core.isset(h)&&h.length>0){try{if(core.isset(d)){d(JSON.parse(h))}return}catch(f){console.log(f)}}if(core.isset(d)){d(JSON.parse(i))}return}if(core.isset(d)){d(a)}}})};utils.prototype.removeLocalForage=function(b,c,a){if(!core.platform.useLocalForage){this.removeLocalStorage(b);if(core.isset(c)){c()}return}localforage.removeItem(core.firstData.name+"_"+b,function(d){if(core.isset(d)){if(core.isset(a)){a(d)}}else{if(core.isset(c)){c()}}})};utils.prototype.clone=function(b){if(!core.isset(b)){return b}if(b instanceof Date){var a=new Date();a.setTime(b.getTime());return a}if(b instanceof Array){var a=[];for(var c in b){a[c]=core.clone(b[c])}return a}if(b instanceof Function){return b}if(b instanceof Object){var a={};for(var c in b){if(b.hasOwnProperty(c)){a[c]=core.clone(b[c])}}return a}return b};utils.prototype.cropImage=function(e,g){g=g||32;var b=document.createElement("canvas");var c=b.getContext("2d");b.width=g;b.height=g;var a=[];for(var d=0;d<e.height;d+=g){c.drawImage(e,0,d,g,g,0,0,g,g);var f=new Image();f.src=b.toDataURL("image/png");a.push(f);c.clearRect(0,0,g,g)}return a};utils.prototype.formatDate=function(a){if(!core.isset(a)){return""}return a.getFullYear()+"-"+core.setTwoDigits(a.getMonth()+1)+"-"+core.setTwoDigits(a.getDate())+" "+core.setTwoDigits(a.getHours())+":"+core.setTwoDigits(a.getMinutes())+":"+core.setTwoDigits(a.getSeconds())};utils.prototype.formatDate2=function(a){if(!core.isset(a)){return""}return a.getFullYear()+core.setTwoDigits(a.getMonth()+1)+core.setTwoDigits(a.getDate())+core.setTwoDigits(a.getHours())+core.setTwoDigits(a.getMinutes())+core.setTwoDigits(a.getSeconds())};utils.prototype.setTwoDigits=function(a){return parseInt(a)<10?"0"+a:a};utils.prototype.formatBigNumber=function(g){g=Math.floor(parseFloat(g));if(!core.isset(g)){return"???"}var b=g<0?"-":"";g=Math.abs(g);if(g<=999999){return b+g}var a=[{val:1e+20,c:"g"},{val:1e+16,c:"j"},{val:1000000000000,c:"z"},{val:100000000,c:"e"},{val:10000,c:"w"},];for(var d=0;d<a.length;d++){var e=a[d];if(g>=10*e.val){var f=g/e.val;return b+f.toFixed(Math.max(0,Math.floor(4-Math.log10(f+1))))+e.c}}return b+g};utils.prototype.arrayToRGB=function(a){var d=parseInt(a[0])||0,c=parseInt(a[1])||0,b=parseInt(a[2])||0;if(d<0){d=0}if(b<0){b=0}if(c<0){c=0}if(d>255){d=255}if(b>255){b=255}if(c>255){c=255}return"#"+((1<<24)+(d<<16)+(c<<8)+b).toString(16).slice(1)};utils.prototype.encodeRoute=function(d){var a="";var c="",b=0;d.forEach(function(e){if(e=="up"||e=="down"||e=="left"||e=="right"){if(e!=c&&b>0){a+=c.substring(0,1).toUpperCase();if(b>1){a+=b}b=0}c=e;b++}else{if(b>0){a+=c.substring(0,1).toUpperCase();if(b>1){a+=b}b=0}if(e.indexOf("item:")==0){a+="I"+e.substring(5)+":"}else{if(e.indexOf("unEquip:")==0){a+="u"+e.substring(8)}else{if(e.indexOf("equip:")==0){a+="e"+e.substring(6)+":"}else{if(e.indexOf("fly:")==0){a+="F"+e.substring(4)+":"}else{if(e.indexOf("choices:")==0){a+="C"+e.substring(8)}else{if(e.indexOf("shop:")==0){a+="S"+e.substring(5)}else{if(e=="turn"){a+="T"}else{if(e.indexOf("turn:")==0){a+="t"+e.substring(5).substring(0,1).toUpperCase()+":"}else{if(e=="getNext"){a+="G"}else{if(e.indexOf("input:")==0){a+="P"+e.substring(6)}else{if(e.indexOf("input2:")==0){a+="Q"+e.substring(7)+":"}else{if(e=="no"){a+="N"}else{if(e.indexOf("move:")==0){a+="M"+e.substring(5)}else{if(e.indexOf("key:")==0){a+="K"+e.substring(4)}else{if(e.indexOf("random:")==0){a+="X"+e.substring(7)}}}}}}}}}}}}}}}}});if(b>0){a+=c.substring(0,1).toUpperCase();if(b>1){a+=b}}return a};utils.prototype.decodeRoute=function(k){if(!core.isset(k)){return k}var a=[],g=0;var d=function(c){var i="";while(g<k.length&&!isNaN(k.charAt(g))){i+=k.charAt(g++)}if(i.length==0){i="1"}return core.isset(c)?i:parseInt(i)};var e=function(){var c="";while(g<k.length&&k.charAt(g)!=":"){c+=k.charAt(g++)}g++;return c};while(g<k.length){var b=k.charAt(g++);var j=(b=="I"||b=="e"||b=="F"||b=="S"||b=="Q"||b=="t")?e():d();var h={U:"up",D:"down",L:"left",R:"right"};switch(b){case"U":case"D":case"L":case"R":for(var f=0;f<j;f++){a.push(h[b])}break;case"I":a.push("item:"+j);break;case"u":a.push("unEquip:"+j);break;case"e":a.push("equip:"+j);break;case"F":a.push("fly:"+j);break;case"C":a.push("choices:"+j);break;case"S":a.push("shop:"+j+":"+d(true));break;case"T":a.push("turn");break;case"t":a.push("turn:"+h[j]);break;case"G":a.push("getNext");break;case"P":a.push("input:"+j);break;case"Q":a.push("input2:"+j);break;case"N":a.push("no");break;case"M":++g;a.push("move:"+j+":"+d());break;case"K":a.push("key:"+j);break;case"X":a.push("random:"+j);break}}return a};utils.prototype.isset=function(a){if(a==undefined||a==null||(typeof a=="number"&&isNaN(a))){return false}return true};utils.prototype.subarray=function(c,d){if(!core.isset(c)||!core.isset(d)||!(c instanceof Array)||!(d instanceof Array)||c.length<d.length){return null}var e=core.clone(c),f=core.clone(d);while(f.length>0){if(e.shift()!=f.shift()){return null}}return e};utils.prototype.clamp=function(g,c,d){var f=Math.min(c,d),e=Math.max(c,d);return Math.min(Math.max(g||0,f),e)};utils.prototype.encodeBase64=function(a){return btoa(encodeURIComponent(a).replace(/%([0-9A-F]{2})/g,function(b,c){return String.fromCharCode(parseInt(c,16))}))};utils.prototype.decodeBase64=function(a){return decodeURIComponent(atob(a).split("").map(function(b){return"%"+("00"+b.charCodeAt(0).toString(16)).slice(-2)}).join(""))};utils.prototype.__init_seed=function(){var a=new Date().getTime()%34834795+3534;a=this.__next_rand(a);a=this.__next_rand(a);a=this.__next_rand(a);core.setFlag("seed",a);core.setFlag("rand",a)};utils.prototype.__next_rand=function(a){a=(a%127773)*16807-~~(a/127773)*2836;a+=a<0?2147483647:0;return a};utils.prototype.rand=function(b){var c=core.getFlag("rand");c=this.__next_rand(c);core.setFlag("rand",c);var a=c/2147483647;if(core.isset(b)&&b>0){return Math.floor(a*b)}return a};utils.prototype.rand2=function(b){b=b||2147483648;var c;if(core.status.replay.replaying){var a=core.status.replay.toReplay.shift();if(a.indexOf("random:")==0){c=parseInt(a.substring(7))}else{core.stopReplay();core.drawTip("录像文件出错");return}}else{c=Math.floor(Math.random()*b)}core.status.route.push("random:"+c);return c};utils.prototype.readFile=function(c,a,b){core.platform.successCallback=c;core.platform.errorCallback=a;if(core.isset(window.jsinterface)){window.jsinterface.readFile();return}if(!core.platform.isOnline){alert("离线状态下不支持文件读取！");if(core.isset(a)){a()}return}if(core.platform.fileReader==null){alert("当前浏览器不支持FileReader！");if(core.isset(a)){a()}return}if(core.platform.fileInput==null){core.platform.fileInput=document.createElement("input");core.platform.fileInput.style.opacity=0;core.platform.fileInput.type="file";core.platform.fileInput.onchange=function(){var d=core.platform.fileInput.files;if(d.length==0){if(core.isset(core.platform.errorCallback)){core.platform.errorCallback()}return}if(!b){core.platform.fileReader.readAsText(core.platform.fileInput.files[0])}else{core.platform.fileReader.readAsDataURL(core.platform.fileInput.files[0])}core.platform.fileInput.value=""}}core.platform.fileInput.click()};utils.prototype.readFileContent=function(a){var c=null;if(a.slice(0,4)==="data"){if(core.isset(core.platform.successCallback)){core.platform.successCallback(a)}return}try{c=JSON.parse(a);if(core.isset(c)){if(core.isset(core.platform.successCallback)){core.platform.successCallback(c)}return}}catch(b){console.log(b)}alert("不是有效的JSON文件！");if(core.isset(core.platform.errorCallback)){core.platform.errorCallback()}};utils.prototype.download=function(d,b){if(core.isset(window.jsinterface)){window.jsinterface.download(d,b);return}if(!core.platform.isOnline){alert("离线状态下不支持下载操作！");return}if(core.platform.isIOS){alert("iOS平台下不支持下载操作！");return}if(!core.platform.isPC){if(!core.platform.isChrome||core.platform.isQQ||core.platform.isWeChat){if(core.copy(b)){alert("移动端只有Chrome浏览器支持直接下载文件！\n所有应下载内容已经复制到您的剪切板，请自行创建空白文件并粘贴。")}else{alert("该平台或浏览器暂不支持下载操作！")}return}}if(core.platform.isSafari){alert("你当前使用的是Safari浏览器，不支持直接下载文件。\n即将打开一个新窗口为应下载内容，请自行全选复制然后创建空白文件并粘贴。");var a=new Blob([b],{type:"text/plain;charset=utf-8"});var e=window.URL.createObjectURL(a);var f=window.open(e,"_blank");window.URL.revokeObjectURL(e);return}var a=new Blob([b],{type:"text/plain;charset=utf-8"});if(window.navigator.msSaveOrOpenBlob){window.navigator.msSaveBlob(a,d)}else{var e=window.URL.createObjectURL(a);var c=window.document.createElement("a");c.href=e;c.download=d;document.body.appendChild(c);c.click();document.body.removeChild(c);window.URL.revokeObjectURL(e)}};utils.prototype.copy=function(a){if(core.isset(window.jsinterface)){window.jsinterface.copy(filename,content);return true}if(!core.platform.supportCopy){return false}var d=document.createElement("textarea");d.style.position="fixed";d.style.top=0;d.style.left=0;d.style.width="2em";d.style.height="2em";d.style.padding=0;d.style.border="none";d.style.outline="none";d.style.boxShadow="none";d.style.background="transparent";d.value=a;document.body.appendChild(d);d.focus();d.setSelectionRange(0,d.value.length);var c=false;try{c=document.execCommand("copy")}catch(b){c=false}document.body.removeChild(d);return c};utils.prototype.show=function(b,e,a){if(!core.isset(e)){b.style.display="block";return}b.style.display="block";if(main.mode!="play"){b.style.opacity=1;if(core.isset(a)){a()}return}b.style.opacity=0;var c=0;var d=window.setInterval(function(){c+=0.03;b.style.opacity=c;if(c>1){clearInterval(d);if(core.isset(a)){a()}}},e)};utils.prototype.hide=function(c,e,a){if(!core.isset(e)){c.style.display="none";return}if(main.mode!="play"){c.style.display="none";if(core.isset(a)){a()}return}var d=1;var b=window.setInterval(function(){d-=0.03;c.style.opacity=d;if(d<0){c.style.display="none";clearInterval(b);if(core.isset(a)){a()}}},e)};utils.prototype._export=function(b){if(!core.isset(b)){b=[core.status.floorId]}else{if(b=="all"){b=core.clone(core.floorIds)}else{if(typeof b=="string"){b=[b]}}}var e={};var a=b.length+"\n13 13\n\n";b.forEach(function(h){var g=core.maps.getMapArray(core.status.maps[h].blocks,13,13);a+=g.map(function(i){i.forEach(function(k){var j=core.maps.initBlock(null,null,k);if(core.isset(j.event)&&j.event.cls.indexOf("enemy")==0){e[k]=j.event.id}});return i.join("\t")}).join("\n")+"\n\n"});a+=["redJewel","blueJewel","greenJewel","redPotion","bluePotion","yellowPotion","greenPotion","sword1","shield1"].map(function(g){return core.values[g]}).join(" ")+"\n\n";a+=Object.keys(e).length+"\n";for(var f in e){var c=e[f],d=core.material.enemys[c];a+=f+" "+d.hp+" "+d.atk+" "+d.def+" "+d.money+" "+d.special+"\n"}a+="\n0 0 0 0 0 0\n\n";a+=core.status.hero.hp+" "+core.status.hero.atk+" "+core.status.hero.def+" "+core.status.hero.mdef+" "+core.status.hero.money+" "+core.itemCount("yellowKey")+" "+core.itemCount("blueKey")+" "+core.itemCount("redKey")+" 0 "+core.status.hero.loc.x+" "+core.status.hero.loc.y+"\n";console.log(a)};utils.prototype.http=function(f,g,b,e,a,c,d){var h=new XMLHttpRequest();h.open(f,g,true);if(core.isset(c)){h.overrideMimeType(c)}if(core.isset(d)){h.responseType=d}h.onload=function(i){if(h.status==200){if(core.isset(e)){e(h.response)}}else{if(core.isset(a)){a("HTTP "+h.status)}}};h.onabort=function(){if(core.isset(a)){a("Abort")}};h.ontimeout=function(){if(core.isset(a)){a("Timeout")}};h.onerror=function(){if(core.isset(a)){a("Error on Connection")}};if(core.isset(b)){h.send(b)}else{h.send()}};function items(){this.init()}items.prototype.init=function(){this.items=items_296f5d02_12fd_4166_a7c1_b5e830c9ee3a.items;this.itemEffect=items_296f5d02_12fd_4166_a7c1_b5e830c9ee3a.itemEffect;this.itemEffectTip=items_296f5d02_12fd_4166_a7c1_b5e830c9ee3a.itemEffectTip;this.useItemEffect=items_296f5d02_12fd_4166_a7c1_b5e830c9ee3a.useItemEffect;this.canUseItemEffect=items_296f5d02_12fd_4166_a7c1_b5e830c9ee3a.canUseItemEffect};items.prototype.getItems=function(){return this.items};items.prototype.getItemEffect=function(itemId,itemNum){var itemCls=core.material.items[itemId].cls;if(itemCls==="items"){var ratio=parseInt(core.status.thisMap.item_ratio)||1;var curr_hp=core.status.hero.hp;if(itemId in this.itemEffect){eval(this.itemEffect[itemId])}core.status.hero.statistics.hp+=core.status.hero.hp-curr_hp}else{core.addItem(itemId,itemNum)}};items.prototype.getItemEffectTip=function(itemId){var itemCls=core.material.items[itemId].cls;if(itemCls==="items"){var ratio=parseInt(core.status.thisMap.item_ratio)||1;if(itemId in this.itemEffectTip){return eval(this.itemEffectTip[itemId])||""}}return""};items.prototype.useItem=function(itemId,callback){if(!this.canUseItem(itemId)){if(core.isset(callback)){callback()}return}var itemCls=core.material.items[itemId].cls;if(itemId in this.useItemEffect){eval(this.useItemEffect[itemId])}if(itemId!="book"&&itemId!="fly"){core.status.route.push("item:"+itemId)}if(itemCls=="tools"){core.status.hero.items[itemCls][itemId]--}if(core.status.hero.items[itemCls][itemId]==0){delete core.status.hero.items[itemCls][itemId]}core.updateStatusBar();if(core.isset(callback)){callback()}};items.prototype.canUseItem=function(itemId){if(!core.hasItem(itemId)){return false}if(itemId in this.canUseItemEffect){return eval(this.canUseItemEffect[itemId])}return false};items.prototype.itemCount=function(b){if(!core.isset(b)||!core.isset(core.material.items[b])){return 0}var a=core.material.items[b].cls;if(a=="items"){return 0}return core.isset(core.status.hero.items[a][b])?core.status.hero.items[a][b]:0};items.prototype.hasItem=function(a){return core.itemCount(a)>0};items.prototype.hasEquip=function(a){if(!core.isset(a)){return null}if(!core.isset((core.material.items[a]||{}).equip)){return null}return a==this.getEquip(core.material.items[a].equip.type)};items.prototype.getEquip=function(a){return(core.status.hero.equipment||[])[a]||null};items.prototype.setItem=function(b,c){c=c||0;if(c<=0){c=0}var a=core.material.items[b].cls;if(a=="items"){return}if(!core.isset(core.status.hero.items[a])){core.status.hero.items[a]={}}core.status.hero.items[a][b]=c;if(a!="keys"&&c==0){delete core.status.hero.items[a][b]}};items.prototype.removeItem=function(b,c){c=c||1;if(!core.hasItem(b)){return false}var a=core.material.items[b].cls;core.status.hero.items[a][b]-=c;if(a!="keys"&&core.status.hero.items[a][b]<=0){delete core.status.hero.items[a][b]}core.updateStatusBar();return true};items.prototype.addItem=function(c,d){d=d||1;var b=core.material.items[c];var a=b.cls;if(a=="items"){return}if(!core.isset(core.status.hero.items[a])){core.status.hero.items[a]={};core.status.hero.items[a][c]=0}else{if(!core.isset(core.status.hero.items[a][c])){core.status.hero.items[a][c]=0}}core.status.hero.items[a][c]+=d;if(a=="constants"&&core.status.hero.items[a][c]>1){core.status.hero.items[a][c]=1}};items.prototype.loadEquip=function(b,a){if(!core.isset(core.status.hero.equipment)){core.status.hero.equipment=[]}core.playSound("equip.mp3");var c=core.material.items[b];if(!core.isset(c)){if(core.isset(a)){a()}return}var d=c.equip.type;var f=core.status.hero.equipment[d];var e=core.compareEquipment(b,f);if(core.flags.equipPercentage){core.setFlag("equip_atk_buff",core.getFlag("equip_atk_buff",1)+e.atk/100);core.setFlag("equip_def_buff",core.getFlag("equip_def_buff",1)+e.def/100);core.setFlag("equip_mdef_buff",core.getFlag("equip_mdef_buff",1)+e.mdef/100)}else{core.status.hero.atk+=e.atk;core.status.hero.def+=e.def;core.status.hero.mdef+=e.mdef}core.status.hero.equipment[d]=b;core.updateStatusBar();core.removeItem(b);if(core.isset(f)){core.addItem(f,1)}core.drawTip("已装备上"+c.name,core.material.icons.items[b]);if(core.isset(a)){a()}};items.prototype.unloadEquip=function(b,a){if(!core.isset(core.status.hero.equipment)){core.status.hero.equipment=[]}core.playSound("equip.mp3");var d=core.status.hero.equipment[b];if(!core.isset(d)){if(core.isset(a)){a()}return}var c=core.material.items[d];if(core.flags.equipPercentage){core.setFlag("equip_atk_buff",core.getFlag("equip_atk_buff",1)-(c.equip.atk||0)/100);core.setFlag("equip_def_buff",core.getFlag("equip_def_buff",1)-(c.equip.def||0)/100);core.setFlag("equip_mdef_buff",core.getFlag("equip_mdef_buff",1)-(c.equip.mdef||0)/100)}else{core.status.hero.atk-=c.equip.atk||0;core.status.hero.def-=c.equip.def||0;core.status.hero.mdef-=c.equip.mdef||0}core.status.hero.equipment[b]=null;core.updateStatusBar();core.addItem(d,1);core.drawTip("已卸下"+c.name,core.material.icons.items[d]);if(core.isset(a)){a()}};items.prototype.compareEquipment=function(f,b){var c=0,d=0,g=0;if(core.isset(f)){var e=core.material.items[f];c+=(e.equip||{}).atk||0;d+=(e.equip||{}).def||0;g+=(e.equip||{}).mdef||0}if(core.isset(b)){var a=core.material.items[b];c-=(a.equip||{}).atk||0;d-=(a.equip||{}).def||0;g-=(a.equip||{}).mdef||0}return{atk:c,def:d,mdef:g}};function icons(){this.init()}icons.prototype.init=function(){this.icons=icons_4665ee12_3a1f_44a4_bea3_0fccba634dc1;this.tilesetStartOffset=10000};icons.prototype.getIcons=function(){return this.icons};icons.prototype.getTilesetOffset=function(c){if(typeof c=="string"){if(!/^X\d+$/.test(c)){return null}c=parseInt(c.substring(1))}else{if(typeof c!="number"){return null}}core.tilesets=core.tilesets||[];var f=this.tilesetStartOffset;for(var b in core.tilesets){var e=core.tilesets[b];var d=core.material.images.tilesets[e];var g=Math.floor(d.width/32),a=Math.floor(d.height/32);if(c>=f&&c<f+g*a){var h=(c-f)%g,j=parseInt((c-f)/g);return{image:e,x:h,y:j}}f+=this.tilesetStartOffset}return null};function maps(){this.init()}maps.prototype.init=function(){this.blocksInfo=maps_90f36752_8815_4be8_b32b_d7fad1d0542e};maps.prototype.loadFloor=function(c,d){var b=core.floors[c];if(!core.isset(d)){d=b.map}if(d instanceof Array){d={map:d}}var a={};["floorId","title","name","canFlyTo","canUseQuickShop","cannotViewMap","color","weather","defaultGround","images","item_ratio","upFloor","bgm","downFloor","underGround"].forEach(function(f){if(core.isset(d[f])){a[f]=core.clone(d[f])}else{a[f]=core.clone(b[f])}});d=d.map;var e=function(n,o,h,k){var g=[];var q=core.floors[k].width||13;var p=core.floors[k].height||13;for(var l=0;l<p;l++){for(var m=0;m<q;m++){var f=o.initBlock(m,l,(n[l]||[])[m]||0);o.addInfo(f);o.addEvent(f,m,l,h.events[m+","+l]);o.addChangeFloor(f,m,l,h.changeFloor[m+","+l]);if(core.isset(f.event)){g.push(f)}}}return g};if(main.mode=="editor"){main.editor.mapIntoBlocks=function(h,f,g){return e(h,core.maps,f,g)}}a.blocks=e(d,this,b,c);return a};maps.prototype.initBlock=function(e,f,b){var a=null;b=""+b;if(b.length>2){if(b.indexOf(":f")==b.length-2){b=b.substring(0,b.length-2);a=true}else{if(b.indexOf(":t")==b.length-2){b=b.substring(0,b.length-2);a=false}}}b=parseInt(b);var d={x:e,y:f,id:b};if(a!=null){d.disable=a}if(b==17){d.event={cls:"terrains",id:"airwall",noPass:true}}else{if(b in this.blocksInfo){d.event=JSON.parse(JSON.stringify(this.blocksInfo[b]))}else{var c=core.icons.getTilesetOffset(b);if(c!=null){d.event={cls:"tileset",id:"X"+b,noPass:true}}}}return d};maps.prototype.addInfo=function(a){if(core.isset(a.event)){if(a.event.cls.indexOf("enemy")==0&&!core.isset(a.event.trigger)){a.event.trigger="battle"}if(a.event.cls=="items"&&!core.isset(a.event.trigger)){a.event.trigger="getItem"}if(!core.isset(a.event.noPass)){if(a.event.cls.indexOf("enemy")==0||a.event.cls.indexOf("npc")==0||a.event.cls=="terrains"||a.event.cls=="autotile"){a.event.noPass=true}}if(!core.isset(a.event.animate)){if(a.event.cls=="enemys"||a.event.cls=="npcs"){a.event.animate=2}if(a.event.cls=="animates"||a.event.cls=="enemy48"||a.event.cls=="npc48"){a.event.animate=4}}a.event.height=32;if(a.event.cls=="enemy48"||a.event.cls=="npc48"){a.event.height=48}}};maps.prototype.addEvent=function(a,d,e,b){if(!core.isset(b)){return}if(!core.isset(a.event)){a.event={cls:"terrains",id:"none",noPass:false}}if(typeof b=="string"){b={data:[b]}}else{if(b instanceof Array){b={data:b}}}if(!core.isset(b.data)){b.data=[]}if(core.isset(b.noPass)){a.event.noPass=b.noPass}if(!core.isset(a.disable)&&core.isset(b.enable)){a.disable=!b.enable}if(!core.isset(a.event.trigger)){if(core.isset(b.trigger)){a.event.trigger=b.trigger}else{a.event.trigger="action"}}else{if(core.isset(b.trigger)&&b.trigger!="checkBlock"){a.event.trigger=b.trigger}}for(var c in b){if(c!="disable"&&c!="trigger"&&c!="noPass"&&core.isset(b[c])){a.event[c]=core.clone(b[c])}}};maps.prototype.addChangeFloor=function(a,d,e,b,c){if(!core.isset(b)){return}this.addEvent(a,d,e,{trigger:"changeFloor",data:b},c)};maps.prototype.initMaps=function(b){var d={};for(var c=0;c<b.length;c++){var a=b[c];d[a]=this.loadFloor(a)}return d};maps.prototype.save=function(e,b){if(!core.isset(b)){var d={};for(var c in e){d[c]=this.save(e,c)}return d}var h=core.clone(e[b]);var g=core.floors[b].width||13;var f=core.floors[b].height||13;var a=[];for(var i=0;i<f;i++){a[i]=[];for(var j=0;j<g;j++){a[i].push(0)}}h.blocks.forEach(function(k){if(core.isset(k.disable)){if(!k.disable){a[k.y][k.x]=k.id+":t"}else{a[k.y][k.x]=k.id+":f"}}else{a[k.y][k.x]=k.id}});delete h.blocks;h.map=a;return main.mode=="editor"?a:h};maps.prototype.resizeMap=function(c){c=c||core.status.floorId;core.bigmap.width=core.floors[c].width||13;core.bigmap.height=core.floors[c].height||13;var b=core.bigmap.width*32;var a=core.bigmap.height*32;core.bigmap.canvas.forEach(function(d){core.canvas[d].canvas.setAttribute("width",b);core.canvas[d].canvas.setAttribute("height",a);core.canvas[d].canvas.style.width=b*core.domStyle.scale+"px";core.canvas[d].canvas.style.height=a*core.domStyle.scale+"px";if(main.mode==="editor"&&editor.isMobile){core.canvas[d].canvas.style.width=core.bigmap.width*32/416*96+"vw";core.canvas[d].canvas.style.height=core.bigmap.height*32/416*96+"vw"}})};maps.prototype.load=function(a,b){if(b==undefined){var c={};core.floorIds.forEach(function(d){c[d]=core.maps.loadFloor(d,a[d])});return c}return this.loadFloor(b,a[b])};maps.prototype.getMapArray=function(a,d,c){d=d||13;c=c||13;var b=[];for(var e=0;e<c;e++){b[e]=[];for(var f=0;f<d;f++){b[e].push(0)}}a.forEach(function(g){if(!g.disable&&g.x<d&&g.y<c){b[g.y][g.x]=g.id}});return b};maps.prototype.canMoveHero=function(o,p,b,c){if(!core.isset(o)){o=core.getHeroLoc("x")}if(!core.isset(p)){p=core.getHeroLoc("y")}if(!core.isset(b)){b=core.getHeroLoc("direction")}if(!core.isset(c)){c=core.status.floorId}if(core.isset(core.floors[c].cannotMove)){var a=core.floors[c].cannotMove[o+","+p];if(core.isset(a)&&a instanceof Array&&a.indexOf(b)>=0){return false}}var i=core.getBlock(o,p,c);if(i!=null){var j=i.block.event.id;var k=j.slice(0,5).toLowerCase()=="arrow";if(k){var h=j.slice(5).toLowerCase();if(b!=h){return false}}}var n={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var l=o+n[b].x,m=p+n[b].y;var f=core.getBlock(l,m);if(f!=null){var g=f.block.event.id;var d=g.slice(0,5).toLowerCase()=="arrow";if(d){var e=g.slice(5).toLowerCase();if((n[b].x+n[e].x)==0&&(n[b].y+n[e].y)==0){return false}}}if(c==core.status.floorId&&core.status.hero.hp<=core.status.checkBlock.damage[l+core.bigmap.width*m]&&!core.flags.canGoDeadZone&&core.getBlock(l,m)==null){return false}return true};maps.prototype.canMoveDirectly=function(a,b){if(!core.flags.enableMoveDirectly){return -1}if(core.hasFlag("poison")){return -1}var e=core.getHeroLoc("x"),f=core.getHeroLoc("y");if(e==a&&f==b){return 0}var h=core.getBlockId(e,f);if((h!=null&&h!="upFloor"&&h!="downFloor"&&h!="portal"&&h!="upPortal"&&h!="leftPortal"&&h!="downPortal"&&h!="rightPortal")||core.status.checkBlock.damage[e+core.bigmap.width*f]>0){return -1}var n=[],m=[];n[e+core.bigmap.width*f]=0;m.push(e+core.bigmap.width*f);var d={left:[-1,0],up:[0,-1],right:[1,0],down:[0,1]};while(m.length>0){var g=m.shift(),i=parseInt(g%core.bigmap.width),j=parseInt(g/core.bigmap.width);for(var c in d){if(!core.canMoveHero(i,j,c)){continue}var k=i+d[c][0],l=j+d[c][1];if(k<0||k>=core.bigmap.width||l<0||l>=core.bigmap.height||n[k+core.bigmap.width*l]||core.getBlock(k,l)!=null||core.status.checkBlock.damage[k+core.bigmap.width*l]>0){continue}n[k+core.bigmap.width*l]=n[i+core.bigmap.width*j]+1;if(k==a&&l==b){return n[k+core.bigmap.width*l]}m.push(k+core.bigmap.width*l)}}return -1};maps.prototype.drawBlock=function(b,a,d,e){if(b.event.id=="none"){return}var c=b.event.cls,f=b.event.height||32;var g,i,j;if(c=="tileset"){var h=core.icons.getTilesetOffset(b.event.id);if(h==null){return}g=core.material.images.tilesets[h.image];i=h.x;j=h.y}else{if(c=="autotile"){return}else{if(b.id==17){if(!core.isset(core.material.images.airwall)){return}g=core.material.images.airwall;i=j=0}else{g=core.material.images[c];i=(a||0)%(b.event.animate||1);j=core.material.icons[c][b.event.id]}}}d=d||0;e=e||0;core.canvas.event.clearRect(b.x*32+d,b.y*32+e,32,32);core.canvas.event.drawImage(g,i*32,j*f+f-32,32,32,b.x*32+d,b.y*32+e,32,32);if(f>32){core.canvas.event2.clearRect(b.x*32+d,b.y*32+32-f+e,32,f-32);core.canvas.event2.drawImage(g,i*32,j*f,32,f-32,b.x*32+d,b.y*32+32-f+e,32,f-32)}};maps.prototype.drawBgFgMap=function(g,e,l){var n=core.floors[g].width||13;var j=core.floors[g].height||13;var i=(core.status.maps||core.floors)[g].defaultGround||"ground";var c=core.material.icons.terrains[i];var d=core.material.images.terrains;var h=function(r){var q=core.clone(core.floors[g][r+"map"]||[]);if(main.mode=="editor"){q=core.clone(editor[r+"map"])||q}for(var s=0;s<n;s++){for(var t=0;t<j;t++){q[t]=q[t]||[];if(core.hasFlag(r+"_"+g+"_"+s+"_"+t)){q[t][s]=0}else{q[t][s]=core.getFlag(r+"v_"+g+"_"+s+"_"+t,q[t][s]||0)}if(main.mode=="editor"){q[t][s]=q[t][s].idnum||q[t][s]||0}}}return q};var a=h(l);for(var o=0;o<n;o++){for(var p=0;p<j;p++){if(l=="bg"){e.drawImage(d,0,c*32,32,32,o*32,p*32,32,32)}if(a[p][o]>0){var b=core.maps.initBlock(o,p,a[p][o]);if(core.isset(b.event)){var k=b.event.id,f=b.event.cls;if(f=="autotile"){core.drawAutotile(e,a,b,32,0,0)}else{if(f=="tileset"){var m=core.icons.getTilesetOffset(k);if(m!=null){e.drawImage(core.material.images.tilesets[m.image],32*m.x,32*m.y,32,32,32*o,32*p,32,32)}}else{if(a[p][o]==17){if(core.isset(core.material.images.airwall)){e.drawImage(core.material.images.airwall,32*o,32*p)}}else{e.drawImage(core.material.images[f],0,core.material.icons[f][k]*32,32,32,o*32,p*32,32,32)}}}}}}}};maps.prototype.drawMap=function(d,a){d=d||core.status.floorId;core.clearMap("all");core.removeGlobalAnimate(null,null,true);var b=function(){core.maps.drawBgFgMap(d,core.canvas.bg,"bg");core.maps.drawBgFgMap(d,core.canvas.fg,"fg");var e=[];if(core.isset(core.status.maps[d].images)){e=core.status.maps[d].images;if(typeof e=="string"){e=[[0,0,e]]}}e.forEach(function(k){var f=parseInt(k[0]),g=parseInt(k[1]),j=k[2];if(core.isset(f)&&core.isset(g)&&!core.hasFlag("floorimg_"+d+"_"+f+"_"+g)&&core.isset(core.material.images.images[j])){var i=core.material.images.images[j];if(!k[3]){if(/.*\.gif/i.test(j)&&main.mode=="play"){core.dom.gif.innerHTML="";var h=new Image();h.src=core.material.images.images[j].src;h.style.position="absolute";h.style.left=(32*f*core.domStyle.scale)+"px";h.style.top=(32*g*core.domStyle.scale)+"px";h.style.width=core.material.images.images[j].width*core.domStyle.scale+"px";h.style.height=core.material.images.images[j].height*core.domStyle.scale+"px";core.dom.gif.appendChild(h)}else{core.canvas.bg.drawImage(i,32*f,32*g,i.width,i.height)}}else{if(k[3]==1){core.canvas.fg.drawImage(i,32*f,32*g,i.width,i.height)}else{if(k[3]==2){core.canvas.fg.drawImage(i,0,0,i.width,i.height-32,32*f,32*g,i.width,i.height-32);core.canvas.bg.drawImage(i,0,i.height-32,i.width,32,32*f,32*g+i.height-32,i.width,32)}}}}})};if(main.mode=="editor"){}else{b()}core.status.floorId=d;core.status.thisMap=core.status.maps[d];var c=function(){var i=core.status.maps[core.status.floorId];var h=i.blocks;var g=core.maps.getMapArray(h,core.bigmap.width,core.bigmap.height);for(var e=0;e<h.length;e++){var f=h[e];if(core.isset(f.event)&&!f.disable){if(f.event.cls=="autotile"){core.drawAutotile(core.canvas.event,g,f,32,0,0)}else{core.drawBlock(f);core.addGlobalAnimate(f)}}}};if(main.mode=="editor"){main.editor.updateMap=function(){core.removeGlobalAnimate(null,null,true);core.clearMap("bg");core.clearMap("event");core.clearMap("event2");core.clearMap("fg");b();c();core.setGlobalAnimate(core.values.animateSpeed)}}else{c();core.setGlobalAnimate(core.values.animateSpeed);core.drawHero();core.updateStatusBar()}if(core.isset(a)){a()}};maps.prototype.drawAutotile=function(c,n,a,p,m,q){var l=[[10,9,4,3],[10,9,4,13],[10,9,18,3],[10,9,16,15],[10,43,4,3],[10,31,4,25],[10,7,2,3],[10,31,16,5],[48,9,4,3],[8,9,4,1],[36,9,30,3],[36,9,6,15],[46,45,4,3],[46,11,4,25],[12,45,30,3],[34,33,28,27]];var d=function(t,u,v,i,w,x){var y=16*((w-1)%6),z=16*(~~((w-1)/6));t.drawImage(i,y,z,16,16,u,v,x/2,x/2)};var g=function(i,t,u){if(t<0||u<0||t>=n[0].length||u>=n.length){return 1}else{return n[u][t]==i?1:0}};var b=function(F,G){var v=n[G][F];var E=[];for(var w=0;w<4;w++){var u=0;var C=w%2,D=~~(w/2);for(var z=0;z<4;z++){var A=z%2,B=~~(z/2);var t=g(v,F+C+A-1,G+D+B-1);u+=t*(Math.pow(2,3-z))}E.push(u)}return E};var h=function(z,A){var v=[];var w=b(z,A);for(var u=0;u<4;u++){var t=l[w[u]];v.push(t[3-u])}return v};var r=a.x,s=a.y;var o=h(r,s);if(o[0]==13){if(o[1]==16){o[1]=14}if(o[2]==31){o[2]=19}}if(o[1]==18){if(o[0]==15){o[0]=17}if(o[3]==36){o[3]=24}}if(o[2]==43){if(o[0]==25){o[0]=37}if(o[3]==46){o[3]=44}}if(o[3]==48){if(o[1]==30){o[1]=42}if(o[2]==45){o[2]=47}}for(var j=0;j<4;j++){var k=o[j];var e=r*p+p/2*(j%2),f=s*p+p/2*(~~(j/2));d(c,e+m,f+q,core.material.images.autotile[a.event.id],k,p)}};maps.prototype.noPassExists=function(c,d,b){var a=core.getBlock(c,d,b);if(a==null){return false}return core.isset(a.block.event.noPass)&&a.block.event.noPass};maps.prototype.noPass=function(a,b){return a<0||a>=core.bigmap.width||b<0||b>=core.bigmap.height||this.noPassExists(a,b)};maps.prototype.npcExists=function(c,d,b){var a=this.getBlock(c,d,b);if(a==null){return false}return a.block.event.cls.indexOf("npc")==0};maps.prototype.terrainExists=function(d,e,c,b){var a=this.getBlock(d,e,b);if(a==null){return false}return a.block.event.cls=="terrains"&&(core.isset(c)?a.block.event.id==c:true)};maps.prototype.stairExists=function(c,d,b){var a=this.getBlock(c,d,b);if(a==null){return false}return a.block.event.cls=="terrains"&&(a.block.event.id=="upFloor"||a.block.event.id=="downFloor")};maps.prototype.nearStair=function(){var a=core.getHeroLoc("x"),b=core.getHeroLoc("y");return this.stairExists(a,b)||this.stairExists(a-1,b)||this.stairExists(a,b-1)||this.stairExists(a+1,b)||this.stairExists(a,b+1)};maps.prototype.enemyExists=function(d,e,c,b){var a=this.getBlock(d,e,b);if(a==null){return false}return a.block.event.cls.indexOf("enemy")==0&&(core.isset(c)?a.block.event.id==c:true)};maps.prototype.getBlock=function(e,f,b,d){if(!core.isset(b)){b=core.status.floorId}var a=core.status.maps[b].blocks;for(var c=0;c<a.length;c++){if(a[c].x==e&&a[c].y==f&&core.isset(a[c].event)){if(!d&&a[c].disable){return null}return{index:c,block:a[c]}}}return null};maps.prototype.getBlockId=function(d,e,b,c){var a=core.getBlock(d,e,b,c);if(a==null){return null}if(core.isset(a.block.event)){return a.block.event.id}return null};maps.prototype.getBlockCls=function(d,e,b,c){var a=core.getBlock(d,e,b,c);if(a==null){return null}if(core.isset(a.block.event)){return a.block.event.cls}return null};maps.prototype.moveBlock=function(v,w,t,u,l,h){u=u||500;core.clearMap("route");var e=core.getBlock(v,w);if(e==null){if(core.isset(h)){h()}return}var j=e.block.id;core.status.replay.animate=true;core.removeBlock(v,w);core.clearMap("ui");core.setAlpha("ui",1);e=e.block;var k,f,g,i=e.event.height||32;if(e.event.cls=="tileset"){var p=core.icons.getTilesetOffset(e.event.id);if(p==null){if(core.isset(h)){h()}return}f=p.x;g=p.y;k=core.material.images.tilesets[p.image]}else{if(e.event.cls=="autotile"){if(core.isset(h)){h()}return}else{if(e.id==17){if(core.isset(h)){h()}return}else{k=core.material.images[e.event.cls];f=0;g=core.material.icons[e.event.cls][e.event.id]}}}var q=1;core.setOpacity("route",q);core.canvas.route.drawImage(k,f*32,g*i,32,i,e.x*32,e.y*32+32-i,32,i);var m=[];t.forEach(function(x){if(typeof x=="string"){m.push(x)}else{if(!core.isset(x.value)){m.push(x.direction)}else{for(var y=0;y<x.value;y++){m.push(x.direction)}}}});var n=32*v,o=32*w,s=0;var r={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var d=e.event.animate||1;var b=0;var c=0;var a=window.setInterval(function(){c+=u/16/core.status.replay.speed;if(c>=core.values.animateSpeed){b++;c=0;if(b>=d){b=0}}if(e.event.cls=="tileset"){b=f}if(m.length==0){if(l){q=0}else{q-=0.06}core.setOpacity("route",q);core.clearMap("route",n,o-i+32,32,i);core.canvas.route.drawImage(k,b*32,g*i,32,i,n,o-i+32,32,i);if(q<=0){clearInterval(a);core.clearMap("route");core.setOpacity("route",1);if(l){core.setBlock(j,n/32,o/32);core.showBlock(n/32,o/32)}core.status.replay.animate=false;if(core.isset(h)){h()}}}else{s++;n+=r[m[0]].x*2;o+=r[m[0]].y*2;core.clearMap("route",n-32,o-32,96,96);core.canvas.route.drawImage(k,b*32,g*i,32,i,n,o-i+32,32,i);if(s==16){s=0;m.shift()}}},u/16/core.status.replay.speed)};maps.prototype.jumpBlock=function(z,A,p,q,B,w,h){B=B||500;core.clearMap("route");var e=core.getBlock(z,A);if(e==null){if(core.isset(h)){h()}return}var s=e.block.id;core.status.replay.animate=true;core.removeBlock(z,A);core.clearMap("ui");core.setAlpha("ui",1);e=e.block;var t,f,g,r=e.event.height||32;if(e.event.cls=="tileset"){var x=core.icons.getTilesetOffset(e.event.id);if(x==null){if(core.isset(h)){h()}return}f=x.x;g=x.y;t=core.material.images.tilesets[x.image]}else{if(e.event.cls=="autotile"){if(core.isset(h)){h()}return}else{if(e.id==17){if(core.isset(h)){h()}return}else{t=core.material.images[e.event.cls];f=0;g=core.material.icons[e.event.cls][e.event.id]}}}var y=1;core.setOpacity("route",y);core.canvas.route.drawImage(t,f*32,g*r,32,r,e.x*32,e.y*32+32-r,32,r);core.playSound("jump.mp3");var n=p-z,o=q-A,k=Math.round(Math.sqrt(n*n+o*o));var v=6+k,u=v*2;var i=z,j=A;var l=function(){return i*32};var m=function(){var E=j*32;if(u>=v){var D=u-v}else{var D=v-u}return E-(v*v-D*D)/2};var C=function(){u--;i=(i*u+p)/(u+1);j=(j*u+q)/(u+1)};var d=e.event.animate||1;var b=0;var c=0;var a=window.setInterval(function(){c+=B/16/core.status.replay.speed;if(c>=core.values.animateSpeed){b++;c=0;if(b>=d){b=0}}if(e.event.cls=="tileset"){b=f}if(u>0){core.clearMap("route",l(),m()-r+32,32,r);C();core.canvas.route.drawImage(t,b*32,g*r,32,r,l(),m()-r+32,32,r)}else{if(w){y=0}else{y-=0.06}core.setOpacity("route",y);core.clearMap("route",l(),m()-r+32,32,r);core.canvas.route.drawImage(t,b*32,g*r,32,r,l(),m()-r+32,32,r);if(y<=0){clearInterval(a);core.clearMap("route");core.setOpacity("route",1);if(w){core.setBlock(s,p,q);core.showBlock(p,q)}core.status.replay.animate=false;if(core.isset(h)){h()}}}},B/16/core.status.replay.speed)};maps.prototype.animateBlock=function(e,h,g,b){if(h!="hide"){h="show"}core.clearMap("route");if(typeof e[0]=="number"&&typeof e[1]=="number"){e=[e]}var d=[];e.forEach(function(o){var i=core.getBlock(o[0],o[1],null,true);if(i==null){return}i=i.block;var m,j,k,l=i.event.height||32;if(i.event.cls=="tileset"){var n=core.icons.getTilesetOffset(i.event.id);if(n==null){if(core.isset(b)){b()}return}j=n.x;k=n.y;m=core.material.images.tilesets[n.image]}else{if(i.event.cls=="autotile"){return}else{if(i.id==17){return}else{m=core.material.images[i.event.cls];j=0;k=core.material.icons[i.event.cls][i.event.id]}}}d.push({x:o[0],y:o[1],height:l,bx:j,by:k,image:m})});if(d.length==0){if(core.isset(b)){b()}return}core.status.replay.animate=true;var c=function(){d.forEach(function(i){core.canvas.route.drawImage(i.image,i.bx*32,i.by*i.height,32,i.height,i.x*32,i.y*32+32-i.height,32,i.height)})};var f=0;if(h=="hide"){f=1}core.setOpacity("route",f);c();var a=window.setInterval(function(){if(h=="show"){f+=0.1}else{f-=0.1}core.setOpacity("route",f);if(f>=1||f<=0){clearInterval(a);core.clearMap("route");core.setOpacity("route",1);core.status.replay.animate=false;if(core.isset(b)){b()}}},g/10/core.status.replay.speed)};maps.prototype.showBlock=function(c,d,b){b=b||core.status.floorId;var a=core.getBlock(c,d,b,true);if(a==null){return}a=a.block;if(a.disable){a.disable=false;if(b==core.status.floorId&&core.isset(a.event)){core.drawBlock(a);core.addGlobalAnimate(a);core.syncGlobalAnimate()}core.updateStatusBar()}};maps.prototype.hideBlock=function(d,e,b){b=b||core.status.floorId;var a=core.getBlock(d,e,b,true);if(a==null){return}if(b==core.status.floorId){core.removeGlobalAnimate(d,e);core.canvas.event.clearRect(d*32,e*32,32,32);var c=32;if(core.isset(a.block.event)){c=a.block.event.height||32}if(c>32){core.canvas.event2.clearRect(d*32,e*32+32-c,32,c-32)}}a.disable=true;core.updateStatusBar()};maps.prototype.removeBlock=function(e,f,b){b=b||core.status.floorId;var a=core.getBlock(e,f,b,true);if(a==null){return}var d=a.index;if(b==core.status.floorId){core.removeGlobalAnimate(e,f);core.canvas.event.clearRect(e*32,f*32,32,32);var c=32;if(core.isset(a.block.event)){c=a.block.event.height||32}if(c>32){core.canvas.event2.clearRect(e*32,f*32+32-c,32,c-32)}}core.removeBlockById(d,b);core.updateStatusBar()};maps.prototype.removeBlockById=function(e,d){var b=core.status.maps[d].blocks,a=b[e];var g=a.x,h=a.y;var c=core.floors[d].events[g+","+h];if(!core.isset(c)){c=core.floors[d].changeFloor[g+","+h]}var f=false;if(core.isset(a.event)&&a.event.cls.indexOf("enemy")==0&&core.enemys.hasSpecial(core.material.enemys[a.event.id].special,23)){f=true}if(!f&&!core.isset(c)){b.splice(e,1);return}a.disable=true};maps.prototype.removeBlockByIds=function(a,b){b.sort(function(c,d){return d-c}).forEach(function(c){core.removeBlockById(c,a)})};maps.prototype.setBlock=function(c,e,f,b){b=b||core.status.floorId;if(!core.isset(c)||!core.isset(e)||!core.isset(f)){return}if(e<0||e>=core.bigmap.width||f<0||f>=core.bigmap.height){return}var d=core.getBlock(e,f,b,true);var a=core.maps.initBlock(e,f,c);core.maps.addInfo(a);core.maps.addEvent(a,e,f,core.floors[b].events[e+","+f]);core.maps.addChangeFloor(a,e,f,core.floors[b].changeFloor[e+","+f]);if(core.isset(a.event)){if(d==null){core.status.maps[b].blocks.push(a)}else{d.block.id=c;d.block.event=a.event}if(b==core.status.floorId){core.drawMap(b)}}};maps.prototype.setBgFgBlock=function(b,c,d,e,a){a=a||core.status.floorId;if(!core.isset(c)||!core.isset(d)||!core.isset(e)){return}if(d<0||d>=core.bigmap.width||e<0||e>=core.bigmap.height){return}if(b!="bg"&&b!="fg"){return}core.setFlag(b+"v_"+a+"_"+d+"_"+e,c);if(a==core.status.floorId){core.drawMap(a)}};maps.prototype.addGlobalAnimate=function(a){if(main.mode=="editor"&&main.editor.disableGlobalAnimate){return}if(!core.isset(a.event)||!core.isset(a.event.animate)||a.event.animate==1){return}var c=core.clone(a);c.status=0;core.status.globalAnimateObjs.push(c)};maps.prototype.removeGlobalAnimate=function(c,d,a){if(main.mode=="editor"&&main.editor.disableGlobalAnimate){return}if(a){core.status.globalAnimateObjs=[];return}for(var b=0;b<core.status.globalAnimateObjs.length;b++){if(core.status.globalAnimateObjs[b].x==c&&core.status.globalAnimateObjs[b].y==d){core.status.globalAnimateObjs.splice(b,1);return}}};maps.prototype.setGlobalAnimate=function(a){if(main.mode=="editor"&&main.editor.disableGlobalAnimate){return}core.syncGlobalAnimate();core.animateFrame.speed=a;core.animateFrame.globalAnimate=true};maps.prototype.syncGlobalAnimate=function(){core.status.globalAnimateObjs.forEach(function(a){a.status=0})};maps.prototype.drawBoxAnimate=function(){for(var b=0;b<core.status.boxAnimateObjs.length;b++){var c=core.status.boxAnimateObjs[b];c.status=((c.status||0)+1)%c.animate;core.clearMap("ui",c.bgx,c.bgy,c.bgWidth,c.bgHeight);core.fillRect("ui",c.bgx,c.bgy,c.bgWidth,c.bgHeight,core.animateFrame.background);core.canvas.ui.drawImage(c.image,c.status*32,c.pos,32,c.height,c.x,c.y,32,c.height)}};maps.prototype.drawAnimateFrame=function(a,b,c,e){var d=a.frames[e];var f=a.ratio;d.forEach(function(l){var i=a.images[l.index];if(!core.isset(i)){return}var k=i.width*f*l.zoom/100;var j=i.height*f*l.zoom/100;core.setAlpha("animate",l.opacity/255);var g=b+l.x,h=c+l.y;if(!l.mirror&&!l.angle){core.canvas.animate.drawImage(i,g-k/2-core.bigmap.offsetX,h-j/2-core.bigmap.offsetY,k,j)}else{core.saveCanvas("animate");core.canvas.animate.translate(g,h);if(l.angle){core.canvas.animate.rotate(-l.angle*Math.PI/180)}if(l.mirror){core.canvas.animate.scale(-1,1)}core.canvas.animate.drawImage(i,-k/2-core.bigmap.offsetX,-j/2-core.bigmap.offsetY,k,j);core.loadCanvas("animate")}})};maps.prototype.drawAnimate=function(f,g,h,b){if(core.isset(core.status.replay)&&core.status.replay.replaying){if(core.isset(b)){b()}return}if(!core.isset(core.material.animates[f])||!core.isset(g)||!core.isset(h)){if(core.isset(b)){b()}return}clearInterval(core.interval.animateInterval);var a=core.material.animates[f],c=32*g+16,d=32*h+16;core.playSound(a.se);if(!core.isset(b)){core.status.animateObjs.push({animate:a,centerX:c,centerY:d,index:0});return}var e=0;core.clearMap("animate");core.maps.drawAnimateFrame(a,c,d,e++);core.interval.animateInterval=setInterval(function(i){if(e==a.frames.length){clearInterval(core.interval.animateInterval);core.clearMap("animate");core.setAlpha("animate",1);if(core.isset(b)){b()}return}core.clearMap("animate");core.maps.drawAnimateFrame(a,c,d,e++)},50)};maps.prototype.setFloorImage=function(d,c,b,a){if(d!="show"){d="hide"}if(typeof c[0]=="number"&&typeof c[1]=="number"){c=[c]}b=b||core.status.floorId;if(c.length==0){return}c.forEach(function(f){var g=f[0],h=f[1];var e="floorimg_"+b+"_"+g+"_"+h;core.setFlag(e,d=="show"?false:true)});if(b==core.status.floorId){core.drawMap(b,a)}else{if(core.isset(a)){a()}}};maps.prototype.setBgFgMap=function(e,d,c,b,a){if(e!="show"){e="hide"}if(d!="fg"){d="bg"}if(typeof c[0]=="number"&&typeof c[1]=="number"){c=[c]}b=b||core.status.floorId;if(c.length==0){return}c.forEach(function(g){var h=g[0],i=g[1];var f=d+"_"+b+"_"+h+"_"+i;core.setFlag(f,e=="show"?false:true)});if(b==core.status.floorId){core.drawMap(b,a)}else{if(core.isset(a)){a()}}};maps.prototype.resetMap=function(a){var a=a||core.status.floorId;core.status.maps[a]=this.loadFloor(a);if(a==core.status.floorId){this.drawMap(a,function(){core.drawTip("地图重置成功")})}else{core.drawTip(a+"地图重置成功")}};function enemys(){this.init()}enemys.prototype.init=function(){this.enemys=enemys_fcae963b_31c9_42b4_b48c_bb48d09f3f80;this.enemydata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.enemys;if(main.mode=="play"){this.enemydata.hasSpecial=function(c,d){return core.enemys.hasSpecial(c,d)}}};enemys.prototype.getEnemys=function(a){if(!core.isset(a)){return this.enemys}return this.enemys[a]};enemys.prototype.hasSpecial=function(a,b){if(!core.isset(a)){return false}if(a instanceof Array){return a.indexOf(b)>=0}if(typeof a=="number"){return a!=0&&(a%100==b||this.hasSpecial(parseInt(a/100),b))}if(typeof a=="string"){return this.hasSpecial(core.material.enemys[a],b)}if(core.isset(a.special)){return this.hasSpecial(a.special,b)}return false};enemys.prototype.getSpecials=function(){return this.enemydata.getSpecials()};enemys.prototype.calContent=function(b,a){if(typeof b=="string"){b=core.material.enemys[b]}if(typeof a=="string"){return a}if(a instanceof Function){return a(b)}return""};enemys.prototype.getSpecialText=function(a){if(typeof a=="string"){a=core.material.enemys[a]}if(!core.isset(a)){return[]}var c=a.special;var e=[];var d=this.getSpecials();if(core.isset(d)){for(var b=0;b<d.length;b++){if(this.hasSpecial(c,d[b][0])){e.push(this.calContent(a,d[b][1]))}}}return e};enemys.prototype.getSpecialHint=function(a,d){if(typeof a=="string"){a=core.material.enemys[a]}var e=this.getSpecials();if(!core.isset(d)){if(!core.isset(e)){return[]}var b=[];for(var c=0;c<e.length;c++){if(this.hasSpecial(a,e[c][0])){b.push(this.calContent(a,e[c][1])+"："+this.calContent(a,e[c][2]))}}return b}if(!core.isset(e)){return""}for(var c=0;c<e.length;c++){if(d==e[c][0]){return this.calContent(a,e[c][1])+"："+this.calContent(a,e[c][2])}}return""};enemys.prototype.canBattle=function(b,d,e,c){var a=this.getDamage(b,d,e,c);return a!=null&&a<core.status.hero.hp};enemys.prototype.getDamage=function(b,d,e,c){if(typeof b=="string"){b=core.material.enemys[b]}var a=this.calDamage(b,core.status.hero.hp,core.status.hero.atk,core.status.hero.def,core.status.hero.mdef,d,e,c);if(a==null){return null}return a+this.getExtraDamage(b)};enemys.prototype.getExtraDamage=function(a){if(typeof a=="string"){a=core.material.enemys[a]}var b=0;if(this.hasSpecial(a.special,17)){b+=core.getFlag("hatred",0)}if(this.hasSpecial(a.special,22)){b+=a.damage||0}return b};enemys.prototype.nextCriticals=function(b,k,p,q,c){if(typeof b=="string"){b=core.material.enemys[b]}var o=!core.flags.useLoop;k=k||1;if(this.hasSpecial(b.special,3)){if(core.status.hero.atk<=b.def){return[[b.def+1-core.status.hero.atk,"?"]]}return[]}if(this.hasSpecial(b.special,10)){return[]}var e=this.getDamageInfo(b,core.status.hero.hp,core.status.hero.atk,core.status.hero.def,core.status.hero.mdef,p,q,c);if(e==null){if(core.status.hero.atk<=b.def){return[[b.def+1-core.status.hero.atk,"?"]]}return[]}if(e.damage<=0&&!core.flags.enableNegativeDamage){return[[0,0]]}var f=[],l=null;var h=e.mon_hp,d=core.status.hero.atk,g=b.def,n=e.turn;if(o){for(var m=n-1;m>=1;m--){var i=Math.ceil(h/m)+g;if(core.flags.equipPercentage){i=Math.ceil(i/core.getFlag("equip_atk_buff",1))}if(i<=d){break}if(i!=l){var j=this.getDamageInfo(b,core.status.hero.hp,i,core.status.hero.def,core.status.hero.mdef,p,q,c);if(j==null){break}f.push([i-d,e.damage-j.damage]);if(j.damage<=0&&!core.flags.enableNegativeDamage){break}l=i}if(f.length>=k){break}}}else{l=e.damage;for(var a=d+1;a<=h+g;a++){var j=this.getDamageInfo(b,core.status.hero.hp,a,core.status.hero.def,core.status.hero.mdef,p,q,c);if(j==null){break}if(l>j.damage){l=j.damage;f.push([a-d,e.damage-j.damage]);if(j.damage<=0&&!core.flags.enableNegativeDamage){break}if(f.length>=k){break}}}}if(f.length==0){f.push([0,0])}return f};enemys.prototype.getDefDamage=function(a,c,f,g,b){if(typeof a=="string"){a=core.material.enemys[a]}c=c||1;var e=this.calDamage(a,core.status.hero.hp,core.status.hero.atk,core.status.hero.def,core.status.hero.mdef,f,g,b);var d=this.calDamage(a,core.status.hero.hp,core.status.hero.atk,core.status.hero.def+c,core.status.hero.mdef,f,g,b);if(e==null||d==null){return"???"}return e-d};enemys.prototype.getEnemyInfo=function(a,e,c,d,f,g,h,b){if(typeof a=="string"){a=core.material.enemys[a]}return this.enemydata.getEnemyInfo(a,e,c,d,f,g,h,b)};enemys.prototype.getDamageInfo=function(a,e,c,d,f,g,h,b){if(typeof a=="string"){a=core.material.enemys[a]}return this.enemydata.getDamageInfo(a,e,c,d,f,g,h,b)};enemys.prototype.calDamage=function(a,e,c,d,f,h,i,b){if(typeof a=="string"){a=core.material.enemys[a]}var g=this.getDamageInfo(a,e,c,d,f,h,i,b);if(g==null){return null}return g.damage};enemys.prototype.updateEnemys=function(){return this.enemydata.updateEnemys()};enemys.prototype.getCurrentEnemys=function(h){h=h||core.status.floorId;var g=[];var q={};var l=core.status.maps[h].blocks;for(var a=0;a<l.length;a++){if(core.isset(l[a].event)&&!l[a].disable&&l[a].event.cls.indexOf("enemy")==0){var e=l[a].event.id;if(core.isset(q[e])){continue}var d=core.material.enemys[e];var o=d.hp,m=d.atk,n=d.def;var i=core.status.hero.atk,j=core.status.hero.def,k=core.status.hero.mdef;if(core.flags.equipPercentage){i=Math.floor(core.getFlag("equip_atk_buff",1)*i);j=Math.floor(core.getFlag("equip_def_buff",1)*j);k=Math.floor(core.getFlag("equip_mdef_buff",1)*k)}var f=this.getEnemyInfo(d,core.status.hero.hp,i,j,k,null,null,h);var p=core.enemys.getSpecialText(e);if(p.length>=3){p="多属性..."}else{p=p.join("  ")}var c=this.nextCriticals(e);if(c.length>0){c=c[0]}g.push({id:e,name:d.name,hp:f.hp,atk:f.atk,def:f.def,money:f.money||0,experience:f.experience||0,point:f.point||0,special:p,damage:this.getDamage(e,null,null,h),critical:c[0],criticalDamage:c[1],defDamage:this.getDefDamage(e,1,null,null,h)});q[e]=true}}g.sort(function(r,s){if(r.damage==s.damage){return r.money-s.money}if(r.damage==null){return 1}if(s.damage==null){return -1}return r.damage-s.damage});return g};function events(){this.init()}events.prototype.init=function(){this.eventdata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.events;this.events={battle:function(c,b,a){b.battle(c.event.id,c.x,c.y);if(b.isset(a)){a()}},getItem:function(c,b,a){b.getItem(c.event.id,1,c.x,c.y);if(b.isset(a)){a()}},openDoor:function(c,b,a){b.openDoor(c.event.id,c.x,c.y,true,function(){if(b.isset(a)){a()}b.replay()})},changeFloor:function(c,b,a){var d={};if(b.isset(c.event.data.loc)){d={x:c.event.data.loc[0],y:c.event.data.loc[1]}}if(b.isset(c.event.data.direction)){d.direction=c.event.data.direction}if(b.status.event.id!="action"){b.status.event.id=null}b.changeFloor(c.event.data.floorId,c.event.data.stair,d,c.event.data.time,function(){if(b.isset(a)){a()}b.replay()})},passNet:function(c,b,a){b.events.passNet(c);if(b.isset(a)){a()}},changeLight:function(c,b,a){b.events.changeLight(c.x,c.y);if(b.isset(a)){a()}},ski:function(c,b,a){b.events.ski();if(b.isset(a)){a()}},pushBox:function(c,b,a){b.events.pushBox(c);if(b.isset(a)){a()}},action:function(c,b,a){b.events.insertAction(c.event.data,c.x,c.y,a)}}};events.prototype.getEvents=function(a){if(!core.isset(a)){return this.events}return this.events[a]};events.prototype.initGame=function(){return this.eventdata.initGame()};events.prototype.startGame=function(a){if(core.status.isStarting){return}core.status.isStarting=true;core.hideStartAnimate(function(){core.drawText(core.clone(core.firstData.startText),function(){if(core.flags.showBattleAnimateConfirm){core.status.event.selection=core.flags.battleAnimate?0:1;core.ui.drawConfirmBox("你想开启战斗动画吗？\n之后可以在菜单栏中开启或关闭。\n（强烈建议新手开启此项）",function(){core.data.flags.battleAnimate=true;core.flags.battleAnimate=true;core.setLocalStorage("battleAnimate",true);core.startGame(a);core.utils.__init_seed();core.events.setInitData(a)},function(){core.data.flags.battleAnimate=false;core.flags.battleAnimate=false;core.setLocalStorage("battleAnimate",false);core.startGame(a);core.utils.__init_seed();core.events.setInitData(a)})}else{core.startGame(a);core.utils.__init_seed();core.events.setInitData(a)}})})};events.prototype.setInitData=function(a){return this.eventdata.setInitData(a)};events.prototype.win=function(b,a){core.status.gameOver=true;return this.eventdata.win(b,a)};events.prototype.lose=function(a){core.status.gameOver=true;return this.eventdata.lose(a)};events.prototype.gameOver=function(c,d,e){core.clearMap("animate");core.clearMap("image");core.clearMap("weather");core.dom.gif2.innerHTML="";core.animateFrame.weather.type=null;core.animateFrame.weather.level=0;core.animateFrame.weather.nodes=[];core.setFg(null,0);core.ui.closePanel();var a=function(){core.ui.closePanel();core.ui.drawConfirmBox("你想下载录像吗？",function(){var f={name:core.firstData.name,version:core.firstData.version,hard:core.status.hard,seed:core.getFlag("seed"),route:core.encodeRoute(core.status.route)};core.download(core.firstData.name+"_"+core.formatDate2(new Date())+".h5route",JSON.stringify(f));core.restart()},function(){core.restart()})};var b=function(){core.ui.closePanel();if(!core.isset(c)){a();return}var f=function(i){var h=core.status.hero.hp;if(i==undefined){h=1}var g=new FormData();g.append("type","score");g.append("name",core.firstData.name);g.append("version",core.firstData.version);g.append("platform",core.platform.isPC?"PC":core.platform.isAndroid?"Android":core.platform.isIOS?"iOS":"");g.append("hard",core.encodeBase64(core.status.hard));g.append("username",core.encodeBase64(i||""));g.append("ending",core.encodeBase64(c));g.append("lv",core.status.hero.lv);g.append("hp",Math.min(h,Math.pow(2,63)));g.append("atk",core.status.hero.atk);g.append("def",core.status.hero.def);g.append("mdef",core.status.hero.mdef);g.append("money",core.status.hero.money);g.append("experience",core.status.hero.experience);g.append("steps",core.status.hero.steps);g.append("norank",e||0);g.append("seed",core.getFlag("seed"));g.append("totalTime",Math.floor(core.status.hero.statistics.totalTime/1000));g.append("route",core.encodeRoute(core.status.route));g.append("base64",1);if(main.isCompetition){core.http("POST","/games/competition/upload.php",g)}else{core.http("POST","/games/upload.php",g)}setTimeout(function(){a()},150)};core.ui.drawConfirmBox("你想记录你的ID和成绩吗？",function(){if(main.isCompetition){f("")}else{f(prompt("请输入你的ID："))}},function(){if(main.isCompetition){a()}else{f(undefined)}});return};if(d){core.drawText("录像回放完毕！",function(){core.restart()})}else{if(core.isset(core.values.maxValidHp)&&core.status.hero.hp>core.values.maxValidHp){core.drawText("作弊可耻！",function(){core.restart()})}else{if(core.hasFlag("debug")){core.drawText("\t[系统提示]调试模式下无法上传成绩",function(){core.restart()})}else{b()}}}};events.prototype.afterChangeFloor=function(a,b){if(main.mode!="play"){return}return this.eventdata.afterChangeFloor(a,b)};events.prototype.doEvents=function(b,c,d,a){if(!core.isset(b)){return}if(!(b instanceof Array)){b=[b]}core.status.event={id:"action",data:{list:[{todo:core.clone(b),total:core.clone(b),condition:"false"}],x:c,y:d,callback:a}};core.waitHeroToStop(function(){core.lockControl();core.events.doAction()})};events.prototype.doAction=function(){core.status.boxAnimateObjs=[];clearInterval(core.status.event.interval);core.status.event.interval=null;core.clearMap("ui");core.setAlpha("ui",1);if(core.status.event.data.list.length==0){var callback=core.status.event.data.callback;core.ui.closePanel();if(core.isset(callback)){callback()}core.replay();return}var current=core.status.event.data.list[0];if(current.todo.length==0){if(core.calValue(current.condition)){current.todo=core.clone(current.total)}else{core.status.event.data.list.shift()}this.doAction();return}var data=current.todo.shift();core.status.event.data.current=data;var x=core.status.event.data.x,y=core.status.event.data.y;if(typeof data=="string"){core.status.event.data.type="text";if(core.status.replay.replaying){core.events.doAction()}else{core.ui.drawTextBox(data)}return}core.status.event.data.type=data.type;switch(data.type){case"text":if(core.status.replay.replaying){core.events.doAction()}else{core.ui.drawTextBox(data.text,data.showAll)}break;case"autoText":if(core.status.replay.replaying){core.events.doAction()}else{core.ui.drawTextBox(data.text);setTimeout(function(){core.events.doAction()},data.time||3000)}break;case"setText":if(data.position=="up"||data.position=="down"||data.position=="center"){core.status.textAttribute.position=data.position}["bold","titlefont","textfont","time"].forEach(function(t){if(core.isset(data[t])){core.status.textAttribute[t]=data[t]}});["background","title","text"].forEach(function(t){if(core.isset(data[t])&&(data[t] instanceof Array)&&data[t].length>=3){if(data[t].length==3){data[t].push(1)}core.status.textAttribute[t]=data[t]}});core.setFlag("textAttribute",core.status.textAttribute);core.events.doAction();break;case"tip":core.drawTip(core.replaceText(data.text));core.events.doAction();break;case"show":if(!core.isset(data.loc)){data.loc=[x,y]}if((typeof data.loc[0]=="number"||typeof data.loc[0]=="string")&&(typeof data.loc[1]=="number"||typeof data.loc[1]=="string")){data.loc=[[core.calValue(data.loc[0]),core.calValue(data.loc[1])]]}if(core.isset(data.time)&&data.time>0&&(!core.isset(data.floorId)||data.floorId==core.status.floorId)){core.animateBlock(data.loc,"show",data.time,function(){data.loc.forEach(function(t){core.showBlock(t[0],t[1],data.floorId)});core.events.doAction()})}else{data.loc.forEach(function(t){core.showBlock(t[0],t[1],data.floorId)});this.doAction()}break;case"hide":if(!core.isset(data.loc)){data.loc=[x,y]}if((typeof data.loc[0]=="number"||typeof data.loc[0]=="string")&&(typeof data.loc[1]=="number"||typeof data.loc[1]=="string")){data.loc=[[core.calValue(data.loc[0]),core.calValue(data.loc[1])]]}if(core.isset(data.time)&&data.time>0&&(!core.isset(data.floorId)||data.floorId==core.status.floorId)){data.loc.forEach(function(t){core.hideBlock(t[0],t[1],data.floorId)});core.animateBlock(data.loc,"hide",data.time,function(){data.loc.forEach(function(t){core.removeBlock(t[0],t[1],data.floorId)});core.events.doAction()})}else{data.loc.forEach(function(t){core.removeBlock(t[0],t[1],data.floorId)});this.doAction()}break;case"setBlock":if(core.isset(data.loc)){x=core.calValue(data.loc[0]);y=core.calValue(data.loc[1])}core.setBlock(data.number,x,y,data.floorId);this.doAction();break;case"showFloorImg":if(!core.isset(data.loc)){data.loc=[x,y]}if((typeof data.loc[0]=="number"||typeof data.loc[0]=="string")&&(typeof data.loc[1]=="number"||typeof data.loc[1]=="string")){data.loc=[[core.calValue(data.loc[0]),core.calValue(data.loc[1])]]}core.maps.setFloorImage("show",data.loc,data.floorId,function(){core.events.doAction()});break;case"hideFloorImg":if(!core.isset(data.loc)){data.loc=[x,y]}if((typeof data.loc[0]=="number"||typeof data.loc[0]=="string")&&(typeof data.loc[1]=="number"||typeof data.loc[1]=="string")){data.loc=[[core.calValue(data.loc[0]),core.calValue(data.loc[1])]]}core.maps.setFloorImage("hide",data.loc,data.floorId,function(){core.events.doAction()});break;case"showBgFgMap":if(!core.isset(data.loc)){data.loc=[x,y]}if((typeof data.loc[0]=="number"||typeof data.loc[0]=="string")&&(typeof data.loc[1]=="number"||typeof data.loc[1]=="string")){data.loc=[[core.calValue(data.loc[0]),core.calValue(data.loc[1])]]}core.maps.setBgFgMap("show",data.name,data.loc,data.floorId,function(){core.events.doAction()});break;case"hideBgFgMap":if(!core.isset(data.loc)){data.loc=[x,y]}if((typeof data.loc[0]=="number"||typeof data.loc[0]=="string")&&(typeof data.loc[1]=="number"||typeof data.loc[1]=="string")){data.loc=[[core.calValue(data.loc[0]),core.calValue(data.loc[1])]]}core.maps.setBgFgMap("hide",data.name,data.loc,data.floorId,function(){core.events.doAction()});break;case"setBgFgBlock":if(core.isset(data.loc)){x=core.calValue(data.loc[0]);y=core.calValue(data.loc[1])}core.setBgFgBlock(data.name,data.number,x,y,data.floorId);this.doAction();break;case"follow":if(core.isset(core.material.images.images[data.name])&&core.material.images.images[data.name].width==128){if(!core.isset(core.status.hero.followers)){core.status.hero.followers=[]}core.status.hero.followers.push({img:data.name});core.control.gatherFollowers();core.clearMap("hero");core.drawHero()}this.doAction();break;case"unfollow":if(core.isset(core.status.hero.followers)){var remove=false;if(!core.isset(data.name)&&core.status.hero.followers.length>0){core.status.hero.followers=[];remove=true}if(core.isset(data.name)){for(var i=0;i<core.status.hero.followers.length;i++){if(core.status.hero.followers[i].img==data.name){core.status.hero.followers.splice(i,1);remove=true;break}}}if(remove){core.control.gatherFollowers();core.clearMap("hero");core.drawHero()}}this.doAction();break;case"animate":if(core.isset(data.loc)){if(data.loc=="hero"){x=core.getHeroLoc("x");y=core.getHeroLoc("y")}else{if(data.loc instanceof Array){x=core.calValue(data.loc[0]);y=core.calValue(data.loc[1])}}}if(data.async){core.drawAnimate(data.name,x,y);core.events.doAction()}else{core.drawAnimate(data.name,x,y,function(){core.events.doAction()})}break;case"move":if(core.isset(data.loc)){x=core.calValue(data.loc[0]);y=core.calValue(data.loc[1])}core.moveBlock(x,y,data.steps,data.time,data.keep,function(){core.events.doAction()});break;case"moveHero":core.eventMoveHero(data.steps,data.time,function(){core.events.doAction()});break;case"jump":var sx=x,sy=y,ex=x,ey=y;if(core.isset(data.from)){sx=core.calValue(data.from[0]);sy=core.calValue(data.from[1])}if(core.isset(data.to)){ex=core.calValue(data.to[0]);ey=core.calValue(data.to[1])}core.jumpBlock(sx,sy,ex,ey,data.time,data.keep,function(){core.events.doAction()});break;case"jumpHero":var ex=core.status.hero.loc.x,ey=core.status.hero.loc.y;if(core.isset(data.loc)){ex=core.calValue(data.loc[0]);ey=core.calValue(data.loc[1])}core.jumpHero(ex,ey,data.time,function(){core.events.doAction()});break;case"changeFloor":var heroLoc={x:core.calValue(data.loc[0]),y:core.calValue(data.loc[1])};if(core.isset(data.direction)){heroLoc.direction=data.direction}core.changeFloor(data.floorId||core.status.floorId,null,heroLoc,data.time,function(){core.lockControl();core.events.doAction()});break;case"changePos":core.clearMap("hero");if(core.isset(data.loc)){core.setHeroLoc("x",core.calValue(data.loc[0]));core.setHeroLoc("y",core.calValue(data.loc[1]))}if(core.isset(data.direction)){core.setHeroLoc("direction",data.direction)}core.drawHero();this.doAction();break;case"showImage":if(core.isset(data.loc)&&core.isset(core.material.images.images[data.name])){core.canvas.image.drawImage(core.material.images.images[data.name],core.calValue(data.loc[0]),core.calValue(data.loc[1]))}else{core.clearMap("image")}this.doAction();break;case"animateImage":if(core.status.replay.replaying){this.doAction()}else{if(core.isset(data.loc)&&core.isset(core.material.images.images[data.name])&&(data.action=="show"||data.action=="hide")){if(data.async){core.events.animateImage(data.action,core.material.images.images[data.name],data.loc,data.time,data.keep);this.doAction()}else{core.events.animateImage(data.action,core.material.images.images[data.name],data.loc,data.time,data.keep,function(){core.events.doAction()})}}else{this.doAction()}}break;case"showGif":if(core.isset(data.loc)&&core.isset(core.material.images.images[data.name])){var gif=new Image();gif.src=core.material.images.images[data.name].src;gif.style.position="absolute";gif.style.left=(core.calValue(data.loc[0])*core.domStyle.scale)+"px";gif.style.top=(core.calValue(data.loc[1])*core.domStyle.scale)+"px";gif.style.width=core.material.images.images[data.name].width*core.domStyle.scale+"px";gif.style.height=core.material.images.images[data.name].height*core.domStyle.scale+"px";core.dom.gif2.appendChild(gif)}else{core.dom.gif2.innerHTML=""}this.doAction();break;case"moveImage":if(core.status.replay.replaying){this.doAction()}else{if(core.isset(data.from)&&core.isset(data.to)&&core.isset(core.material.images.images[data.name])){if(data.async){core.events.moveImage(core.material.images.images[data.name],data.from,data.to,data.time,data.keep);this.doAction()}else{core.events.moveImage(core.material.images.images[data.name],data.from,data.to,data.time,data.keep,function(){core.events.doAction()})}}else{this.doAction()}}break;case"setFg":if(data.async){core.setFg(data.color,data.time);core.setFlag("color",data.color||null);this.doAction()}else{core.setFg(data.color,data.time,function(){core.setFlag("color",data.color||null);core.events.doAction()})}break;case"setWeather":core.setWeather(data.name,data.level);if(core.isset(data.name)){core.setFlag("weather",[data.name,data.level])}else{core.setFlag("weather",null)}this.doAction();break;case"openDoor":if(core.isset(data.loc)){x=core.calValue(data.loc[0]);y=core.calValue(data.loc[1])}var floorId=data.floorId||core.status.floorId;var block=core.getBlock(x,y,floorId);if(block!=null){if(floorId==core.status.floorId){core.openDoor(block.block.event.id,block.block.x,block.block.y,false,function(){core.events.doAction()})}else{core.removeBlock(block.block.x,block.block.y,floorId);this.doAction()}break}this.doAction();break;case"openShop":if(core.status.replay.replaying){core.status.shops[data.id].visited=true;core.status.event.data.list=[];this.doAction()}else{core.events.openShop(data.id)}break;case"disableShop":core.events.disableQuickShop(data.id);this.doAction();break;case"battle":core.battle(data.id,null,null,true,function(){core.events.doAction()});break;case"trigger":var toX=core.calValue(data.loc[0]),toY=core.calValue(data.loc[1]);var block=core.getBlock(toX,toY);if(block!=null){block=block.block;if(core.isset(block.event)&&block.event.trigger=="action"){core.status.event.data.list=[{todo:core.clone(block.event.data),total:core.clone(block.event.data),condition:"false"}];core.status.event.data.x=block.x;core.status.event.data.y=block.y}}this.doAction();break;case"playSound":if(!core.status.replay.replaying){core.playSound(data.name)}this.doAction();break;case"playBgm":core.playBgm(data.name);this.doAction();break;case"pauseBgm":core.pauseBgm();this.doAction();break;case"resumeBgm":core.resumeBgm();this.doAction();break;case"setVolume":data.value=parseInt(data.value||0);if(data.value<0){data.value=0}if(data.value>100){data.value=100}if(data.async){this.setVolume(data.value/100,data.time);this.doAction()}else{this.setVolume(data.value/100,data.time,function(){core.events.doAction()})}break;case"setValue":try{var value=core.calValue(data.value);if(data.name.indexOf("status:")==0){value=parseFloat(value);core.setStatus(data.name.substring(7),value)}if(data.name.indexOf("item:")==0){value=parseInt(value);var itemId=data.name.substring(5);if(value>core.itemCount(itemId)){core.getItem(itemId,value-core.itemCount(itemId))}else{core.setItem(itemId,value)}}if(data.name.indexOf("flag:")==0){core.setFlag(data.name.substring(5),value)}}catch(e){console.log(e)}if(core.status.hero.hp<=0){core.status.hero.hp=0;core.updateStatusBar();core.events.lose()}else{core.updateStatusBar();this.doAction()}break;case"setFloor":core.status.maps[data.floorId||core.status.floorId][data.name]=core.calValue(data.value);core.updateStatusBar();this.doAction();break;case"setHeroIcon":this.setHeroIcon(data.name);this.doAction();break;case"input":var value;if(core.status.replay.replaying){var action=core.status.replay.toReplay.shift();if(action.indexOf("input:")==0){value=parseInt(action.substring(6))}else{core.stopReplay();core.drawTip("录像文件出错");return}}else{core.interval.onDownInterval="tmp";value=prompt(core.replaceText(data.text))}value=Math.abs(parseInt(value)||0);core.status.route.push("input:"+value);core.setFlag("input",value);this.doAction();break;case"input2":var value;if(core.status.replay.replaying){var action=core.status.replay.toReplay.shift();try{if(action.indexOf("input2:")!=0){throw new Error("Input2 Error. Current action: "+action)}value=core.decodeBase64(action.substring(7))}catch(e){console.log(e);core.stopReplay();core.drawTip("录像文件出错");return}}else{core.interval.onDownInterval="tmp";value=prompt(core.replaceText(data.text));if(!core.isset(value)){value=""}}core.status.route.push("input2:"+core.encodeBase64(value));core.setFlag("input",value);this.doAction();break;case"if":if(core.calValue(data.condition)){core.events.insertAction(data["true"])}else{core.events.insertAction(data["false"])}this.doAction();break;case"choices":if(core.status.replay.replaying){if(core.status.replay.toReplay.length==0){core.status.replay.replaying=false;core.drawTip("录像回放完毕")}else{var action=core.status.replay.toReplay.shift(),index;if(action=="turn"){action=core.status.replay.toReplay.shift()}if(action.indexOf("choices:")==0&&((index=parseInt(action.substring(8)))>=0)&&index<data.choices.length){core.status.event.selection=index;setTimeout(function(){core.status.route.push("choices:"+index);core.events.insertAction(data.choices[index].action);core.events.doAction()},750/Math.max(1,core.status.replay.speed))}else{core.stopReplay();core.drawTip("录像文件出错")}}}core.ui.drawChoices(data.text,data.choices);break;case"while":if(core.calValue(data.condition)){core.unshift(core.status.event.data.list,{todo:core.clone(data.data),total:core.clone(data.data),condition:data.condition})}this.doAction();break;case"break":core.status.event.data.list.shift();this.doAction();break;case"continue":if(core.calValue(core.status.event.data.list[0].condition)){core.status.event.data.list[0].todo=core.clone(core.status.event.data.list[0].total)}else{core.status.event.data.list.shift()}this.doAction();break;case"win":core.events.win(data.reason,data.norank);break;case"lose":core.events.lose(data.reason);break;case"function":var func=data["function"];if(core.isset(func)){if((typeof func=="string")&&func.indexOf("function")==0){eval("("+func+")()")}else{if(func instanceof Function){func()}}}this.doAction();break;case"update":core.updateStatusBar();this.doAction();break;case"updateEnemys":core.enemys.updateEnemys();core.updateStatusBar();this.doAction();break;case"viberate":if(data.async){core.events.vibrate(data.time);this.doAction()}else{core.events.vibrate(data.time,function(){core.events.doAction()})}break;case"sleep":if(core.status.replay.replaying){core.events.doAction()}else{setTimeout(function(){core.events.doAction()},data.time)}break;case"wait":if(core.status.replay.replaying){var code=core.status.replay.toReplay.shift();if(code.indexOf("input:")==0){var value=parseInt(code.substring(6));core.status.route.push("input:"+value);if(value>=10000){core.setFlag("type",1);core.setFlag("x",parseInt((value-10000)/100));core.setFlag("y",value%100)}else{core.setFlag("type",0);core.setFlag("keycode",value)}core.events.doAction()}else{core.stopReplay();core.drawTip("录像文件出错")}}break;case"revisit":var block=core.getBlock(x,y);if(block!=null){block=block.block;if(core.isset(block.event)&&block.event.trigger=="action"){core.status.event.data.list=[{todo:core.clone(block.event.data),total:core.clone(block.event.data),condition:"false"}]}}this.doAction();break;case"exit":core.status.event.data.list=[];core.events.doAction();break;default:core.status.event.data.type="text";core.ui.drawTextBox("\t[警告]出错啦！\n"+data.type+" 事件不被支持...")}return};events.prototype.insertAction=function(a,c,d,b){if(core.status.event.id!="action"){this.doEvents(a,c,d,b)}else{core.unshift(core.status.event.data.list[0].todo,a);if(core.isset(c)){core.status.event.data.x=c}if(core.isset(d)){core.status.event.data.y=d}if(core.isset(b)){core.status.event.data.callback=b}}};events.prototype.getNextItem=function(){if(!core.status.heroStop||!core.flags.enableGentleClick){return false}var f=core.getHeroLoc("x"),g=core.getHeroLoc("y"),c=core.getHeroLoc("direction");if(core.isset(core.floors[core.status.floorId].cannotMove)){var b=core.floors[core.status.floorId].cannotMove[f+","+g];if(core.isset(b)&&b instanceof Array&&b.indexOf(c)>=0){return false}}var d=core.nextX(),e=core.nextY();var a=core.getBlock(d,e);if(a==null){return false}if(a.block.event.trigger=="getItem"){core.getItem(a.block.event.id,1,d,e);core.status.route.push("getNext");return true}return false};events.prototype.getItem=function(c,d,e,f,a){d=d||1;core.playSound("item.mp3");var b=core.material.items[c].cls;core.items.getItemEffect(c,d);core.removeBlock(e,f);var g="获得 "+core.material.items[c].name;if(d>1){g+="x"+d}if(b==="items"){g+=core.items.getItemEffectTip(c)}core.drawTip(g,core.material.icons.items[c]);core.canvas.event.clearRect(e*32,f*32,32,32);core.updateStatusBar();this.eventdata.afterGetItem(c,e,f,a)};events.prototype.openDoor=function(d,i,j,f,a){if(core.interval.openDoorAnimate!=null){return}if(!core.terrainExists(i,j,d)&&d!="lava"&&d!="star"){if(core.isset(a)){a()}return}if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.status.automaticRoute.moveStepBeforeStop=core.status.automaticRoute.autoStepRoutes.slice(core.status.automaticRoute.autoStep-1,core.status.automaticRoute.autoStepRoutes.length);if(core.status.automaticRoute.moveStepBeforeStop.length>=1){core.status.automaticRoute.moveStepBeforeStop[0].step-=core.status.automaticRoute.movedStep}}core.stopAutomaticRoute();var g=30;var c=d;if(c.length<4||c.substring(c.length-4)!="Door"){c=c+"Door";g=70}if(!core.isset(core.material.icons.animates[c])){if(core.isset(a)){a()}return}var e=d.replace("Door","Key");if(f&&(e=="specialKey"||core.isset(core.material.items[e]))){var e=d.replace("Door","Key");if(!core.hasItem(e)){if(e!="specialKey"){core.drawTip("你没有"+core.material.items[e].name)}else{core.drawTip("无法开启此门")}core.clearContinueAutomaticRoute();return}core.autosave(true);core.removeItem(e)}core.playSound("door.mp3");var h=0;var b=core.material.icons.animates[c];core.status.replay.animate=true;core.removeGlobalAnimate(i,j);core.interval.openDoorAnimate=window.setInterval(function(){h++;if(h==4){clearInterval(core.interval.openDoorAnimate);core.interval.openDoorAnimate=null;core.removeBlock(i,j);core.status.replay.animate=false;core.events.afterOpenDoor(d,i,j,a);return}core.canvas.event.clearRect(32*i,32*j,32,32);core.canvas.event.drawImage(core.material.images.animates,32*h,32*b,32,32,32*i,32*j,32,32)},g/core.status.replay.speed)};events.prototype.battle=function(c,d,e,b,a){if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.status.automaticRoute.moveStepBeforeStop=core.status.automaticRoute.autoStepRoutes.slice(core.status.automaticRoute.autoStep-1,core.status.automaticRoute.autoStepRoutes.length);if(core.status.automaticRoute.moveStepBeforeStop.length>=1){core.status.automaticRoute.moveStepBeforeStop[0].step-=core.status.automaticRoute.movedStep}}core.stopHero();core.stopAutomaticRoute();if(!core.enemys.canBattle(c,d,e)&&!b&&!core.isset(core.status.event.id)){core.drawTip("你打不过此怪物！");core.clearContinueAutomaticRoute();return}if(!core.isset(core.status.event.id)){core.autosave(true)}if(core.flags.battleAnimate&&!core.status.replay.replaying){core.waitHeroToStop(function(){core.ui.drawBattleAnimate(c,function(){core.events.afterBattle(c,d,e,a)})})}else{core.events.afterBattle(c,d,e,a)}};events.prototype.trigger=function(g,h){core.status.isSkiing=false;var d=core.status.thisMap.blocks;var e;for(var a=0;a<d.length;a++){if(d[a].x==g&&d[a].y==h&&!d[a].disable){e=d[a].event&&d[a].event.noPass;if(e){core.clearAutomaticRouteNode(g,h)}if(core.isset(d[a].event)&&core.isset(d[a].event.trigger)){var f=d[a].event.trigger;if(f=="ski"){core.status.isSkiing=true}if(f=="changeFloor"&&!e){var c=core.flags.portalWithoutTrigger;if(core.isset(d[a].event.data)&&core.isset(d[a].event.data.portalWithoutTrigger)){c=d[a].event.data.portalWithoutTrigger}if(c){if(core.status.replay.replaying){if(core.status.replay.toReplay[0]=="no"){core.status.replay.toReplay.shift();core.status.route.push("no");continue}}else{if(core.status.automaticRoute.autoHeroMove||core.status.automaticRoute.autoStep<core.status.automaticRoute.autoStepRoutes.length){core.status.route.push("no");continue}}}}core.status.automaticRoute.moveDirectly=false;core.material.events[f](d[a],core,function(b){})}}}};events.prototype.setFloorName=function(a){a=a||core.status.floorId;var b=core.status.maps[a].name||"";if(typeof b=="number"){b=""+b}if(!core.isset(b)||b==""){b="&nbsp;"}if(core.statusBar.floor.innerHTML==b){return}core.statusBar.floor.innerHTML=b;if(/^[+-]?\d+$/.test(b)){core.statusBar.floor.style.fontStyle="italic";core.statusBar.floor.style.fontSize="1.1em"}else{core.statusBar.floor.style.fontStyle="normal";if(b.length<=5){core.statusBar.floor.style.fontSize="1.1em"}else{if(b.length==6){core.statusBar.floor.style.fontSize="0.9em"}else{core.statusBar.floor.style.fontSize="0.7em"}}}};events.prototype.changeFloor=function(d,j,f,k,b,e){if(!core.isset(d)){d=core.status.floorId}if(d==":before"){var h=core.floorIds.indexOf(core.status.floorId);if(h>0){d=core.floorIds[h-1]}else{d=core.status.floorId}}else{if(d==":next"){var h=core.floorIds.indexOf(core.status.floorId);if(h<core.floorIds.length-1){d=core.floorIds[h+1]}else{d=core.status.floorId}}}var c=(!core.isset(k)||k>=100)&&!core.status.replay.replaying;k=k||800;k/=20;core.lockControl();core.stopHero();core.stopAutomaticRoute();core.clearContinueAutomaticRoute();core.status.replay.animate=true;core.dom.floorNameLabel.innerHTML=core.status.maps[d].title;if(!core.isset(j)&&!core.isset(f)){f=core.status.hero.loc}if(core.isset(j)){if(!core.isset(f)){f={}}if(core.isset(core.status.maps[d][j])){f.x=core.status.maps[d][j][0];f.y=core.status.maps[d][j][1]}else{var a=core.status.maps[d].blocks;for(var g in a){if(core.isset(a[g].event)&&!a[g].disable&&a[g].event.id===j){f.x=a[g].x;f.y=a[g].y;break}}}if(!core.isset(f.x)){f.x=core.status.hero.loc.x;f.y=core.status.hero.loc.y}}if(core.status.maps[d].canFlyTo&&core.status.hero.flyRange.indexOf(d)<0){core.status.hero.flyRange.push(d);core.status.hero.flyRange.sort(function(i,l){return core.floorIds.indexOf(i)-core.floorIds.indexOf(l)})}window.setTimeout(function(){var i=function(){core.events.setFloorName(d);if(core.isset(core.status.maps[d].bgm)){var l=core.status.maps[d].bgm;if(l instanceof Array){l=l[0]}core.playBgm(l)}var m=core.getFlag("color",null);if(!core.isset(m)&&core.isset(core.status.maps[d].color)){m=core.status.maps[d].color}if(core.isset(m)){core.clearMap("curtain");if(core.isset(m[3])){core.setAlpha("curtain",m[3])}else{core.setAlpha("curtain",1)}core.fillRect("curtain",0,0,416,416,core.arrayToRGB(m));core.status.curtainColor=m}else{core.clearMap("curtain");core.setAlpha("curtain",0)}var n=core.getFlag("weather",null);if(!core.isset(n)&&core.isset(core.status.maps[d].weather)){n=core.status.maps[d].weather}if(core.isset(n)){core.setWeather(n[0],n[1])}else{core.setWeather()}core.dom.gif.innerHTML="";if(!core.isset(e)){core.status.maps[d].blocks.forEach(function(o){if(o.disable&&core.isset(o.event)&&o.event.cls.indexOf("enemy")==0&&core.enemys.hasSpecial(core.material.enemys[o.event.id].special,23)){o.disable=false}})}core.maps.resizeMap(d);core.drawMap(d,function(){if(core.isset(f.direction)){core.setHeroLoc("direction",f.direction)}core.setHeroLoc("x",f.x);core.setHeroLoc("y",f.y);core.clearMap("hero");core.drawHero();var o=function(){core.unLockControl();core.status.replay.animate=false;core.events.afterChangeFloor(d,e);if(core.isset(b)){b()}};if(c){core.hide(core.dom.floorMsgGroup,k/4,function(){o()})}else{o()}})};core.playSound("floor.mp3");if(c){core.show(core.dom.floorMsgGroup,k/2,function(){i()})}else{i()}},25)};events.prototype.animateImage=function(h,c,e,g,d,b){g=g||0;if((h!="show"&&h!="hide")||g<=0){if(core.isset(b)){b()}return}clearInterval(core.interval.tipAnimate);core.setAlpha("data",1);var f=0;if(h=="hide"){f=1}if(h=="hide"&&d){core.clearMap("image")}core.setOpacity("data",f);var i=core.calValue(e[0]),j=core.calValue(e[1]);core.canvas.data.drawImage(c,i,j);core.status.replay.animate=true;var a=setInterval(function(){if(h=="show"){f+=0.1}else{f-=0.1}core.setOpacity("data",f);if(f>=1||f<=0){clearInterval(a);if(h=="show"&&d){core.canvas.image.drawImage(c,i,j)}core.clearMap("data");core.setOpacity("data",1);core.status.replay.animate=false;if(core.isset(b)){b()}}},g/10)};events.prototype.moveImage=function(g,d,k,j,h,b){j=j||1000;clearInterval(core.interval.tipAnimate);core.setAlpha("data",1);core.setOpacity("data",1);if(h){core.clearMap("image")}core.status.replay.animate=true;var e=core.calValue(d[0]),f=core.calValue(d[1]),l=core.calValue(k[0]),m=core.calValue(k[1]);var i=0;var c=function(){core.clearMap("data");var n=parseInt(e+(l-e)*i/64);var o=parseInt(f+(m-f)*i/64);core.canvas.data.drawImage(g,n,o)};c();var a=setInterval(function(){i++;c();if(i>=64){clearInterval(a);core.clearMap("data");core.status.replay.animate=false;if(h){core.canvas.data.drawImage(g,l,m)}if(core.isset(b)){b()}}},j/64)};events.prototype.setVolume=function(g,f,a){var d=function(h){core.musicStatus.volume=h;if(core.isset(core.musicStatus.playingBgm)){core.material.bgms[core.musicStatus.playingBgm].volume=h}core.musicStatus.gainNode.gain.value=h};if(!core.isset(f)||f<100){d(g);if(core.isset(a)){a()}return}core.status.replay.animate=true;var b=core.musicStatus.volume;var e=0;var c=setInterval(function(){e++;var h=b+(g-b)*e/32;d(h);if(e>=32){clearInterval(c);core.status.replay.animate=false;if(core.isset(a)){a()}}},f/32)};events.prototype.vibrate=function(i,c){if(core.isset(core.status.replay)&&core.status.replay.replaying){if(core.isset(c)){c()}return}core.status.replay.animate=true;var a=function(p,q){for(var m=0,k;k=core.dom.gameCanvas[m];m++){var l=k.getAttribute("id");if(l=="ui"||l=="data"){continue}var n=p,o=q;if(core.bigmap.canvas.indexOf(l)>=0){n-=core.bigmap.offsetX;o-=core.bigmap.offsetY}core.control.setGameCanvasTranslate(l,n,o)}};if(!core.isset(i)||i<1000){i=1000}var f=i*3/50;var h=5;var g=5;var e=1;var d=0;var j=function(){if(f>=1||d!=0){var k=(g*h*e)/10;if(f<=1&&d*(d+k)<0){d=0}else{d+=k}if(d>g*2){e=-1}if(d<-g*2){e=1}if(f>=1){f-=1}}};var b=setInterval(function(){j();a(d,0);if(f===0){clearInterval(b);core.status.replay.animate=false;if(core.isset(c)){c()}}},50/3)};events.prototype.openShop=function(shopId,needVisited){var shop=core.status.shops[shopId];shop.times=shop.times||0;shop.visited=shop.visited||false;if(needVisited&&!shop.visited){if(shop.times==0){core.drawTip("该商店尚未开启")}else{core.drawTip("该商店已失效")}return}shop.visited=true;var selection=core.status.event.selection;var actions=[];if(core.isset(core.status.event.data)&&core.isset(core.status.event.data.actions)){actions=core.status.event.data.actions}var fromList;if(core.isset(core.status.event.data)&&core.isset(core.status.event.data.fromList)){fromList=core.status.event.data.fromList}core.ui.closePanel();core.lockControl();core.status.event.id="shop";core.status.event.data={id:shopId,shop:shop,actions:actions,fromList:fromList};core.status.event.selection=selection;var content="\t["+shop.name+","+shop.icon+"]";var times=shop.times,need=eval(shop.need);content=content+shop.text.replace(/\${([^}]+)}/g,function(word,value){return eval(value)});var use=shop.use=="experience"?"经验":"金币";var choices=[];for(var i=0;i<shop.choices.length;i++){var choice=shop.choices[i];var text=choice.text;if(core.isset(choice.need)){text+="（"+eval(choice.need)+use+"）"}choices.push(text)}choices.push("离开");core.ui.drawChoices(content,choices)};events.prototype.disableQuickShop=function(a){core.status.shops[a].visited=false};events.prototype.canUseQuickShop=function(a){return this.eventdata.canUseQuickShop(a)};events.prototype.setHeroIcon=function(a,b){if(core.isset(core.material.images.images[a])&&core.material.images.images[a].width==128){core.setFlag("heroIcon",a);core.material.images.hero.onload=function(){core.material.icons.hero.height=core.material.images.images[a].height/4;core.control.updateHeroIcon(a);if(!b){core.drawHero()}};core.material.images.hero.src=core.material.images.images[a].src}};events.prototype.checkLvUp=function(){if(!core.flags.enableLevelUp||!core.isset(core.firstData.levelUp)||core.status.hero.lv>=core.firstData.levelUp.length){return}var need=(core.firstData.levelUp[core.status.hero.lv]||{}).need;if(!core.isset(need)){return}if(core.status.hero.experience>=need){core.status.hero.lv++;var effect=core.firstData.levelUp[core.status.hero.lv-1].effect;if(typeof effect=="string"){if(effect.indexOf("function")==0){eval("("+effect+")()")}else{effect.split(";").forEach(function(t){core.doEffect(t)})}}else{if(effect instanceof Function){effect()}}this.checkLvUp()}};events.prototype.useItem=function(b){core.ui.closePanel();if(b=="book"){core.openBook(false);return}if(b=="fly"){core.useFly(false);return}if(b=="centerFly"){core.lockControl();core.status.event.id="centerFly";var a="rgba(255,0,0,0.5)";if(core.canUseItem("centerFly")){a="rgba(0,255,0,0.5)"}var e=core.bigmap.width-1-core.getHeroLoc("x"),f=core.bigmap.height-1-core.getHeroLoc("y");core.ui.drawThumbnail(core.status.floorId,"ui",core.status.thisMap.blocks,0,0,416,e,f,core.status.hero.loc,core.getFlag("heroIcon","hero.png"));var c=core.clamp(e-6,0,core.bigmap.width-13),d=core.clamp(f-6,0,core.bigmap.height-13);core.fillRect("ui",(e-c)*32,(f-d)*32,32,32,a);core.status.event.data={x:e,y:f,poxX:e-c,posY:f-d};core.drawTip("请确认当前中心对称飞行器的位置");return}if(core.canUseItem(b)){core.useItem(b)}else{core.drawTip("当前无法使用"+core.material.items[b].name)}};events.prototype.addPoint=function(a){return this.eventdata.addPoint(a)};events.prototype.afterBattle=function(b,c,d,a){return this.eventdata.afterBattle(b,c,d,a)};events.prototype.afterOpenDoor=function(b,c,d,a){return this.eventdata.afterOpenDoor(b,c,d,a)};events.prototype.passNet=function(a){if(core.hasItem("shoes")){return}if(a.event.id=="lavaNet"){}if(a.event.id=="poisonNet"){if(core.hasFlag("poison")){return}core.setFlag("poison",true)}if(a.event.id=="weakNet"){if(core.hasFlag("weak")){return}core.setFlag("weak",true);var d=core.values.weakValue;var b=d>=1?d:Math.floor(d*core.status.hero.atk);var c=d>=1?d:Math.floor(d*core.status.hero.def);core.setFlag("weakAtk",b);core.setFlag("weakDef",c);core.status.hero.atk-=b;core.status.hero.def-=c}if(a.event.id=="curseNet"){if(core.hasFlag("curse")){return}core.setFlag("curse",true)}core.updateStatusBar()};events.prototype.changeLight=function(c,d){var a=core.getBlock(c,d);if(a==null){return}var b=a.index;a=a.block;if(a.event.id!="light"){return}a.id=166;a.event={cls:"terrains",id:"darkLight",noPass:true};core.drawBlock(a);this.afterChangeLight(c,d)};events.prototype.afterChangeLight=function(a,b){return this.eventdata.afterChangeLight(a,b)};events.prototype.ski=function(a){if(!core.isset(a)){a=core.status.automaticRoute.lastDirection||core.getHeroLoc("direction")}if(core.status.event.id!="ski"){core.waitHeroToStop(function(){core.status.event.id="ski";core.events.ski(a)})}else{core.moveHero(a,function(){if(core.status.event.id=="ski"&&!core.status.isSkiing){core.status.event.id=null;core.unLockControl();core.replay()}})}};events.prototype.pushBox=function(b){if(b.event.id!="box"&&b.event.id!="boxed"){return}var f={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var c=core.getHeroLoc("direction"),d=b.x+f[c].x,e=b.y+f[c].y;if(d<0||d>=core.bigmap.width||e<0||e>=core.bigmap.height){return}var a=core.getBlock(d,e,null,true);if(a!=null&&!(core.isset(a.block.event)&&a.block.event.id=="flower")){return}if(a==null){core.status.thisMap.blocks.push(core.maps.initBlock(d,e,169));a=core.getBlock(d,e)}else{a.block.id=170;a.block.event=core.maps.initBlock(null,null,170).event}core.drawBlock(a.block);if(b.event.id=="box"){core.removeBlock(b.x,b.y)}else{b.id=168;b.event=core.maps.initBlock(null,null,168).event;core.drawBlock(b)}core.updateStatusBar();core.status.replay.animate=true;core.moveHero(c,function(){core.status.replay.animate=false;core.status.route.pop();core.events.afterPushBox();core.replay()})};events.prototype.afterPushBox=function(){return this.eventdata.afterPushBox()};events.prototype.afterUseBomb=function(){return this.eventdata.afterUseBomb()};events.prototype.beforeSaveData=function(a){return this.eventdata.beforeSaveData(a)};events.prototype.afterLoadData=function(a){return this.eventdata.afterLoadData(a)};events.prototype.uploadCurrent=function(b){var a=new FormData();a.append("type","score");a.append("name",core.firstData.name);a.append("version",core.firstData.version);a.append("platform",core.platform.isPC?"PC":core.platform.isAndroid?"Android":core.platform.isIOS?"iOS":"");a.append("hard",core.encodeBase64(core.status.hard));a.append("username",core.encodeBase64(b||"current"));a.append("lv",core.status.hero.lv);a.append("hp",Math.min(core.status.hero.hp,Math.pow(2,63)));a.append("atk",core.status.hero.atk);a.append("def",core.status.hero.def);a.append("mdef",core.status.hero.mdef);a.append("money",core.status.hero.money);a.append("experience",core.status.hero.experience);a.append("steps",core.status.hero.steps);a.append("seed",core.getFlag("seed"));a.append("totalTime",Math.floor(core.status.hero.statistics.totalTime/1000));a.append("route",core.encodeRoute(core.status.route));a.append("deler","current");a.append("base64",1);core.http("POST","/games/upload.php",a)};function actions(){this.init()}actions.prototype.init=function(){};actions.prototype.onkeyDown=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying&&core.status.event.id!="save"&&(core.status.event.id||"").indexOf("book")!=0&&core.status.event.id!="viewMaps"){return}if(!core.isset(core.status.holdingKeys)){core.status.holdingKeys=[]}var c={37:true,38:true,39:true,40:true}[a.keyCode];if(c&&!core.status.lockControl){for(var b=0;b<core.status.holdingKeys.length;b++){if(core.status.holdingKeys[b]===a.keyCode){return}}core.status.holdingKeys.push(a.keyCode);this.pressKey(a.keyCode)}else{if(a.keyCode==17){core.status.ctrlDown=true}this.keyDown(a.keyCode)}};actions.prototype.onkeyUp=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying&&core.status.event.id!="save"&&(core.status.event.id||"").indexOf("book")!=0&&core.status.event.id!="viewMaps"){if(a.keyCode==27){core.stopReplay()}else{if(a.keyCode==90){core.speedDownReplay()}else{if(a.keyCode==88){core.speedUpReplay()}else{if(a.keyCode==32){core.triggerReplay()}else{if(a.keyCode==65){core.rewindReplay()}else{if(a.keyCode==83){core.saveReplay()}else{if(a.keyCode==67){core.bookReplay()}else{if(a.keyCode==33||a.keyCode==34){core.viewMapReplay()}else{if(a.keyCode>=49&&a.keyCode<=51){core.setReplaySpeed(a.keyCode-48)}else{if(a.keyCode==52){core.setReplaySpeed(6)}else{if(a.keyCode==53){core.setReplaySpeed(12)}else{if(a.keyCode==54){core.setReplaySpeed(24)}}}}}}}}}}}}return}var c={37:true,38:true,39:true,40:true}[a.keyCode];if(c&&!core.status.lockControl){for(var b=0;b<core.status.holdingKeys.length;b++){if(core.status.holdingKeys[b]===a.keyCode){core.status.holdingKeys=core.status.holdingKeys.slice(0,b).concat(core.status.holdingKeys.slice(b+1));if(b===core.status.holdingKeys.length&&core.status.holdingKeys.length!==0){core.pressKey(core.status.holdingKeys.slice(-1)[0])}break}}this.keyUp(a.keyCode)}else{if(a.keyCode==17){core.status.ctrlDown=false}this.keyUp(a.keyCode)}};actions.prototype.pressKey=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying&&core.status.event.id!="save"&&(core.status.event.id||"").indexOf("book")!=0){return}if(a===core.status.holdingKeys.slice(-1)[0]){this.keyDown(a);window.setTimeout(function(){core.pressKey(a)},30)}};actions.prototype.keyDown=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying&&core.status.event.id!="save"&&(core.status.event.id||"").indexOf("book")!=0&&core.status.event.id!="viewMaps"){return}if(core.status.lockControl){if(a==17){this.keyDownCtrl();return}if(core.status.event.id=="action"){this.keyDownAction(a);return}if(core.status.event.id=="book"){this.keyDownBook(a);return}if(core.status.event.id=="fly"){this.keyDownFly(a);return}if(core.status.event.id=="viewMaps"){this.keyDownViewMaps(a);return}if(core.status.event.id=="shop"){this.keyDownShop(a);return}if(core.status.event.id=="selectShop"){this.keyDownQuickShop(a);return}if(core.status.event.id=="equipbox"){this.keyDownEquipbox(a);return}if(core.status.event.id=="toolbox"){this.keyDownToolbox(a);return}if(core.status.event.id=="save"||core.status.event.id=="load"||core.status.event.id=="replayLoad"){this.keyDownSL(a);return}if(core.status.event.id=="switchs"){this.keyDownSwitchs(a);return}if(core.status.event.id=="settings"){this.keyDownSettings(a);return}if(core.status.event.id=="syncSave"){this.keyDownSyncSave(a);return}if(core.status.event.id=="syncSelect"){this.keyDownSyncSelect(a);return}if(core.status.event.id=="localSaveSelect"){this.keyDownLocalSaveSelect(a);return}if(core.status.event.id=="storageRemove"){this.keyDownStorageRemove(a);return}if(core.status.event.id=="cursor"){this.keyDownCursor(a);return}if(core.status.event.id=="replay"){this.keyDownReplay(a)}return}if(!core.status.played){return}switch(a){case 37:core.moveHero("left");break;case 38:core.moveHero("up");break;case 39:core.moveHero("right");break;case 40:core.moveHero("down");break;break}};actions.prototype.keyUp=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying&&core.status.event.id!="save"&&(core.status.event.id||"").indexOf("book")!=0&&core.status.event.id!="viewMaps"){return}if(core.status.lockControl){core.status.holdingKeys=[];if(core.status.event.id=="text"&&(a==13||a==32||a==67)){core.drawText();return}if(core.status.event.id=="confirmBox"){this.keyUpConfirmBox(a);return}if(core.status.event.id=="action"){this.keyUpAction(a);return}if(core.status.event.id=="about"&&(a==13||a==32||a==67)){this.clickAbout();return}if(core.status.event.id=="book"){this.keyUpBook(a);return}if(core.status.event.id=="book-detail"&&(a==13||a==32||a==67)){this.clickBookDetail();return}if(core.status.event.id=="fly"){this.keyUpFly(a);return}if(core.status.event.id=="viewMaps"){this.keyUpViewMaps(a);return}if(core.status.event.id=="shop"){this.keyUpShop(a);return}if(core.status.event.id=="selectShop"){this.keyUpQuickShop(a);return}if(core.status.event.id=="toolbox"){this.keyUpToolbox(a);return}if(core.status.event.id=="equipbox"){this.keyUpEquipbox(a);return}if(core.status.event.id=="save"||core.status.event.id=="load"||core.status.event.id=="replayLoad"){this.keyUpSL(a);return}if(core.status.event.id=="switchs"){this.keyUpSwitchs(a);return}if(core.status.event.id=="settings"){this.keyUpSettings(a);return}if(core.status.event.id=="syncSave"){this.keyUpSyncSave(a);return}if(core.status.event.id=="syncSelect"){this.keyUpSyncSelect(a);return}if(core.status.event.id=="localSaveSelect"){this.keyUpLocalSaveSelect(a);return}if(core.status.event.id=="storageRemove"){this.keyUpStorageRemove(a);return}if(core.status.event.id=="cursor"){this.keyUpCursor(a);return}if(core.status.event.id=="replay"){this.keyUpReplay(a);return}if(core.status.event.id=="centerFly"){this.keyUpCenterFly(a);return}return}if(!core.status.played){return}switch(a){case 27:if(core.status.heroStop){core.openSettings(true)}break;case 71:if(core.status.heroStop){core.useFly(true)}break;case 81:if(core.status.heroStop){core.openEquipbox(true)}break;case 88:if(core.status.heroStop){core.openBook(true)}break;case 65:if(core.status.heroStop){core.doSL("autoSave","load")}break;case 66:if(core.status.heroStop){core.ui.drawStatistics()}break;case 83:if(core.status.heroStop){core.save(true)}break;case 68:if(core.status.heroStop){core.load(true)}break;case 69:if(core.status.heroStop){core.ui.drawCursor()}break;case 84:if(core.status.heroStop){core.openToolbox(true)}break;case 90:if(core.status.heroStop){core.turnHero()}break;case 75:case 86:if(core.status.heroStop){core.openQuickShop(true)}break;case 32:if(core.status.heroStop){core.getNextItem()}break;case 72:if(core.status.heroStop){core.ui.drawHelp()}break;case 82:if(core.status.heroStop){if(core.hasFlag("debug")){core.drawText("\t[系统提示]调试模式下无法回放录像")}else{core.ui.drawReplay()}}break;case 33:case 34:if(core.status.heroStop){if(core.flags.enableViewMaps){core.ui.drawMaps()}else{core.drawTip("本塔不允许浏览地图！")}}break;case 37:break;case 38:break;case 39:break;case 40:break;case 49:if(core.status.heroStop&&core.hasItem("pickaxe")){if(core.canUseItem("pickaxe")){core.useItem("pickaxe")}else{core.drawTip("当前不能使用破墙镐")}}break;case 50:if(core.status.heroStop){if(core.hasItem("bomb")){if(core.canUseItem("bomb")){core.useItem("bomb")}else{core.drawTip("当前不能使用炸弹")}}else{if(core.hasItem("hammer")){if(core.canUseItem("hammer")){core.useItem("hammer")}else{core.drawTip("当前不能使用圣锤")}}}}break;case 51:if(core.status.heroStop&&core.hasItem("centerFly")){core.events.useItem("centerFly")}break}if(core.isset(core.status.automaticRoute)&&core.status.automaticRoute.autoHeroMove){core.stopAutomaticRoute()}core.stopHero()};actions.prototype.ondown=function(b,c){if(core.isset(core.status.replay)&&core.status.replay.replaying&&core.status.event.id!="save"&&(core.status.event.id||"").indexOf("book")!=0&&core.status.event.id!="viewMaps"){return}if(!core.status.played||core.status.lockControl){this.onclick(b,c,[]);if(core.timeout.onDownTimeout==null){core.timeout.onDownTimeout=setTimeout(function(){if(core.interval.onDownInterval==null){core.interval.onDownInterval=setInterval(function(){if(!core.actions.longClick(b,c,true)){clearInterval(core.interval.onDownInterval);core.interval.onDownInterval=null}},40)}},500)}return}core.status.downTime=new Date();core.clearMap("route");var a={x:b,y:c};core.status.stepPostfix=[];core.status.stepPostfix.push(a);core.fillPosWithPoint(a)};actions.prototype.onmove=function(g,h){if(core.isset(core.status.replay)&&core.status.replay.replaying&&core.status.event.id!="save"&&(core.status.event.id||"").indexOf("book")!=0&&core.status.event.id!="viewMaps"){return}var e={x:g,y:h};var f=core.status.stepPostfix[core.status.stepPostfix.length-1];var a=[e.y-f.y,f.x-e.x,f.y-e.y,e.x-f.x];var d=0,c=4;for(var b=0;b<4;b++){if(a[b]>d){c=b;d=a[b]}}e=[{x:0,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:0},false][c];if(e){e.x+=f.x;e.y+=f.y;core.status.stepPostfix.push(e);core.fillPosWithPoint(e)}};actions.prototype.onup=function(){if(core.isset(core.status.replay)&&core.status.replay.replaying&&core.status.event.id!="save"&&(core.status.event.id||"").indexOf("book")!=0&&core.status.event.id!="viewMaps"){return}clearTimeout(core.timeout.onDownTimeout);core.timeout.onDownTimeout=null;clearInterval(core.interval.onDownInterval);core.interval.onDownInterval=null;if(core.status.stepPostfix.length>0){var g=[];var a={"0":{"1":"down","-1":"up"},"-1":{"0":"left"},"1":{"0":"right"}};for(var b=1;b<core.status.stepPostfix.length;b++){var d=core.status.stepPostfix[b-1];var c=core.status.stepPostfix[b];g.push({direction:a[c.x-d.x][c.y-d.y],x:c.x+parseInt(core.bigmap.offsetX/32),y:c.y+parseInt(core.bigmap.offsetY/32)})}var e=core.status.stepPostfix[0].x;var f=core.status.stepPostfix[0].y;core.status.stepPostfix=[];if(!core.status.lockControl){core.clearMap("route");core.canvas.route.restore()}if(!core.status.lockControl&&g.length==0&&core.status.downTime!=null&&new Date()-core.status.downTime>=1000){this.longClick(e,f)}else{this.onclick(e,f,g)}core.status.downTime=null}};actions.prototype.getClickLoc=function(f,g){var d={x:0,y:0};var c=32;c=c*core.domStyle.scale;switch(core.domStyle.screenMode){case"vertical":d.x=0;d.y=core.dom.statusBar.offsetHeight+3;break;case"horizontal":case"bigScreen":d.x=core.dom.statusBar.offsetWidth+3;d.y=0;break}var a=core.dom.gameGroup.offsetLeft+d.x;var e=core.dom.gameGroup.offsetTop+d.y;var b={x:f-a,y:g-e,size:c};return b};actions.prototype.onclick=function(b,c,a){if(core.isset(core.status.replay)&&core.status.replay.replaying&&core.status.event.id!="save"&&(core.status.event.id||"").indexOf("book")!=0&&core.status.event.id!="viewMaps"){return}a=a||[];if(b<0||c<0||b>12||c>12){return}if(!core.status.lockControl){core.setAutomaticRoute(b+parseInt(core.bigmap.offsetX/32),c+parseInt(core.bigmap.offsetY/32),a);return}if(core.status.event.id=="centerFly"){this.clickCenterFly(b,c);return}if(core.status.event.id=="book"){this.clickBook(b,c);return}if(core.status.event.id=="book-detail"){this.clickBookDetail(b,c);return}if(core.status.event.id=="fly"){this.clickFly(b,c);return}if(core.status.event.id=="viewMaps"){this.clickViewMaps(b,c);return}if(core.status.event.id=="switchs"){this.clickSwitchs(b,c);return}if(core.status.event.id=="settings"){this.clickSettings(b,c);return}if(core.status.event.id=="shop"){this.clickShop(b,c);return}if(core.status.event.id=="selectShop"){this.clickQuickShop(b,c);return}if(core.status.event.id=="equipbox"){this.clickEquipbox(b,c);return}if(core.status.event.id=="toolbox"){this.clickToolbox(b,c);return}if(core.status.event.id=="save"||core.status.event.id=="load"||core.status.event.id=="replayLoad"){this.clickSL(b,c);return}if(core.status.event.id=="confirmBox"){this.clickConfirmBox(b,c);return}if(core.status.event.id=="keyBoard"){this.clickKeyBoard(b,c);return}if(core.status.event.id=="about"){this.clickAbout(b,c);return}if(core.status.event.id=="action"){this.clickAction(b,c);return}if(core.status.event.id=="text"){core.drawText();return}if(core.status.event.id=="syncSave"){this.clickSyncSave(b,c);return}if(core.status.event.id=="syncSelect"){this.clickSyncSelect(b,c);return}if(core.status.event.id=="localSaveSelect"){this.clickLocalSaveSelect(b,c);return}if(core.status.event.id=="storageRemove"){this.clickStorageRemove(b,c);return}if(core.status.event.id=="cursor"){this.clickCursor(b,c);return}if(core.status.event.id=="replay"){this.clickReplay(b,c);return}};actions.prototype.onmousewheel=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying&&core.status.event.id!="save"&&(core.status.event.id||"").indexOf("book")!=0&&core.status.event.id!="viewMaps"){if(a==1){core.speedUpReplay()}if(a==-1){core.speedDownReplay()}return}if(core.status.lockControl&&core.status.event.id=="fly"){if(a==1){core.ui.drawFly(core.status.event.data+1)}if(a==-1){core.ui.drawFly(core.status.event.data-1)}return}if(core.status.lockControl&&core.status.event.id=="book"){if(a==1){core.ui.drawBook(core.status.event.data-6)}if(a==-1){core.ui.drawBook(core.status.event.data+6)}return}if(core.status.lockControl&&(core.status.event.id=="save"||core.status.event.id=="load")){if(a==1){core.ui.drawSLPanel(core.status.event.data-10)}if(a==-1){core.ui.drawSLPanel(core.status.event.data+10)}return}if(core.status.lockControl&&core.status.event.id=="viewMaps"){if(a==1){this.clickViewMaps(6,3)}if(a==-1){this.clickViewMaps(6,9)}return}};actions.prototype.longClick=function(b,c,a){if(!core.isPlaying()){return false}if(core.status.lockControl){if(core.status.event.id=="text"){core.drawText();return true}if(core.status.event.id=="action"&&core.status.event.data.type=="text"){core.doAction();return true}}else{if(!a){core.waitHeroToStop(function(){core.ui.drawKeyBoard()})}}return false};actions.prototype.keyDownCtrl=function(){if(core.status.event.id=="text"){core.drawText();return}if(core.status.event.id=="action"&&core.status.event.data.type=="text"){core.doAction();return}};actions.prototype.clickCenterFly=function(a,b){if(a==core.status.event.data.poxX&&b==core.status.event.data.posY){if(core.canUseItem("centerFly")){core.useItem("centerFly")}else{core.drawTip("当前不能使用中心对称飞行器")}}core.ui.closePanel()};actions.prototype.keyUpCenterFly=function(a){if(a==51||a==13||a==32||a==67){if(core.canUseItem("centerFly")){core.useItem("centerFly")}else{core.drawTip("当前不能使用中心对称飞行器")}}core.ui.closePanel()};actions.prototype.clickConfirmBox=function(a,b){if((a==4||a==5)&&b==7&&core.isset(core.status.event.data.yes)){core.status.event.data.yes()}if((a==7||a==8)&&b==7&&core.isset(core.status.event.data.no)){core.status.event.data.no()}};actions.prototype.keyUpConfirmBox=function(a){if(a==37){core.status.event.selection=0;core.ui.drawConfirmBox(core.status.event.ui,core.status.event.data.yes,core.status.event.data.no)}if(a==39){core.status.event.selection=1;core.ui.drawConfirmBox(core.status.event.ui,core.status.event.data.yes,core.status.event.data.no)}if(a==13||a==32||a==67){if(core.status.event.selection==0&&core.isset(core.status.event.data.yes)){core.status.event.selection=null;core.status.event.data.yes()}if(core.status.event.selection==1&&core.isset(core.status.event.data.no)){core.status.event.selection=null;core.status.event.data.no()}}};actions.prototype.clickAction=function(d,e){if(core.status.event.data.type=="text"){if(core.status.event.interval!=null){core.insertAction({type:"text",text:core.status.event.ui,showAll:true})}core.doAction();return}if(core.status.event.data.type=="wait"){core.setFlag("type",1);core.setFlag("x",d);core.setFlag("y",e);core.status.route.push("input:"+(10000+100*d+e));core.doAction();return}if(core.status.event.data.type=="choices"){var b=core.status.event.data.current;var a=b.choices;if(a.length==0){return}if(d>=5&&d<=7){var c=6-parseInt((a.length-1)/2);if(e>=c&&e<c+a.length){core.status.route.push("choices:"+(e-c));core.insertAction(a[e-c].action);core.doAction()}}}};actions.prototype.keyDownAction=function(c){if(core.status.event.data.type=="choices"){var b=core.status.event.data.current;var a=b.choices;if(a.length>0){if(c==38){core.status.event.selection--;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}if(c==40){core.status.event.selection++;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}}}};actions.prototype.keyUpAction=function(c){if(core.status.event.data.type=="text"&&(c==13||c==32||c==67)){if(core.status.event.interval!=null){core.insertAction({type:"text",text:core.status.event.ui,showAll:true})}core.doAction();return}if(core.status.event.data.type=="wait"){core.setFlag("type",0);core.setFlag("keycode",c);core.status.route.push("input:"+c);core.doAction();return}if(core.status.event.data.type=="choices"){var b=core.status.event.data.current;var a=b.choices;if(a.length>0){if(c==13||c==32||c==67){core.status.route.push("choices:"+core.status.event.selection);core.insertAction(a[core.status.event.selection].action);core.doAction()}}}};actions.prototype.clickBook=function(d,e){if((d==3||d==4)&&e==12){core.ui.drawBook(core.status.event.data-6);return}if((d==8||d==9)&&e==12){core.ui.drawBook(core.status.event.data+6);return}if(d>=10&&d<=12&&e==12){if(core.status.event.selection==null){core.ui.closePanel()}else{core.status.boxAnimateObjs=[];core.ui.drawMaps(core.status.event.selection)}return}var a=core.status.event.data;if(core.isset(a)&&e<12){var c=parseInt(a/6);var b=6*c+parseInt(e/2);core.ui.drawBook(b);core.ui.drawBookDetail(b)}return};actions.prototype.keyDownBook=function(a){if(a==37){core.ui.drawBook(core.status.event.data-6)}if(a==38){core.ui.drawBook(core.status.event.data-1)}if(a==39){core.ui.drawBook(core.status.event.data+6)}if(a==40){core.ui.drawBook(core.status.event.data+1)}if(a==33){core.ui.drawBook(core.status.event.data-6)}if(a==34){core.ui.drawBook(core.status.event.data+6)}return};actions.prototype.keyUpBook=function(b){if(b==27||b==88){if(core.status.event.selection==null){core.ui.closePanel()}else{core.status.boxAnimateObjs=[];core.ui.drawMaps(core.status.event.selection)}return}if(b==13||b==32||b==67){var a=core.status.event.data;if(core.isset(a)){this.clickBook(6,2*(a%6))}return}};actions.prototype.clickBookDetail=function(){core.clearMap("data");core.status.event.id="book"};actions.prototype.clickFly=function(a,b){if((a==10||a==11)&&b==9){core.ui.drawFly(core.status.event.data-1)}if((a==10||a==11)&&b==5){core.ui.drawFly(core.status.event.data+1)}if((a==10||a==11)&&b==10){core.ui.drawFly(core.status.event.data-10)}if((a==10||a==11)&&b==4){core.ui.drawFly(core.status.event.data+10)}if(a>=5&&a<=7&&b==12){core.ui.closePanel()}if(a>=0&&a<=9&&b>=3&&b<=11){core.control.flyTo(core.status.hero.flyRange[core.status.event.data])}return};actions.prototype.keyDownFly=function(a){if(a==37){core.ui.drawFly(core.status.event.data-10)}else{if(a==38){core.ui.drawFly(core.status.event.data+1)}else{if(a==39){core.ui.drawFly(core.status.event.data+10)}else{if(a==40){core.ui.drawFly(core.status.event.data-1)}}}}return};actions.prototype.keyUpFly=function(a){if(a==71||a==27||a==88){core.ui.closePanel()}if(a==13||a==32||a==67){this.clickFly(5,5)}return};actions.prototype.clickViewMaps=function(h,i){if(!core.isset(core.status.event.data)){core.ui.drawMaps(core.floorIds.indexOf(core.status.floorId));return}var g=core.floorIds.indexOf(core.status.floorId);var d=core.status.event.data.index;var a=core.status.event.data.x,b=core.status.event.data.y;var c=core.floorIds[d],f=core.floors[c].width||13,e=core.floors[c].height||13;if(h==0&&i==0){core.status.event.data.damage=!core.status.event.data.damage;core.ui.drawMaps(d,a,b);return}if(h>=2&&h<=10&&i<=1&&e>13){core.ui.drawMaps(d,a,b-1);return}if(h>=2&&h<=10&&i>=11&&e>13){core.ui.drawMaps(d,a,b+1);return}if(h<=1&&i>=2&&i<=10){core.ui.drawMaps(d,a-1,b);return}if(h>=11&&i>=2&&i<=10){core.ui.drawMaps(d,a+1,b);return}if(i<=4&&(e==13||(h>=2&&h<=10))){d++;while(d<core.floorIds.length&&d!=g&&core.status.maps[core.floorIds[d]].cannotViewMap){d++}if(d<core.floorIds.length){core.ui.drawMaps(d)}}else{if(i>=8&&(e==13||(h>=2&&h<=10))){d--;while(d>=0&&d!=g&&core.status.maps[core.floorIds[d]].cannotViewMap){d--}if(d>=0){core.ui.drawMaps(d)}}else{if(h>=2&&h<=10&&i>=5&&i<=7){core.clearMap("data");core.setOpacity("data",1);core.ui.closePanel()}}}};actions.prototype.keyDownViewMaps=function(b){if(!core.isset(core.status.event.data)){return}var a=core.floorIds[core.status.event.data.index],c=core.floors[a].height||13;if(b==38||b==33){this.clickViewMaps(6,3)}if(b==40||b==34){this.clickViewMaps(6,9)}if(b==87&&c>13){this.clickViewMaps(6,0)}if(b==65){this.clickViewMaps(0,6)}if(b==83&&c>13){this.clickViewMaps(6,12)}if(b==68){this.clickViewMaps(12,6)}return};actions.prototype.keyUpViewMaps=function(a){if(!core.isset(core.status.event.data)){core.ui.drawMaps(core.floorIds.indexOf(core.status.floorId));return}if(a==27||a==13||a==32||(!core.status.replay.replaying&&a==67)){core.clearMap("data");core.setOpacity("data",1);core.ui.closePanel()}if(a==86){core.status.event.data.damage=!core.status.event.data.damage;core.ui.drawMaps(core.status.event.data.index,core.status.event.data.x,core.status.event.data.y)}if(a==88||(core.status.replay.replaying&&a==67)){if(core.isset(core.status.replay)&&core.status.replay.replaying){core.bookReplay()}else{core.openBook(false)}}return};actions.prototype.clickShop=function(x,y){var shop=core.status.event.data.shop;var choices=shop.choices;if(x>=5&&x<=7){var topIndex=6-parseInt(choices.length/2);if(y>=topIndex&&y<topIndex+choices.length){core.status.event.selection=y-topIndex;var money=core.getStatus("money"),experience=core.getStatus("experience");var times=shop.times,need=eval(shop.need);var use=shop.use;var use_text=use=="money"?"金币":"经验";var choice=choices[y-topIndex];if(core.isset(choice.need)){need=eval(choice.need)}if(need>eval(use)){core.drawTip("你的"+use_text+"不足");return false}core.status.event.data.actions.push(y-topIndex);eval(use+"-="+need);core.setStatus("money",money);core.setStatus("experience",experience);choice.effect.split(";").forEach(function(t){core.doEffect(t)});core.updateStatusBar();shop.times++;core.events.openShop(core.status.event.data.id)}else{if(y==topIndex+choices.length){if(core.status.event.data.actions.length>0){core.status.route.push("shop:"+core.status.event.data.id+":"+core.status.event.data.actions.join(""))}core.status.event.data.actions=[];core.status.boxAnimateObjs=[];if(core.status.event.data.fromList){core.ui.drawQuickShop()}else{core.ui.closePanel()}}else{return false}}}return true};actions.prototype.keyDownShop=function(a){if(a==38){core.status.event.selection--;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}if(a==40){core.status.event.selection++;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}};actions.prototype.keyUpShop=function(b){if(b==27||b==88){if(core.status.event.data.actions.length>0){core.status.route.push("shop:"+core.status.event.data.id+":"+core.status.event.data.actions.join(""))}core.status.event.data.actions=[];core.status.boxAnimateObjs=[];if(core.status.event.data.fromList){core.ui.drawQuickShop()}else{core.ui.closePanel()}return}var c=core.status.event.data.shop;var a=c.choices;if(b==13||b==32||b==67){var d=6-parseInt(a.length/2);this.clickShop(6,d+core.status.event.selection)}return};actions.prototype.clickQuickShop=function(e,f){var c=core.status.shops,a=Object.keys(c);if(e>=5&&e<=7){var d=6-parseInt(a.length/2);if(f>=d&&f<d+a.length){var b=core.events.canUseQuickShop(a[f-d]);if(core.isset(b)){core.drawText(b);return}core.events.openShop(a[f-d],true);if(core.status.event.id=="shop"){core.status.event.data.fromList=true}}else{if(f==d+a.length){core.ui.closePanel()}}}};actions.prototype.keyDownQuickShop=function(a){if(a==38){core.status.event.selection--;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}if(a==40){core.status.event.selection++;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}};actions.prototype.keyUpQuickShop=function(a){if(a==27||a==75||a==88||a==86){core.ui.closePanel();return}var c=core.status.shops,b=Object.keys(c);if(a==13||a==32||a==67){var d=6-parseInt(b.length/2);this.clickQuickShop(6,d+core.status.event.selection)}return};actions.prototype.clickToolbox=function(d,e){if(d>=10&&d<=12&&e==0){core.ui.closePanel();core.openEquipbox();return}if(d>=10&&d<=12&&e==12){core.ui.closePanel();return}var c=core.status.event.data.toolsPage;var a=core.status.event.data.constantsPage;if(d==3||d==4){if(e==7&&c>1){core.status.event.data.toolsPage--;core.ui.drawToolbox(core.status.event.selection)}if(e==12&&a>1){core.status.event.data.toolsPage--;core.ui.drawToolbox(core.status.event.selection)}}if(d==8||d==9){if(e==7&&c<Math.ceil(Object.keys(core.status.hero.items.tools).length/12)){core.status.event.data.toolsPage++;core.ui.drawToolbox(core.status.event.selection)}if(e==12&&a<Math.ceil(Object.keys(core.status.hero.items.constants).length/12)){core.status.event.data.constantsPage++;core.ui.drawToolbox(core.status.event.selection)}}var b=parseInt(d/2);if(e==4){b+=0}else{if(e==6){b+=6}else{if(e==9){b+=12}else{if(e==11){b+=18}else{b=-1}}}}if(b>=0){this.clickToolboxIndex(b)}};actions.prototype.clickToolboxIndex=function(a){var c=null;var d;if(a<12){d=a+12*(core.status.event.data.toolsPage-1);c=Object.keys(core.status.hero.items.tools).sort()}else{d=a%12+12*(core.status.event.data.constantsPage-1);c=Object.keys(core.status.hero.items.constants).sort()}if(c==null){return}if(d>=c.length){return}var b=c[d];if(b==core.status.event.data.selectId){core.events.useItem(b)}else{core.ui.drawToolbox(a)}};actions.prototype.keyDownToolbox=function(f){if(!core.isset(core.status.event.data)){return}var h=Object.keys(core.status.hero.items.tools).sort();var a=Object.keys(core.status.hero.items.constants).sort();var e=core.status.event.selection;var j=core.status.event.data.toolsPage;var c=core.status.event.data.constantsPage;var k=Math.ceil(h.length/12);var d=Math.ceil(a.length/12);var i=j<k?11:(h.length+11)%12;var b=12+(c<d?11:(a.length+11)%12);if(f==37){if(e==0){if(j>1){core.status.event.data.toolsPage--;e=11}else{return}}else{if(e==12){if(c==1){if(k==0){return}core.status.event.data.toolsPage=k;e=(h.length+11)%12}else{core.status.event.data.constantsPage--;e=23}}else{e-=1}}this.clickToolboxIndex(e);return}if(f==38){if(e>=12&&e<=17){if(k==0){return}if(i>=6){e=Math.min(i,e-6)}else{e=Math.min(i,e-12)}}else{if(e<6){return}else{e-=6}}this.clickToolboxIndex(e);return}if(f==39){if(j<k&&e==11){core.status.event.data.toolsPage++;e=0}else{if(c<d&&e==23){core.status.event.data.constantsPage++;e=12}else{if(e==i){if(d==0){return}core.status.event.data.constantsPage=1;e=12}else{if(e==b){return}else{e++}}}}this.clickToolboxIndex(e);return}if(f==40){var g=null;if(e<=5){if(i>5){g=Math.min(i,e+6)}else{e+=6}}if(g==null&&e<=11){if(d==0){return}g=Math.min(e+6,b)}if(g==null&&e<=17){if(b>17){g=Math.min(b,e+6)}}if(g!=null){this.clickToolboxIndex(g)}return}};actions.prototype.keyUpToolbox=function(a){if(a==81){core.ui.closePanel();core.openEquipbox();return}if(a==84||a==27||a==88){core.ui.closePanel();return}if(!core.isset(core.status.event.data)){return}if(a==13||a==32||a==67){this.clickToolboxIndex(core.status.event.selection);return}};actions.prototype.clickEquipbox=function(d,e){if(d>=10&&d<=12&&e==0){core.ui.closePanel();core.openToolbox();return}if(d>=10&&d<=12&&e==12){core.ui.closePanel();return}var c=core.status.event.data.page;if((d==3||d==4)&&e==12){if(c>1){core.status.event.data.page--;core.ui.drawEquipbox(core.status.event.selection)}return}if((d==8||d==9)&&e==12){var b=Math.ceil(Object.keys(core.status.hero.items.equips).length/12);if(c<b){core.status.event.data.page++;core.ui.drawEquipbox(core.status.event.selection)}return}var a=parseInt(d/2);if(e==4){a+=0}else{if(e==6){a+=6}else{if(e==9){a+=12}else{if(e==11){a+=18}else{a=-1}}}}if(a>=0){if(a<12){a=parseInt(a/2)}this.clickEquipboxIndex(a)}};actions.prototype.clickEquipboxIndex=function(c){if(c<6){if(c>=(main.equipName||[]).length){return}if(c==core.status.event.selection&&core.isset(core.status.hero.equipment[c])){core.unloadEquip(c);core.status.route.push("unEquip:"+c)}}else{if(c>=12){var b=Object.keys(core.status.hero.items.equips||{}).sort();if(c==core.status.event.selection){var a=b[c-12+(core.status.event.data.page-1)*12];core.loadEquip(a);core.status.route.push("equip:"+a)}}}core.ui.drawEquipbox(c)};actions.prototype.keyDownEquipbox=function(c){if(!core.isset(core.status.event.data)){return}var a=(main.equipName||[]).length;var d=Object.keys(core.status.hero.items.equips).sort();var b=core.status.event.selection;var e=core.status.event.data.page;var g=Math.ceil(d.length/12);var f=12+(e<g?11:(d.length+11)%12);if(c==37){if(b==0){return}if(b==12){if(e>1){core.status.event.data.page--;b=23}else{if(e==1){b=a-1}else{return}}}else{b-=1}this.clickEquipboxIndex(b);return}if(c==38){if(b<3){return}else{if(b<6){b-=3}else{if(b<18){b=parseInt((b-12)/2);if(a>3){b=Math.min(a-1,b+3)}else{b=Math.min(a-1,b)}}else{b-=6}}}this.clickEquipboxIndex(b);return}if(c==39){if(e<g&&b==23){core.status.event.data.page++;b=12}else{if(b==a-1){if(g==0){return}b=12}else{if(b==f){return}else{b++}}}this.clickEquipboxIndex(b);return}if(c==40){if(b<3){if(a>3){b=Math.min(b+3,a-1)}else{if(g==0){return}b=Math.min(2*b+1+12,f)}}else{if(b<6){if(g==0){return}b=Math.min(2*(b-3)+1+12,f)}else{if(b<18){b=Math.min(b+6,f)}else{return}}}this.clickEquipboxIndex(b);return}};actions.prototype.keyUpEquipbox=function(a){if(a==84){core.ui.closePanel();core.openToolbox();return}if(a==81||a==27||a==88){core.ui.closePanel();return}if(!core.isset(core.status.event.data.selectId)){return}if(a==13||a==32||a==67){this.clickEquipboxIndex(core.status.event.selection);return}};actions.prototype.clickSL=function(e,f){var b=core.status.event.data;var d=parseInt(b/10),c=b%10;if((e==3||e==4)&&f==12){core.ui.drawSLPanel(10*(d-1)+c);return}if((e==8||e==9)&&f==12){core.ui.drawSLPanel(10*(d+1)+c);return}if(e>=10&&e<=12&&f==12){core.ui.closePanel();if(!core.isPlaying()){core.showStartAnimate()}return}if(e>=0&&e<=2&&f==12){if(core.status.event.id=="save"){core.status.event.selection=!core.status.event.selection;core.ui.drawSLPanel(b)}else{var b=parseInt(prompt("请输入读档编号"))||0;if(b>0){core.doSL(b,core.status.event.id)}}return}var a=null;if(f>=1&&f<=4){if(e>=1&&e<=3){a="autoSave"}if(e>=5&&e<=7){a=5*d+1}if(e>=9&&e<=11){a=5*d+2}}if(f>=7&&f<=10){if(e>=1&&e<=3){a=5*d+3}if(e>=5&&e<=7){a=5*d+4}if(e>=9&&e<=11){a=5*d+5}}if(a!=null){if(core.status.event.selection){if(a=="autoSave"){core.drawTip("无法删除自动存档！")}else{core.removeLocalForage("save"+a,function(){core.ui.drawSLPanel(b,true)},function(){core.drawTip("无法删除存档！")})}}else{core.doSL(a,core.status.event.id)}}};actions.prototype.keyDownSL=function(b){var a=core.status.event.data;var d=parseInt(a/10),c=a%10;if(b==37){if(c==0){core.ui.drawSLPanel(10*(d-1)+5)}else{core.ui.drawSLPanel(a-1)}return}if(b==38){if(c<3){core.ui.drawSLPanel(10*(d-1)+c+3)}else{core.ui.drawSLPanel(a-3)}return}if(b==39){if(c==5){core.ui.drawSLPanel(10*(d+1)+1)}else{core.ui.drawSLPanel(a+1)}return}if(b==40){if(c>=3){core.ui.drawSLPanel(10*(d+1)+c-3)}else{core.ui.drawSLPanel(a+3)}return}if(b==33){core.ui.drawSLPanel(10*(d-1)+c);return}if(b==34){core.ui.drawSLPanel(10*(d+1)+c);return}};actions.prototype.keyUpSL=function(b){var a=core.status.event.data;var d=parseInt(a/10),c=a%10;if(b==27||b==88||(core.status.event.id=="save"&&b==83)||(core.status.event.id=="load"&&b==68)){core.ui.closePanel();if(!core.isPlaying()){core.showStartAnimate()}return}if(b==13||b==32||b==67){if(c==0){core.doSL("autoSave",core.status.event.id)}else{core.doSL(5*d+c,core.status.event.id)}return}if(b==69&&core.status.event.id=="load"){var a=parseInt(prompt("请输入读档编号"))||0;if(a>0){core.doSL(a,core.status.event.id)}return}if(b==46){if(c==0){core.drawTip("无法删除自动存档！")}else{core.removeLocalForage("save"+(5*d+c),function(){core.ui.drawSLPanel(a,true)},function(){core.drawTip("无法删除存档！")})}}};actions.prototype.clickSwitchs=function(d,e){if(d<5||d>7){return}var a=core.status.event.ui.choices;var c=6-parseInt((a.length-1)/2);if(e>=c&&e<c+a.length){var b=e-c;switch(b){case 0:core.musicStatus.bgmStatus=!core.musicStatus.bgmStatus;if(core.musicStatus.bgmStatus){core.resumeBgm()}else{core.pauseBgm();core.musicStatus.playingBgm=null}core.setLocalStorage("bgmStatus",core.musicStatus.bgmStatus);core.ui.drawSwitchs();break;case 1:core.musicStatus.soundStatus=!core.musicStatus.soundStatus;core.setLocalStorage("soundStatus",core.musicStatus.soundStatus);core.ui.drawSwitchs();break;case 2:if(!core.flags.canOpenBattleAnimate){core.drawTip("本塔不能开启战斗动画！")}else{core.flags.battleAnimate=!core.flags.battleAnimate;core.setLocalStorage("battleAnimate",core.flags.battleAnimate);core.ui.drawSwitchs()}break;case 3:core.flags.displayEnemyDamage=!core.flags.displayEnemyDamage;core.updateDamage();core.setLocalStorage("enemyDamage",core.flags.displayEnemyDamage);core.ui.drawSwitchs();break;case 4:core.flags.displayCritical=!core.flags.displayCritical;core.updateDamage();core.setLocalStorage("critical",core.flags.displayCritical);core.ui.drawSwitchs();break;case 5:core.flags.displayExtraDamage=!core.flags.displayExtraDamage;core.updateDamage();core.setLocalStorage("extraDamage",core.flags.displayExtraDamage);core.ui.drawSwitchs();break;case 6:core.flags.clickMoveDirectly=!core.flags.clickMoveDirectly;core.setLocalStorage("clickMoveDirectly",core.flags.clickMoveDirectly);core.ui.drawSwitchs();break;case 7:core.platform.useLocalForage=!core.platform.useLocalForage;core.setLocalStorage("useLocalForage",core.platform.useLocalForage);core.ui.drawSwitchs();break;case 8:window.open(core.platform.isPC?"editor.html":"editor-mobile.html","_blank");break;case 9:window.open(core.firstData.name+".zip","_blank");break;case 10:core.status.event.selection=0;core.ui.drawSettings();break}}};actions.prototype.keyDownSwitchs=function(a){if(a==38){core.status.event.selection--;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}if(a==40){core.status.event.selection++;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}};actions.prototype.keyUpSwitchs=function(b){if(b==27||b==88){core.status.event.selection=0;core.ui.drawSettings();return}var a=core.status.event.ui.choices;if(b==13||b==32||b==67){var c=6-parseInt((a.length-1)/2);this.clickSwitchs(6,c+core.status.event.selection)}};actions.prototype.clickSettings=function(d,e){if(d<5||d>7){return}var a=core.status.event.ui.choices;var c=6-parseInt((a.length-1)/2);if(e>=c&&e<c+a.length){var b=e-c;switch(b){case 0:core.status.event.selection=0;core.ui.drawSwitchs();break;case 1:core.status.event.selection=0;core.ui.drawQuickShop();break;case 2:if(!core.flags.enableViewMaps){core.drawTip("本塔不允许浏览地图！")}else{core.ui.drawMaps()}break;case 3:core.status.event.selection=0;core.ui.drawSyncSave();break;case 4:core.status.event.selection=1;core.ui.drawConfirmBox("你确定要返回标题页面吗？",function(){core.ui.closePanel();core.restart()},function(){core.status.event.selection=3;core.ui.drawSettings()});break;case 5:core.ui.drawStatistics();break;case 6:core.ui.drawHelp();break;case 7:core.ui.drawAbout();break;case 8:core.ui.closePanel();break}}return};actions.prototype.keyDownSettings=function(a){if(a==38){core.status.event.selection--;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}if(a==40){core.status.event.selection++;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}};actions.prototype.keyUpSettings=function(b){if(b==27||b==88){core.ui.closePanel();return}var a=core.status.event.ui.choices;if(b==13||b==32||b==67){var c=6-parseInt((a.length-1)/2);this.clickSettings(6,c+core.status.event.selection)}};actions.prototype.clickSyncSave=function(d,e){if(d<5||d>7){return}var a=core.status.event.ui.choices;var c=6-parseInt((a.length-1)/2);if(e>=c&&e<c+a.length){var b=e-c;switch(b){case 0:core.status.event.selection=0;core.ui.drawSyncSelect();break;case 1:core.syncLoad();break;case 2:core.status.event.selection=0;core.ui.drawLocalSaveSelect();break;case 3:core.readFile(function(g){if(g.name!=core.firstData.name){alert("存档和游戏不一致！");return}if(g.version!=core.firstData.version){alert("游戏版本不一致！");return}if(!core.isset(g.data)){alert("无效的存档！");return}var f=g.data;if(f instanceof Array){core.ui.drawConfirmBox("所有本地存档都将被覆盖，确认？",function(){for(var h=1;h<=5*(main.savePages||30);h++){if(h<=f.length){core.setLocalForage("save"+h,f[h-1])}else{core.removeLocalForage("save"+h)}}core.drawText("读取成功！\n你的本地所有存档均已被覆盖。")},function(){core.status.event.selection=0;core.ui.drawSyncSave()})}else{core.setLocalForage("save"+core.status.saveIndex,f,function(){core.drawText("同步成功！\n单存档已覆盖至存档"+core.status.saveIndex)})}},function(){});break;case 4:core.status.event.selection=0;core.ui.drawReplay();break;case 5:if(core.hasFlag("debug")){core.drawText("\t[系统提示]调试模式下无法下载录像");break}core.download(core.firstData.name+"_"+core.formatDate2(new Date())+".h5route",JSON.stringify({name:core.firstData.name,hard:core.status.hard,seed:core.getFlag("seed"),route:core.encodeRoute(core.status.route)}));break;case 6:core.status.event.selection=0;core.ui.drawStorageRemove();break;case 7:core.status.event.selection=3;core.ui.drawSettings();break}}return};actions.prototype.keyDownSyncSave=function(a){if(a==38){core.status.event.selection--;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}if(a==40){core.status.event.selection++;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}};actions.prototype.keyUpSyncSave=function(b){if(b==27||b==88){core.status.event.selection=2;core.ui.drawSettings();return}var a=core.status.event.ui.choices;if(b==13||b==32||b==67){var c=6-parseInt((a.length-1)/2);this.clickSyncSave(6,c+core.status.event.selection)}};actions.prototype.clickSyncSelect=function(d,e){if(d<5||d>7){return}var a=core.status.event.ui.choices;var c=6-parseInt((a.length-1)/2);if(e>=c&&e<c+a.length){var b=e-c;switch(b){case 0:core.syncSave("all");break;case 1:core.syncSave();break;case 2:core.status.event.selection=0;core.ui.drawSyncSave();break}}};actions.prototype.keyDownSyncSelect=function(a){if(a==38){core.status.event.selection--;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}if(a==40){core.status.event.selection++;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}};actions.prototype.keyUpSyncSelect=function(b){if(b==27||b==88){core.status.event.selection=0;core.ui.drawSettings();return}var a=core.status.event.ui.choices;if(b==13||b==32||b==67){var c=6-parseInt((a.length-1)/2);this.clickSyncSelect(6,c+core.status.event.selection)}};actions.prototype.clickLocalSaveSelect=function(e,f){if(e<5||e>7){return}var a=core.status.event.ui.choices;var d=6-parseInt((a.length-1)/2);var b=null;if(f>=d&&f<d+a.length){var c=f-d;if(c<2){core.control.getSaves(c==0?null:core.status.saveIndex,function(h){if(core.isset(h)){var g={name:core.firstData.name,version:core.firstData.version,data:h};core.download(core.firstData.name+"_"+core.formatDate2(new Date())+".h5save",JSON.stringify(g))}})}}core.status.event.selection=2;core.ui.drawSyncSave()};actions.prototype.keyDownLocalSaveSelect=function(a){if(a==38){core.status.event.selection--;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}if(a==40){core.status.event.selection++;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}};actions.prototype.keyUpLocalSaveSelect=function(b){if(b==27||b==88){core.status.event.selection=0;core.ui.drawSettings();return}var a=core.status.event.ui.choices;if(b==13||b==32||b==67){var c=6-parseInt((a.length-1)/2);this.clickLocalSaveSelect(6,c+core.status.event.selection)}};actions.prototype.clickStorageRemove=function(e,f){if(e<5||e>7){return}var a=core.status.event.ui.choices;var d=6-parseInt((a.length-1)/2);if(f>=d&&f<d+a.length){var c=f-d;switch(c){case 0:if(core.platform.useLocalForage){core.ui.drawWaiting("正在清空，请稍后...");localforage.clear(function(){core.ui.closePanel();core.drawText("\t[操作成功]你的所有存档已被清空。")})}else{localStorage.clear();core.drawText("\t[操作成功]你的所有存档已被清空。")}break;case 1:if(core.platform.useLocalForage){core.ui.drawWaiting("正在清空，请稍后...");for(var b=1;b<=5*(main.savePages||30);b++){core.removeLocalForage("save"+b)}core.removeLocalForage("autoSave",function(){core.ui.closePanel();core.drawText("\t[操作成功]当前塔的存档已被清空。")})}else{for(var b=1;b<=5*(main.savePages||30);b++){core.removeLocalStorage("save"+b)}core.removeLocalStorage("autoSave");core.drawText("\t[操作成功]当前塔的存档已被清空。")}break;case 2:core.status.event.selection=5;core.ui.drawSyncSave();break}}};actions.prototype.keyDownStorageRemove=function(a){if(a==38){core.status.event.selection--;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}if(a==40){core.status.event.selection++;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}};actions.prototype.keyUpStorageRemove=function(b){if(b==27||b==88){core.status.event.selection=5;core.ui.drawSyncSave();return}var a=core.status.event.ui.choices;if(b==13||b==32||b==67){var c=6-parseInt((a.length-1)/2);this.clickStorageRemove(6,c+core.status.event.selection)}};actions.prototype.clickReplay=function(j,k){if(j<5||j>7){return}var a=core.status.event.ui.choices;var i=6-parseInt((a.length-1)/2);if(k>=i&&k<i+a.length){var h=k-i;switch(h){case 0:core.ui.closePanel();var b=core.status.hard,e=core.clone(core.status.route);var g=core.getFlag("seed");core.resetStatus(core.firstData.hero,b,core.firstData.floorId,null,core.initStatus.maps);core.events.setInitData(b);core.setFlag("seed",g);core.setFlag("rand",g);core.changeFloor(core.status.floorId,null,core.firstData.hero.loc,null,function(){core.startReplay(e)},true);break;case 1:core.status.event.id="replayLoad";core.status.event.selection=null;var f=core.status.saveIndex;var d=parseInt((f-1)/5),c=f-5*d;core.ui.drawSLPanel(10*d+c);break;case 2:if(core.hasFlag("debug")){core.drawText("\t[系统提示]调试模式下无法下载录像");break}core.download(core.firstData.name+"_"+core.formatDate2(new Date())+".h5route",JSON.stringify({name:core.firstData.name,hard:core.status.hard,seed:core.getFlag("seed"),route:core.encodeRoute(core.status.route)}));break;break;case 3:core.ui.closePanel();break}}};actions.prototype.keyDownReplay=function(a){if(a==38){core.status.event.selection--;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}if(a==40){core.status.event.selection++;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}};actions.prototype.keyUpReplay=function(b){if(b==27||b==88){core.ui.closePanel();return}var a=core.status.event.ui.choices;if(b==13||b==32||b==67){var c=6-parseInt((a.length-1)/2);this.clickReplay(6,c+core.status.event.selection)}};actions.prototype.clickKeyBoard=function(b,c){if(c==3&&b>=1&&b<=11){core.ui.closePanel();core.keyUp(112+b-1)}if(c==4&&b>=1&&b<=10){core.ui.closePanel();core.keyUp(b==10?48:48+b)}var a=[["Q","W","E","R","T","Y","U","I","O","P"],["A","S","D","F","G","H","J","K","L"],["Z","X","C","V","B","N","M"],];if(c==5&&b>=1&&b<=10){core.ui.closePanel();core.keyUp(a[0][b-1].charCodeAt(0))}if(c==6&&b>=1&&b<=9){core.ui.closePanel();core.keyUp(a[1][b-1].charCodeAt(0))}if(c==7&&b>=1&&b<=7){core.ui.closePanel();core.keyUp(a[2][b-1].charCodeAt(0))}if(c==8&&b>=1&&b<=11){core.ui.closePanel();if(b==1){core.keyUp(189)}if(b==2){core.keyUp(187)}if(b==3){core.keyUp(219)}if(b==4){core.keyUp(221)}if(b==5){core.keyUp(220)}if(b==6){core.keyUp(186)}if(b==7){core.keyUp(222)}if(b==8){core.keyUp(188)}if(b==9){core.keyUp(190)}if(b==10){core.keyUp(191)}if(b==11){core.keyUp(192)}}if(c==9&&b>=1&&b<=10){core.ui.closePanel();if(b==1){core.keyUp(27)}if(b==2){core.keyUp(9)}if(b==3){core.keyUp(20)}if(b==4){core.keyUp(16)}if(b==5){core.keyUp(17)}if(b==6){core.keyUp(18)}if(b==7){core.keyUp(32)}if(b==8){core.keyUp(8)}if(b==9){core.keyUp(13)}if(b==10){core.keyUp(46)}}if(c==10&&b>=9&&b<=11){core.ui.closePanel()}};actions.prototype.clickCursor=function(a,b){if(a==core.status.automaticRoute.cursorX&&b==core.status.automaticRoute.cursorY){core.ui.closePanel();core.onclick(a,b,[]);return}core.status.automaticRoute.cursorX=a;core.status.automaticRoute.cursorY=b;core.ui.drawCursor()};actions.prototype.keyDownCursor=function(a){if(a==37){core.status.automaticRoute.cursorX--;core.ui.drawCursor();return}if(a==38){core.status.automaticRoute.cursorY--;core.ui.drawCursor();return}if(a==39){core.status.automaticRoute.cursorX++;core.ui.drawCursor();return}if(a==40){core.status.automaticRoute.cursorY++;core.ui.drawCursor();return}};actions.prototype.keyUpCursor=function(a){if(a==27||a==88){core.ui.closePanel();return}if(a==13||a==32||a==67||a==69){core.ui.closePanel();core.onclick(core.status.automaticRoute.cursorX,core.status.automaticRoute.cursorY,[]);return}};actions.prototype.clickAbout=function(){if(core.isPlaying()){core.ui.closePanel()}else{core.restart()}};function data(){this.init()}data.prototype.init=function(){this.firstData=data_a1e2fb4a_e986_4524_b0da_9b7ba7c0874d.firstData;this.values=data_a1e2fb4a_e986_4524_b0da_9b7ba7c0874d.values;this.flags=data_a1e2fb4a_e986_4524_b0da_9b7ba7c0874d.flags};data.prototype.getFirstData=function(){return core.clone(this.firstData)};function ui(){this.init()}ui.prototype.init=function(){this.uidata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.ui};ui.prototype.clearMap=function(c,e,f,d,a){if(c=="all"){for(var b in core.canvas){if(b=="curtain"){continue}core.canvas[b].clearRect(0,0,core.bigmap.width*32,core.bigmap.height*32)}core.dom.gif.innerHTML=""}else{core.canvas[c].clearRect(e||0,f||0,d||core.bigmap.width*32,a||core.bigmap.height*32)}};ui.prototype.fillText=function(b,d,e,f,c,a){if(core.isset(c)){core.setFillStyle(b,c)}if(core.isset(a)){core.setFont(b,a)}core.canvas[b].fillText(d,e,f)};ui.prototype.fillRect=function(b,e,f,d,a,c){if(core.isset(c)){core.setFillStyle(b,c)}core.canvas[b].fillRect(e,f,d,a)};ui.prototype.strokeRect=function(c,f,g,e,a,d,b){if(core.isset(d)){core.setStrokeStyle(c,d)}if(core.isset(b)){core.setLineWidth(c,b)}core.canvas[c].strokeRect(f,g,e,a)};ui.prototype.drawLine=function(b,d,f,e,g,c,a){if(core.isset(c)){core.setStrokeStyle(b,c)}if(core.isset(a)){core.setLineWidth(b,a)}core.canvas[b].beginPath();core.canvas[b].moveTo(d,f);core.canvas[b].lineTo(e,g);core.canvas[b].stroke()};ui.prototype.drawArrow=function(f,h,j,i,k,g,e){if(h==i&&j==k){return}if(core.isset(g)){core.setStrokeStyle(f,g)}if(core.isset(e)){core.setLineWidth(f,e)}var d=10;var b=i-h,c=k-j;var a=Math.atan2(c,b);core.canvas[f].beginPath();core.canvas[f].moveTo(h,j);core.canvas[f].lineTo(i,k);core.canvas[f].lineTo(i-d*Math.cos(a-Math.PI/6),k-d*Math.sin(a-Math.PI/6));core.canvas[f].moveTo(i,k);core.canvas[f].lineTo(i-d*Math.cos(a+Math.PI/6),k-d*Math.sin(a+Math.PI/6));core.canvas[f].stroke()};ui.prototype.setFont=function(b,a){core.canvas[b].font=a};ui.prototype.setLineWidth=function(c,a){if(c=="all"){for(var b in core.canvas){core.canvas[b].lineWidth=a}}core.canvas[c].lineWidth=a};ui.prototype.saveCanvas=function(a){core.canvas[a].save()};ui.prototype.loadCanvas=function(a){core.canvas[a].restore()};ui.prototype.setStrokeStyle=function(b,c){if(b=="all"){for(var a in core.canvas){core.canvas[a].strokeStyle=c}}else{core.canvas[b].strokeStyle=c}};ui.prototype.setAlpha=function(c,a){if(c=="all"){for(var b in core.canvas){core.canvas[b].globalAlpha=a}}else{core.canvas[c].globalAlpha=a}};ui.prototype.setOpacity=function(b,c){if(b=="all"){for(var a in core.canvas){core.canvas[a].canvas.style.opacity=c}}else{core.canvas[b].canvas.style.opacity=c}};ui.prototype.setFillStyle=function(b,c){if(b=="all"){for(var a in core.canvas){core.canvas[a].fillStyle=c}}else{core.canvas[b].fillStyle=c}};ui.prototype.closePanel=function(){core.status.boxAnimateObjs=[];clearInterval(core.status.event.interval);core.clearMap("ui");core.setAlpha("ui",1);core.unLockControl();core.status.event.data=null;core.status.event.id=null;core.status.event.selection=null;core.status.event.ui=null;core.status.event.interval=null};ui.prototype.drawTip=function(e,c){var f,g,h,a,b=false,d=0;clearInterval(core.interval.tipAnimate);core.setFont("data","16px Arial");core.setOpacity("data",0);core.canvas.data.textAlign="left";if(!core.isset(c)){f=16;g=18;h=f+core.canvas.data.measureText(e).width+16;a=42}else{f=44;g=18;h=f+core.canvas.data.measureText(e).width+8;a=42}core.interval.tipAnimate=window.setInterval(function(){if(b){d-=0.1}else{d+=0.1}core.setOpacity("data",d);core.clearMap("data",5,5,400,a);core.fillRect("data",5,5,h,a,"#000");if(core.isset(c)){core.canvas.data.drawImage(core.material.images.items,0,c*32,32,32,10,8,32,32)}core.fillText("data",e,f+5,g+15,"#fff");if(d>0.6||d<0){if(b){core.clearMap("data",5,5,400,a);core.setOpacity("data",1);clearInterval(core.interval.tipAnimate);return}else{if(!core.isset(core.timeout.getItemTipTimeout)){core.timeout.getItemTipTimeout=window.setTimeout(function(){b=true;core.timeout.getItemTipTimeout=null},750)}d=0.6;core.setOpacity("data",d)}}},30)};ui.prototype.drawText=function(b,a){if(core.isset(b)){if((core.isset(core.status.event)&&core.status.event.id=="action")||(core.isset(core.status.replay)&&core.status.replay.replaying)){core.insertAction(b,null,null,a);return}if(typeof b=="string"){b=[{content:b}]}else{if(b instanceof Object&&core.isset(b.content)){b=[b]}else{if(!(b instanceof Array)){core.drawTip("出错了");console.log(b);return}}}core.status.event={id:"text",data:{list:b,callback:a}};core.lockControl();core.stopAutomaticRoute();setTimeout(function(){core.drawText()},30);return}if(core.status.event.data.list.length==0){var a=core.status.event.data.callback;core.ui.closePanel(false);if(core.isset(a)){a()}return}var c=core.status.event.data.list.shift();if(typeof c=="string"){core.ui.drawTextBox(c)}else{core.ui.drawTextBox(c.content,c.id)}};ui.prototype.drawTextBox=function(d,x){if(core.isset(core.status.event)&&core.status.event.id=="action"){core.status.event.ui=d}clearInterval(core.status.event.interval);core.status.event.interval=null;var o=null,s=null,p=null,m=null,n=32,a=null;if(d.indexOf("\t[")==0||d.indexOf("\\t[")==0){var q=d.indexOf("]");if(q>=0){var z=d.substring(2,q);if(d.indexOf("\\t[")==0){z=d.substring(3,q)}d=d.substring(q+1);var y=z.split(",");if(y.length==1){o=y[0];if(o=="hero"){s=core.status.hero.name}else{if(core.isset(core.material.enemys[o])){s=core.material.enemys[o].name;if(core.isset(core.material.icons.enemy48[o])){p=core.material.images.enemy48;m=core.material.icons.enemy48[o];n=48;a=4}else{p=core.material.images.enemys;m=core.material.icons.enemys[o];n=32;a=2}}else{s=o;o="npc";p=null;m=null}}}else{s=y[0];o="npc";if(y[1]=="hero"){o="hero"}else{if(core.isset(core.material.icons.npc48[y[1]])){p=core.material.images.npc48;m=core.material.icons.npc48[y[1]];n=48;a=4}else{if(core.isset(core.material.icons.npcs[y[1]])){p=core.material.images.npcs;m=core.material.icons.npcs[y[1]];n=32;a=2}else{if(core.isset(core.material.icons.enemy48[y[1]])){p=core.material.images.enemy48;m=core.material.icons.enemy48[y[1]];n=48;a=4}else{if(core.isset(core.material.icons.enemys[y[1]])){p=core.material.images.enemys;m=core.material.icons.enemys[y[1]];n=32;a=2}}}}}}}}var A=core.status.textAttribute||core.initStatus.textAttribute;var C=A.titlefont||22;var B=A.textfont||16;var t=A.position,u=null,v=null,G=n-32;if(d.indexOf("\b[")==0||d.indexOf("\\b[")==0){var q=d.indexOf("]");if(q>=0){var z=d.substring(2,q);if(d.indexOf("\\b[")==0){z=d.substring(3,q)}d=d.substring(q+1);var y=z.split(",");if(y[0]=="up"||y[0]=="center"||y[0]=="down"){t=y[0];if(core.status.event.id=="action"){u=core.status.event.data.x;v=core.status.event.data.y}if(y.length>=2){if(y[1]=="hero"){u=core.getHeroLoc("x");v=core.getHeroLoc("y");G=core.material.icons.hero.height-32}else{if(y.length>=3){u=parseInt(y[1]);v=parseInt(y[2])}}}}}}d=core.replaceText(d);var b=core.canvas.ui.createPattern(core.material.ground,"repeat");core.status.boxAnimateObjs=[];core.clearMap("ui");var r=10,w=416-2*r;var e=r+25;if(o=="hero"||core.isset(m)){e=r+63}var E=w-(e-r)-13;var i=B+"px Verdana";if(A.bold){i="bold "+i}var g=core.splitLines("ui",d,E,i);var j=20+(B+5)*(g.length+1)+(o=="hero"?core.material.icons.hero.height-10:core.isset(s)?n-10:0);var F=6,H=22;var D;if(t=="center"){D=parseInt((416-j)/2)}else{if(t=="up"){if(u==null||v==null){D=5}else{D=32*v-j-G-H}}else{if(t=="down"){if(u==null||v==null){D=416-j-5}else{D=32*v+32+H}}}}var c=main.borderColor||"#FFFFFF";core.setAlpha("ui",A.background[3]);core.setFillStyle("ui",core.arrayToRGB(A.background));core.setStrokeStyle("ui",c);core.fillRect("ui",r,D,w,j);core.strokeRect("ui",r-1,D-1,w+1,j+1,c,2);var F=9;if(t=="up"&&core.isset(u)&&core.isset(v)){core.canvas.ui.clearRect(32*u+F,D+j-1,32-2*F,2);core.canvas.ui.beginPath();core.canvas.ui.moveTo(32*u+F-1,D+j-1);core.canvas.ui.lineTo(32*u+16,D+j+H-2);core.canvas.ui.lineTo(32*u+32-F+1,D+j-1);core.canvas.ui.moveTo(32*u+F-1,D+j-1);core.canvas.ui.closePath();core.canvas.ui.fill();core.drawLine("ui",32*u+F,D+j,32*u+16,D+j+H-2);core.drawLine("ui",32*u+32-F,D+j,32*u+16,D+j+H-2)}if(t=="down"&&core.isset(u)&&core.isset(v)){core.canvas.ui.clearRect(32*u+F,D-2,32-2*F,3);core.canvas.ui.beginPath();core.canvas.ui.moveTo(32*u+F-1,D+1);core.canvas.ui.lineTo(32*u+16-1,D-H+2);core.canvas.ui.lineTo(32*u+32-F-1,D+1);core.canvas.ui.moveTo(32*u+F-1,D+1);core.canvas.ui.closePath();core.canvas.ui.fill();core.drawLine("ui",32*u+F,D,32*u+16,D-H+2);core.drawLine("ui",32*u+32-F,D,32*u+16,D-H+2)}core.canvas.ui.textAlign="left";var f=D+35;if(core.isset(o)){f=D+57;core.setAlpha("ui",A.title[3]);core.setFillStyle("ui",core.arrayToRGB(A.title));core.setStrokeStyle("ui",core.arrayToRGB(A.title));if(o=="hero"){var k=core.material.icons.hero.height;core.strokeRect("ui",r+15-1,D+40-1,34,k+2,c,2);core.fillText("ui",s,e,D+30,null,"bold "+C+"px Verdana");core.clearMap("ui",r+15,D+40,32,k);core.fillRect("ui",r+15,D+40,32,k,b);var l=core.material.icons.hero.down;core.canvas.ui.drawImage(core.material.images.hero,l.stop*32,l.loc*k,32,k,r+15,D+40,32,k)}else{core.fillText("ui",s,e,D+30,null,"bold "+C+"px Verdana");if(core.isset(m)){core.strokeRect("ui",r+15-1,D+40-1,34,n+2,c,2);core.status.boxAnimateObjs=[];core.status.boxAnimateObjs.push({bgx:r+15,bgy:D+40,bgWidth:32,bgHeight:n,x:r+15,y:D+40,height:n,animate:a,image:p,pos:m*n});core.drawBoxAnimate()}}}var h=function(I){core.clearMap("ui",e,f-18,E,D+j-f+10);core.setAlpha("ui",A.background[3]);core.setFillStyle("ui",core.arrayToRGB(A.background));core.fillRect("ui",e,f-18,E,D+j-f+11);core.setAlpha("ui",A.text[3]);core.setFillStyle("ui",core.arrayToRGB(A.text));var J=core.splitLines("ui",I,E,i);for(var K=0;K<J.length;K++){core.fillText("ui",J[K],e,f+(B+5)*K,null,i)}};if(x||A.time<=0||core.status.event.id!="action"){h(d)}else{var q=0;core.status.event.interval=setInterval(function(){h(d.substring(0,++q));if(q==d.length){clearInterval(core.status.event.interval);core.status.event.interval=null}},A.time)}};ui.prototype.drawChoices=function(h,g){g=g||[];var b=core.canvas.ui.createPattern(core.material.ground,"repeat");core.clearMap("ui");core.setAlpha("ui",1);core.setFillStyle("ui",b);core.status.event.ui={text:h,choices:g};var x=g.length;var D=416-2*85;core.setFont("ui","bold 17px Verdana");for(var p=0;p<g.length;p++){D=Math.max(D,core.canvas.ui.measureText(core.replaceText(g[p].text||g[p])).width+30)}var v=parseInt((416-D)/2);var m=32*(x+2),d=208+m/2;if(x%2==0){d+=16}var f=d-m+56;var s=null,y=null,t=null,q=null,r=32,a=null;var l=null;var j=v+15;if(core.isset(h)){if(h.indexOf("\t[")==0||h.indexOf("\\t[")==0){var u=h.indexOf("]");if(u>=0){var A=h.substring(2,u);if(h.indexOf("\\t[")==0){A=h.substring(3,u)}h=h.substring(u+1);var z=A.split(",");if(z.length==1){s=z[0];if(s=="hero"){y=core.status.hero.name}else{if(core.isset(core.material.enemys[s])){y=core.material.enemys[s].name;if(core.isset(core.material.icons.enemy48[s])){t=core.material.images.enemy48;q=core.material.icons.enemy48[s];r=48;a=4}else{t=core.material.images.enemys;q=core.material.icons.enemys[s];r=32;a=2}}else{y=s;s="npc";t=null;q=null}}}else{y=z[0];s="npc";if(z[1]=="hero"){s="hero"}else{if(core.isset(core.material.icons.npc48[z[1]])){t=core.material.images.npc48;q=core.material.icons.npc48[z[1]];r=48;a=4}else{if(core.isset(core.material.icons.npcs[z[1]])){t=core.material.images.npcs;q=core.material.icons.npcs[z[1]];r=32;a=2}else{if(core.isset(core.material.icons.enemy48[z[1]])){t=core.material.images.enemy48;q=core.material.icons.enemy48[z[1]];r=48;a=4}else{if(core.isset(core.material.icons.enemys[z[1]])){t=core.material.images.enemys;q=core.material.icons.enemys[z[1]];r=32;a=2}}}}}}}}h=core.replaceText(h);if(s=="hero"||core.isset(q)){j=v+60}l=core.splitLines("ui",h,D-(j-v)-10,"bold 15px Verdana");var e=0;if(y!=null){e+=25}e+=l.length*20;m+=e}var C=d-m;var c=main.borderColor||"#FFFFFF";core.fillRect("ui",v,C,D,m,b);core.strokeRect("ui",v-1,C-1,D+1,m+1,c,2);if(core.isset(l)){var k=C+35;if(core.isset(s)){core.canvas.ui.textAlign="center";k=C+55;var B=v+D/2;if(s=="hero"||core.isset(q)){B+=12}if(s=="hero"){var n=core.material.icons.hero.height;core.strokeRect("ui",v+15-1,C+30-1,34,n+2,"#DDDDDD",2);core.fillText("ui",y,B,C+27,"#FFD700","bold 19px Verdana");core.clearMap("ui",v+15,C+30,32,n);core.fillRect("ui",v+15,C+30,32,n,b);var o=core.material.icons.hero.down;core.canvas.ui.drawImage(core.material.images.hero,o.stop*32,o.loc*n,32,n,v+15,C+30,32,n)}else{core.fillText("ui",y,B,C+27,"#FFD700","bold 19px Verdana");if(core.isset(q)){core.strokeRect("ui",v+15-1,C+30-1,34,r+2,"#DDDDDD",2);core.status.boxAnimateObjs=[];core.status.boxAnimateObjs.push({bgx:v+15,bgy:C+30,bgWidth:32,bgHeight:r,x:v+15,y:C+30,height:r,animate:a,image:t,pos:q*r});core.drawBoxAnimate()}}}core.canvas.ui.textAlign="left";for(var p=0;p<l.length;p++){core.fillText("ui",l[p],j,k,"#FFFFFF","bold 15px Verdana");k+=20}}core.canvas.ui.textAlign="center";for(var p=0;p<g.length;p++){core.fillText("ui",core.replaceText(g[p].text||g[p]),208,f+32*p,"#FFFFFF","bold 17px Verdana")}if(g.length>0){if(!core.isset(core.status.event.selection)){core.status.event.selection=0}while(core.status.event.selection<0){core.status.event.selection+=g.length}while(core.status.event.selection>=g.length){core.status.event.selection-=g.length}var w=core.canvas.ui.measureText(core.replaceText(g[core.status.event.selection].text||g[core.status.event.selection])).width;core.strokeRect("ui",208-w/2-5,f+32*core.status.event.selection-20,w+10,28,"#FFD700",2)}return};ui.prototype.drawConfirmBox=function(m,o,k){core.lockControl();core.status.event.id="confirmBox";core.status.event.data={yes:o,no:k};core.status.event.ui=m;if(!core.isset(core.status.event.selection)||core.status.event.selection>1){core.status.event.selection=1}if(core.status.event.selection<0){core.status.event.selection=0}var a=core.canvas.ui.createPattern(core.material.ground,"repeat");core.clearMap("ui");core.setAlpha("ui",1);core.setFillStyle("ui",a);core.setFont("ui","bold 19px Verdana");var d=m.split("\n");var h=d.length;var j=0;for(var e in d){j=Math.max(j,core.canvas.ui.measureText(d[e]).width)}var f=Math.min(208-40-parseInt(j/2),100);var n=140-(h-1)*30;var l=416-2*f,c=416-140-n;var b=main.borderColor||"#FFFFFF";if(core.isPlaying()){core.fillRect("ui",f,n,l,c,a)}if(core.isPlaying()){core.strokeRect("ui",f-1,n-1,l+1,c+1,b,2)}core.canvas.ui.textAlign="center";for(var e in d){core.fillText("ui",d[e],208,n+50+e*30,"#FFFFFF")}core.fillText("ui","确定",208-38,n+c-35,"#FFFFFF","bold 17px Verdana");core.fillText("ui","取消",208+38,n+c-35);var g=core.canvas.ui.measureText("确定").width;if(core.status.event.selection==0){core.strokeRect("ui",208-38-parseInt(g/2)-5,n+c-35-20,g+10,28,"#FFD700",2)}if(core.status.event.selection==1){core.strokeRect("ui",208+38-parseInt(g/2)-5,n+c-35-20,g+10,28,"#FFD700",2)}};ui.prototype.drawSwitchs=function(){core.status.event.id="switchs";var a=["背景音乐： "+(core.musicStatus.bgmStatus?"[ON]":"[OFF]"),"背景音效： "+(core.musicStatus.soundStatus?"[ON]":"[OFF]"),"战斗动画： "+(core.flags.battleAnimate?"[ON]":"[OFF]"),"怪物显伤： "+(core.flags.displayEnemyDamage?"[ON]":"[OFF]"),"临界显伤： "+(core.flags.displayCritical?"[ON]":"[OFF]"),"领域显伤： "+(core.flags.displayExtraDamage?"[ON]":"[OFF]"),"单击瞬移： "+(core.flags.clickMoveDirectly?"[ON]":"[OFF]"),"新版存档： "+(core.platform.useLocalForage?"[ON]":"[OFF]"),"查看工程","下载离线版本","返回主菜单"];this.drawChoices(null,a)};ui.prototype.drawSettings=function(){core.status.event.id="settings";this.drawChoices(null,["系统设置","快捷商店","浏览地图","同步存档","返回标题","数据统计","操作帮助","关于本塔","返回游戏"])};ui.prototype.drawQuickShop=function(){core.status.event.id="selectShop";var d=core.status.shops,c=Object.keys(d);var a=[];for(var b=0;b<c.length;b++){a.push(d[c[b]].textInList)}a.push("返回游戏");this.drawChoices(null,a)};ui.prototype.drawBattleAnimate=function(K,f){core.lockControl();if(!core.isset(core.status.event.id)){core.status.event={id:"battle"}}var n=core.getStatus("hp"),l=core.getStatus("atk"),m=core.getStatus("def"),o=core.getStatus("mdef");n=Math.max(0,n);l=Math.max(0,l);m=Math.max(0,m);o=Math.max(0,o);if(core.flags.equipPercentage){l=Math.floor(core.getFlag("equip_atk_buff",1)*l);m=Math.floor(core.getFlag("equip_def_buff",1)*m);o=Math.floor(core.getFlag("equip_mdef_buff",1)*o)}var g=core.material.enemys[K];var h=core.enemys.getEnemyInfo(g,n,l,m,o);var G=h.hp,D=h.atk,E=h.def,H=h.money,F=h.experience,I=h.special;var u=0;if(core.enemys.hasSpecial(I,11)){var T=n*g.value;T=Math.floor(T)||0;if(g.add){G+=T}u+=T}n-=core.enemys.getExtraDamage(g);if(core.enemys.hasSpecial(I,2)){m=0}var R=0;if(core.enemys.hasSpecial(I,1)){R=1}var S=2;if(core.enemys.hasSpecial(I,4)){S=3}if(core.enemys.hasSpecial(I,5)){S=4}if(core.enemys.hasSpecial(I,6)){S=1+(g.n||4)}if(core.enemys.hasSpecial(I,7)){u+=Math.floor(core.values.breakArmor*m)}if(core.enemys.hasSpecial(I,9)){u+=Math.floor(core.values.purify*o)}o-=u;if(o<0){n+=o;o=0}var O=core.enemys.getSpecialText(K);var b=core.canvas.ui.createPattern(core.material.ground,"repeat");core.clearMap("ui");var w=10,L=416-2*w;var A=3;if(core.flags.enableMDef||core.flags.enableMoney||core.flags.enableExperience){A=4}if(core.flags.enableMoney&&core.flags.enableExperience){A=5}var z=60;var k=z*A+50;var Q=(416-k)/2,d=k;core.setAlpha("ui",0.85);core.fillRect("ui",w,Q,L,d,"#000000");core.setAlpha("ui",1);core.strokeRect("ui",w-1,Q-1,L+1,d+1,"#FFFFFF",2);core.clearMap("data");clearInterval(core.interval.tipAnimate);core.setAlpha("data",1);core.setOpacity("data",1);core.status.boxAnimateObjs=[];var C=35;var e=40;var J=32,a=2;var t=core.material.images.enemys,s=core.material.icons.enemys;if(core.isset(core.material.icons.enemy48[K])){t=core.material.images.enemy48;s=core.material.icons.enemy48;J=48;a=4}var p=core.material.icons.hero.height;core.strokeRect("ui",w+C-1,Q+C-1,e+2,p+e-32+2,"#FFD700",2);core.strokeRect("ui",w+L-C-e-1,Q+C-1,e+2,J+e-32+2);core.canvas.ui.textAlign="center";core.fillText("ui",core.status.hero.name,w+C+e/2,Q+C+p+40,"#FFD700","bold 22px Verdana");core.fillText("ui","怪物",w+L-C-e/2,Q+C+J+40);for(var r=0,v=0;r<O.length;r++){if(O[r]!=""){core.fillText("ui",O[r],w+L-C-e/2,Q+C+J+44+20*(++v),"#FF6A6A","15px Verdana")}}core.clearMap("ui",w+C,Q+C,e,p+e-32);core.fillRect("ui",w+C,Q+C,e,p+e-32,b);var q=core.material.icons.hero.down;core.canvas.ui.drawImage(core.material.images.hero,q.stop*32,q.loc*p,32,p,w+C+(e-32)/2,Q+C+(e-32)/2,32,p);core.status.boxAnimateObjs=[];core.status.boxAnimateObjs.push({bgx:w+L-C-40,bgy:Q+C,bgWidth:e,bgHeight:J+e-32,x:w+L-C-40+(e-32)/2,y:Q+C+(e-32)/2,height:J,image:t,pos:J*s[K],animate:a});core.drawBoxAnimate();var B=80;var y=w+C+e+10;var x=y+B;var M=w+L-C-e-10;var N=M-B;core.canvas.ui.textAlign="left";var P=Q+C+10;core.fillText("ui","生命值",y,P,"#DDDDDD","16px Verdana");core.drawLine("ui",y,P+8,x,P+8,"#FFFFFF",2);core.canvas.data.textAlign="right";core.fillText("data",n,x,P+26,"#DDDDDD","bold 16px Verdana");P+=z;core.canvas.ui.textAlign="left";core.fillText("ui","攻击",y,P,"#DDDDDD","16px Verdana");core.drawLine("ui",y,P+8,x,P+8,"#FFFFFF",2);core.canvas.ui.textAlign="right";core.fillText("ui",l,x,P+26,"#DDDDDD","bold 16px Verdana");P+=z;core.canvas.ui.textAlign="left";core.fillText("ui","防御",y,P,"#DDDDDD","16px Verdana");core.drawLine("ui",y,P+8,x,P+8,"#FFFFFF",2);core.canvas.ui.textAlign="right";core.fillText("ui",m,x,P+26,"#DDDDDD","bold 16px Verdana");if(core.flags.enableMDef){P+=z;core.canvas.ui.textAlign="left";core.fillText("ui","护盾",y,P,"#DDDDDD","16px Verdana");core.drawLine("ui",y,P+8,x,P+8,"#FFFFFF",2);core.canvas.data.textAlign="right";core.fillText("data",o,x,P+26,"#DDDDDD","bold 16px Verdana")}core.canvas.ui.textAlign="right";var P=Q+C+10;core.fillText("ui","生命值",M,P,"#DDDDDD","16px Verdana");core.drawLine("ui",N,P+8,M,P+8,"#FFFFFF",2);core.canvas.data.textAlign="left";core.fillText("data",G,N,P+26,"#DDDDDD","bold 16px Verdana");P+=z;core.canvas.ui.textAlign="right";core.fillText("ui","攻击",M,P,"#DDDDDD","16px Verdana");core.drawLine("ui",N,P+8,M,P+8,"#FFFFFF",2);core.canvas.ui.textAlign="left";core.fillText("ui",D,N,P+26,"#DDDDDD","bold 16px Verdana");P+=z;core.canvas.ui.textAlign="right";core.fillText("ui","防御",M,P,"#DDDDDD","16px Verdana");core.drawLine("ui",N,P+8,M,P+8,"#FFFFFF",2);core.canvas.ui.textAlign="left";core.fillText("ui",E,N,P+26,"#DDDDDD","bold 16px Verdana");if(core.flags.enableMoney){P+=z;core.canvas.ui.textAlign="right";core.fillText("ui","金币",M,P,"#DDDDDD","16px Verdana");core.drawLine("ui",N,P+8,M,P+8,"#FFFFFF",2);core.canvas.ui.textAlign="left";core.fillText("ui",H,N,P+26,"#DDDDDD","bold 16px Verdana")}if(core.flags.enableExperience){P+=z;core.canvas.ui.textAlign="right";core.fillText("ui","经验",M,P,"#DDDDDD","16px Verdana");core.drawLine("ui",N,P+8,M,P+8,"#FFFFFF",2);core.canvas.ui.textAlign="left";core.fillText("ui",F,N,P+26,"#DDDDDD","bold 16px Verdana")}core.canvas.ui.textAlign="left";core.fillText("ui","V",x+8,208-15,"#FFFFFF","italic bold 40px Verdana");core.canvas.ui.textAlign="right";core.fillText("ui","S",N-8,208+15,"#FFFFFF","italic bold 40px Verdana");var c=setInterval(function(){core.playSound("attack.mp3");if(R==0){core.drawLine("data",w+L-C-e+6,Q+C+J+e-32-6,w+L-C-6,Q+C+6,"#FF0000",4);setTimeout(function(){core.clearMap("data",w+L-C-e,Q+C,e,e+J-32)},250);if(l-E>0){G-=l-E}if(G<0){G=0}core.clearMap("data",N,Q+C+10,B,40);core.canvas.data.textAlign="left";core.fillText("data",G,N,Q+C+10+26,"#DDDDDD","bold 16px Verdana");if(core.enemys.hasSpecial(I,8)){o-=Math.floor(core.values.counterAttack*l);if(o<0){n+=o;o=0}core.clearMap("data",y,Q+C+10,B,40);core.canvas.data.textAlign="right";core.fillText("data",n,x,Q+C+10+26,"#DDDDDD","bold 16px Verdana");if(core.flags.enableMDef){core.clearMap("data",y,Q+C+10+3*z,B,40);core.fillText("data",o,x,Q+C+10+26+3*z)}}}else{core.drawLine("data",w+C+6,Q+C+p+(e-32)-6,w+C+e-6,Q+C+6,"#FF0000",4);setTimeout(function(){core.clearMap("data",w+C,Q+C,e,p+e-32)},250);var i=D-m;if(i<0){i=0}o-=i;if(o<0){n+=o;o=0}core.clearMap("data",y,Q+C+10,B,40);core.canvas.data.textAlign="right";core.fillText("data",n,x,Q+C+10+26,"#DDDDDD","bold 16px Verdana");if(core.flags.enableMDef){core.clearMap("data",y,Q+C+10+3*z,B,40);core.fillText("data",o,x,Q+C+10+26+3*z)}}R++;if(R>=S){R=0}if(n<=0||G<=0){clearInterval(c);core.status.boxAnimateObjs=[];core.clearMap("ui");core.setAlpha("ui",1);core.clearMap("data");if(core.status.event.id=="battle"){core.unLockControl();core.status.event.id=null}if(core.isset(f)){f()}return}},400)};ui.prototype.drawWaiting=function(e){core.lockControl();core.status.event.id="waiting";var a=core.canvas.ui.createPattern(core.material.ground,"repeat");core.clearMap("ui");core.setAlpha("ui",1);core.setFillStyle("ui",a);core.setFont("ui","bold 17px Verdana");var f=core.canvas.ui.measureText(e).width;var d=Math.max(f+50,220);var c=208-parseInt(d/2),g=208-32-16,b=416-2*g;core.fillRect("ui",c,g,d,b,a);core.strokeRect("ui",c-1,g-1,d+1,b+1,"#FFFFFF",2);core.canvas.ui.textAlign="center";core.fillText("ui",e,208,g+56,"#FFFFFF")};ui.prototype.drawSyncSave=function(){core.status.event.id="syncSave";this.drawChoices(null,["同步存档到服务器","从服务器加载存档","存档至本地文件","从本地文件读档","回放当前录像","下载当前录像","清空本地存档","返回主菜单"])};ui.prototype.drawSyncSelect=function(){core.status.event.id="syncSelect";this.drawChoices(null,["同步本地所有存档","只同步当前单存档","返回上级菜单"])};ui.prototype.drawLocalSaveSelect=function(){core.status.event.id="localSaveSelect";this.drawChoices(null,["下载所有存档","只下载当前单存档","返回上级菜单"])};ui.prototype.drawStorageRemove=function(){core.status.event.id="storageRemove";this.drawChoices(null,["清空全部塔的存档","只清空当前塔的存档","返回上级菜单"])};ui.prototype.drawReplay=function(){core.lockControl();core.status.event.id="replay";this.drawChoices(null,["从头回放录像","从存档开始回放","下载当前录像","返回游戏"])};ui.prototype.drawPagination=function(b,d,c){if(d<=1){return}if(!core.isset(c)){c=12}core.setFont("ui","bold 15px Verdana");core.setFillStyle("ui","#DDDDDD");var a=core.canvas.ui.measureText(b+" / "+b).width;core.canvas.ui.textAlign="left";core.fillText("ui",b+" / "+d,parseInt((416-a)/2),c*32+19);core.canvas.ui.textAlign="center";if(b>1){core.fillText("ui","上一页",208-80,c*32+19)}if(b<d){core.fillText("ui","下一页",208+80,c*32+19)}};ui.prototype.drawCursor=function(){if(!core.isset(core.status.automaticRoute.cursorX)){core.status.automaticRoute.cursorX=core.getHeroLoc("x")}if(core.status.automaticRoute.cursorX<0){core.status.automaticRoute.cursorX=0}if(core.status.automaticRoute.cursorX>12){core.status.automaticRoute.cursorX=12}if(!core.isset(core.status.automaticRoute.cursorY)){core.status.automaticRoute.cursorY=core.getHeroLoc("y")}if(core.status.automaticRoute.cursorY<0){core.status.automaticRoute.cursorY=0}if(core.status.automaticRoute.cursorY>12){core.status.automaticRoute.cursorY=12}core.status.event.id="cursor";core.lockControl();core.clearMap("ui");core.setAlpha("ui",1);var a=4;core.strokeRect("ui",32*core.status.automaticRoute.cursorX+a/2,32*core.status.automaticRoute.cursorY+a/2,32-a,32-a,"#FFD700",a)};ui.prototype.drawBook=function(n){var j=core.enemys.getCurrentEnemys(core.floorIds[(core.status.event.selection||{}).index]);var b=core.canvas.ui.createPattern(core.material.ground,"repeat");clearInterval(core.interval.tipAnimate);core.clearMap("data");core.setOpacity("data",1);core.clearMap("ui");core.setAlpha("ui",1);core.setFillStyle("ui",b);core.fillRect("ui",0,0,416,416);core.setAlpha("ui",0.6);core.setFillStyle("ui","#000000");core.fillRect("ui",0,0,416,416);core.setAlpha("ui",1);core.canvas.ui.textAlign="left";core.setFont("ui","bold 15px Verdana");if(j.length==0){core.fillText("ui","本层无怪物",83,222,"#999999","bold 50px Verdana");core.canvas.ui.textAlign="center";core.fillText("ui","返回游戏",370,403,"#DDDDDD","bold 15px Verdana");return}if(n<0){n=0}if(n>=j.length){n=j.length-1}var q=6;var p=parseInt(n/q)+1;var s=parseInt((j.length-1)/q)+1;core.status.event.data=n;var r=(p-1)*q,g=Math.min(p*q,j.length);j=j.slice(r,g);core.status.boxAnimateObjs=[];for(var m=0;m<j.length;m++){var h=j[m];core.strokeRect("ui",22,62*m+22,42,42,"#DDDDDD",2);var c="enemys";if(core.isset(core.material.icons.enemy48[h.id])){c="enemy48"}var l=c=="enemy48"?48:32;var a=c=="enemy48"?4:2;core.status.boxAnimateObjs.push({bgx:22,bgy:62*m+22,bgWidth:42,bgHeight:42,x:27,y:62*m+27,height:32,animate:a,image:core.material.images[c],pos:core.material.icons[c][h.id]*l});core.canvas.ui.textAlign="center";if(h.special==""){core.fillText("ui",h.name,115,62*m+47,"#DDDDDD","bold 17px Verdana")}else{core.fillText("ui",h.name,115,62*m+40,"#DDDDDD","bold 17px Verdana");core.fillText("ui",h.special,115,62*m+62,"#FF6A6A","bold 15px Verdana")}core.canvas.ui.textAlign="left";core.fillText("ui","生命",165,62*m+32,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.hp),195,62*m+32,"#DDDDDD","bold 13px Verdana");core.fillText("ui","攻击",255,62*m+32,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.atk),285,62*m+32,"#DDDDDD","bold 13px Verdana");core.fillText("ui","防御",335,62*m+32,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.def),365,62*m+32,"#DDDDDD","bold 13px Verdana");var k=165,o=0;if(core.flags.enableMoney){core.fillText("ui","金币",165,62*m+50,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.money),195,62*m+50,"#DDDDDD","bold 13px Verdana");k=255;o++}if(core.flags.enableAddPoint){core.canvas.ui.textAlign="left";core.fillText("ui","加点",k,62*m+50,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.point),k+30,62*m+50,"#DDDDDD","bold 13px Verdana");k=255;o++}if(core.flags.enableExperience&&o<2){core.canvas.ui.textAlign="left";core.fillText("ui","经验",k,62*m+50,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.experience),k+30,62*m+50,"#DDDDDD","bold 13px Verdana");o++}var f=281;if(o==1){f=326}if(o==2){f=361}core.canvas.ui.textAlign="center";var e=h.damage;var d="#FFFF00";if(e==null){e="无法战斗";d="#FF0000"}else{if(e>=core.status.hero.hp){d="#FF0000"}if(e<=0){d="#00FF00"}e=core.formatBigNumber(e);if(core.enemys.hasSpecial(core.material.enemys[h.id],19)){e+="+"}if(core.enemys.hasSpecial(core.material.enemys[h.id],21)){e+="-"}}if(core.material.enemys[h.id].notBomb){e+="[b]"}core.fillText("ui",e,f,62*m+50,d,"bold 13px Verdana");core.canvas.ui.textAlign="left";core.fillText("ui","临界",165,62*m+68,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.critical),195,62*m+68,"#DDDDDD","bold 13px Verdana");core.fillText("ui","减伤",255,62*m+68,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.criticalDamage),285,62*m+68,"#DDDDDD","bold 13px Verdana");core.fillText("ui","1防",335,62*m+68,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.defDamage),365,62*m+68,"#DDDDDD","bold 13px Verdana");if(n==r+m){core.strokeRect("ui",10,62*m+13,416-10*2,62,"#FFD700")}}core.drawBoxAnimate();this.drawPagination(p,s,12);core.canvas.ui.textAlign="center";core.fillText("ui","返回游戏",370,403,"#DDDDDD","bold 15px Verdana")};ui.prototype.drawBookDetail=function(p){var l=core.enemys.getCurrentEnemys(core.floorIds[(core.status.event.selection||{}).index]);if(l.length==0){return}if(p<0){p=0}if(p>=l.length){p=l.length-1}var j=l[p];var k=j.id;var n=core.enemys.getSpecialHint(core.material.enemys[k]);if(n.length==0){n.push("该怪物无特殊属性。")}if(core.enemys.hasSpecial(core.material.enemys[k].special,11)){var g=core.getDamage(k);if(g!=null){var v=1,h=100*g;var t=core.status.hero.hp;while(v<h){var s=Math.floor((v+h)/2);core.status.hero.hp=s;if(core.canBattle(k)){h=s}else{v=s+1}}core.status.hero.hp=v;if(core.canBattle(k)){n.push("");n.push("打死该怪物最低需要生命值："+core.formatBigNumber(v))}core.status.hero.hp=t}}n.push("");var f=core.enemys.nextCriticals(k,10).map(function(i){return i[0]+":"+i[1]});while(f[0]=="0:0"){f.shift()}n.push("临界表："+JSON.stringify(f));var b=n.join("\n");core.status.event.id="book-detail";clearInterval(core.interval.tipAnimate);core.clearMap("data");core.setOpacity("data",1);var q=10,u=416-2*q;var c=q+25;var y=u-(c-q)-13;var e=core.splitLines("data",b,y,"16px Verdana");var m=416-10-Math.min(416-24*(e.length+1)-65,250);var x=(416-m)/2,a=m;core.setAlpha("data",0.9);core.fillRect("data",q,x,u,a,"#000000");core.setAlpha("data",1);core.strokeRect("data",q-1,x-1,u+1,a+1,main.borderColor||"#FFFFFF",2);core.canvas.data.textAlign="left";core.fillText("data",j.name,c,x+30,"#FFD700","bold 22px Verdana");var d=x+57;for(var o=0;o<e.length;o++){var w=e[o];var p=w.indexOf("：");if(p>=0){var z=w.substring(0,p+1);core.fillText("data",z,c,d,"#FF6A6A","bold 16px Verdana");var r=core.canvas.data.measureText(z).width;core.fillText("data",w.substring(p+1),c+r,d,"#FFFFFF","16px Verdana")}else{core.fillText("data",e[o],c,d,"#FFFFFF","16px Verdana")}d+=24}core.fillText("data","<点击任意位置继续>",270,x+m-13,"#CCCCCC","13px Verdana")};ui.prototype.drawFly=function(b){if(b<0){b=0}if(b>=core.status.hero.flyRange.length){b=core.status.hero.flyRange.length-1}core.status.event.data=b;var a=core.status.hero.flyRange[b];var c=core.status.maps[a].title;core.clearMap("ui");core.setAlpha("ui",0.85);core.fillRect("ui",0,0,416,416,"#000000");core.setAlpha("ui",1);core.canvas.ui.textAlign="center";core.fillText("ui","楼层跳跃",208,60,"#FFFFFF","bold 28px Verdana");core.fillText("ui","返回游戏",208,403,"#FFFFFF","bold 15px Verdana");core.fillText("ui",c,356,247,"#FFFFFF","bold 19px Verdana");if(b<core.status.hero.flyRange.length-1){core.fillText("ui","▲",356,247-64,"#FFFFFF","17px Verdana");core.fillText("ui","▲",356,247-96,"#FFFFFF","17px Verdana");core.fillText("ui","▲",356,247-96-7,"#FFFFFF","17px Verdana")}if(b>0){core.fillText("ui","▼",356,247+64,"#FFFFFF","17px Verdana");core.fillText("ui","▼",356,247+96,"#FFFFFF","17px Verdana");core.fillText("ui","▼",356,247+96+7,"#FFFFFF","17px Verdana")}core.strokeRect("ui",20,100,273,273,"#FFFFFF",2);this.drawThumbnail(a,"ui",core.status.maps[a].blocks,20,100,273)};ui.prototype.drawMaps=function(c,k,l){core.lockControl();core.status.event.id="viewMaps";if(!core.isset(c)){core.status.event.data=null;core.clearMap("ui");core.setAlpha("ui",1);core.clearMap("animate");core.setOpacity("animate",0.4);core.fillRect("animate",0,0,416,416,"#000000");core.strokeRect("ui",66,2,284,60,"#FFD700",4);core.strokeRect("ui",2,66,60,284);core.strokeRect("ui",66,416-62,284,60);core.strokeRect("ui",416-62,66,60,284);core.strokeRect("ui",66,66,284,92);core.strokeRect("ui",66,32*8+2,284,92);core.canvas.ui.textAlign="center";core.fillText("ui","上移地图 [W]",208,38,"#FFD700","20px Arial");core.fillText("ui","下移地图 [S]",208,390);var i=150;core.fillText("ui","左",32,i);core.fillText("ui","移",32,i+32);core.fillText("ui","地",32,i+32*2);core.fillText("ui","图",32,i+32*3);core.fillText("ui","[A]",32,i+32*4);core.fillText("ui","右",384,i);core.fillText("ui","移",384,i+32);core.fillText("ui","地",384,i+32*2);core.fillText("ui","图",384,i+32*3);core.fillText("ui","[D]",384,i+32*4);core.fillText("ui","前张地图 [▲ / PGUP]",208,64+54);core.fillText("ui","后张地图 [▼ / PGDN]",208,32*8+54);core.fillText("ui","退出 [ESC / ENTER]",208,208+8);core.fillText("ui","[X] 可查看怪物手册",285,208+40,null,"13px Arial");return}core.clearMap("animate");core.setOpacity("animate",1);if(core.isset(c.index)){k=c.x;l=c.y;c=c.index}if(c<0){c=0}if(c>=core.floorIds.length){c=core.floorIds.length-1}var a=core.floorIds[c],e=core.floors[a].width||13,d=core.floors[a].height||13;if(!core.isset(k)){k=parseInt(e/2)}if(!core.isset(l)){l=parseInt(d/2)}if(k<6){k=6}if(k>e-7){k=e-7}if(l<6){l=6}if(l>d-7){l=d-7}core.status.event.data={index:c,x:k,y:l,damage:(core.status.event.data||{damage:false}).damage};clearTimeout(core.interval.tipAnimate);core.clearMap("ui");core.setAlpha("ui",1);this.drawThumbnail(a,"ui",core.status.maps[a].blocks,0,0,416,k,l);core.clearMap("data");core.setOpacity("data",0.2);core.canvas.data.textAlign="left";core.setFont("data","16px Arial");var f=core.status.maps[a].title;if(e>13||d>13){f+=" ["+(k-6)+","+(l-6)+"]"}var g=16,h=18,j=g+core.canvas.data.measureText(f).width+16,b=42;core.fillRect("data",5,5,j,b,"#000");core.setOpacity("data",0.4);core.fillText("data",f,g+5,h+15,"#fff")};ui.prototype.drawToolbox=function(h){if(!core.isset(core.status.event.data)||!core.isset(core.status.event.data.toolsPage)||!core.isset(core.status.event.data.constantsPage)){core.status.event.data={toolsPage:1,constantsPage:1,selectId:null}}var q=Object.keys(core.status.hero.items.tools).sort();var b=Object.keys(core.status.hero.items.constants).sort();var r=core.status.event.data.toolsPage;var c=core.status.event.data.constantsPage;var s=Math.ceil(q.length/12);var d=Math.ceil(b.length/12);if(!core.isset(h)){if(q.length>0){h=0}else{if(b.length>0){h=12}else{h=0}}}core.status.event.selection=h;var m;var n;if(h<12){m=h+(r-1)*12;if(m>=q.length){m=Math.max(0,q.length-1)}n=q[m]}else{m=h%12+(c-1)*12;if(m>=b.length){m=Math.max(0,b.length-1)}n=b[m]}if(!core.hasItem(n)){n=null}core.status.event.data.selectId=n;core.clearMap("ui");core.setAlpha("ui",0.85);core.fillRect("ui",0,0,416,416,"#000000");core.setAlpha("ui",1);core.setFillStyle("ui","#DDDDDD");core.setStrokeStyle("ui","#DDDDDD");core.canvas.ui.lineWidth=2;core.canvas.ui.strokeWidth=2;var t=20;core.canvas.ui.beginPath();core.canvas.ui.moveTo(0,130-t);core.canvas.ui.lineTo(416,130-t);core.canvas.ui.stroke();core.canvas.ui.beginPath();core.canvas.ui.moveTo(416,129-t);core.canvas.ui.lineTo(416,105-t);core.canvas.ui.lineTo(416-72,105-t);core.canvas.ui.lineTo(416-102,129-t);core.canvas.ui.fill();core.canvas.ui.beginPath();core.canvas.ui.moveTo(0,290-t);core.canvas.ui.lineTo(416,290-t);core.canvas.ui.stroke();core.canvas.ui.beginPath();core.canvas.ui.moveTo(416,289-t);core.canvas.ui.lineTo(416,265-t);core.canvas.ui.lineTo(416-72,265-t);core.canvas.ui.lineTo(416-102,289-t);core.canvas.ui.fill();core.canvas.ui.textAlign="right";core.fillText("ui","消耗道具",411,124-t,"#333333","bold 16px Verdana");core.fillText("ui","永久道具",411,284-t);core.canvas.ui.textAlign="left";if(core.isset(n)){var j=core.material.items[n];core.fillText("ui",j.name,10,32,"#FFD700","bold 20px Verdana");var o=j.text||"该道具暂无描述。";var l=core.splitLines("ui",o,406,"17px Verdana");core.fillText("ui",l[0],10,62,"#FFFFFF","17px Verdana");if(l.length==1){core.fillText("ui","<继续点击该道具即可进行使用>",10,89,"#CCCCCC","14px Verdana")}else{var k=o.substring(l[0].length);core.fillText("ui",k,10,89,"#FFFFFF","17px Verdana")}}core.canvas.ui.textAlign="right";var g=core.material.images.items;for(var e=0;e<12;e++){var p=q[12*(r-1)+e];if(!core.isset(p)){break}var u=144+Math.floor(e/6)*54+5-t;var f=core.material.icons.items[p];core.canvas.ui.drawImage(g,0,f*32,32,32,16*(4*(e%6)+1)+5,u,32,32);core.fillText("ui",core.itemCount(p),16*(4*(e%6)+1)+40,u+33,"#FFFFFF","bold 14px Verdana");if(n==p){core.strokeRect("ui",16*(4*(e%6)+1)+1,u-4,40,40,"#FFD700")}}for(var e=0;e<12;e++){var a=b[12*(c-1)+e];if(!core.isset(a)){break}var u=304+Math.floor(e/6)*54+5-t;var f=core.material.icons.items[a];core.canvas.ui.drawImage(g,0,f*32,32,32,16*(4*(e%6)+1)+5,u,32,32);if(n==a){core.strokeRect("ui",16*(4*(e%6)+1)+1,u-4,40,40,"#FFD700")}}this.drawPagination(r,s,7);this.drawPagination(c,d,12);core.canvas.ui.textAlign="center";core.fillText("ui","[装备栏]",370,25,"#DDDDDD","bold 15px Verdana");core.fillText("ui","返回游戏",370,403,"#DDDDDD","bold 15px Verdana")};ui.prototype.drawEquipbox=function(m){if(!core.isset(core.status.event.data)||!core.isset(core.status.event.data.page)){core.status.event.data={page:1,selectId:null}}var a=main.equipName||[];var g=a.length;if(!core.isset(core.status.hero.equipment)){core.status.hero.equipment=[]}var e=core.status.hero.equipment;var q=Object.keys(core.status.hero.items.equips).sort();var r=core.status.event.data.page;var u=Math.ceil(q.length/12);if(!core.isset(m)){if(g>0&&core.isset(e[0])){m=0}else{if(q.length>0){m=12}else{m=0}}}if(m>=12&&q.length==0){m=0}var s=null;if(m<12){if(m>=g){m=Math.max(0,g-1)}s=e[m]||null}else{if(r==u){m=Math.min(m,(q.length+11)%12+12)}s=q[m-12+(r-1)*12];if(!core.hasItem(s)){s=null}}core.status.event.selection=m;core.status.event.data.selectId=s;core.clearMap("ui",0,0,416,416);core.setAlpha("ui",0.85);core.fillRect("ui",0,0,416,416,"#000000");core.setAlpha("ui",1);core.setFillStyle("ui","#DDDDDD");core.setStrokeStyle("ui","#DDDDDD");core.canvas.ui.lineWidth=2;core.canvas.ui.strokeWidth=2;var v=20;core.canvas.ui.beginPath();core.canvas.ui.moveTo(0,130-v);core.canvas.ui.lineTo(416,130-v);core.canvas.ui.stroke();core.canvas.ui.beginPath();core.canvas.ui.moveTo(416,129-v);core.canvas.ui.lineTo(416,105-v);core.canvas.ui.lineTo(416-72,105-v);core.canvas.ui.lineTo(416-102,129-v);core.canvas.ui.fill();core.canvas.ui.beginPath();core.canvas.ui.moveTo(0,290-v);core.canvas.ui.lineTo(416,290-v);core.canvas.ui.stroke();core.canvas.ui.beginPath();core.canvas.ui.moveTo(416,289-v);core.canvas.ui.lineTo(416,265-v);core.canvas.ui.lineTo(416-72,265-v);core.canvas.ui.lineTo(416-102,289-v);core.canvas.ui.fill();core.canvas.ui.textAlign="right";core.fillText("ui","当前装备",411,124-v,"#333333","bold 16px Verdana");core.fillText("ui","拥有装备",411,284-v);core.canvas.ui.textAlign="left";if(core.isset(s)){var d=core.material.items[s];if(!core.isset(d.equip)){d.equip={type:0}}var h=d.equip.type;core.fillText("ui",d.name+"（"+(a[h]||"未知部位")+"）",10,32,"#FFD700","bold 20px Verdana");var t=d.text||"该装备暂无描述。";var o=core.splitLines("ui",t,406,"17px Verdana");core.fillText("ui",o[0],10,62,"#FFFFFF","17px Verdana");if(o.length==1){var b;if(m<12){b=core.compareEquipment(null,s)}else{b=core.compareEquipment(s,e[d.equip.type])}var c=10;[["攻击","atk"],["防御","def"],["魔防","mdef"]].forEach(function(C){var D=C[0],x=C[1];if(!core.isset(b[x])||b[x]==0){return}var i="#00FF00";if(b[x]<0){i="#FF0000"}var B=core.getStatus(x),z=B+b[x];if(core.flags.equipPercentage){var A=core.getFlag("equip_"+x+"_buff",1),y=A+b[x]/100;B=Math.floor(A*core.getStatus(x));z=Math.floor(y*core.getStatus(x))}var w=D+" "+B+"->";core.fillText("ui",w,c,89,"#CCCCCC","bold 14px Verdana");c+=core.canvas.ui.measureText(w).width;core.fillText("ui",z,c,89,i);c+=core.canvas.ui.measureText(z).width+15})}else{var n=t.substring(o[0].length);core.fillText("ui",n,10,89,"#FFFFFF","17px Verdana")}}core.canvas.ui.textAlign="right";var l=core.material.images.items;for(var j=0;j<g;j++){var f=e[j]||null;if(core.isset(f)){var k=core.material.icons.items[f];core.canvas.ui.drawImage(l,0,k*32,32,32,16*(8*(j%3)+5)+5,144+Math.floor(j/3)*54+5-v,32,32)}core.fillText("ui",a[j]||"未知",16*(8*(j%3)+1)+40,144+Math.floor(j/3)*54+32-v,"#FFFFFF","bold 16px Verdana");core.strokeRect("ui",16*(8*(j%3)+5)+1,144+Math.floor(j/3)*54+1-v,40,40,m==j?"#FFD700":"#FFFFFF")}for(var j=0;j<12;j++){var p=q[12*(r-1)+j];if(!core.isset(p)){continue}var k=core.material.icons.items[p];core.canvas.ui.drawImage(l,0,k*32,32,32,16*(4*(j%6)+1)+5,304+Math.floor(j/6)*54+5-v,32,32);if(core.itemCount(p)>1){core.fillText("ui",core.itemCount(p),16*(4*(j%6)+1)+40,304+Math.floor(j/6)*54+38-v,"#FFFFFF","bold 14px Verdana")}if(m>=12&&s==p){core.strokeRect("ui",16*(4*(j%6)+1)+1,304+Math.floor(j/6)*54+1-v,40,40,"#FFD700")}}this.drawPagination(r,u,12);core.canvas.ui.textAlign="center";core.fillText("ui","[道具栏]",370,25,"#DDDDDD","bold 15px Verdana");core.fillText("ui","返回游戏",370,403,"#DDDDDD","bold 15px Verdana")};ui.prototype.drawSLPanel=function(d,j){if(!core.isset(d)){d=1}if(d<0){d=0}var i=parseInt(d/10),h=d%10;var g=main.savePages||30;if(i>=g){i=g-1}if(h>5){h=5}d=10*i+h;var e=-1;if(core.isset(core.status.event.data)){e=parseInt(core.status.event.data/10)}core.status.event.data=d;if(!core.isset(core.status.event.ui)){core.status.event.ui=[]}var m=416/6,k=118;var l="#FFD700";if(core.status.event.selection){l="#FF6A6A"}var c=function(){core.clearMap("ui");core.setAlpha("ui",0.85);core.fillRect("ui",0,0,416,416,"#000000");core.setAlpha("ui",1);core.ui.drawPagination(i+1,g,12);core.canvas.ui.textAlign="center";core.fillText("ui","返回游戏",370,403,"#DDDDDD","bold 15px Verdana");if(core.status.event.selection){core.setFillStyle("ui","#FF6A6A")}if(core.status.event.id=="save"){core.fillText("ui","删除模式",48,403)}else{core.fillText("ui","输入编号",48,403)}};var a=function(n,o){var q=core.status.event.id=="save"?"存档":core.status.event.id=="load"?"读档":core.status.event.id=="replayLoad"?"回放":"";core.status.event.ui[o]=n;var p=5*i+o;if(o<3){core.fillText("ui",o==0?"自动存档":q+p,(2*o+1)*m,35,"#FFFFFF","bold 17px Verdana");core.strokeRect("ui",(2*o+1)*m-k/2,50,k,k,o==h?l:"#FFFFFF",o==h?6:2);if(core.isset(n)&&core.isset(n.floorId)){core.ui.drawThumbnail(n.floorId,"ui",core.maps.load(n.maps,n.floorId).blocks,(2*o+1)*m-k/2,50,k,n.hero.loc.x,n.hero.loc.y,n.hero.loc,n.hero.flags.heroIcon||"hero.png");core.fillText("ui",core.formatDate(new Date(n.time)),(2*o+1)*m,65+k,"#FFFFFF","10px Verdana")}else{core.fillRect("ui",(2*o+1)*m-k/2,50,k,k,"#333333",2);core.fillText("ui","空",(2*o+1)*m,117,"#FFFFFF","bold 30px Verdana")}}else{core.fillText("ui",q+p,(2*o-5)*m,230,"#FFFFFF","bold 17px Verdana");core.strokeRect("ui",(2*o-5)*m-k/2,245,k,k,o==h?l:"#FFFFFF",o==h?6:2);if(core.isset(n)&&core.isset(n.floorId)){core.ui.drawThumbnail(n.floorId,"ui",core.maps.load(n.maps,n.floorId).blocks,(2*o-5)*m-k/2,245,k,n.hero.loc.x,n.hero.loc.y,n.hero.loc,n.hero.flags.heroIcon||"hero.png");core.fillText("ui",core.formatDate(new Date(n.time)),(2*o-5)*m,260+k,"#FFFFFF","10px Verdana")}else{core.fillRect("ui",(2*o-5)*m-k/2,245,k,k,"#333333",2);core.fillText("ui","空",(2*o-5)*m,245+70,"#FFFFFF","bold 30px Verdana")}}};function f(o,n){if(o==6){n();return}core.getLocalForage(o==0?"autoSave":"save"+(5*i+o),null,function(p){core.status.event.ui[o]=p;f(o+1,n)},function(p){console.log(p)})}function b(){c();for(var n=0;n<6;n++){a(core.status.event.ui[n],n)}}if(j||i!=e){core.status.event.ui=[];f(0,b)}else{b()}};ui.prototype.drawThumbnail=function(j,g,f,B,C,v,h,i,m,l){var r=core.floors[j].width||13;var q=core.floors[j].height||13;var w=core.bigmap.tempCanvas;var A=r*32,z=q*32;w.canvas.width=A;w.canvas.height=z;w.clearRect(0,0,A,z);core.maps.drawBgFgMap(j,w,"bg");var o=[];if(core.isset((core.status.maps||core.floors)[j].images)){o=(core.status.maps||core.floors)[j].images;if(typeof o=="string"){o=[[0,0,o]]}}o.forEach(function(E){var b=parseInt(E[0]),x=parseInt(E[1]),D=E[2];if(core.isset(b)&&core.isset(x)&&!core.hasFlag("floorimg_"+j+"_"+b+"_"+x)&&core.isset(core.material.images.images[D])){var y=core.material.images.images[D];if(!E[3]){w.drawImage(y,32*b,32*x,y.width,y.height)}else{if(E[3]==2){w.drawImage(y,0,y.height-32,y.width,32,32*b,32*x+y.height-32,y.width,32)}}}});var p=core.maps.getMapArray(f,r,q);for(var a in f){var c=f[a];if(core.isset(c.event)&&!c.disable){if(c.event.cls=="autotile"){core.drawAutotile(w,p,c,32,0,0)}else{if(c.event.cls=="tileset"){var s=core.icons.getTilesetOffset(c.event.id);if(s!=null){w.drawImage(core.material.images.tilesets[s.image],32*s.x,32*s.y,32,32,32*c.x,32*c.y,32,32)}}else{if(c.id==17){if(core.isset(core.material.images.airwall)){w.drawImage(core.material.images.airwall,32*c.x,32*c.y)}}else{if(c.event.id!="none"){var d=core.material.icons[c.event.cls][c.event.id];var e=core.material.images[c.event.cls];var k=c.event.height||32;w.drawImage(e,0,d*k,32,k,32*c.x,32*c.y+32-k,32,k)}}}}}}if(core.isset(m)){if(!core.isset(core.material.images.images[l])){l="hero.png"}var n=core.material.icons.hero[m.direction];var k=core.material.images.images[l].height/4;w.drawImage(core.material.images.images[l],n.stop*32,n.loc*k,32,k,32*m.x,32*m.y+32-k,32,k)}core.maps.drawBgFgMap(j,w,"fg");o.forEach(function(E){var b=parseInt(E[0]),x=parseInt(E[1]),D=E[2];if(core.isset(b)&&core.isset(x)&&!core.hasFlag("floorimg_"+j+"_"+b+"_"+x)&&core.isset(core.material.images.images[D])){var y=core.material.images.images[D];if(E[3]==1){w.drawImage(y,32*b,32*x,y.width,y.height)}else{if(E[3]==2){w.drawImage(y,0,0,y.width,y.height-32,32*b,32*x,y.width,y.height-32)}}}});if(core.status.event.id=="viewMaps"&&(core.status.event.data||{}).damage){core.control.updateDamage(j,w)}core.clearMap(g,B,C,v,v);if(!core.isset(h)){h=parseInt(r/2)}if(!core.isset(i)){i=parseInt(q/2)}var t=core.clamp(h-6,0,r-13),u=core.clamp(i-6,0,q-13);core.canvas[g].drawImage(w.canvas,t*32,u*32,416,416,B,C,v,v)};ui.prototype.drawKeyBoard=function(){core.lockControl();core.status.event.id="keyBoard";core.clearMap("ui");var c=16,g=48,f=416-2*c,b=416-2*g;var a=core.canvas.ui.createPattern(core.material.ground,"repeat");core.fillRect("ui",c,g,f,b,a);core.strokeRect("ui",c-1,g-1,f+1,b+1,"#FFFFFF",2);core.canvas.ui.textAlign="center";core.fillText("ui","虚拟键盘",208,g+35,"#FFD700","bold 22px Verdana");core.setFont("ui","17px Verdana");core.setFillStyle("ui","#FFFFFF");var e=128-9;var d=[["F1","F2","F3","F4","F5","F6","F7","F8","F9","10","11"],["1","2","3","4","5","6","7","8","9","0"],["Q","W","E","R","T","Y","U","I","O","P"],["A","S","D","F","G","H","J","K","L"],["Z","X","C","V","B","N","M"],["-","=","[","]","\\",";","'",",",".","/","`"],["ES","TA","CA","SH","CT","AL","SP","BS","EN","DE"]];d.forEach(function(j){for(var h=0;h<j.length;h++){core.fillText("ui",j[h],48+32*h,e)}e+=32});core.canvas.ui.textAlign="center";core.fillText("ui","返回游戏",416-80,e-3,"#FFFFFF","bold 15px Verdana")};ui.prototype.drawStatistics=function(){var ids=this.uidata.drawStatistics();var obj={};ids.forEach(function(e){obj[e]=0});var total={monster:{count:0,money:0,experience:0,point:0,},count:obj,add:{hp:0,atk:0,def:0,mdef:0}};var current=core.clone(total);core.floorIds.forEach(function(floorId){var floor=core.status.maps[floorId];var blocks=core.status.maps[floorId].blocks;if(floor.cannotViewMap&&floorId!=core.status.floorId){return}blocks.forEach(function(block){if(!core.isset(block.event)||block.disable){return}var event=block.event;if(event.cls.indexOf("enemy")==0){var enemyId=event.id,enemy=core.material.enemys[enemyId];total.monster.money+=enemy.money||0;total.monster.experience+=enemy.experience||0;total.monster.point+=enemy.point||0;total.monster.count++;if(floorId==core.status.floorId){current.monster.money+=enemy.money||0;current.monster.experience+=enemy.experience||0;current.monster.point+=enemy.point||0;current.monster.count++}}else{var id=event.id;var temp=core.clone(core.status.hero);if(core.isset(total.count[id])){var hp=0,atk=0,def=0,mdef=0;if(core.isset(core.material.items[id])&&core.material.items[id].cls=="items"&&id!="superPotion"){var ratio=floor.item_ratio||1;if(core.isset(core.items.itemEffect[id])){eval(core.items.itemEffect[id])}hp=core.status.hero.hp-temp.hp;atk=core.status.hero.atk-temp.atk;def=core.status.hero.def-temp.def;mdef=core.status.hero.mdef-temp.mdef}else{if(id.indexOf("sword")==0&&core.isset(core.values[id])){var x=core.values[id];if(typeof x=="number"){x={atk:x}}atk+=x.atk||0;def+=x.def||0;mdef+=x.mdef||0}if(id.indexOf("shield")==0&&core.isset(core.values[id])){var x=core.values[id];if(typeof x=="number"){x={def:x}}atk+=x.atk||0;def+=x.def||0;mdef+=x.mdef||0}}core.status.hero=core.clone(temp);total.count[id]++;total.add.hp+=hp;total.add.atk+=atk;total.add.def+=def;total.add.mdef+=mdef;if(floorId==core.status.floorId){current.count[id]++;current.add.hp+=hp;current.add.atk+=atk;current.add.def+=def;current.add.mdef+=mdef}}}})});var getText=function(type,data){var text=type+"地图中：\n";text+="共有怪物"+data.monster.count+"个";if(core.flags.enableMoney){text+="，总金币数"+data.monster.money}if(core.flags.enableExperience){text+="，总经验数"+data.monster.experience}if(core.flags.enableAddPoint){text+="，总加点数"+data.monster.point}text+="。\n\n";Object.keys(data.count).forEach(function(key){var value=data.count[key];if(value>0){var name=null;if(key=="yellowDoor"){name="黄门"}else{if(key=="blueDoor"){name="蓝门"}else{if(key=="redDoor"){name="红门"}else{if(key=="greenDoor"){name="绿门"}else{if(key=="steelDoor"){name="铁门"}else{name=(core.material.items[key]||{}).name}}}}}if(core.isset(name)){text+=name+value+"个；"}}});text+="\n\n";text+="共加生命值"+core.formatBigNumber(data.add.hp)+"点，攻击"+core.formatBigNumber(data.add.atk)+"点，防御"+core.formatBigNumber(data.add.def)+"点，魔防"+core.formatBigNumber(data.add.mdef)+"点。";return text};var formatTime=function(time){return core.setTwoDigits(parseInt(time/3600000))+":"+core.setTwoDigits(parseInt(time/60000)%60)+":"+core.setTwoDigits(parseInt(time/1000)%60)};var statistics=core.status.hero.statistics;core.drawText([getText("全塔",total),getText("当前",current),"当前总步数："+core.status.hero.steps+"，当前游戏时长："+formatTime(statistics.currTime)+"，总游戏时长"+formatTime(statistics.totalTime)+"。\n瞬间移动次数："+statistics.moveDirectly+"，共计少走"+statistics.ignoreSteps+"步。\n\n总计通过血瓶恢复生命值为"+core.formatBigNumber(statistics.hp)+"点。\n\n总计打死了"+statistics.battle+"个怪物，受到的伤害为"+core.formatBigNumber(statistics.battleDamage+statistics.poisonDamage+statistics.extraDamage)+"，其中战斗伤害"+core.formatBigNumber(statistics.battleDamage)+"点"+(core.flags.enableDebuff?("，中毒伤害"+core.formatBigNumber(statistics.poisonDamage)+"点"):"")+"，领域/夹击/阻击/血网伤害"+core.formatBigNumber(statistics.extraDamage)+"点。","\t[说明]1. 地图数据统计的效果仅模拟当前立刻获得该道具的效果。\n2. 不会计算“不可被浏览地图”的隐藏层的数据。\n3. 不会计算任何通过事件得到的道具（显示事件、改变图块、或直接增加道具等）。\n4. 在自定义道具（例如其他宝石）后，需在ui.js的drawStatistics中注册，不然不会进行统计。\n5. 所有统计信息仅供参考，如有错误，概不负责。"])};ui.prototype.drawAbout=function(){return this.uidata.drawAbout()};ui.prototype.drawHelp=function(){core.drawText(["\t[键盘快捷键列表][CTRL] 跳过对话\n[Z] 转向\n[X] 打开/关闭怪物手册\n[G] 打开/关闭楼层传送器\n[A] 读取自动存档（回退）\n[S/D] 打开/关闭存/读档页面\n[K/V] 打开/关闭快捷商店选择列表\n[T] 打开/关闭工具栏\n[ESC] 打开/关闭系统菜单\n[B] 打开数据统计\n[H] 打开帮助页面\n[R] 回放\n[SPACE] 轻按（仅在轻按开关打开时有效）\n[PgUp/PgDn] 浏览地图\n[1] 快捷使用破墙镐\n[2] 快捷使用炸弹/圣锤\n[3] 快捷使用中心对称飞行器","\t[鼠标操作]点状态栏中图标： 进行对应的操作\n点任意块： 寻路并移动\n点任意块并拖动： 指定寻路路线\n双击空地： 瞬间移动\n单击勇士： 转向\n双击勇士： 轻按（仅在轻按开关打开时有效）\n长按任意位置：跳过剧情对话或打开虚拟键盘\n"])};function core(){this.material={animates:{},images:{},bgms:{},sounds:{},ground:null,items:{},enemys:{},icons:{},events:{}};this.timeout={getItemTipTimeout:null,turnHeroTimeout:null,onDownTimeout:null,};this.interval={heroMoveInterval:null,tipAnimate:null,openDoorAnimate:null,animateInterval:null,onDownInterval:null,};this.animateFrame={background:null,globalAnimate:false,globalTime:null,boxTime:null,animateTime:null,moveTime:null,speed:null,weather:{time:null,type:null,level:0,nodes:[],data:null,}};this.musicStatus={audioContext:null,startDirectly:false,bgmStatus:false,soundStatus:true,playingBgm:null,isPlaying:false,gainNode:null,volume:1,};this.platform={isOnline:true,isPC:true,isAndroid:false,isIOS:false,isWeChat:false,isQQ:false,isChrome:false,supportCopy:false,useLocalForage:true,fileInput:null,fileReader:null,successCallback:null,errorCallback:null,};this.domStyle={styles:[],scale:1,};this.bigmap={canvas:["bg","event","event2","fg","damage","route"],offsetX:0,offsetY:0,width:13,height:13,tempCanvas:null,};this.initStatus={played:false,gameOver:false,hero:{},floorId:null,thisMap:null,maps:null,checkBlock:{},lockControl:false,heroMoving:0,heroStop:true,automaticRoute:{autoHeroMove:false,autoStep:0,movedStep:0,destStep:0,destX:null,destY:null,autoStepRoutes:[],moveStepBeforeStop:[],lastDirection:null,cursorX:null,cursorY:null,moveDirectly:false,},downTime:null,ctrlDown:false,route:[],replay:{replaying:false,pausing:false,animate:false,toReplay:[],totalList:[],speed:1,steps:0,save:[],},saveIndex:null,shops:{},event:{id:null,data:null,selection:null,ui:null,interval:null,},textAttribute:{position:"center",title:[255,215,0,1],background:[0,0,0,0.85],text:[255,255,255,1],titlefont:22,textfont:16,bold:false,time:0,},curtainColor:null,openingDoor:null,isSkiing:false,globalAnimateObjs:[],boxAnimateObjs:[],animateObjs:[],};this.status={}}core.prototype.init=function(d,a){for(var g in d){core[g]=d[g]}core.flags=core.clone(core.data.flags);core.values=core.clone(core.data.values);core.firstData=core.data.getFirstData();if(!core.flags.enableExperience){core.flags.enableLevelUp=false}if(!core.flags.canOpenBattleAnimate){core.flags.showBattleAnimateConfirm=false;core.flags.battleAnimate=false;core.setLocalStorage("battleAnimate",false)}if(core.isset(core.firstData.shops)){core.firstData.shops.forEach(function(e){core.initStatus.shops[e.id]=e})}core.dom.versionLabel.innerHTML=core.firstData.version;core.dom.logoLabel.innerHTML=core.firstData.title;document.title=core.firstData.title+" - HTML5魔塔";document.getElementById("startLogo").innerHTML=core.firstData.title;core.material.items=core.clone(core.items.getItems());core.material.enemys=core.clone(core.enemys.getEnemys());core.material.icons=core.icons.getIcons();core.material.events=core.events.getEvents();core.platform.isOnline=location.protocol.indexOf("http")==0;if(core.platform.isOnline){window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext;try{core.musicStatus.audioContext=new window.AudioContext();core.musicStatus.gainNode=core.musicStatus.audioContext.createGain();core.musicStatus.gainNode.connect(core.musicStatus.audioContext.destination)}catch(f){console.log("该浏览器不支持AudioContext");core.musicStatus.audioContext=null}}["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"].forEach(function(e){if(navigator.userAgent.indexOf(e)>=0){if(e=="iPhone"||e=="iPad"||e=="iPod"){core.platform.isIOS=true}if(e=="Android"){core.platform.isAndroid=true}core.platform.isPC=false}});try{core.platform.supportCopy=document.queryCommandSupported("copy")}catch(f){core.platform.supportCopy=false}var b=/Chrome\/(\d+)\./i.exec(navigator.userAgent);if(core.isset(b)&&parseInt(b[1])>=50){core.platform.isChrome=true}core.platform.isSafari=/Safari/i.test(navigator.userAgent)&&!/Chrome/i.test(navigator.userAgent);core.platform.isQQ=/QQ/i.test(navigator.userAgent);core.platform.isWeChat=/MicroMessenger/i.test(navigator.userAgent);core.platform.useLocalForage=core.getLocalStorage("useLocalForage",!core.platform.isIOS);if(core.platform.useLocalForage){try{core.setLocalForage("__test__",LZString.compress("__test__"),function(){try{core.getLocalForage("__test__",null,function(i){try{if(LZString.decompress(i)!="__test__"){console.log("localForage unsupported!");core.platform.useLocalForage=false}else{console.log("localForage supported!");core.removeLocalForage("__test__")}}catch(j){console.log(j);core.platform.useLocalForage=false}},function(i){console.log(i);core.platform.useLocalForage=false})}catch(h){console.log(h);core.platform.useLocalForage=false}},function(h){console.log(h);core.platform.useLocalForage=false})}catch(f){console.log(f);core.platform.useLocalForage=false}}if(window.FileReader){core.platform.fileReader=new FileReader();core.platform.fileReader.onload=function(){core.readFileContent(core.platform.fileReader.result)};core.platform.fileReader.onerror=function(){if(core.isset(core.platform.errorCallback)){core.platform.errorCallback()}}}if(core.platform.isPC){core.musicStatus.startDirectly=true}else{var c=navigator.connection;if(core.isset(c)&&c.type=="wifi"){core.musicStatus.startDirectly=true}}core.musicStatus.bgmStatus=core.getLocalStorage("bgmStatus",true);if(!core.musicStatus.startDirectly){core.musicStatus.bgmStatus=false}core.setLocalStorage("bgmStatus",core.musicStatus.bgmStatus);core.musicStatus.soundStatus=core.getLocalStorage("soundStatus",true);core.setLocalStorage("soundStatus",core.musicStatus.soundStatus);core.flags.battleAnimate=core.getLocalStorage("battleAnimate",core.flags.battleAnimate);core.flags.displayEnemyDamage=core.getLocalStorage("enemyDamage",core.flags.displayEnemyDamage);core.flags.displayCritical=core.getLocalStorage("critical",core.flags.displayCritical);core.flags.displayExtraDamage=core.getLocalStorage("extraDamage",core.flags.displayExtraDamage);core.flags.clickMoveDirectly=core.getLocalStorage("clickMoveDirectly",core.flags.clickMoveDirectly);core.material.ground=new Image();core.material.ground.src="project/images/ground.png";core.bigmap.tempCanvas=document.createElement("canvas").getContext("2d");core.loader.load(function(){console.log(core.material);core.material.icons.hero.height=core.material.images.hero.height/4;core.control.updateHeroIcon();core.initStatus.maps=core.maps.initMaps(core.floorIds);core.setRequestAnimationFrame();core.showStartAnimate();if(main.mode=="play"){core.events.initGame()}if(core.isset(functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.plugins)){core.plugin=new functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.plugins.plugin()}if(core.isset(a)){a()}})};core.prototype.setRequestAnimationFrame=function(){core.control.setRequestAnimationFrame()};core.prototype.showStartAnimate=function(a){core.control.showStartAnimate(a)};core.prototype.hideStartAnimate=function(a){core.control.hideStartAnimate(a)};core.prototype.isPlaying=function(){return core.control.isPlaying()};core.prototype.clearStatus=function(){core.control.clearStatus()};core.prototype.resetStatus=function(c,b,a,e,d,f){core.control.resetStatus(c,b,a,e,d,f)};core.prototype.startGame=function(b,a){core.control.startGame(b,a)};core.prototype.restart=function(){core.control.restart()};core.prototype.onkeyDown=function(a){return core.actions.onkeyDown(a)};core.prototype.onkeyUp=function(a){return core.actions.onkeyUp(a)};core.prototype.pressKey=function(a){return core.actions.pressKey(a)};core.prototype.keyDown=function(a){return core.actions.keyDown(a)};core.prototype.keyUp=function(a){return core.actions.keyUp(a)};core.prototype.ondown=function(a,b){return core.actions.ondown(a,b)};core.prototype.onmove=function(a,b){return core.actions.onmove(a,b)};core.prototype.onup=function(){return core.actions.onup()};core.prototype.getClickLoc=function(a,b){return core.actions.getClickLoc(a,b)};core.prototype.onclick=function(b,c,a){return core.actions.onclick(b,c,a)};core.prototype.onmousewheel=function(a){return core.actions.onmousewheel(a)};core.prototype.clearAutomaticRouteNode=function(a,b){core.control.clearAutomaticRouteNode(a,b)};core.prototype.stopAutomaticRoute=function(){core.control.stopAutomaticRoute()};core.prototype.continueAutomaticRoute=function(){core.control.continueAutomaticRoute()};core.prototype.clearContinueAutomaticRoute=function(){core.control.clearContinueAutomaticRoute()};core.prototype.setAutomaticRoute=function(a,b,c){core.control.setAutomaticRoute(a,b,c)};core.prototype.automaticRoute=function(a,b){return core.control.automaticRoute(a,b)};core.prototype.fillPosWithPoint=function(a){core.control.fillPosWithPoint(a)};core.prototype.setAutoHeroMove=function(a){core.control.setAutoHeroMove(a)};core.prototype.setHeroMoveInterval=function(b,c,d,a){core.control.setHeroMoveInterval(b,c,d,a)};core.prototype.moveAction=function(a){core.control.moveAction(a)};core.prototype.turnHero=function(a){core.control.turnHero(a)};core.prototype.canMoveHero=function(c,d,a,b){return core.maps.canMoveHero(c,d,a,b)};core.prototype.canMoveDirectly=function(a,b){return core.maps.canMoveDirectly(a,b)};core.prototype.moveHero=function(b,a){core.control.moveHero(b,a)};core.prototype.eventMoveHero=function(b,c,a){core.control.eventMoveHero(b,c,a)};core.prototype.jumpHero=function(b,c,d,a){core.control.jumpHero(b,c,d,a)};core.prototype.moveOneStep=function(){core.control.moveOneStep()};core.prototype.waitHeroToStop=function(a){core.control.waitHeroToStop(a)};core.prototype.stopHero=function(){core.control.stopHero()};core.prototype.drawHero=function(a,d,e,c,b){core.control.drawHero(a,d,e,c,b)};core.prototype.setHeroLoc=function(a,b,c){core.control.setHeroLoc(a,b,c)};core.prototype.getHeroLoc=function(a){return core.control.getHeroLoc(a)};core.prototype.nextX=function(a){return core.control.nextX(a)};core.prototype.nextY=function(a){return core.control.nextY(a)};core.prototype.openDoor=function(b,d,e,c,a){core.events.openDoor(b,d,e,c,a)};core.prototype.battle=function(c,d,e,b,a){core.events.battle(c,d,e,b,a)};core.prototype.afterBattle=function(b,c,d,a){core.events.afterBattle(b,c,d,a)};core.prototype.trigger=function(a,b){core.events.trigger(a,b)};core.prototype.changeFloor=function(b,e,d,f,a,c){core.events.changeFloor(b,e,d,f,a,c)};core.prototype.clearMap=function(b,d,e,c,a){core.ui.clearMap(b,d,e,c,a)};core.prototype.fillText=function(b,d,e,f,c,a){core.ui.fillText(b,d,e,f,c,a)};core.prototype.fillRect=function(b,e,f,d,a,c){core.ui.fillRect(b,e,f,d,a,c)};core.prototype.strokeRect=function(c,f,g,e,a,d,b){core.ui.strokeRect(c,f,g,e,a,d,b)};core.prototype.drawLine=function(b,d,f,e,g,c,a){core.ui.drawLine(b,d,f,e,g,c,a)};core.prototype.setFont=function(b,a){core.ui.setFont(b,a)};core.prototype.setLineWidth=function(b,a){core.ui.setLineWidth(b,a)};core.prototype.saveCanvas=function(a){core.ui.saveCanvas(a)};core.prototype.loadCanvas=function(a){core.ui.loadCanvas(a)};core.prototype.setStrokeStyle=function(a,b){core.ui.setStrokeStyle(a,b)};core.prototype.setAlpha=function(b,a){core.ui.setAlpha(b,a)};core.prototype.setOpacity=function(a,b){core.ui.setOpacity(a,b)};core.prototype.setFillStyle=function(a,b){core.ui.setFillStyle(a,b)};core.prototype.drawBlock=function(b,a,c,d){core.maps.drawBlock(b,a,c,d)};core.prototype.drawMap=function(b,a){core.maps.drawMap(b,a)};core.prototype.drawAutotile=function(b,d,a,e,c,f){core.maps.drawAutotile(b,d,a,e,c,f)};core.prototype.noPassExists=function(b,c,a){return core.maps.noPassExists(b,c,a)};core.prototype.noPass=function(a,b){return core.maps.noPass(a,b)};core.prototype.npcExists=function(b,c,a){return core.maps.npcExists(b,c,a)};core.prototype.terrainExists=function(c,d,b,a){return core.maps.terrainExists(c,d,b,a)};core.prototype.stairExists=function(b,c,a){return core.maps.stairExists(b,c,a)};core.prototype.nearStair=function(){return core.maps.nearStair()};core.prototype.enemyExists=function(c,d,b,a){return core.maps.enemyExists(c,d,b,a)};core.prototype.getBlock=function(c,d,a,b){return core.maps.getBlock(c,d,a,b)};core.prototype.getBlockId=function(c,d,a,b){return core.maps.getBlockId(c,d,a,b)};core.prototype.getBlockCls=function(c,d,a,b){return core.maps.getBlockCls(c,d,a,b)};core.prototype.moveBlock=function(e,f,c,d,b,a){core.maps.moveBlock(e,f,c,d,b,a)};core.prototype.jumpBlock=function(e,f,b,c,g,d,a){core.maps.jumpBlock(e,f,b,c,g,d,a)};core.prototype.animateBlock=function(b,d,c,a){core.maps.animateBlock(b,d,c,a)};core.prototype.showBlock=function(b,c,a){core.maps.showBlock(b,c,a)};core.prototype.hideBlock=function(b,c,a){core.maps.hideBlock(b,c,a)};core.prototype.removeBlock=function(b,c,a){core.maps.removeBlock(b,c,a)};core.prototype.removeBlockById=function(b,a){core.maps.removeBlockById(b,a)};core.prototype.removeBlockByIds=function(a,b){core.maps.removeBlockByIds(a,b)};core.prototype.setBlock=function(b,c,d,a){core.maps.setBlock(b,c,d,a)};core.prototype.setBgFgBlock=function(b,c,d,e,a){core.maps.setBgFgBlock(b,c,d,e,a)};core.prototype.addGlobalAnimate=function(a){core.maps.addGlobalAnimate(a)};core.prototype.removeGlobalAnimate=function(b,c,a){core.maps.removeGlobalAnimate(b,c,a)};core.prototype.setGlobalAnimate=function(a){core.maps.setGlobalAnimate(a)};core.prototype.syncGlobalAnimate=function(){core.maps.syncGlobalAnimate()};core.prototype.drawBoxAnimate=function(){core.maps.drawBoxAnimate()};core.prototype.drawAnimate=function(b,c,d,a){core.maps.drawAnimate(b,c,d,a)};core.prototype.updateCheckBlock=function(){core.control.updateCheckBlock()};core.prototype.checkBlock=function(){core.control.checkBlock()};core.prototype.snipe=function(a){core.control.snipe(a)};core.prototype.setWeather=function(b,a){core.control.setWeather(b,a)};core.prototype.setFg=function(b,c,a){core.control.setFg(b,c,a)};core.prototype.updateDamage=function(){core.control.updateDamage()};core.prototype.hasSpecial=function(a,b){return core.enemys.hasSpecial(a,b)};core.prototype.canBattle=function(a,c,d,b){return core.enemys.canBattle(a,c,d,b)};core.prototype.getDamage=function(a,c,d,b){return core.enemys.getDamage(a,c,d,b)};core.prototype.itemCount=function(a){return core.items.itemCount(a)};core.prototype.hasItem=function(a){return core.items.hasItem(a)};core.prototype.hasEquip=function(a){return core.items.hasEquip(a)};core.prototype.getEquip=function(a){return core.items.getEquip(a)};core.prototype.setItem=function(a,b){core.items.setItem(a,b)};core.prototype.removeItem=function(a,b){return core.items.removeItem(a,b)};core.prototype.useItem=function(b,a){core.items.useItem(b,a)};core.prototype.canUseItem=function(a){return core.items.canUseItem(a)};core.prototype.loadEquip=function(b,a){core.items.loadEquip(b,a)};core.prototype.unloadEquip=function(b,a){core.items.unloadEquip(b,a)};core.prototype.compareEquipment=function(b,a){return core.items.compareEquipment(b,a)};core.prototype.addItem=function(a,b){core.items.addItem(a,b)};core.prototype.getNextItem=function(){return core.events.getNextItem()};core.prototype.getItem=function(b,c,d,e,a){core.events.getItem(b,c,d,e,a)};core.prototype.drawTip=function(b,a){core.ui.drawTip(b,a)};core.prototype.drawText=function(b,a){core.ui.drawText(b,a)};core.prototype.replaceText=function(a){return core.utils.replaceText(a)};core.prototype.calValue=function(a){return core.utils.calValue(a)};core.prototype.doEffect=function(a){core.control.doEffect(a)};core.prototype.splitLines=function(a,d,c,b){return core.utils.splitLines(a,d,c,b)};core.prototype.unshift=function(c,d){return core.utils.unshift(c,d)};core.prototype.setLocalStorage=function(a,b){return core.utils.setLocalStorage(a,b)};core.prototype.getLocalStorage=function(b,a){return core.utils.getLocalStorage(b,a)};core.prototype.removeLocalStorage=function(a){core.utils.removeLocalStorage(a)};core.prototype.setLocalForage=function(b,d,c,a){core.utils.setLocalForage(b,d,c,a)};core.prototype.getLocalForage=function(c,a,d,b){core.utils.getLocalForage(c,a,d,b)};core.prototype.removeLocalForage=function(b,c,a){core.utils.removeLocalForage(b,c,a)};core.prototype.clone=function(a){return core.utils.clone(a)};core.prototype.cropImage=function(a,b){return core.utils.cropImage(a,b)};core.prototype.formatDate=function(a){return core.utils.formatDate(a)};core.prototype.formatDate2=function(a){return core.utils.formatDate2(a)};core.prototype.formatBigNumber=function(a){return core.utils.formatBigNumber(a)};core.prototype.setTwoDigits=function(a){return core.utils.setTwoDigits(a)};core.prototype.arrayToRGB=function(a){return core.utils.arrayToRGB(a)};core.prototype.debug=function(){core.control.debug()};core.prototype.beforeSaveData=function(a){return core.events.beforeSaveData(a)};core.prototype.afterLoadData=function(a){return core.events.afterLoadData(a)};core.prototype.resetMap=function(a){core.maps.resetMap(a)};core.prototype.startReplay=function(a){core.control.startReplay(a)};core.prototype.closePanel=function(){core.ui.closePanel()};core.prototype.triggerReplay=function(){core.control.triggerReplay()};core.prototype.pauseReplay=function(){core.control.pauseReplay()};core.prototype.resumeReplay=function(){core.control.resumeReplay()};core.prototype.speedUpReplay=function(){core.control.speedUpReplay()};core.prototype.speedDownReplay=function(){core.control.speedDownReplay()};core.prototype.setReplaySpeed=function(a){core.control.setReplaySpeed(a)};core.prototype.rewindReplay=function(){core.control.rewindReplay()};core.prototype.stopReplay=function(){core.control.stopReplay()};core.prototype.saveReplay=function(){core.control.saveReplay()};core.prototype.bookReplay=function(){core.control.bookReplay()};core.prototype.viewMapReplay=function(){core.control.viewMapReplay()};core.prototype.replay=function(){core.control.replay()};core.prototype.checkStatus=function(b,c,a){return core.control.checkStatus(b,c,a)};core.prototype.openBook=function(a){core.control.openBook(a)};core.prototype.useFly=function(a){core.control.useFly(a)};core.prototype.openEquipbox=function(a){core.control.openEquipbox(a)};core.prototype.openToolbox=function(a){core.control.openToolbox(a)};core.prototype.openQuickShop=function(a){core.control.openQuickShop(a)};core.prototype.save=function(a){core.control.save(a)};core.prototype.load=function(a){core.control.load(a)};core.prototype.openSettings=function(a){core.control.openSettings(a)};core.prototype.autosave=function(a){core.control.autosave(a)};core.prototype.doSL=function(a,b){core.control.doSL(a,b)};core.prototype.syncSave=function(a){core.control.syncSave(a)};core.prototype.syncLoad=function(){core.control.syncLoad()};core.prototype.saveData=function(){return core.control.saveData()};core.prototype.loadData=function(b,a){core.control.loadData(b,a)};core.prototype.encodeRoute=function(a){return core.utils.encodeRoute(a)};core.prototype.decodeRoute=function(a){return core.utils.decodeRoute(a)};core.prototype.http=function(f,g,b,e,a,c,d){core.utils.http(f,g,b,e,a,c,d)};core.prototype.setStatus=function(a,b){core.control.setStatus(a,b)};core.prototype.getStatus=function(a){return core.control.getStatus(a)};core.prototype.getLvName=function(){return core.control.getLvName()};core.prototype.setFlag=function(a,b){core.control.setFlag(a,b)};core.prototype.getFlag=function(b,a){return core.control.getFlag(b,a)};core.prototype.hasFlag=function(a){return core.control.hasFlag(a)};core.prototype.doAction=function(){core.events.doAction()};core.prototype.insertAction=function(b,c,d,a){core.events.insertAction(b,c,d,a)};core.prototype.lockControl=function(){core.control.lockControl()};core.prototype.unLockControl=function(){core.control.unLockControl()};core.prototype.isset=function(a){return core.utils.isset(a)};core.prototype.subarray=function(c,d){return core.utils.subarray(c,d)};core.prototype.clamp=function(e,c,d){return core.utils.clamp(e,c,d)};core.prototype.encodeBase64=function(a){return core.utils.encodeBase64(a)};core.prototype.decodeBase64=function(a){return core.utils.decodeBase64(a)};core.prototype.rand=function(a){return core.utils.rand(a)};core.prototype.rand2=function(a){return core.utils.rand2(a)};core.prototype.readFile=function(c,a,b){core.utils.readFile(c,a,b)};core.prototype.readFileContent=function(a){core.utils.readFileContent(a)};core.prototype.download=function(b,a){core.utils.download(b,a)};core.prototype.copy=function(a){return core.utils.copy(a)};core.prototype.playBgm=function(a){core.control.playBgm(a)};core.prototype.pauseBgm=function(){core.control.pauseBgm()};core.prototype.resumeBgm=function(){core.control.resumeBgm()};core.prototype.playSound=function(a){core.control.playSound(a)};core.prototype.show=function(b,c,a){core.utils.show(b,c,a)};core.prototype.hide=function(b,c,a){core.utils.hide(b,c,a)};core.prototype.clearStatusBar=function(){core.control.clearStatusBar()};core.prototype.updateStatusBar=function(){core.control.updateStatusBar()};core.prototype.resize=function(b,a){core.control.resize(b,a)};core.prototype.domRenderer=function(){core.control.domRenderer()};var core=new core();