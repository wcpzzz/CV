function control(){this.init()}control.prototype.init=function(){this.controldata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.control};control.prototype.setRequestAnimationFrame=function(){(function(){var c=0;var d=["webkit","moz"];for(var e=0;e<d.length&&!window.requestAnimationFrame;++e){window.requestAnimationFrame=window[d[e]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[d[e]+"CancelAnimationFrame"]||window[d[e]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(f,h){var g=new Date().getTime();var j=Math.max(0,16.7-(g-c));var i=window.setTimeout(function(){f(g+j)},j);c=g+j;return i}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(f){clearTimeout(f)}}}());core.animateFrame.speed=core.values.animateSpeed;core.animateFrame.background=core.canvas.ui.createPattern(core.material.ground,"repeat");var b={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var a=function(g){core.animateFrame.globalTime=core.animateFrame.globalTime||g;core.animateFrame.boxTime=core.animateFrame.boxTime||g;core.animateFrame.animateTime=core.animateFrame.animateTime||g;core.animateFrame.moveTime=core.animateFrame.moveTime||g;core.animateFrame.weather.time=core.animateFrame.weather.time||g;if(core.isPlaying()&&core.isset(core.status)&&core.isset(core.status.hero)&&core.isset(core.status.hero.statistics)){core.status.hero.statistics.totalTime+=g-(core.status.hero.statistics.start||g);core.status.hero.statistics.currTime+=g-(core.status.hero.statistics.start||g);core.status.hero.statistics.start=g}if(core.animateFrame.globalAnimate&&core.isPlaying()){if(g-core.animateFrame.globalTime>core.animateFrame.speed&&core.isset(core.status.globalAnimateObjs)){for(var c=0;c<core.status.globalAnimateObjs.length;c++){var f=core.status.globalAnimateObjs[c];f.status=(f.status+1)%(f.event.animate||1);core.drawBlock(f,f.status)}core.animateFrame.globalTime=g}}if(g-core.animateFrame.boxTime>core.animateFrame.speed&&core.isset(core.status.boxAnimateObjs)&&core.status.boxAnimateObjs.length>0){core.drawBoxAnimate();core.animateFrame.boxTime=g}if(g-core.animateFrame.animateTime>50&&core.isset(core.status.animateObjs)&&core.status.animateObjs.length>0){core.clearMap("animate");core.status.animateObjs=core.status.animateObjs.filter(function(j){return j.index<j.animate.frames.length});core.status.animateObjs.forEach(function(j){core.maps.drawAnimateFrame(j.animate,j.centerX,j.centerY,j.index++)});core.animateFrame.animateTime=g}if(g-core.animateFrame.moveTime>16&&core.isset(core.status.heroMoving)&&core.status.heroMoving>0){var h=core.getHeroLoc("x"),i=core.getHeroLoc("y"),e=core.getHeroLoc("direction");if(core.status.heroMoving<=4){core.drawHero(e,h,i,"leftFoot",4*core.status.heroMoving)}else{if(core.status.heroMoving<=8){core.drawHero(e,h,i,"rightFoot",4*core.status.heroMoving)}}core.animateFrame.moveTime=g}if(core.isPlaying()&&g-core.animateFrame.weather.time>30){if(core.animateFrame.weather.type=="rain"&&core.animateFrame.weather.level>0){core.clearMap("weather");core.canvas.weather.strokeStyle="rgba(174,194,224,0.8)";core.canvas.weather.lineWidth=1;core.canvas.weather.lineCap="round";core.animateFrame.weather.nodes.forEach(function(j){core.canvas.weather.beginPath();core.canvas.weather.moveTo(j.x,j.y);core.canvas.weather.lineTo(j.x+j.l*j.xs,j.y+j.l*j.ys);core.canvas.weather.stroke();j.x+=j.xs;j.y+=j.ys;if(j.x>416||j.y>416){j.x=Math.random()*416;j.y=-10}});core.canvas.weather.fill()}else{if(core.animateFrame.weather.type=="snow"&&core.animateFrame.weather.level>0){core.clearMap("weather");core.canvas.weather.fillStyle="rgba(255, 255, 255, 0.8)";core.canvas.weather.beginPath();if(!core.isset(core.animateFrame.weather.data)){core.animateFrame.weather.data=0}core.animateFrame.weather.data+=0.01;var d=core.animateFrame.weather.data;core.animateFrame.weather.nodes.forEach(function(j){core.canvas.weather.moveTo(j.x,j.y);core.canvas.weather.arc(j.x,j.y,j.r,0,Math.PI*2,true);j.x+=Math.sin(d)*2;j.y+=Math.cos(d+j.d)+1+j.r/2;if(j.x>416+5||j.x<-5||j.y>416){if(Math.random()>1/3){j.x=Math.random()*416;j.y=-10}else{if(Math.sin(d)>0){j.x=-5;j.y=Math.random()*416}else{j.x=416+5;j.y=Math.random()*416}}}});core.canvas.weather.fill()}}core.animateFrame.weather.time=g}functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.plugins.parallelDo(g);window.requestAnimationFrame(a)};window.requestAnimationFrame(a)};control.prototype.showStartAnimate=function(a){core.dom.startPanel.style.opacity=1;core.dom.startPanel.style.display="block";core.dom.startTop.style.opacity=1;core.dom.startTop.style.display="block";core.dom.startButtonGroup.style.display="none";core.dom.startButtons.style.display="block";core.dom.levelChooseButtons.style.display="none";core.status.played=false;core.clearStatus();core.clearMap("all");var b=1;var c=window.setInterval(function(){b-=0.03;if(b<0){clearInterval(c);core.dom.startTop.style.display="none";core.dom.startButtonGroup.style.display="block";if(core.isset(a)){a()}}core.dom.startTop.style.opacity=b},20)};control.prototype.hideStartAnimate=function(a){var b=1;var c=window.setInterval(function(){b-=0.03;if(b<0){clearInterval(c);core.dom.startPanel.style.display="none";if(core.isset(a)){a()}}core.dom.startPanel.style.opacity=b},20)};control.prototype.isPlaying=function(){return core.isset(core.status.played)&&core.status.played};control.prototype.clearStatus=function(){for(var a in core.timeout){clearTimeout(core.timeout[a]);core.timeout[a]=null}for(var a in core.interval){clearInterval(core.interval[a]);core.interval[a]=null}core.status={};core.clearStatusBar();core.status.played=false;core.events.setHeroIcon("hero.png",true)};control.prototype.resetStatus=function(c,b,a,e,d,g){var f=0;if(core.isset(core.status)&&core.isset(core.status.hero)&&core.isset(core.status.hero.statistics)&&core.isset(e)){f=core.status.hero.statistics.totalTime}core.clearStatus();core.status=core.clone(core.initStatus);core.status.floorId=a;core.status.maps=core.clone(d);core.material.enemys=core.clone(core.enemys.getEnemys());core.material.items=core.clone(core.items.getItems());core.status.hero=core.clone(c);core.events.setHeroIcon(core.getFlag("heroIcon","hero.png"),true);if(!core.isset(core.status.hero.statistics)){core.status.hero.statistics={totalTime:f,currTime:0,hp:0,battle:0,battleDamage:0,poisonDamage:0,extraDamage:0,moveDirectly:0,ignoreSteps:0,}}core.status.hero.statistics.totalTime=Math.max(core.status.hero.statistics.totalTime,f);core.status.hero.statistics.start=null;core.status.hard=b;if(core.isset(e)){core.status.route=e}core.status.saveIndex=core.getLocalStorage("saveIndex2",1);if(core.isset(g)){core.values=core.clone(g)}else{core.values=core.clone(core.data.values)}core.events.initGame();core.status.played=true};control.prototype.startGame=function(b,a){console.log("开始游戏");this.resetStatus(core.firstData.hero,b,core.firstData.floorId,null,core.initStatus.maps);core.changeFloor(core.status.floorId,null,core.firstData.hero.loc,null,function(){if(core.isset(a)){a()}},true);setTimeout(function(){var c=new FormData();c.append("type","people");c.append("name",core.firstData.name);c.append("version",core.firstData.version);c.append("platform",core.platform.isPC?"PC":core.platform.isAndroid?"Android":core.platform.isIOS?"iOS":"");c.append("hard",core.encodeBase64(b));c.append("hardCode",core.getFlag("hard",0));c.append("base64",1);core.utils.http("POST","/games/upload.php",c)})};control.prototype.restart=function(){this.showStartAnimate();if(core.bgms.length>0){core.playBgm(core.bgms[0])}};control.prototype.clearAutomaticRouteNode=function(a,b){if(core.status.event.id==null){core.canvas.route.clearRect(a*32+5,b*32+5,27,27)}};control.prototype.stopAutomaticRoute=function(){if(!core.status.played){return}core.status.automaticRoute.autoHeroMove=false;core.status.automaticRoute.autoStep=0;core.status.automaticRoute.destStep=0;core.status.automaticRoute.movedStep=0;core.status.automaticRoute.autoStepRoutes=[];core.status.automaticRoute.destX=null;core.status.automaticRoute.destY=null;core.status.automaticRoute.lastDirection=null;core.stopHero();if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.clearMap("route")}};control.prototype.continueAutomaticRoute=function(){var a=core.status.automaticRoute.moveStepBeforeStop;if(a.length===0||(a.length===1&&a[0].step===1)){core.status.automaticRoute.moveStepBeforeStop=[]}else{core.setAutoHeroMove(a)}};control.prototype.clearContinueAutomaticRoute=function(){core.clearMap("route");core.status.automaticRoute.moveStepBeforeStop=[]};control.prototype.moveDirectly=function(a,b){var c=core.canMoveDirectly(a,b);if(c>=0){core.clearMap("hero");var d=core.status.route[core.status.route.length-1];if(["left","right","up","down"].indexOf(d)>=0){core.setHeroLoc("direction",d)}core.setHeroLoc("x",a);core.setHeroLoc("y",b);core.drawHero();core.status.route.push("move:"+a+":"+b);core.status.hero.statistics.moveDirectly++;core.status.hero.statistics.ignoreSteps+=c;return true}return false};control.prototype.tryMoveDirectly=function(a,b){if(Math.abs(core.getHeroLoc("x")-a)+Math.abs(core.getHeroLoc("y")-b)<=1){return false}var c=function(e,f,d){if(e<0||e>=core.bigmap.width||f<0||f>=core.bigmap.height){return false}if(core.control.moveDirectly(e,f)){if(core.isset(d)){core.moveHero(d,function(){})}return true}return false};return c(a,b)||c(a-1,b,"right")||c(a,b-1,"down")||c(a,b+1,"up")||c(a+1,b,"left")};control.prototype.setAutomaticRoute=function(a,b,h){if(!core.status.played||core.status.lockControl){return}if(core.status.automaticRoute.autoHeroMove){var c=core.status.automaticRoute.destX,d=core.status.automaticRoute.destY;core.stopAutomaticRoute();if(c==a&&d==b){core.status.automaticRoute.moveDirectly=true;setTimeout(function(){if(core.status.automaticRoute.moveDirectly&&core.status.heroMoving==0){core.control.tryMoveDirectly(a,b)}core.status.automaticRoute.moveDirectly=false},100)}return}if(a==core.status.hero.loc.x&&b==core.status.hero.loc.y&&h.length==0){if(core.timeout.turnHeroTimeout==null){core.timeout.turnHeroTimeout=setTimeout(function(){core.turnHero();clearTimeout(core.timeout.turnHeroTimeout);core.timeout.turnHeroTimeout=null},250)}else{clearTimeout(core.timeout.turnHeroTimeout);core.timeout.turnHeroTimeout=null;core.getNextItem()}return}if(core.timeout.turnHeroTimeout!=null){return}if(core.flags.clickMoveDirectly&&core.status.heroStop){if(core.control.tryMoveDirectly(a,b)){return}}var g=0;var i=null;var f;if(!(f=core.automaticRoute(a,b))){if(a==core.status.hero.loc.x&&b==core.status.hero.loc.y){f=[]}else{core.clearMap("route");return}}f=f.concat(h);core.status.automaticRoute.destX=a;core.status.automaticRoute.destY=b;core.canvas.route.save();core.clearMap("route");core.canvas.route.fillStyle="#bfbfbf";core.canvas.route.strokeStyle="#bfbfbf";core.canvas.route.lineWidth=8;for(var e=0;e<f.length;e++){if(i==null){g++;i=f[e].direction}else{if(i==f[e].direction){g++}else{core.status.automaticRoute.autoStepRoutes.push({direction:i,step:g});g=1;i=f[e].direction}}if(e==f.length-1){core.status.automaticRoute.autoStepRoutes.push({direction:i,step:g});core.canvas.route.fillRect(f[e].x*32+10,f[e].y*32+10,12,12)}else{core.canvas.route.beginPath();if(core.isset(f[e+1])&&i!=f[e+1].direction){if(i=="up"&&f[e+1].direction=="left"||i=="right"&&f[e+1].direction=="down"){core.canvas.route.moveTo(f[e].x*32+5,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+27)}else{if(i=="up"&&f[e+1].direction=="right"||i=="left"&&f[e+1].direction=="down"){core.canvas.route.moveTo(f[e].x*32+27,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+27)}else{if(i=="left"&&f[e+1].direction=="up"||i=="down"&&f[e+1].direction=="right"){core.canvas.route.moveTo(f[e].x*32+27,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+5)}else{if(i=="right"&&f[e+1].direction=="up"||i=="down"&&f[e+1].direction=="left"){core.canvas.route.moveTo(f[e].x*32+5,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+5)}}}}core.canvas.route.stroke();continue}switch(i){case"up":case"down":core.canvas.route.beginPath();core.canvas.route.moveTo(f[e].x*32+16,f[e].y*32+5);core.canvas.route.lineTo(f[e].x*32+16,f[e].y*32+27);core.canvas.route.stroke();break;case"left":case"right":core.canvas.route.beginPath();core.canvas.route.moveTo(f[e].x*32+5,f[e].y*32+16);core.canvas.route.lineTo(f[e].x*32+27,f[e].y*32+16);core.canvas.route.stroke();break}}}core.canvas.route.restore();core.setAutoHeroMove()};control.prototype.automaticRoute=function(e,f){var j=core.bigmap.width,i=core.bigmap.height;var u=core.getHeroLoc("x");var v=core.getHeroLoc("y");var t={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};if(e==u&&f==v){return false}var s=[];var r=new PriorityQueue({comparator:function(w,x){return w.depth-x.depth}});var a=[];s[u+j*v]="";r.queue({depth:0,x:u,y:v});while(r.length!=0){var b=r.dequeue();var c=b.depth,n=b.x,o=b.y;for(var h in t){if(!core.canMoveHero(n,o,h)){continue}var p=n+t[h].x;var q=o+t[h].y;if(p<0||p>=j||q<0||q>=i){continue}var m=p+j*q;if(core.isset(s[m])){continue}var d=1;var l,k=core.getBlock(p,q);if(k!=null){l=k.block.event.id;if(l=="light"){d=100}if(!core.flags.potionWhileRouting&&l.substring(l.length-6)=="Potion"){d+=20}if(k.block.event.trigger=="changeFloor"){d+=10}}d+=core.status.checkBlock.damage[m]*10;if(p==e&&q==f){s[m]=h;break}if(core.noPassExists(p,q)){continue}s[m]=h;r.queue({depth:c+d,x:p,y:q})}if(core.isset(s[e+j*f])){break}}if(!core.isset(s[e+j*f])){return false}var n=e,o=f;while(n!=u||o!=v){var g=s[n+j*o];a.push({direction:g,x:n,y:o});n-=t[g].x;o-=t[g].y}a.reverse();return a};control.prototype.fillPosWithPoint=function(a){core.fillRect("route",a.x*32+12+core.bigmap.offsetX,a.y*32+12+core.bigmap.offsetY,8,8,"#bfbfbf")};control.prototype.setAutoHeroMove=function(a){a=a||core.status.automaticRoute.autoStepRoutes;if(a.length==0){return}core.status.automaticRoute.autoStepRoutes=a;core.status.automaticRoute.autoHeroMove=true;core.status.automaticRoute.autoStep=1;core.status.automaticRoute.destStep=a[0].step;core.moveHero(a[0].direction)};control.prototype.setHeroMoveInterval=function(b,e,f,a){if(core.status.heroMoving>0){return}core.status.heroMoving=1;var c={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var d=1;if(core.status.replay.speed>3){d=2}if(core.status.replay.speed>6){d=4}if(core.status.replay.speed>12){d=8}core.interval.heroMoveInterval=window.setInterval(function(){core.status.heroMoving+=d;if(core.status.heroMoving>=8){core.setHeroLoc("x",e+c[b].x,true);core.setHeroLoc("y",f+c[b].y,true);core.control.updateFollowers();core.moveOneStep();core.clearMap("hero");core.drawHero(b);clearInterval(core.interval.heroMoveInterval);core.status.heroMoving=0;if(core.isset(a)){a()}}},12.5*d/core.status.replay.speed)};control.prototype.moveAction=function(a){if(core.interval.openDoorAnimate!=null){return}if(core.status.heroMoving>0){return}var e={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var c=core.getHeroLoc("direction");var f=core.getHeroLoc("x");var g=core.getHeroLoc("y");var d=core.noPass(f+e[c].x,g+e[c].y),b=core.canMoveHero();if(d||!b){if(core.status.event.id!="ski"){core.status.route.push(c)}core.status.automaticRoute.moveStepBeforeStop=[];core.status.automaticRoute.lastDirection=core.getHeroLoc("direction");if(b){core.trigger(f+e[c].x,g+e[c].y)}core.drawHero(c,f,g);if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.clearContinueAutomaticRoute();core.stopAutomaticRoute()}if(core.isset(a)){a()}}else{core.setHeroMoveInterval(c,f,g,function(){if(core.status.automaticRoute.autoHeroMove){core.status.automaticRoute.movedStep++;core.status.automaticRoute.lastDirection=core.getHeroLoc("direction");if(core.status.automaticRoute.destStep==core.status.automaticRoute.movedStep){if(core.status.automaticRoute.autoStep==core.status.automaticRoute.autoStepRoutes.length){core.clearContinueAutomaticRoute();core.stopAutomaticRoute()}else{core.status.automaticRoute.movedStep=0;core.status.automaticRoute.destStep=core.status.automaticRoute.autoStepRoutes[core.status.automaticRoute.autoStep].step;core.setHeroLoc("direction",core.status.automaticRoute.autoStepRoutes[core.status.automaticRoute.autoStep].direction);core.status.automaticRoute.autoStep++}}}else{if(core.status.heroStop){core.drawHero()}}if(core.status.event.id!="ski"){core.status.route.push(c)}var j=core.getHeroLoc("x"),k=core.getHeroLoc("y");var h=core.getBlock(j,k);var i=false;if(h!=null&&h.block.event.trigger=="getItem"&&!core.isset(core.floors[core.status.floorId].afterGetItem[j+","+k])){i=true;core.trigger(j,k)}core.checkBlock();if(!i&&!core.status.gameOver){core.trigger(j,k)}if(core.isset(a)){a()}})}};control.prototype.turnHero=function(a){if(core.isset(a)){core.setHeroLoc("direction",a);core.drawHero();core.clearMap("route");core.status.route.push("turn:"+a);return}if(core.status.hero.loc.direction=="up"){core.status.hero.loc.direction="right"}else{if(core.status.hero.loc.direction=="right"){core.status.hero.loc.direction="down"}else{if(core.status.hero.loc.direction=="down"){core.status.hero.loc.direction="left"}else{if(core.status.hero.loc.direction=="left"){core.status.hero.loc.direction="up"}}}}core.drawHero();core.clearMap("route");core.status.route.push("turn")};control.prototype.moveHero=function(b,a){if(core.status.heroMoving!=0){return}if(core.isset(b)){core.setHeroLoc("direction",b)}if(!core.isset(a)){core.status.heroStop=false;core.status.automaticRoute.moveDirectly=false;var c=function(){if(!core.status.heroStop){if(core.hasFlag("debug")&&core.status.ctrlDown){if(core.status.heroMoving!=0){return}var f={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};b=core.getHeroLoc("direction");var d=core.getHeroLoc("x")+f[b].x,e=core.getHeroLoc("y")+f[b].y;if(d<0||d>=core.bigmap.width||e<0||e>=core.bigmap.height){return}core.status.heroMoving=-1;core.eventMoveHero([b],100,function(){core.status.heroMoving=0;c()})}else{core.moveAction();setTimeout(c,50)}}else{core.stopHero()}};c()}else{core.moveAction(function(){a()})}};control.prototype.eventMoveHero=function(f,g,b){g=g||100;core.clearMap("ui");core.setAlpha("ui",1);var c=[];f.forEach(function(h){if(typeof h=="string"){c.push(h)}else{if(!core.isset(h.value)){c.push(h.direction)}else{for(var j=0;j<h.value;j++){c.push(h.direction)}}}});var e=0;var d={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};core.status.replay.animate=true;var a=window.setInterval(function(){var i=core.getHeroLoc("x"),j=core.getHeroLoc("y");if(c.length==0){clearInterval(a);core.drawHero(null,i,j);core.status.replay.animate=false;if(core.isset(b)){b()}}else{var h=c[0];core.setHeroLoc("direction",h);e++;if(e<=4){core.drawHero(h,i,j,"leftFoot",4*e)}else{if(e<=8){core.drawHero(h,i,j,"rightFoot",4*e)}}if(e==8){e=0;core.setHeroLoc("x",i+d[h].x,true);core.setHeroLoc("y",j+d[h].y,true);core.control.updateFollowers();c.shift()}}},g/8/core.status.replay.speed)};control.prototype.jumpHero=function(j,k,s,b){var q=core.status.hero.loc.x,r=core.status.hero.loc.y;if(!core.isset(j)){j=q}if(!core.isset(k)){k=r}s=s||500;core.clearMap("ui");core.setAlpha("ui",1);core.status.replay.animate=true;core.playSound("jump.mp3");var h=j-q,i=k-r,e=Math.round(Math.sqrt(h*h+i*i));var o=6+e,n=o*2;var c=q,d=r;var m=core.material.icons.hero[core.getHeroLoc("direction")];var p="stop";var l=core.material.icons.hero.height;var f=function(){return c*32};var g=function(){var v=d*32;if(n>=o){var u=n-o}else{var u=o-n}return v-(o*o-u*u)/2};var t=function(){n--;c=(c*n+j)/(n+1);d=(d*n+k)/(n+1)};if(core.isset(core.status.hero.followers)&&core.status.hero.followers.length>0){core.clearMap("hero")}var a=window.setInterval(function(){if(n>0){core.clearMap("hero",f()-core.bigmap.offsetX,g()-l+32-core.bigmap.offsetY,32,l);t();var u=f(),v=g();core.bigmap.offsetX=core.clamp(u-32*6,0,32*core.bigmap.width-416);core.bigmap.offsetY=core.clamp(v-32*6,0,32*core.bigmap.height-416);core.control.updateViewport();core.canvas.hero.drawImage(core.material.images.hero,m[p]*32,m.loc*l,32,l,u-core.bigmap.offsetX,v+32-l-core.bigmap.offsetY,32,l)}else{clearInterval(a);core.setHeroLoc("x",j);core.setHeroLoc("y",k);core.drawHero();core.status.replay.animate=false;if(core.isset(b)){b()}}},s/16/core.status.replay.speed)};control.prototype.moveOneStep=function(){core.status.hero.steps++;if(core.hasFlag("poison")){core.status.hero.statistics.poisonDamage+=core.values.poisonDamage;core.status.hero.hp-=core.values.poisonDamage;if(core.status.hero.hp<=0){core.status.hero.hp=0;core.updateStatusBar();core.events.lose();return}core.updateStatusBar()}};control.prototype.waitHeroToStop=function(a){var b=core.status.automaticRoute.lastDirection;core.stopAutomaticRoute();core.clearContinueAutomaticRoute();if(core.isset(a)){core.status.replay.animate=true;core.lockControl();core.status.automaticRoute.moveDirectly=false;setTimeout(function(){core.status.replay.animate=false;if(core.isset(b)){core.setHeroLoc("direction",b)}core.drawHero();a()},30)}};control.prototype.stopHero=function(){core.status.heroStop=true};control.prototype.setGameCanvasTranslate=function(b,d,e){var a=core.dom.gameCanvas[b];d=d*core.domStyle.scale;e=e*core.domStyle.scale;a.style.transform="translate("+d+"px,"+e+"px)";a.style.webkitTransform="translate("+d+"px,"+e+"px)";a.style.OTransform="translate("+d+"px,"+e+"px)";a.style.MozTransform="translate("+d+"px,"+e+"px)";if(main.mode==="editor"&&editor.isMobile){a.style.transform="translate("+(d/416*96)+"vw,"+(e/416*96)+"vw)";a.style.webkitTransform="translate("+(d/416*96)+"vw,"+(e/416*96)+"vw)";a.style.OTransform="translate("+(d/416*96)+"vw,"+(e/416*96)+"vw)";a.style.MozTransform="translate("+(d/416*96)+"vw,"+(e/416*96)+"vw)"}};control.prototype.updateViewport=function(){core.bigmap.canvas.forEach(function(a){core.control.setGameCanvasTranslate(a,-core.bigmap.offsetX,-core.bigmap.offsetY)})};control.prototype.drawHero=function(a,m,n,k,g){if(!core.isPlaying()){return}var j={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};if(!core.isset(m)){m=core.getHeroLoc("x")}if(!core.isset(n)){n=core.getHeroLoc("y")}k=k||"stop";a=a||core.getHeroLoc("direction");g=g||0;var l=j[a];var h=l.x*g;var i=l.y*g;var c=h==0?0:h/Math.abs(h),d=i==0?0:i/Math.abs(i);core.bigmap.offsetX=core.clamp((m-6)*32+h,0,32*core.bigmap.width-416);core.bigmap.offsetY=core.clamp((n-6)*32+i,0,32*core.bigmap.height-416);core.clearAutomaticRouteNode(m+c,n+d);core.canvas.hero.clearRect(m*32-core.bigmap.offsetX-32,n*32-core.bigmap.offsetY-32,96,96);var e=core.material.icons.hero;var b=[];b.push({img:core.material.images.hero,height:core.material.icons.hero.height,heroIcon:e[a],posx:m*32-core.bigmap.offsetX+h,posy:n*32-core.bigmap.offsetY+i,status:k,index:0,});if(core.isset(core.status.hero.followers)){var f=1;core.status.hero.followers.forEach(function(o){core.canvas.hero.clearRect(32*o.x-core.bigmap.offsetX-32,32*o.y-core.bigmap.offsetY-32,96,96);if(core.isset(core.material.images.images[o.img])){b.push({img:core.material.images.images[o.img],height:core.material.images.images[o.img].height/4,heroIcon:e[o.direction],posx:32*o.x-core.bigmap.offsetX+(o.stop?0:j[o.direction].x*g),posy:32*o.y-core.bigmap.offsetY+(o.stop?0:j[o.direction].y*g),status:o.stop?"stop":k,index:f++})}})}b.sort(function(o,p){return o.posy==p.posy?p.index-o.index:o.posy-p.posy});b.forEach(function(o){core.canvas.hero.drawImage(o.img,o.heroIcon[o.status]*32,o.heroIcon.loc*o.height,32,o.height,o.posx,o.posy+32-o.height,32,o.height)});core.control.updateViewport()};control.prototype.setHeroLoc=function(a,b,c){core.status.hero.loc[a]=b;if((a=="x"||a=="y")&&!c){this.gatherFollowers()}};control.prototype.getHeroLoc=function(a){if(!core.isset(a)){return core.status.hero.loc}return core.status.hero.loc[a]};control.prototype.nextX=function(a){var b={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};return core.getHeroLoc("x")+b[core.getHeroLoc("direction")].x*(a||1)};control.prototype.nextY=function(a){var b={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};return core.getHeroLoc("y")+b[core.getHeroLoc("direction")].y*(a||1)};control.prototype.gatherFollowers=function(){if(!core.isset(core.status.hero.followers)||core.status.hero.followers.length==0){return}var b=core.getHeroLoc("x"),c=core.getHeroLoc("y"),a=core.getHeroLoc("direction");core.status.hero.followers.forEach(function(d){d.x=b;d.y=c;d.stop=true;d.direction=a})};control.prototype.updateFollowers=function(){if(!core.isset(core.status.hero.followers)||core.status.hero.followers.length==0){return}var c={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};core.status.hero.followers.forEach(function(d){if(!d.stop){d.x+=c[d.direction].x;d.y+=c[d.direction].y}});var a=core.getHeroLoc("x"),b=core.getHeroLoc("y");core.status.hero.followers.forEach(function(f){if(f.x==a&&f.y==b){f.stop=true}else{var d=a-f.x,e=b-f.y;if(d==-1){f.stop=false;f.direction="left"}else{if(d==1){f.stop=false;f.direction="right"}else{if(e==-1){f.stop=false;f.direction="up"}else{if(e==1){f.stop=false;f.direction="down"}}}}}a=f.x;b=f.y})};control.prototype.updateCheckBlock=function(){return this.controldata.updateCheckBlock()};control.prototype.checkBlock=function(){var i=core.getHeroLoc("x"),j=core.getHeroLoc("y");var a=core.status.checkBlock.damage[i+core.bigmap.width*j];if(a>0){core.status.hero.hp-=a;var h=[];if(!core.hasFlag("no_snipe")){var g={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};for(var b in g){var e=i+g[b].x,f=j+g[b].y;if(e<0||e>=core.bigmap.width||f<0||f>=core.bigmap.height){continue}var d=core.status.checkBlock.map[e+core.bigmap.width*f];if(core.isset(d)){var c=core.material.enemys[d];if(core.isset(c)&&core.enemys.hasSpecial(c.special,18)){h.push({direction:b,x:e,y:f})}}}}if(core.status.checkBlock.betweenAttack[i+core.bigmap.width*j]&&a>0){core.drawTip("受到夹击，生命变成一半")}else{if(core.status.checkBlock.map[i+core.bigmap.width*j]=="lavaNet"){core.drawTip("受到血网伤害"+a+"点")}else{if(h.length>0&&a>0){core.drawTip("受到阻击伤害"+a+"点")}else{if(a>0){core.drawTip("受到领域或激光伤害"+a+"点")}}}}if(a>0){core.playSound("zone.mp3");core.drawAnimate("zone",i,j)}core.status.hero.statistics.extraDamage+=a;if(core.status.hero.hp<=0){core.status.hero.hp=0;core.updateStatusBar();core.events.lose();return}h=h.filter(function(n){var o=n.x,p=n.y,k=n.direction;var l=o+g[k].x,m=p+g[k].y;return l>=0&&l<core.bigmap.width&&m>=0&&m<core.bigmap.height&&core.getBlock(l,m,null,true)==null});core.updateStatusBar();if(h.length>0){core.snipe(h)}}};control.prototype.snipe=function(c){var b={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};c.forEach(function(j){var k=j.x,l=j.y,h=j.direction;j.nx=k+b[j.direction].x;j.ny=l+b[j.direction].y;core.removeGlobalAnimate(k,l);var d=core.getBlock(k,l).block;var e=d.event.cls;var i=d.event.height||32;j.animate=d.event.animate||1;j.blockIcon=core.material.icons[e][d.event.id];j.blockImage=core.material.images[e];j.height=i;var g=core.enemys.getDamage(d.event.id,k,l);var f="#000000";if(g==null){g="???";f="#FF0000"}else{if(g<=0){f="#00FF00"}else{if(g<core.status.hero.hp/3){f="#FFFFFF"}else{if(g<core.status.hero.hp*2/3){f="#FFFF00"}else{if(g<core.status.hero.hp){f="#FF7F00"}else{f="#FF0000"}}}}g=core.formatBigNumber(g)}j.damage=g;j.color=f;j.block=core.clone(d)});var a=function(){c.forEach(function(e){core.removeBlock(e.x,e.y);var d=core.clone(e.block);d.x=e.nx;d.y=e.ny;core.status.thisMap.blocks.push(d);core.drawBlock(d);core.addGlobalAnimate(d)});core.syncGlobalAnimate();core.updateStatusBar();return};if(core.status.replay.replaying){a()}else{core.waitHeroToStop(function(){core.lockControl();var h=500,g=0;var e=0;var f=0;core.canvas.damage.textAlign="left";var d=window.setInterval(function(){g++;f+=h/16;if(f>=core.values.animateSpeed){e++;f=0}c.forEach(function(n){var o=n.x,p=n.y,i=n.direction;var j=b[i].x*2*g,k=b[i].y*2*g;var l=32*o+j,m=32*p+k;core.clearMap("damage",l-2*b[i].x,m-2*b[i].y,32,32);core.canvas.event.clearRect(l-2*b[i].x,m-2*b[i].y,32,32);core.canvas.event2.clearRect(l-2*b[i].x,m-2*b[i].y-32,32,32);core.drawBlock(n.block,e,j,k);if(core.hasItem("book")){core.setFillStyle("damage","#000000");core.canvas.damage.fillText(n.damage,l+2,m+30);core.canvas.damage.fillText(n.damage,l,m+30);core.canvas.damage.fillText(n.damage,l+2,m+32);core.canvas.damage.fillText(n.damage,l,m+32);core.setFillStyle("damage",n.color);core.canvas.damage.fillText(n.damage,l+1,m+31)}});if(g==16){clearInterval(d);a();if(core.status.event.id==null){core.unLockControl()}}},h/16)})}};control.prototype.setWeather=function(d,c){if(d!="rain"&&d!="snow"){core.clearMap("weather");core.animateFrame.weather.type=null;core.animateFrame.weather.level=0;core.animateFrame.weather.nodes=[];return}c=parseInt(c);if(d==core.animateFrame.weather.type&&(!core.isset(c)||20*c==core.animateFrame.weather.level)){return}if(!core.isset(c)){c=5}if(c<1){c=1}if(c>10){c=10}c*=20;core.clearMap("weather");core.animateFrame.weather.type=d;core.animateFrame.weather.level=c;core.animateFrame.weather.nodes=[];if(d=="rain"){for(var b=0;b<c;b++){core.animateFrame.weather.nodes.push({x:Math.random()*416,y:Math.random()*416,l:Math.random()*2.5,xs:-4+Math.random()*4+2,ys:Math.random()*10+10})}}else{if(d=="snow"){for(var b=0;b<c;b++){core.animateFrame.weather.nodes.push({x:Math.random()*416,y:Math.random()*416,r:Math.random()*5+1,d:Math.random()*c,})}}}};control.prototype.setFg=function(c,f,a){if(!core.isset(f)){f=750}if(f<=0){f=0}if(!core.isset(core.status.curtainColor)){core.status.curtainColor=[0,0,0,0]}var d=core.status.curtainColor;if(!core.isset(c)){c=[0,0,0,0]}if(c.length==3){c.push(1)}if(c[3]<0){c[3]=0}if(c[3]>1){c[3]=1}if(f==0){core.clearMap("curtain");core.setAlpha("curtain",c[3]);core.fillRect("curtain",0,0,416,416,core.arrayToRGB(c));core.status.curtainColor=c;if(core.isset(a)){a()}return}var e=0;core.status.replay.animate=true;var b=setInterval(function(){e++;var g=d[3]+(c[3]-d[3])*e/25;var j=parseInt(d[0]+(c[0]-d[0])*e/25);var i=parseInt(d[1]+(c[1]-d[1])*e/25);var h=parseInt(d[2]+(c[2]-d[2])*e/25);core.clearMap("curtain");core.setAlpha("curtain",g);core.fillRect("curtain",0,0,416,416,core.arrayToRGB([j,i,h]));if(e>=25){clearInterval(b);core.status.curtainColor=c;core.status.replay.animate=false;if(core.isset(a)){a()}}},f/25/core.status.replay.speed)};control.prototype.updateDamage=function(h,c){if(!core.isset(h)){h=core.status.floorId}if(!core.isset(c)){c=core.canvas.damage;core.clearMap("damage")}var k=core.status.maps[h].blocks;if(!core.hasItem("book")){return}c.font="bold 11px Arial";var i=core.status.hero.hp;if(core.flags.displayEnemyDamage||core.flags.displayCritical){c.textAlign="left";for(var a=0;a<k.length;a++){var m=k[a].x,n=k[a].y;if(core.isset(k[a].event)&&k[a].event.cls.indexOf("enemy")==0&&!k[a].disable){if(k[a].event.trigger!="battle"){var g=core.floors[h].events[m+","+n];if(core.isset(g)&&!(g instanceof Array)){if(g.displayDamage===false){continue}}}var j=k[a].event.id;if(core.flags.displayEnemyDamage){var f=core.enemys.getDamage(j,m,n);var d="#000000";if(f==null){f="???";d="#FF0000"}else{if(f<=0){d="#00FF00"}else{if(f<i/3){d="#FFFFFF"}else{if(f<i*2/3){d="#FFFF00"}else{if(f<i){d="#FF7F00"}else{d="#FF0000"}}}}f=core.formatBigNumber(f);if(core.enemys.hasSpecial(core.material.enemys[j],19)){f+="+"}if(core.enemys.hasSpecial(core.material.enemys[j],21)){f+="-"}}c.fillStyle="#000000";c.fillText(f,32*m+2,32*(n+1)-2);c.fillText(f,32*m,32*(n+1)-2);c.fillText(f,32*m+2,32*(n+1));c.fillText(f,32*m,32*(n+1));c.fillStyle=d;c.fillText(f,32*m+1,32*(n+1)-1)}if(core.flags.displayCritical){var e=core.enemys.nextCriticals(j);if(e.length>0){e=e[0]}e=core.formatBigNumber(e[0]);if(e=="???"){e="?"}c.fillStyle="#000000";c.fillText(e,32*m+2,32*(n+1)-2-10);c.fillText(e,32*m,32*(n+1)-2-10);c.fillText(e,32*m+2,32*(n+1)-10);c.fillText(e,32*m,32*(n+1)-10);c.fillStyle="#FFFFFF";c.fillText(e,32*m+1,32*(n+1)-1-10)}}}}if(core.flags.displayExtraDamage){c.textAlign="center";var l=null;if(h!=core.status.floorId){l=core.clone(core.status.checkBlock);core.status.thisMap=core.status.maps[h];core.bigmap.width=core.floors[h].width||13;core.bigmap.height=core.floors[h].height||13;core.updateCheckBlock()}for(var m=0;m<core.bigmap.width;m++){for(var n=0;n<core.bigmap.height;n++){var f=core.status.checkBlock.damage[m+core.bigmap.width*n];if(f>0){f=core.formatBigNumber(f);c.fillStyle="#000000";c.fillText(f,32*m+17,32*(n+1)-13);c.fillText(f,32*m+15,32*(n+1)-15);c.fillText(f,32*m+17,32*(n+1)-15);c.fillText(f,32*m+15,32*(n+1)-13);c.fillStyle="#FF7F00";c.fillText(f,32*m+16,32*(n+1)-14)}}}if(h!=core.status.floorId){core.status.thisMap=core.status.maps[core.status.floorId];core.status.checkBlock=l;core.bigmap.width=core.floors[core.status.floorId].width||13;core.bigmap.height=core.floors[core.status.floorId].height||13}}};control.prototype.doEffect=function(a){a.split(";").forEach(function(c){var b=c.split("+=");if(b.length!=2){return}var e=b[0],g=core.calValue(b[1]);if(e.indexOf("status:")==0){var f=e.substring(7);core.setStatus(f,core.getStatus(f)+g)}else{if(e.indexOf("item:")==0){var d=e.substring(5);core.setItem(d,core.itemCount(d)+g)}}})};control.prototype.debug=function(){core.setFlag("debug",true);core.insertAction(["\t[调试模式开启]此模式下按住Ctrl键（或Ctrl+Shift键）可以穿墙并忽略一切事件。\n同时，录像将失效，也无法上传成绩。"])};control.prototype.startReplay=function(a){core.status.replay.replaying=true;core.status.replay.pausing=false;core.status.replay.speed=1;core.status.replay.toReplay=core.clone(a);core.status.replay.totalList=core.clone(a);core.status.replay.steps=0;core.status.replay.save=[];core.updateStatusBar();core.drawTip("开始播放");this.replay();return};control.prototype.triggerReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(core.status.replay.pausing){this.resumeReplay()}else{this.pauseReplay()}};control.prototype.pauseReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}core.status.replay.pausing=true;core.updateStatusBar();core.drawTip("暂停播放")};control.prototype.resumeReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}core.status.replay.pausing=false;core.updateStatusBar();core.drawTip("恢复播放");core.replay()};control.prototype.speedUpReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}if(core.status.replay.speed==12){core.status.replay.speed=24}else{if(core.status.replay.speed==6){core.status.replay.speed=12}else{if(core.status.replay.speed==3){core.status.replay.speed=6}else{if(core.status.replay.speed<3){var a=core.status.replay.speed>=2?2:1;core.status.replay.speed=parseInt(10*core.status.replay.speed+a)/10}}}}core.drawTip("x"+core.status.replay.speed+"倍")};control.prototype.speedDownReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}if(core.status.replay.speed==24){core.status.replay.speed=12}else{if(core.status.replay.speed==12){core.status.replay.speed=6}else{if(core.status.replay.speed==6){core.status.replay.speed=3}else{var a=core.status.replay.speed>=2?2:1;core.status.replay.speed=parseInt(10*core.status.replay.speed-a)/10}}}if(core.status.replay.speed<0.3){core.status.replay.speed=0.3}core.drawTip("x"+core.status.replay.speed+"倍")};control.prototype.setReplaySpeed=function(a){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}core.status.replay.speed=a;core.drawTip("x"+core.status.replay.speed+"倍")};control.prototype.stopReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}core.status.replay.toReplay=[];core.status.replay.totalList=[];core.status.replay.replaying=false;core.status.replay.pausing=false;core.status.replay.speed=1;core.status.replay.steps=0;core.status.replay.save=[];core.updateStatusBar();core.drawTip("停止播放并恢复游戏")};control.prototype.rewindReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}if(!core.status.replay.pausing){core.drawTip("请先暂停录像");return}if(core.status.replay.animate){core.drawTip("请等待当前事件的处理结束");return}if(core.status.replay.save.length==0){core.drawTip("无法再回到上一个节点");return}var b=core.status.replay.save;var a=b.pop();core.loadData(a.data,function(){core.status.replay={replaying:true,pausing:true,animate:false,toReplay:a.replay.toReplay,totalList:a.replay.totalList,speed:a.replay.speed,steps:a.replay.steps,save:b};core.updateStatusBar();core.drawTip("成功回退到上一个节点")})};control.prototype.saveReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}if(!core.status.replay.pausing){core.drawTip("请先暂停录像");return}if(core.status.replay.animate||core.isset(core.status.event.id)){core.drawTip("请等待当前事件的处理结束");return}core.lockControl();core.status.event.id="save";var c=core.status.saveIndex;var b=parseInt((c-1)/5),a=c-5*b;core.ui.drawSLPanel(10*b+a)};control.prototype.bookReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0){return}if(!core.status.replay.replaying){return}if(!core.status.replay.pausing){core.drawTip("请先暂停录像");return}if(core.status.event.id=="viewMaps"){core.status.event.selection=core.status.event.data;core.status.event.id=null}if(core.status.replay.animate||core.isset(core.status.event.id)){core.drawTip("请等待当前事件的处理结束");return}core.lockControl();core.status.event.id="book";core.useItem("book")};control.prototype.viewMapReplay=function(){if(core.status.event.id=="save"||(core.status.event.id||"").indexOf("book")==0||core.status.event.id=="viewMaps"){return}if(!core.status.replay.replaying){return}if(!core.status.replay.pausing){core.drawTip("请先暂停录像");return}if(core.status.replay.animate||core.isset(core.status.event.id)){core.drawTip("请等待当前事件的处理结束");return}core.lockControl();core.status.event.id="viewMaps";core.ui.drawMaps()};control.prototype.replay=function(){if(!core.status.replay.replaying){return}if(core.status.replay.pausing){return}if(core.status.replay.animate){return}if(core.status.replay.toReplay.length==0){core.stopReplay();core.insertAction("录像回放完毕！");return}core.status.replay.steps++;if(core.status.replay.steps%50==0){core.status.replay.save.push({data:core.saveData(),replay:{totalList:core.clone(core.status.replay.totalList),toReplay:core.clone(core.status.replay.toReplay),speed:core.status.replay.speed,steps:core.status.replay.steps}})}var a=core.status.replay.toReplay.shift();if(a=="up"||a=="down"||a=="left"||a=="right"){core.moveHero(a,function(){setTimeout(function(){core.replay()})});return}else{if(a.indexOf("item:")==0){var h=a.substring(5);if(core.canUseItem(h)){var t=Object.keys(core.status.hero.items.tools).sort();var c=Object.keys(core.status.hero.items.constants).sort();var g=-1;if((g=t.indexOf(h))>=0){core.status.event.data={toolsPage:Math.floor(g/12)+1,constantsPage:1,selectId:null};g=g%12}else{if(g=c.indexOf(h)>=0){core.status.event.data={toolsPage:1,constantsPage:Math.floor(g/12)+1,selectId:null};g=g%12+12}}if(g>=0){core.ui.drawToolbox(g);setTimeout(function(){core.ui.closePanel();core.useItem(h,function(){core.replay()})},750/Math.max(1,core.status.replay.speed));return}}}else{if(a.indexOf("unEquip:")==0){var e=parseInt(a.substring(8));if(core.isset(e)){core.ui.drawEquipbox(e);core.status.route.push(a);setTimeout(function(){core.ui.closePanel();core.unloadEquip(e,function(){core.replay()})},750/Math.max(1,core.status.replay.speed));return}}else{if(a.indexOf("equip:")==0){var d=a.substring(6);var l=Object.keys(core.status.hero.items.equips).sort();var g=l.indexOf(d);if(g>=0){core.status.route.push(a);core.status.event.data={page:Math.floor(g/12)+1,selectId:null};g=g%12+12;core.ui.drawEquipbox(g);setTimeout(function(){core.ui.closePanel();core.loadEquip(d,function(){core.replay()})},750/Math.max(1,core.status.replay.speed));return}}else{if(a.indexOf("fly:")==0){var f=a.substring(4);var s=core.status.hero.flyRange.indexOf(f);var i=core.status.hero.flyRange.indexOf(core.status.floorId);if(core.hasItem("fly")&&s>=0&&i>=0){core.ui.drawFly(s);setTimeout(function(){if(!core.control.flyTo(f,function(){core.replay()})){core.stopReplay();core.insertAction("录像文件出错")}},750/Math.max(1,core.status.replay.speed));return}}else{if(a.indexOf("shop:")==0){var r=a.substring(5).split(":");var p=r[0],n=r[1].split("");if(n.length>0){var o=core.status.shops[p];if(core.isset(o)&&o.visited){var b=o.choices;var u=6-parseInt(b.length/2);core.status.event.selection=parseInt(n.shift());core.events.openShop(p,false);var q=setInterval(function(){if(!core.actions.clickShop(6,u+core.status.event.selection)){clearInterval(q);core.stopReplay();core.drawTip("录像文件出错");return}if(n.length==0){clearInterval(q);core.actions.clickShop(6,u+b.length);core.replay();return}core.status.event.selection=parseInt(n.shift());core.events.openShop(p,false)},750/Math.max(1,core.status.replay.speed));return}}}else{if(a=="turn"){core.turnHero();core.replay();return}else{if(a.indexOf("turn:")==0){core.turnHero(a.substring(5));core.replay();return}else{if(a=="getNext"){if(core.getNextItem()){core.replay();return}}else{if(a.indexOf("move:")==0){while(core.status.replay.toReplay.length>0&&core.status.replay.toReplay[0].indexOf("move:")==0){a=core.status.replay.toReplay.shift()}var m=a.substring(5).split(":");var v=parseInt(m[0]),w=parseInt(m[1]);var j=core.getHeroLoc("x"),k=core.getHeroLoc("y");if(core.control.moveDirectly(v,w)){core.ui.drawArrow("route",32*j+16,32*k+16,32*v+16,32*w+16,"#FF0000",3);setTimeout(function(){core.clearMap("route");core.replay()},750/Math.max(1,core.status.replay.speed));return}}else{if(a.indexOf("key:")==0){core.actions.keyUp(parseInt(a.substring(4)),true);core.replay();return}}}}}}}}}}}core.stopReplay();core.insertAction("录像文件出错")};control.prototype.checkStatus=function(b,c,a){if(c&&core.status.event.id==b){core.ui.closePanel();return false}if(c&&core.status.lockControl){return false}if(core.isset(a)&&a&&!core.hasItem(b)){core.drawTip("你没有"+core.material.items[b].name);return false}if(!core.status.heroStop){core.drawTip("请先停止勇士行动");return false}core.lockControl();core.status.event.id=b;return true};control.prototype.openBook=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(core.status.event.id=="book"&&core.isset(core.status.event.selection)){core.status.boxAnimateObjs=[];core.ui.drawMaps(core.status.event.selection);return}if(core.status.event.id=="viewMaps"){a=false;core.status.event.selection=core.status.event.data}if(!core.checkStatus("book",a,true)){return}core.useItem("book")};control.prototype.useFly=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("fly",a,true)){return}if(core.flags.flyNearStair&&!core.nearStair()){core.drawTip("只有在楼梯边才能使用传送器");core.unLockControl();core.status.event.data=null;core.status.event.id=null;return}if(!core.canUseItem("fly")){core.drawTip("楼层传送器好像失效了");core.unLockControl();core.status.event.data=null;core.status.event.id=null;return}core.useItem("fly");return};control.prototype.flyTo=function(b,a){return this.controldata.flyTo(b,a)};control.prototype.openEquipbox=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("equipbox",a)){return}core.ui.drawEquipbox()};control.prototype.openToolbox=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("toolbox",a)){return}core.ui.drawToolbox()};control.prototype.openQuickShop=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("selectShop",a)){return}core.ui.drawQuickShop()};control.prototype.save=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("save",a)){return}var d=core.status.saveIndex;var c=parseInt((d-1)/5),b=d-5*c;core.ui.drawSLPanel(10*c+b)};control.prototype.load=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}var d=core.getLocalStorage("saveIndex2",1);var c=parseInt((d-1)/5),b=d-5*c;if(!core.isPlaying()){core.status.event={id:"load",data:null};core.status.lockControl=true;core.dom.startPanel.style.display="none";core.ui.drawSLPanel(10*c+b);return}if(!core.checkStatus("load",a)){return}core.ui.drawSLPanel(10*c+b)};control.prototype.openSettings=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("settings",a)){return}core.ui.drawSettings()};control.prototype.autosave=function(a){if(core.status.event.id!=null){return}var b=null;if(a){b=core.status.route.pop()}core.status.route.push("turn:"+core.getHeroLoc("direction"));core.setLocalForage("autoSave",core.saveData());core.status.route.pop();if(a&&core.isset(b)){core.status.route.push(b)}};control.prototype.doSL=function(a,b){if(b=="save"){if(a=="autoSave"){core.drawTip("不能覆盖自动存档！");return}core.setLocalForage("save"+a,core.saveData(),function(){core.ui.closePanel();core.drawTip("存档成功！");if(a!="autoSave"){core.status.saveIndex=a;core.setLocalStorage("saveIndex2",core.status.saveIndex)}},function(c){console.info(c);core.drawTip("存档失败，请将控制台的报错信息反馈给管理员。")});return}else{if(b=="load"){core.getLocalForage(a=="autoSave"?a:"save"+a,null,function(c){if(!core.isset(c)){core.drawTip("无效的存档");return}if(c.version!=core.firstData.version){if(confirm("存档版本不匹配！\n你想回放此存档的录像吗？\n可以随时停止录像播放以继续游戏。")){core.dom.startPanel.style.display="none";var d=c.hero.flags.seed;core.resetStatus(core.firstData.hero,c.hard,core.firstData.floorId,null,core.initStatus.maps);core.events.setInitData(c.hard);core.setFlag("seed",d);core.setFlag("rand",d);core.changeFloor(core.status.floorId,null,core.firstData.hero.loc,null,function(){core.startReplay(core.decodeRoute(c.route))},true)}return}core.ui.closePanel();core.loadData(c,function(){core.drawTip("读档成功");if(a!="autoSave"){core.status.saveIndex=a;core.setLocalStorage("saveIndex2",core.status.saveIndex)}})},function(c){console.log(c);core.drawTip("无效的存档")});return}else{if(b=="replayLoad"){core.getLocalForage(a=="autoSave"?a:"save"+a,null,function(c){if(!core.isset(c)){core.drawTip("无效的存档");return}if(c.version!=core.firstData.version){core.drawTip("存档版本不匹配");return}if(c.hard!=core.status.hard){core.drawTip("游戏难度不匹配！");return}var d=core.subarray(core.status.route,core.decodeRoute(c.route));if(!core.isset(d)||c.hero.flags.seed!=core.getFlag("seed")){core.drawTip("无法从此存档回放录像");return}core.loadData(c,function(){core.startReplay(d);core.drawTip("回退到存档节点")})},function(c){console.log(c);core.drawTip("无效的存档")})}}}};control.prototype.syncSave=function(a){core.ui.drawWaiting("正在同步，请稍后...");core.control.getSaves(a=="all"?null:core.status.saveIndex,function(d){if(!core.isset(d)){core.drawText("没有要同步的存档");return}var b=new FormData();b.append("type","save");b.append("name",core.firstData.name);var c=JSON.stringify(d);b.append("data",c);core.http("POST","/games/sync.php",b,function(e){var f=JSON.parse(e);if(f.code<0){core.drawText("出错啦！\n无法同步存档到服务器。\n错误原因："+f.msg)}else{core.drawText((a=="all"?"所有存档":"存档"+core.status.saveIndex)+"同步成功！\n\n您的存档编号： "+f.code+"\n您的存档密码： "+f.msg+"\n\n请牢记以上两个信息（如截图等），在从服务器\n同步存档时使用。")}},function(f){core.drawText("出错啦！\n无法同步存档到服务器。\n错误原因："+f)})})};control.prototype.syncLoad=function(){core.interval.onDownInterval="tmp";var b=prompt("请输入存档编号：");if(b==null||b==""){core.ui.drawSyncSave();return}core.interval.onDownInterval="tmp";var c=prompt("请输入存档密码：");if(c==null||c==""){core.ui.drawSyncSave();return}core.ui.drawWaiting("正在同步，请稍后...");var a=new FormData();a.append("type","load");a.append("name",core.firstData.name);a.append("id",b);a.append("password",c);core.http("POST","/games/sync.php",a,function(d){var e=JSON.parse(d);switch(e.code){case 0:var d=JSON.parse(e.msg);if(d instanceof Array){core.status.event.selection=1;core.ui.drawConfirmBox("所有本地存档都将被覆盖，确认？",function(){for(var f=1;f<=5*(main.savePages||30);f++){if(f<=d.length){core.setLocalForage("save"+f,d[f-1])}else{core.removeLocalForage("save"+f)}}core.drawText("同步成功！\n你的本地所有存档均已被覆盖。")},function(){core.status.event.selection=0;core.ui.drawSyncSave()})}else{core.setLocalForage("save"+core.status.saveIndex,d,function(){core.drawText("同步成功！\n单存档已覆盖至存档"+core.status.saveIndex)})}break;case -1:core.drawText("出错啦！\n存档编号"+b+"不存在！");break;case -2:core.drawText("出错啦！\n存档密码错误！");break;default:core.drawText("出错啦！\n无法从服务器同步存档。\n错误原因："+e.msg);break}},function(d){core.drawText("出错啦！\n无法从服务器同步存档。\n错误原因："+d)})};control.prototype.saveData=function(){var a={floorId:core.status.floorId,hero:core.clone(core.status.hero),hard:core.status.hard,maps:core.maps.save(core.status.maps),route:core.encodeRoute(core.status.route),values:core.clone(core.values),shops:{},version:core.firstData.version,time:new Date().getTime()};for(var b in core.status.shops){a.shops[b]={times:core.status.shops[b].times||0,visited:core.status.shops[b].visited||false}}core.events.beforeSaveData(a);return a};control.prototype.loadData=function(b,a){core.resetStatus(b.hero,b.hard,b.floorId,core.decodeRoute(b.route),core.maps.load(b.maps),b.values);for(var d in core.status.shops){if(core.isset(b.shops[d])){core.status.shops[d].times=b.shops[d].times;core.status.shops[d].visited=b.shops[d].visited}}core.status.textAttribute=core.getFlag("textAttribute",core.status.textAttribute);var c=core.getFlag("heroIcon","hero.png");if(core.isset(core.material.images.images[c])){core.material.images.hero.src=core.material.images.images[c].src;core.material.icons.hero.height=core.material.images.images[c].height/4}core.events.afterLoadData(b);core.changeFloor(b.floorId,null,b.hero.loc,0,function(){if(core.isset(a)){a()}},true)};control.prototype.getSaves=function(b,a){if(core.isset(b)){core.getLocalForage("save"+b,null,function(f){if(core.isset(a)){a(f)}},function(f){console.log(f);if(core.isset(a)){a(null)}});return}var d=5*(main.savePages||30);var e=[];var c=function(g,f){if(g>d){if(core.isset(f)){f(e)}return}core.getLocalForage("save"+g,null,function(h){e.push(h);c(g+1,f)},function(h){console.log(h);c(g+1,f)})};c(1,a)};control.prototype.setStatus=function(a,b){if(a=="exp"){a="experience"}if(core.isset(core.status.hero.loc[a])){core.status.hero.loc[a]=b}else{core.status.hero[a]=b}};control.prototype.getStatus=function(a){if(core.isset(core.status.hero.loc[a])){return core.status.hero.loc[a]}if(a=="exp"){a="experience"}return core.status.hero[a]};control.prototype.getLvName=function(){return((core.firstData.levelUp||[])[core.status.hero.lv-1]||{}).name||core.status.hero.lv};control.prototype.setFlag=function(a,b){if(!core.isset(core.status.hero)){return}core.status.hero.flags[a]=b};control.prototype.getFlag=function(b,a){if(!core.isset(core.status.hero)){return a}var c=core.status.hero.flags[b];if(core.isset(c)){return c}return a};control.prototype.hasFlag=function(a){if(core.getFlag(a)){return true}return false};control.prototype.lockControl=function(){core.status.lockControl=true};control.prototype.unLockControl=function(){core.status.lockControl=false};control.prototype.playBgm=function(a){if(main.mode!="play"){return}if(!core.musicStatus.bgmStatus){return}if(!core.isset(core.material.bgms[a])){return}if(core.material.bgms[a]=="loading"){core.material.bgms[a]="starting";return}try{if(core.musicStatus.playingBgm==a&&core.musicStatus.isPlaying){return}if(core.isset(core.musicStatus.playingBgm)&&core.musicStatus.isPlaying){core.material.bgms[core.musicStatus.playingBgm].pause()}core.material.bgms[a].volume=core.musicStatus.volume;core.material.bgms[a].currentTime=0;core.material.bgms[a].play();core.musicStatus.playingBgm=a;core.musicStatus.isPlaying=true}catch(b){console.log("无法播放BGM "+a);console.log(b);core.musicStatus.playingBgm=null}};control.prototype.pauseBgm=function(){try{if(core.isset(core.musicStatus.playingBgm)){core.material.bgms[core.musicStatus.playingBgm].pause()}core.musicStatus.isPlaying=false}catch(a){console.log("无法暂停BGM "+bgm);console.log(a)}};control.prototype.resumeBgm=function(){if(main.mode!="play"){return}if(!core.musicStatus.bgmStatus){return}try{if(core.isset(core.musicStatus.playingBgm)){core.material.bgms[core.musicStatus.playingBgm].play();core.musicStatus.isPlaying=true}else{if(core.bgms.length>0){if(core.isset(core.status.thisMap.bgm)){core.playBgm(core.status.thisMap.bgm)}else{core.playBgm(core.bgms[0])}}}}catch(a){console.log("无法恢复BGM "+bgm);console.log(a)}};control.prototype.playSound=function(d){if(main.mode!="play"){return}if(!core.musicStatus.soundStatus){return}if(!core.isset(core.material.sounds[d])){return}try{if(core.musicStatus.audioContext!=null){var f=core.musicStatus.audioContext.createBufferSource();f.buffer=core.material.sounds[d];f.connect(core.musicStatus.gainNode);try{f.start(0)}catch(a){try{f.noteOn(0)}catch(b){}}}else{core.material.sounds[d].volume=core.musicStatus.volume;core.material.sounds[d].play()}}catch(c){console.log("无法播放SE "+d);console.log(c)}};control.prototype.clearStatusBar=function(){Object.keys(core.statusBar).forEach(function(a){if(core.isset(core.statusBar[a].innerHTML)){core.statusBar[a].innerHTML="&nbsp;"}});core.statusBar.image.book.style.opacity=0.3;if(!core.flags.equipboxButton){core.statusBar.image.fly.style.opacity=0.3}};control.prototype.updateStatusBar=function(){this.controldata.updateStatusBar();if(core.status.replay.replaying){core.statusBar.image.book.src=core.status.replay.pausing?core.statusBar.icons.play.src:core.statusBar.icons.pause.src;core.statusBar.image.book.style.opacity=1;core.statusBar.image.fly.src=core.statusBar.icons.stop.src;core.statusBar.image.fly.style.opacity=1;core.statusBar.image.toolbox.src=core.statusBar.icons.rewind.src;core.statusBar.image.shop.src=core.statusBar.icons.book.src;core.statusBar.image.save.src=core.statusBar.icons.speedDown.src;core.statusBar.image.load.src=core.statusBar.icons.speedUp.src;core.statusBar.image.settings.src=core.statusBar.icons.save.src}else{core.statusBar.image.book.src=core.statusBar.icons.book.src;core.statusBar.image.book.style.opacity=core.hasItem("book")?1:0.3;if(!core.flags.equipboxButton){core.statusBar.image.fly.src=core.statusBar.icons.fly.src;core.statusBar.image.fly.style.opacity=core.hasItem("fly")?1:0.3}else{core.statusBar.image.fly.src=core.statusBar.icons.equipbox.src;core.statusBar.image.fly.style.opacity=1}core.statusBar.image.toolbox.src=core.statusBar.icons.toolbox.src;core.statusBar.image.shop.src=core.statusBar.icons.shop.src;core.statusBar.image.save.src=core.statusBar.icons.save.src;core.statusBar.image.load.src=core.statusBar.icons.load.src;core.statusBar.image.settings.src=core.statusBar.icons.settings.src}};control.prototype.updateHeroIcon=function(f){f=f||"hero.png";if(core.statusBar.icons.name==f){return}core.statusBar.icons.name=f;var d=core.material.images.hero;var c=core.material.icons.hero.height;var g=32/c,h=32*g,e=16-h/2;var a=document.createElement("canvas");var b=a.getContext("2d");a.width=32;a.height=32;b.drawImage(d,0,0,32,c,e,0,h,32);core.statusBar.image.name.src=a.toDataURL("image/png")};control.prototype.resize=function(j,i){if(main.mode=="editor"){return}var n=422;var m=132;var c=32;var w=3;var o=16;var a=n;var h=n+m;var V=j;var s=false;if(j>i&&i<a){s=true;V=i}var r,q,e,g,f,A,z,y,G,B,F,C,O,M,N,K,T,Q,R,S,p,L,t,x,P;var l=core.dom.statusBar.children.length;if(!core.flags.enableFloor){l--}if(!core.flags.enableLv){l--}if(!core.flags.enableHPMax){l--}if(!core.flags.enableMDef){l--}if(!core.flags.enableMoney){l--}if(!core.flags.enableExperience){l--}if(!core.flags.enableLevelUp){l--}if(!core.flags.enableDebuff){l--}if(!core.flags.enableKeys){l--}if(!core.flags.enablePZF){l--}if(!core.flags.enableName){l--}var E=c*9/l;var D=o;if(l>9){D=D*9/l}var v;var d=main.borderColor||"white";y="3px "+d+" solid";K="3px "+d+" solid";var W=(a-V)/4.22;var b=1-W/100;if(V<h){if(V<a){core.domStyle.scale=b;g=V}else{g=n;core.domStyle.scale=1}var u=core.domStyle.scale;var J=n*u;if(!s){core.domStyle.screenMode="vertical";v="block";var k=parseInt((l-1)/3)+1;var I=u*(c*k+w*2)+6;var H=u*(c+w*4)+6;q=J+I+H;r=J;f=I;O=A=g;z=I;y="3px "+d+" solid";B=u*c*0.8;C=0.8*c*u;F=u*m*0.95;x=main.statusTopBackground;M=H;N=z+g;K="3px "+d+" solid";Q=u*c;S=u*m*0.4;P=main.toolsBackground;e="3px "+d+" solid";t=u*w*2;R=u*w*4;p=o*u;L=o*u}else{core.domStyle.screenMode="horizontal";v="none";r=J+m*u;q=J;f=0;O=A=m*u;z=q-w;y="3px "+d+" solid";x=main.statusLeftBackground;B=u*E*0.8;C=0.8*E*u;N=u*E*l+w*2;M=g-N;K="3px "+d+" solid";Q=u*c;P="transparent";p=D*u;L=o*u;e="";F=u*m;S=u*m;t=u*w*2;R=2*w*u}}else{core.domStyle.scale=1;core.domStyle.screenMode="bigScreen";v="none";r=n+m;q=n;g=n;f=0;O=A=m;x=main.statusLeftBackground;z=q-w;B=E*0.8;C=0.8*E;N=E*l+w*2;M=n-N;P="transparent";Q=c;e="";p=D;L=o;F=m;S=m*0.9;t=w*2;R=2*w}var U="px";core.domStyle.styles=[{id:"gameGroup",rules:{width:r+U,height:q+U,top:(i-q)/2+U,left:(j-r)/2+U,}},{className:"gameCanvas",rules:{width:(g-w*2)+U,height:(g-w*2)+U,}},{id:"gif",rules:{width:(g-w*2)+U,height:(g-w*2)+U,}},{id:"gif2",rules:{width:(g-w*2)+U,height:(g-w*2)+U,}},{id:"gameDraw",rules:{width:(g-w*2)+U,height:(g-w*2)+U,top:f+U,right:0,border:y}},{id:"floorMsgGroup",rules:{width:(g-w*2)+U,height:(q-w*2)+U,top:w+U,right:w+U,}},{id:"statusBar",rules:{width:A+U,height:z+U,top:0,left:0,padding:w+U,borderTop:y,borderLeft:y,borderRight:e,fontSize:p+U,background:x,}},{className:"status",rules:{width:"100%",maxWidth:F+U,height:B+U,margin:t/2+U}},{className:"statusLabels",rules:{marginLeft:t+U,lineHeight:C+U,}},{id:"toolBar",rules:{width:O+U,height:M+U,top:N+U,left:0,padding:w+U,borderBottom:K,borderLeft:K,borderRight:e,fontSize:L+U,background:P,}},{className:"tools",rules:{height:Q+U,maxWidth:S+U,marginLeft:R+U,marginTop:t+U,}},{imgId:"shop",rules:{display:v}},{id:"floorCol",rules:{display:core.flags.enableFloor?"block":"none"}},{id:"nameCol",rules:{display:core.flags.enableName?"block":"none"}},{id:"lvCol",rules:{display:core.flags.enableLv?"block":"none"}},{id:"hpmaxCol",rules:{display:core.flags.enableHPMax?"block":"none"}},{id:"mdefCol",rules:{display:core.flags.enableMDef?"block":"none"}},{id:"moneyCol",rules:{display:core.flags.enableMoney?"block":"none"}},{id:"expCol",rules:{display:core.flags.enableExperience?"block":"none"}},{id:"upCol",rules:{display:core.flags.enableLevelUp?"block":"none"}},{id:"keyCol",rules:{display:!core.isset(core.flags.enableKeys)||core.flags.enableKeys?"block":"none"}},{id:"pzfCol",rules:{display:core.flags.enablePZF?"block":"none"}},{id:"debuffCol",rules:{display:core.flags.enableDebuff?"block":"none"}},{id:"hard",rules:{lineHeight:Q+U}}];core.domRenderer()};control.prototype.domRenderer=function(){core.dom.statusBar.style.display="block";core.dom.toolBar.style.display="block";var l=core.domStyle.styles;for(var b=0;b<l.length;b++){if(l[b].hasOwnProperty("rules")){var g=l[b].rules;var h=Object.keys(g);if(l[b].hasOwnProperty("className")){var a=l[b].className;for(var e=0;e<core.dom[a].length;e++){for(var f=0;f<h.length;f++){core.dom[a][e].style[h[f]]=g[h[f]]}}}if(l[b].hasOwnProperty("id")){var c=l[b].id;for(var e=0;e<h.length;e++){core.dom[c].style[h[e]]=g[h[e]]}}if(l[b].hasOwnProperty("imgId")){var d=l[b].imgId;for(var e=0;e<h.length;e++){core.statusBar.image[d].style[h[e]]=g[h[e]]}}}}if(core.isPlaying()&&core.isset(core.status)&&core.isset(core.bigmap)){core.bigmap.canvas.forEach(function(i){core.canvas[i].canvas.style.width=core.bigmap.width*32*core.domStyle.scale+"px";core.canvas[i].canvas.style.height=core.bigmap.height*32*core.domStyle.scale+"px"})}};