function ui(){this.init()}ui.prototype.init=function(){this.uidata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.ui};ui.prototype.clearMap=function(c,e,f,d,a){if(c=="all"){for(var b in core.canvas){if(b=="curtain"){continue}core.canvas[b].clearRect(0,0,core.bigmap.width*32,core.bigmap.height*32)}core.dom.gif.innerHTML=""}else{core.canvas[c].clearRect(e||0,f||0,d||core.bigmap.width*32,a||core.bigmap.height*32)}};ui.prototype.fillText=function(b,d,e,f,c,a){if(core.isset(c)){core.setFillStyle(b,c)}if(core.isset(a)){core.setFont(b,a)}core.canvas[b].fillText(d,e,f)};ui.prototype.fillRect=function(b,e,f,d,a,c){if(core.isset(c)){core.setFillStyle(b,c)}core.canvas[b].fillRect(e,f,d,a)};ui.prototype.strokeRect=function(c,f,g,e,a,d,b){if(core.isset(d)){core.setStrokeStyle(c,d)}if(core.isset(b)){core.setLineWidth(c,b)}core.canvas[c].strokeRect(f,g,e,a)};ui.prototype.drawLine=function(b,d,f,e,g,c,a){if(core.isset(c)){core.setStrokeStyle(b,c)}if(core.isset(a)){core.setLineWidth(b,a)}core.canvas[b].beginPath();core.canvas[b].moveTo(d,f);core.canvas[b].lineTo(e,g);core.canvas[b].stroke()};ui.prototype.drawArrow=function(f,h,j,i,k,g,e){if(h==i&&j==k){return}if(core.isset(g)){core.setStrokeStyle(f,g)}if(core.isset(e)){core.setLineWidth(f,e)}var d=10;var b=i-h,c=k-j;var a=Math.atan2(c,b);core.canvas[f].beginPath();core.canvas[f].moveTo(h,j);core.canvas[f].lineTo(i,k);core.canvas[f].lineTo(i-d*Math.cos(a-Math.PI/6),k-d*Math.sin(a-Math.PI/6));core.canvas[f].moveTo(i,k);core.canvas[f].lineTo(i-d*Math.cos(a+Math.PI/6),k-d*Math.sin(a+Math.PI/6));core.canvas[f].stroke()};ui.prototype.setFont=function(b,a){core.canvas[b].font=a};ui.prototype.setLineWidth=function(c,a){if(c=="all"){for(var b in core.canvas){core.canvas[b].lineWidth=a}}core.canvas[c].lineWidth=a};ui.prototype.saveCanvas=function(a){core.canvas[a].save()};ui.prototype.loadCanvas=function(a){core.canvas[a].restore()};ui.prototype.setStrokeStyle=function(b,c){if(b=="all"){for(var a in core.canvas){core.canvas[a].strokeStyle=c}}else{core.canvas[b].strokeStyle=c}};ui.prototype.setAlpha=function(c,a){if(c=="all"){for(var b in core.canvas){core.canvas[b].globalAlpha=a}}else{core.canvas[c].globalAlpha=a}};ui.prototype.setOpacity=function(b,c){if(b=="all"){for(var a in core.canvas){core.canvas[a].canvas.style.opacity=c}}else{core.canvas[b].canvas.style.opacity=c}};ui.prototype.setFillStyle=function(b,c){if(b=="all"){for(var a in core.canvas){core.canvas[a].fillStyle=c}}else{core.canvas[b].fillStyle=c}};ui.prototype.closePanel=function(){core.status.boxAnimateObjs=[];clearInterval(core.status.event.interval);core.clearMap("ui");core.setAlpha("ui",1);core.unLockControl();core.status.event.data=null;core.status.event.id=null;core.status.event.selection=null;core.status.event.ui=null;core.status.event.interval=null};ui.prototype.drawTip=function(e,c){var f,g,h,a,b=false,d=0;clearInterval(core.interval.tipAnimate);core.setFont("data","16px Arial");core.setOpacity("data",0);core.canvas.data.textAlign="left";if(!core.isset(c)){f=16;g=18;h=f+core.canvas.data.measureText(e).width+16;a=42}else{f=44;g=18;h=f+core.canvas.data.measureText(e).width+8;a=42}core.interval.tipAnimate=window.setInterval(function(){if(b){d-=0.1}else{d+=0.1}core.setOpacity("data",d);core.clearMap("data",5,5,400,a);core.fillRect("data",5,5,h,a,"#000");if(core.isset(c)){core.canvas.data.drawImage(core.material.images.items,0,c*32,32,32,10,8,32,32)}core.fillText("data",e,f+5,g+15,"#fff");if(d>0.6||d<0){if(b){core.clearMap("data",5,5,400,a);core.setOpacity("data",1);clearInterval(core.interval.tipAnimate);return}else{if(!core.isset(core.timeout.getItemTipTimeout)){core.timeout.getItemTipTimeout=window.setTimeout(function(){b=true;core.timeout.getItemTipTimeout=null},750)}d=0.6;core.setOpacity("data",d)}}},30)};ui.prototype.drawText=function(b,a){if(core.isset(b)){if((core.isset(core.status.event)&&core.status.event.id=="action")||(core.isset(core.status.replay)&&core.status.replay.replaying)){core.insertAction(b,null,null,a);return}if(typeof b=="string"){b=[{content:b}]}else{if(b instanceof Object&&core.isset(b.content)){b=[b]}else{if(!(b instanceof Array)){core.drawTip("出错了");console.log(b);return}}}core.status.event={id:"text",data:{list:b,callback:a}};core.lockControl();core.stopAutomaticRoute();setTimeout(function(){core.drawText()},30);return}if(core.status.event.data.list.length==0){var a=core.status.event.data.callback;core.ui.closePanel(false);if(core.isset(a)){a()}return}var c=core.status.event.data.list.shift();if(typeof c=="string"){core.ui.drawTextBox(c)}else{core.ui.drawTextBox(c.content,c.id)}};ui.prototype.drawTextBox=function(d,x){if(core.isset(core.status.event)&&core.status.event.id=="action"){core.status.event.ui=d}clearInterval(core.status.event.interval);core.status.event.interval=null;var o=null,s=null,p=null,m=null,n=32,a=null;if(d.indexOf("\t[")==0||d.indexOf("\\t[")==0){var q=d.indexOf("]");if(q>=0){var z=d.substring(2,q);if(d.indexOf("\\t[")==0){z=d.substring(3,q)}d=d.substring(q+1);var y=z.split(",");if(y.length==1){o=y[0];if(o=="hero"){s=core.status.hero.name}else{if(core.isset(core.material.enemys[o])){s=core.material.enemys[o].name;if(core.isset(core.material.icons.enemy48[o])){p=core.material.images.enemy48;m=core.material.icons.enemy48[o];n=48;a=4}else{p=core.material.images.enemys;m=core.material.icons.enemys[o];n=32;a=2}}else{s=o;o="npc";p=null;m=null}}}else{s=y[0];o="npc";if(y[1]=="hero"){o="hero"}else{if(core.isset(core.material.icons.npc48[y[1]])){p=core.material.images.npc48;m=core.material.icons.npc48[y[1]];n=48;a=4}else{if(core.isset(core.material.icons.npcs[y[1]])){p=core.material.images.npcs;m=core.material.icons.npcs[y[1]];n=32;a=2}else{if(core.isset(core.material.icons.enemy48[y[1]])){p=core.material.images.enemy48;m=core.material.icons.enemy48[y[1]];n=48;a=4}else{if(core.isset(core.material.icons.enemys[y[1]])){p=core.material.images.enemys;m=core.material.icons.enemys[y[1]];n=32;a=2}}}}}}}}var A=core.status.textAttribute||core.initStatus.textAttribute;var C=A.titlefont||22;var B=A.textfont||16;var t=A.position,u=null,v=null,G=n-32;if(d.indexOf("\b[")==0||d.indexOf("\\b[")==0){var q=d.indexOf("]");if(q>=0){var z=d.substring(2,q);if(d.indexOf("\\b[")==0){z=d.substring(3,q)}d=d.substring(q+1);var y=z.split(",");if(y[0]=="up"||y[0]=="center"||y[0]=="down"){t=y[0];if(core.status.event.id=="action"){u=core.status.event.data.x;v=core.status.event.data.y}if(y.length>=2){if(y[1]=="hero"){u=core.getHeroLoc("x");v=core.getHeroLoc("y");G=core.material.icons.hero.height-32}else{if(y.length>=3){u=parseInt(y[1]);v=parseInt(y[2])}}}}}}d=core.replaceText(d);var b=core.canvas.ui.createPattern(core.material.ground,"repeat");core.status.boxAnimateObjs=[];core.clearMap("ui");var r=10,w=416-2*r;var e=r+25;if(o=="hero"||core.isset(m)){e=r+63}var E=w-(e-r)-13;var i=B+"px Verdana";if(A.bold){i="bold "+i}var g=core.splitLines("ui",d,E,i);var j=20+(B+5)*(g.length+1)+(o=="hero"?core.material.icons.hero.height-10:core.isset(s)?n-10:0);var F=6,H=22;var D;if(t=="center"){D=parseInt((416-j)/2)}else{if(t=="up"){if(u==null||v==null){D=5}else{D=32*v-j-G-H}}else{if(t=="down"){if(u==null||v==null){D=416-j-5}else{D=32*v+32+H}}}}var c=main.borderColor||"#FFFFFF";core.setAlpha("ui",A.background[3]);core.setFillStyle("ui",core.arrayToRGB(A.background));core.setStrokeStyle("ui",c);core.fillRect("ui",r,D,w,j);core.strokeRect("ui",r-1,D-1,w+1,j+1,c,2);var F=9;if(t=="up"&&core.isset(u)&&core.isset(v)){core.canvas.ui.clearRect(32*u+F,D+j-1,32-2*F,2);core.canvas.ui.beginPath();core.canvas.ui.moveTo(32*u+F-1,D+j-1);core.canvas.ui.lineTo(32*u+16,D+j+H-2);core.canvas.ui.lineTo(32*u+32-F+1,D+j-1);core.canvas.ui.moveTo(32*u+F-1,D+j-1);core.canvas.ui.closePath();core.canvas.ui.fill();core.drawLine("ui",32*u+F,D+j,32*u+16,D+j+H-2);core.drawLine("ui",32*u+32-F,D+j,32*u+16,D+j+H-2)}if(t=="down"&&core.isset(u)&&core.isset(v)){core.canvas.ui.clearRect(32*u+F,D-2,32-2*F,3);core.canvas.ui.beginPath();core.canvas.ui.moveTo(32*u+F-1,D+1);core.canvas.ui.lineTo(32*u+16-1,D-H+2);core.canvas.ui.lineTo(32*u+32-F-1,D+1);core.canvas.ui.moveTo(32*u+F-1,D+1);core.canvas.ui.closePath();core.canvas.ui.fill();core.drawLine("ui",32*u+F,D,32*u+16,D-H+2);core.drawLine("ui",32*u+32-F,D,32*u+16,D-H+2)}core.canvas.ui.textAlign="left";var f=D+35;if(core.isset(o)){f=D+57;core.setAlpha("ui",A.title[3]);core.setFillStyle("ui",core.arrayToRGB(A.title));core.setStrokeStyle("ui",core.arrayToRGB(A.title));if(o=="hero"){var k=core.material.icons.hero.height;core.strokeRect("ui",r+15-1,D+40-1,34,k+2,c,2);core.fillText("ui",s,e,D+30,null,"bold "+C+"px Verdana");core.clearMap("ui",r+15,D+40,32,k);core.fillRect("ui",r+15,D+40,32,k,b);var l=core.material.icons.hero.down;core.canvas.ui.drawImage(core.material.images.hero,l.stop*32,l.loc*k,32,k,r+15,D+40,32,k)}else{core.fillText("ui",s,e,D+30,null,"bold "+C+"px Verdana");if(core.isset(m)){core.strokeRect("ui",r+15-1,D+40-1,34,n+2,c,2);core.status.boxAnimateObjs=[];core.status.boxAnimateObjs.push({bgx:r+15,bgy:D+40,bgWidth:32,bgHeight:n,x:r+15,y:D+40,height:n,animate:a,image:p,pos:m*n});core.drawBoxAnimate()}}}var h=function(I){core.clearMap("ui",e,f-18,E,D+j-f+10);core.setAlpha("ui",A.background[3]);core.setFillStyle("ui",core.arrayToRGB(A.background));core.fillRect("ui",e,f-18,E,D+j-f+11);core.setAlpha("ui",A.text[3]);core.setFillStyle("ui",core.arrayToRGB(A.text));var J=core.splitLines("ui",I,E,i);for(var K=0;K<J.length;K++){core.fillText("ui",J[K],e,f+(B+5)*K,null,i)}};if(x||A.time<=0||core.status.event.id!="action"){h(d)}else{var q=0;core.status.event.interval=setInterval(function(){h(d.substring(0,++q));if(q==d.length){clearInterval(core.status.event.interval);core.status.event.interval=null}},A.time)}};ui.prototype.drawChoices=function(h,g){g=g||[];var b=core.canvas.ui.createPattern(core.material.ground,"repeat");core.clearMap("ui");core.setAlpha("ui",1);core.setFillStyle("ui",b);core.status.event.ui={text:h,choices:g};var x=g.length;var D=416-2*85;core.setFont("ui","bold 17px Verdana");for(var p=0;p<g.length;p++){D=Math.max(D,core.canvas.ui.measureText(core.replaceText(g[p].text||g[p])).width+30)}var v=parseInt((416-D)/2);var m=32*(x+2),d=208+m/2;if(x%2==0){d+=16}var f=d-m+56;var s=null,y=null,t=null,q=null,r=32,a=null;var l=null;var j=v+15;if(core.isset(h)){if(h.indexOf("\t[")==0||h.indexOf("\\t[")==0){var u=h.indexOf("]");if(u>=0){var A=h.substring(2,u);if(h.indexOf("\\t[")==0){A=h.substring(3,u)}h=h.substring(u+1);var z=A.split(",");if(z.length==1){s=z[0];if(s=="hero"){y=core.status.hero.name}else{if(core.isset(core.material.enemys[s])){y=core.material.enemys[s].name;if(core.isset(core.material.icons.enemy48[s])){t=core.material.images.enemy48;q=core.material.icons.enemy48[s];r=48;a=4}else{t=core.material.images.enemys;q=core.material.icons.enemys[s];r=32;a=2}}else{y=s;s="npc";t=null;q=null}}}else{y=z[0];s="npc";if(z[1]=="hero"){s="hero"}else{if(core.isset(core.material.icons.npc48[z[1]])){t=core.material.images.npc48;q=core.material.icons.npc48[z[1]];r=48;a=4}else{if(core.isset(core.material.icons.npcs[z[1]])){t=core.material.images.npcs;q=core.material.icons.npcs[z[1]];r=32;a=2}else{if(core.isset(core.material.icons.enemy48[z[1]])){t=core.material.images.enemy48;q=core.material.icons.enemy48[z[1]];r=48;a=4}else{if(core.isset(core.material.icons.enemys[z[1]])){t=core.material.images.enemys;q=core.material.icons.enemys[z[1]];r=32;a=2}}}}}}}}h=core.replaceText(h);if(s=="hero"||core.isset(q)){j=v+60}l=core.splitLines("ui",h,D-(j-v)-10,"bold 15px Verdana");var e=0;if(y!=null){e+=25}e+=l.length*20;m+=e}var C=d-m;var c=main.borderColor||"#FFFFFF";core.fillRect("ui",v,C,D,m,b);core.strokeRect("ui",v-1,C-1,D+1,m+1,c,2);if(core.isset(l)){var k=C+35;if(core.isset(s)){core.canvas.ui.textAlign="center";k=C+55;var B=v+D/2;if(s=="hero"||core.isset(q)){B+=12}if(s=="hero"){var n=core.material.icons.hero.height;core.strokeRect("ui",v+15-1,C+30-1,34,n+2,"#DDDDDD",2);core.fillText("ui",y,B,C+27,"#FFD700","bold 19px Verdana");core.clearMap("ui",v+15,C+30,32,n);core.fillRect("ui",v+15,C+30,32,n,b);var o=core.material.icons.hero.down;core.canvas.ui.drawImage(core.material.images.hero,o.stop*32,o.loc*n,32,n,v+15,C+30,32,n)}else{core.fillText("ui",y,B,C+27,"#FFD700","bold 19px Verdana");if(core.isset(q)){core.strokeRect("ui",v+15-1,C+30-1,34,r+2,"#DDDDDD",2);core.status.boxAnimateObjs=[];core.status.boxAnimateObjs.push({bgx:v+15,bgy:C+30,bgWidth:32,bgHeight:r,x:v+15,y:C+30,height:r,animate:a,image:t,pos:q*r});core.drawBoxAnimate()}}}core.canvas.ui.textAlign="left";for(var p=0;p<l.length;p++){core.fillText("ui",l[p],j,k,"#FFFFFF","bold 15px Verdana");k+=20}}core.canvas.ui.textAlign="center";for(var p=0;p<g.length;p++){core.fillText("ui",core.replaceText(g[p].text||g[p]),208,f+32*p,"#FFFFFF","bold 17px Verdana")}if(g.length>0){if(!core.isset(core.status.event.selection)){core.status.event.selection=0}while(core.status.event.selection<0){core.status.event.selection+=g.length}while(core.status.event.selection>=g.length){core.status.event.selection-=g.length}var w=core.canvas.ui.measureText(core.replaceText(g[core.status.event.selection].text||g[core.status.event.selection])).width;core.strokeRect("ui",208-w/2-5,f+32*core.status.event.selection-20,w+10,28,"#FFD700",2)}return};ui.prototype.drawConfirmBox=function(m,o,k){core.lockControl();core.status.event.id="confirmBox";core.status.event.data={yes:o,no:k};core.status.event.ui=m;if(!core.isset(core.status.event.selection)||core.status.event.selection>1){core.status.event.selection=1}if(core.status.event.selection<0){core.status.event.selection=0}var a=core.canvas.ui.createPattern(core.material.ground,"repeat");core.clearMap("ui");core.setAlpha("ui",1);core.setFillStyle("ui",a);core.setFont("ui","bold 19px Verdana");var d=m.split("\n");var h=d.length;var j=0;for(var e in d){j=Math.max(j,core.canvas.ui.measureText(d[e]).width)}var f=Math.min(208-40-parseInt(j/2),100);var n=140-(h-1)*30;var l=416-2*f,c=416-140-n;var b=main.borderColor||"#FFFFFF";if(core.isPlaying()){core.fillRect("ui",f,n,l,c,a)}if(core.isPlaying()){core.strokeRect("ui",f-1,n-1,l+1,c+1,b,2)}core.canvas.ui.textAlign="center";for(var e in d){core.fillText("ui",d[e],208,n+50+e*30,"#FFFFFF")}core.fillText("ui","确定",208-38,n+c-35,"#FFFFFF","bold 17px Verdana");core.fillText("ui","取消",208+38,n+c-35);var g=core.canvas.ui.measureText("确定").width;if(core.status.event.selection==0){core.strokeRect("ui",208-38-parseInt(g/2)-5,n+c-35-20,g+10,28,"#FFD700",2)}if(core.status.event.selection==1){core.strokeRect("ui",208+38-parseInt(g/2)-5,n+c-35-20,g+10,28,"#FFD700",2)}};ui.prototype.drawSwitchs=function(){core.status.event.id="switchs";var a=["背景音乐： "+(core.musicStatus.bgmStatus?"[ON]":"[OFF]"),"背景音效： "+(core.musicStatus.soundStatus?"[ON]":"[OFF]"),"战斗动画： "+(core.flags.battleAnimate?"[ON]":"[OFF]"),"怪物显伤： "+(core.flags.displayEnemyDamage?"[ON]":"[OFF]"),"临界显伤： "+(core.flags.displayCritical?"[ON]":"[OFF]"),"领域显伤： "+(core.flags.displayExtraDamage?"[ON]":"[OFF]"),"单击瞬移： "+(core.flags.clickMoveDirectly?"[ON]":"[OFF]"),"新版存档： "+(core.platform.useLocalForage?"[ON]":"[OFF]"),"查看工程","下载离线版本","返回主菜单"];this.drawChoices(null,a)};ui.prototype.drawSettings=function(){core.status.event.id="settings";this.drawChoices(null,["系统设置","快捷商店","浏览地图","同步存档","返回标题","数据统计","操作帮助","关于本塔","返回游戏"])};ui.prototype.drawQuickShop=function(){core.status.event.id="selectShop";var d=core.status.shops,c=Object.keys(d);var a=[];for(var b=0;b<c.length;b++){a.push(d[c[b]].textInList)}a.push("返回游戏");this.drawChoices(null,a)};ui.prototype.drawBattleAnimate=function(K,f){core.lockControl();if(!core.isset(core.status.event.id)){core.status.event={id:"battle"}}var n=core.getStatus("hp"),l=core.getStatus("atk"),m=core.getStatus("def"),o=core.getStatus("mdef");n=Math.max(0,n);l=Math.max(0,l);m=Math.max(0,m);o=Math.max(0,o);if(core.flags.equipPercentage){l=Math.floor(core.getFlag("equip_atk_buff",1)*l);m=Math.floor(core.getFlag("equip_def_buff",1)*m);o=Math.floor(core.getFlag("equip_mdef_buff",1)*o)}var g=core.material.enemys[K];var h=core.enemys.getEnemyInfo(g,n,l,m,o);var G=h.hp,D=h.atk,E=h.def,H=h.money,F=h.experience,I=h.special;var u=0;if(core.enemys.hasSpecial(I,11)){var T=n*g.value;T=Math.floor(T)||0;if(g.add){G+=T}u+=T}n-=core.enemys.getExtraDamage(g);if(core.enemys.hasSpecial(I,2)){m=0}var R=0;if(core.enemys.hasSpecial(I,1)){R=1}var S=2;if(core.enemys.hasSpecial(I,4)){S=3}if(core.enemys.hasSpecial(I,5)){S=4}if(core.enemys.hasSpecial(I,6)){S=1+(g.n||4)}if(core.enemys.hasSpecial(I,7)){u+=Math.floor(core.values.breakArmor*m)}if(core.enemys.hasSpecial(I,9)){u+=Math.floor(core.values.purify*o)}o-=u;if(o<0){n+=o;o=0}var O=core.enemys.getSpecialText(K);var b=core.canvas.ui.createPattern(core.material.ground,"repeat");core.clearMap("ui");var w=10,L=416-2*w;var A=3;if(core.flags.enableMDef||core.flags.enableMoney||core.flags.enableExperience){A=4}if(core.flags.enableMoney&&core.flags.enableExperience){A=5}var z=60;var k=z*A+50;var Q=(416-k)/2,d=k;core.setAlpha("ui",0.85);core.fillRect("ui",w,Q,L,d,"#000000");core.setAlpha("ui",1);core.strokeRect("ui",w-1,Q-1,L+1,d+1,"#FFFFFF",2);core.clearMap("data");clearInterval(core.interval.tipAnimate);core.setAlpha("data",1);core.setOpacity("data",1);core.status.boxAnimateObjs=[];var C=35;var e=40;var J=32,a=2;var t=core.material.images.enemys,s=core.material.icons.enemys;if(core.isset(core.material.icons.enemy48[K])){t=core.material.images.enemy48;s=core.material.icons.enemy48;J=48;a=4}var p=core.material.icons.hero.height;core.strokeRect("ui",w+C-1,Q+C-1,e+2,p+e-32+2,"#FFD700",2);core.strokeRect("ui",w+L-C-e-1,Q+C-1,e+2,J+e-32+2);core.canvas.ui.textAlign="center";core.fillText("ui",core.status.hero.name,w+C+e/2,Q+C+p+40,"#FFD700","bold 22px Verdana");core.fillText("ui","怪物",w+L-C-e/2,Q+C+J+40);for(var r=0,v=0;r<O.length;r++){if(O[r]!=""){core.fillText("ui",O[r],w+L-C-e/2,Q+C+J+44+20*(++v),"#FF6A6A","15px Verdana")}}core.clearMap("ui",w+C,Q+C,e,p+e-32);core.fillRect("ui",w+C,Q+C,e,p+e-32,b);var q=core.material.icons.hero.down;core.canvas.ui.drawImage(core.material.images.hero,q.stop*32,q.loc*p,32,p,w+C+(e-32)/2,Q+C+(e-32)/2,32,p);core.status.boxAnimateObjs=[];core.status.boxAnimateObjs.push({bgx:w+L-C-40,bgy:Q+C,bgWidth:e,bgHeight:J+e-32,x:w+L-C-40+(e-32)/2,y:Q+C+(e-32)/2,height:J,image:t,pos:J*s[K],animate:a});core.drawBoxAnimate();var B=80;var y=w+C+e+10;var x=y+B;var M=w+L-C-e-10;var N=M-B;core.canvas.ui.textAlign="left";var P=Q+C+10;core.fillText("ui","生命值",y,P,"#DDDDDD","16px Verdana");core.drawLine("ui",y,P+8,x,P+8,"#FFFFFF",2);core.canvas.data.textAlign="right";core.fillText("data",n,x,P+26,"#DDDDDD","bold 16px Verdana");P+=z;core.canvas.ui.textAlign="left";core.fillText("ui","攻击",y,P,"#DDDDDD","16px Verdana");core.drawLine("ui",y,P+8,x,P+8,"#FFFFFF",2);core.canvas.ui.textAlign="right";core.fillText("ui",l,x,P+26,"#DDDDDD","bold 16px Verdana");P+=z;core.canvas.ui.textAlign="left";core.fillText("ui","防御",y,P,"#DDDDDD","16px Verdana");core.drawLine("ui",y,P+8,x,P+8,"#FFFFFF",2);core.canvas.ui.textAlign="right";core.fillText("ui",m,x,P+26,"#DDDDDD","bold 16px Verdana");if(core.flags.enableMDef){P+=z;core.canvas.ui.textAlign="left";core.fillText("ui","护盾",y,P,"#DDDDDD","16px Verdana");core.drawLine("ui",y,P+8,x,P+8,"#FFFFFF",2);core.canvas.data.textAlign="right";core.fillText("data",o,x,P+26,"#DDDDDD","bold 16px Verdana")}core.canvas.ui.textAlign="right";var P=Q+C+10;core.fillText("ui","生命值",M,P,"#DDDDDD","16px Verdana");core.drawLine("ui",N,P+8,M,P+8,"#FFFFFF",2);core.canvas.data.textAlign="left";core.fillText("data",G,N,P+26,"#DDDDDD","bold 16px Verdana");P+=z;core.canvas.ui.textAlign="right";core.fillText("ui","攻击",M,P,"#DDDDDD","16px Verdana");core.drawLine("ui",N,P+8,M,P+8,"#FFFFFF",2);core.canvas.ui.textAlign="left";core.fillText("ui",D,N,P+26,"#DDDDDD","bold 16px Verdana");P+=z;core.canvas.ui.textAlign="right";core.fillText("ui","防御",M,P,"#DDDDDD","16px Verdana");core.drawLine("ui",N,P+8,M,P+8,"#FFFFFF",2);core.canvas.ui.textAlign="left";core.fillText("ui",E,N,P+26,"#DDDDDD","bold 16px Verdana");if(core.flags.enableMoney){P+=z;core.canvas.ui.textAlign="right";core.fillText("ui","金币",M,P,"#DDDDDD","16px Verdana");core.drawLine("ui",N,P+8,M,P+8,"#FFFFFF",2);core.canvas.ui.textAlign="left";core.fillText("ui",H,N,P+26,"#DDDDDD","bold 16px Verdana")}if(core.flags.enableExperience){P+=z;core.canvas.ui.textAlign="right";core.fillText("ui","经验",M,P,"#DDDDDD","16px Verdana");core.drawLine("ui",N,P+8,M,P+8,"#FFFFFF",2);core.canvas.ui.textAlign="left";core.fillText("ui",F,N,P+26,"#DDDDDD","bold 16px Verdana")}core.canvas.ui.textAlign="left";core.fillText("ui","V",x+8,208-15,"#FFFFFF","italic bold 40px Verdana");core.canvas.ui.textAlign="right";core.fillText("ui","S",N-8,208+15,"#FFFFFF","italic bold 40px Verdana");var c=setInterval(function(){core.playSound("attack.mp3");if(R==0){core.drawLine("data",w+L-C-e+6,Q+C+J+e-32-6,w+L-C-6,Q+C+6,"#FF0000",4);setTimeout(function(){core.clearMap("data",w+L-C-e,Q+C,e,e+J-32)},250);if(l-E>0){G-=l-E}if(G<0){G=0}core.clearMap("data",N,Q+C+10,B,40);core.canvas.data.textAlign="left";core.fillText("data",G,N,Q+C+10+26,"#DDDDDD","bold 16px Verdana");if(core.enemys.hasSpecial(I,8)){o-=Math.floor(core.values.counterAttack*l);if(o<0){n+=o;o=0}core.clearMap("data",y,Q+C+10,B,40);core.canvas.data.textAlign="right";core.fillText("data",n,x,Q+C+10+26,"#DDDDDD","bold 16px Verdana");if(core.flags.enableMDef){core.clearMap("data",y,Q+C+10+3*z,B,40);core.fillText("data",o,x,Q+C+10+26+3*z)}}}else{core.drawLine("data",w+C+6,Q+C+p+(e-32)-6,w+C+e-6,Q+C+6,"#FF0000",4);setTimeout(function(){core.clearMap("data",w+C,Q+C,e,p+e-32)},250);var i=D-m;if(i<0){i=0}o-=i;if(o<0){n+=o;o=0}core.clearMap("data",y,Q+C+10,B,40);core.canvas.data.textAlign="right";core.fillText("data",n,x,Q+C+10+26,"#DDDDDD","bold 16px Verdana");if(core.flags.enableMDef){core.clearMap("data",y,Q+C+10+3*z,B,40);core.fillText("data",o,x,Q+C+10+26+3*z)}}R++;if(R>=S){R=0}if(n<=0||G<=0){clearInterval(c);core.status.boxAnimateObjs=[];core.clearMap("ui");core.setAlpha("ui",1);core.clearMap("data");if(core.status.event.id=="battle"){core.unLockControl();core.status.event.id=null}if(core.isset(f)){f()}return}},400)};ui.prototype.drawWaiting=function(e){core.lockControl();core.status.event.id="waiting";var a=core.canvas.ui.createPattern(core.material.ground,"repeat");core.clearMap("ui");core.setAlpha("ui",1);core.setFillStyle("ui",a);core.setFont("ui","bold 17px Verdana");var f=core.canvas.ui.measureText(e).width;var d=Math.max(f+50,220);var c=208-parseInt(d/2),g=208-32-16,b=416-2*g;core.fillRect("ui",c,g,d,b,a);core.strokeRect("ui",c-1,g-1,d+1,b+1,"#FFFFFF",2);core.canvas.ui.textAlign="center";core.fillText("ui",e,208,g+56,"#FFFFFF")};ui.prototype.drawSyncSave=function(){core.status.event.id="syncSave";this.drawChoices(null,["同步存档到服务器","从服务器加载存档","存档至本地文件","从本地文件读档","回放当前录像","下载当前录像","清空本地存档","返回主菜单"])};ui.prototype.drawSyncSelect=function(){core.status.event.id="syncSelect";this.drawChoices(null,["同步本地所有存档","只同步当前单存档","返回上级菜单"])};ui.prototype.drawLocalSaveSelect=function(){core.status.event.id="localSaveSelect";this.drawChoices(null,["下载所有存档","只下载当前单存档","返回上级菜单"])};ui.prototype.drawStorageRemove=function(){core.status.event.id="storageRemove";this.drawChoices(null,["清空全部塔的存档","只清空当前塔的存档","返回上级菜单"])};ui.prototype.drawReplay=function(){core.lockControl();core.status.event.id="replay";this.drawChoices(null,["从头回放录像","从存档开始回放","下载当前录像","返回游戏"])};ui.prototype.drawPagination=function(b,d,c){if(d<=1){return}if(!core.isset(c)){c=12}core.setFont("ui","bold 15px Verdana");core.setFillStyle("ui","#DDDDDD");var a=core.canvas.ui.measureText(b+" / "+b).width;core.canvas.ui.textAlign="left";core.fillText("ui",b+" / "+d,parseInt((416-a)/2),c*32+19);core.canvas.ui.textAlign="center";if(b>1){core.fillText("ui","上一页",208-80,c*32+19)}if(b<d){core.fillText("ui","下一页",208+80,c*32+19)}};ui.prototype.drawCursor=function(){if(!core.isset(core.status.automaticRoute.cursorX)){core.status.automaticRoute.cursorX=core.getHeroLoc("x")}if(core.status.automaticRoute.cursorX<0){core.status.automaticRoute.cursorX=0}if(core.status.automaticRoute.cursorX>12){core.status.automaticRoute.cursorX=12}if(!core.isset(core.status.automaticRoute.cursorY)){core.status.automaticRoute.cursorY=core.getHeroLoc("y")}if(core.status.automaticRoute.cursorY<0){core.status.automaticRoute.cursorY=0}if(core.status.automaticRoute.cursorY>12){core.status.automaticRoute.cursorY=12}core.status.event.id="cursor";core.lockControl();core.clearMap("ui");core.setAlpha("ui",1);var a=4;core.strokeRect("ui",32*core.status.automaticRoute.cursorX+a/2,32*core.status.automaticRoute.cursorY+a/2,32-a,32-a,"#FFD700",a)};ui.prototype.drawBook=function(n){var j=core.enemys.getCurrentEnemys(core.floorIds[(core.status.event.selection||{}).index]);var b=core.canvas.ui.createPattern(core.material.ground,"repeat");clearInterval(core.interval.tipAnimate);core.clearMap("data");core.setOpacity("data",1);core.clearMap("ui");core.setAlpha("ui",1);core.setFillStyle("ui",b);core.fillRect("ui",0,0,416,416);core.setAlpha("ui",0.6);core.setFillStyle("ui","#000000");core.fillRect("ui",0,0,416,416);core.setAlpha("ui",1);core.canvas.ui.textAlign="left";core.setFont("ui","bold 15px Verdana");if(j.length==0){core.fillText("ui","本层无怪物",83,222,"#999999","bold 50px Verdana");core.canvas.ui.textAlign="center";core.fillText("ui","返回游戏",370,403,"#DDDDDD","bold 15px Verdana");return}if(n<0){n=0}if(n>=j.length){n=j.length-1}var q=6;var p=parseInt(n/q)+1;var s=parseInt((j.length-1)/q)+1;core.status.event.data=n;var r=(p-1)*q,g=Math.min(p*q,j.length);j=j.slice(r,g);core.status.boxAnimateObjs=[];for(var m=0;m<j.length;m++){var h=j[m];core.strokeRect("ui",22,62*m+22,42,42,"#DDDDDD",2);var c="enemys";if(core.isset(core.material.icons.enemy48[h.id])){c="enemy48"}var l=c=="enemy48"?48:32;var a=c=="enemy48"?4:2;core.status.boxAnimateObjs.push({bgx:22,bgy:62*m+22,bgWidth:42,bgHeight:42,x:27,y:62*m+27,height:32,animate:a,image:core.material.images[c],pos:core.material.icons[c][h.id]*l});core.canvas.ui.textAlign="center";if(h.special==""){core.fillText("ui",h.name,115,62*m+47,"#DDDDDD","bold 17px Verdana")}else{core.fillText("ui",h.name,115,62*m+40,"#DDDDDD","bold 17px Verdana");core.fillText("ui",h.special,115,62*m+62,"#FF6A6A","bold 15px Verdana")}core.canvas.ui.textAlign="left";core.fillText("ui","生命",165,62*m+32,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.hp),195,62*m+32,"#DDDDDD","bold 13px Verdana");core.fillText("ui","攻击",255,62*m+32,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.atk),285,62*m+32,"#DDDDDD","bold 13px Verdana");core.fillText("ui","防御",335,62*m+32,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.def),365,62*m+32,"#DDDDDD","bold 13px Verdana");var k=165,o=0;if(core.flags.enableMoney){core.fillText("ui","金币",165,62*m+50,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.money),195,62*m+50,"#DDDDDD","bold 13px Verdana");k=255;o++}if(core.flags.enableAddPoint){core.canvas.ui.textAlign="left";core.fillText("ui","加点",k,62*m+50,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.point),k+30,62*m+50,"#DDDDDD","bold 13px Verdana");k=255;o++}if(core.flags.enableExperience&&o<2){core.canvas.ui.textAlign="left";core.fillText("ui","经验",k,62*m+50,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.experience),k+30,62*m+50,"#DDDDDD","bold 13px Verdana");o++}var f=281;if(o==1){f=326}if(o==2){f=361}core.canvas.ui.textAlign="center";var e=h.damage;var d="#FFFF00";if(e==null){e="无法战斗";d="#FF0000"}else{if(e>=core.status.hero.hp){d="#FF0000"}if(e<=0){d="#00FF00"}e=core.formatBigNumber(e);if(core.enemys.hasSpecial(core.material.enemys[h.id],19)){e+="+"}if(core.enemys.hasSpecial(core.material.enemys[h.id],21)){e+="-"}}if(core.material.enemys[h.id].notBomb){e+="[b]"}core.fillText("ui",e,f,62*m+50,d,"bold 13px Verdana");core.canvas.ui.textAlign="left";core.fillText("ui","临界",165,62*m+68,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.critical),195,62*m+68,"#DDDDDD","bold 13px Verdana");core.fillText("ui","减伤",255,62*m+68,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.criticalDamage),285,62*m+68,"#DDDDDD","bold 13px Verdana");core.fillText("ui","1防",335,62*m+68,"#DDDDDD","13px Verdana");core.fillText("ui",core.formatBigNumber(h.defDamage),365,62*m+68,"#DDDDDD","bold 13px Verdana");if(n==r+m){core.strokeRect("ui",10,62*m+13,416-10*2,62,"#FFD700")}}core.drawBoxAnimate();this.drawPagination(p,s,12);core.canvas.ui.textAlign="center";core.fillText("ui","返回游戏",370,403,"#DDDDDD","bold 15px Verdana")};ui.prototype.drawBookDetail=function(p){var l=core.enemys.getCurrentEnemys(core.floorIds[(core.status.event.selection||{}).index]);if(l.length==0){return}if(p<0){p=0}if(p>=l.length){p=l.length-1}var j=l[p];var k=j.id;var n=core.enemys.getSpecialHint(core.material.enemys[k]);if(n.length==0){n.push("该怪物无特殊属性。")}if(core.enemys.hasSpecial(core.material.enemys[k].special,11)){var g=core.getDamage(k);if(g!=null){var v=1,h=100*g;var t=core.status.hero.hp;while(v<h){var s=Math.floor((v+h)/2);core.status.hero.hp=s;if(core.canBattle(k)){h=s}else{v=s+1}}core.status.hero.hp=v;if(core.canBattle(k)){n.push("");n.push("打死该怪物最低需要生命值："+core.formatBigNumber(v))}core.status.hero.hp=t}}n.push("");var f=core.enemys.nextCriticals(k,10).map(function(i){return i[0]+":"+i[1]});while(f[0]=="0:0"){f.shift()}n.push("临界表："+JSON.stringify(f));var b=n.join("\n");core.status.event.id="book-detail";clearInterval(core.interval.tipAnimate);core.clearMap("data");core.setOpacity("data",1);var q=10,u=416-2*q;var c=q+25;var y=u-(c-q)-13;var e=core.splitLines("data",b,y,"16px Verdana");var m=416-10-Math.min(416-24*(e.length+1)-65,250);var x=(416-m)/2,a=m;core.setAlpha("data",0.9);core.fillRect("data",q,x,u,a,"#000000");core.setAlpha("data",1);core.strokeRect("data",q-1,x-1,u+1,a+1,main.borderColor||"#FFFFFF",2);core.canvas.data.textAlign="left";core.fillText("data",j.name,c,x+30,"#FFD700","bold 22px Verdana");var d=x+57;for(var o=0;o<e.length;o++){var w=e[o];var p=w.indexOf("：");if(p>=0){var z=w.substring(0,p+1);core.fillText("data",z,c,d,"#FF6A6A","bold 16px Verdana");var r=core.canvas.data.measureText(z).width;core.fillText("data",w.substring(p+1),c+r,d,"#FFFFFF","16px Verdana")}else{core.fillText("data",e[o],c,d,"#FFFFFF","16px Verdana")}d+=24}core.fillText("data","<点击任意位置继续>",270,x+m-13,"#CCCCCC","13px Verdana")};ui.prototype.drawFly=function(b){if(b<0){b=0}if(b>=core.status.hero.flyRange.length){b=core.status.hero.flyRange.length-1}core.status.event.data=b;var a=core.status.hero.flyRange[b];var c=core.status.maps[a].title;core.clearMap("ui");core.setAlpha("ui",0.85);core.fillRect("ui",0,0,416,416,"#000000");core.setAlpha("ui",1);core.canvas.ui.textAlign="center";core.fillText("ui","楼层跳跃",208,60,"#FFFFFF","bold 28px Verdana");core.fillText("ui","返回游戏",208,403,"#FFFFFF","bold 15px Verdana");core.fillText("ui",c,356,247,"#FFFFFF","bold 19px Verdana");if(b<core.status.hero.flyRange.length-1){core.fillText("ui","▲",356,247-64,"#FFFFFF","17px Verdana");core.fillText("ui","▲",356,247-96,"#FFFFFF","17px Verdana");core.fillText("ui","▲",356,247-96-7,"#FFFFFF","17px Verdana")}if(b>0){core.fillText("ui","▼",356,247+64,"#FFFFFF","17px Verdana");core.fillText("ui","▼",356,247+96,"#FFFFFF","17px Verdana");core.fillText("ui","▼",356,247+96+7,"#FFFFFF","17px Verdana")}core.strokeRect("ui",20,100,273,273,"#FFFFFF",2);this.drawThumbnail(a,"ui",core.status.maps[a].blocks,20,100,273)};ui.prototype.drawMaps=function(c,k,l){core.lockControl();core.status.event.id="viewMaps";if(!core.isset(c)){core.status.event.data=null;core.clearMap("ui");core.setAlpha("ui",1);core.clearMap("animate");core.setOpacity("animate",0.4);core.fillRect("animate",0,0,416,416,"#000000");core.strokeRect("ui",66,2,284,60,"#FFD700",4);core.strokeRect("ui",2,66,60,284);core.strokeRect("ui",66,416-62,284,60);core.strokeRect("ui",416-62,66,60,284);core.strokeRect("ui",66,66,284,92);core.strokeRect("ui",66,32*8+2,284,92);core.canvas.ui.textAlign="center";core.fillText("ui","上移地图 [W]",208,38,"#FFD700","20px Arial");core.fillText("ui","下移地图 [S]",208,390);var i=150;core.fillText("ui","左",32,i);core.fillText("ui","移",32,i+32);core.fillText("ui","地",32,i+32*2);core.fillText("ui","图",32,i+32*3);core.fillText("ui","[A]",32,i+32*4);core.fillText("ui","右",384,i);core.fillText("ui","移",384,i+32);core.fillText("ui","地",384,i+32*2);core.fillText("ui","图",384,i+32*3);core.fillText("ui","[D]",384,i+32*4);core.fillText("ui","前张地图 [▲ / PGUP]",208,64+54);core.fillText("ui","后张地图 [▼ / PGDN]",208,32*8+54);core.fillText("ui","退出 [ESC / ENTER]",208,208+8);core.fillText("ui","[X] 可查看怪物手册",285,208+40,null,"13px Arial");return}core.clearMap("animate");core.setOpacity("animate",1);if(core.isset(c.index)){k=c.x;l=c.y;c=c.index}if(c<0){c=0}if(c>=core.floorIds.length){c=core.floorIds.length-1}var a=core.floorIds[c],e=core.floors[a].width||13,d=core.floors[a].height||13;if(!core.isset(k)){k=parseInt(e/2)}if(!core.isset(l)){l=parseInt(d/2)}if(k<6){k=6}if(k>e-7){k=e-7}if(l<6){l=6}if(l>d-7){l=d-7}core.status.event.data={index:c,x:k,y:l,damage:(core.status.event.data||{damage:false}).damage};clearTimeout(core.interval.tipAnimate);core.clearMap("ui");core.setAlpha("ui",1);this.drawThumbnail(a,"ui",core.status.maps[a].blocks,0,0,416,k,l);core.clearMap("data");core.setOpacity("data",0.2);core.canvas.data.textAlign="left";core.setFont("data","16px Arial");var f=core.status.maps[a].title;if(e>13||d>13){f+=" ["+(k-6)+","+(l-6)+"]"}var g=16,h=18,j=g+core.canvas.data.measureText(f).width+16,b=42;core.fillRect("data",5,5,j,b,"#000");core.setOpacity("data",0.4);core.fillText("data",f,g+5,h+15,"#fff")};ui.prototype.drawToolbox=function(h){if(!core.isset(core.status.event.data)||!core.isset(core.status.event.data.toolsPage)||!core.isset(core.status.event.data.constantsPage)){core.status.event.data={toolsPage:1,constantsPage:1,selectId:null}}var q=Object.keys(core.status.hero.items.tools).sort();var b=Object.keys(core.status.hero.items.constants).sort();var r=core.status.event.data.toolsPage;var c=core.status.event.data.constantsPage;var s=Math.ceil(q.length/12);var d=Math.ceil(b.length/12);if(!core.isset(h)){if(q.length>0){h=0}else{if(b.length>0){h=12}else{h=0}}}core.status.event.selection=h;var m;var n;if(h<12){m=h+(r-1)*12;if(m>=q.length){m=Math.max(0,q.length-1)}n=q[m]}else{m=h%12+(c-1)*12;if(m>=b.length){m=Math.max(0,b.length-1)}n=b[m]}if(!core.hasItem(n)){n=null}core.status.event.data.selectId=n;core.clearMap("ui");core.setAlpha("ui",0.85);core.fillRect("ui",0,0,416,416,"#000000");core.setAlpha("ui",1);core.setFillStyle("ui","#DDDDDD");core.setStrokeStyle("ui","#DDDDDD");core.canvas.ui.lineWidth=2;core.canvas.ui.strokeWidth=2;var t=20;core.canvas.ui.beginPath();core.canvas.ui.moveTo(0,130-t);core.canvas.ui.lineTo(416,130-t);core.canvas.ui.stroke();core.canvas.ui.beginPath();core.canvas.ui.moveTo(416,129-t);core.canvas.ui.lineTo(416,105-t);core.canvas.ui.lineTo(416-72,105-t);core.canvas.ui.lineTo(416-102,129-t);core.canvas.ui.fill();core.canvas.ui.beginPath();core.canvas.ui.moveTo(0,290-t);core.canvas.ui.lineTo(416,290-t);core.canvas.ui.stroke();core.canvas.ui.beginPath();core.canvas.ui.moveTo(416,289-t);core.canvas.ui.lineTo(416,265-t);core.canvas.ui.lineTo(416-72,265-t);core.canvas.ui.lineTo(416-102,289-t);core.canvas.ui.fill();core.canvas.ui.textAlign="right";core.fillText("ui","消耗道具",411,124-t,"#333333","bold 16px Verdana");core.fillText("ui","永久道具",411,284-t);core.canvas.ui.textAlign="left";if(core.isset(n)){var j=core.material.items[n];core.fillText("ui",j.name,10,32,"#FFD700","bold 20px Verdana");var o=j.text||"该道具暂无描述。";var l=core.splitLines("ui",o,406,"17px Verdana");core.fillText("ui",l[0],10,62,"#FFFFFF","17px Verdana");if(l.length==1){core.fillText("ui","<继续点击该道具即可进行使用>",10,89,"#CCCCCC","14px Verdana")}else{var k=o.substring(l[0].length);core.fillText("ui",k,10,89,"#FFFFFF","17px Verdana")}}core.canvas.ui.textAlign="right";var g=core.material.images.items;for(var e=0;e<12;e++){var p=q[12*(r-1)+e];if(!core.isset(p)){break}var u=144+Math.floor(e/6)*54+5-t;var f=core.material.icons.items[p];core.canvas.ui.drawImage(g,0,f*32,32,32,16*(4*(e%6)+1)+5,u,32,32);core.fillText("ui",core.itemCount(p),16*(4*(e%6)+1)+40,u+33,"#FFFFFF","bold 14px Verdana");if(n==p){core.strokeRect("ui",16*(4*(e%6)+1)+1,u-4,40,40,"#FFD700")}}for(var e=0;e<12;e++){var a=b[12*(c-1)+e];if(!core.isset(a)){break}var u=304+Math.floor(e/6)*54+5-t;var f=core.material.icons.items[a];core.canvas.ui.drawImage(g,0,f*32,32,32,16*(4*(e%6)+1)+5,u,32,32);if(n==a){core.strokeRect("ui",16*(4*(e%6)+1)+1,u-4,40,40,"#FFD700")}}this.drawPagination(r,s,7);this.drawPagination(c,d,12);core.canvas.ui.textAlign="center";core.fillText("ui","[装备栏]",370,25,"#DDDDDD","bold 15px Verdana");core.fillText("ui","返回游戏",370,403,"#DDDDDD","bold 15px Verdana")};ui.prototype.drawEquipbox=function(m){if(!core.isset(core.status.event.data)||!core.isset(core.status.event.data.page)){core.status.event.data={page:1,selectId:null}}var a=main.equipName||[];var g=a.length;if(!core.isset(core.status.hero.equipment)){core.status.hero.equipment=[]}var e=core.status.hero.equipment;var q=Object.keys(core.status.hero.items.equips).sort();var r=core.status.event.data.page;var u=Math.ceil(q.length/12);if(!core.isset(m)){if(g>0&&core.isset(e[0])){m=0}else{if(q.length>0){m=12}else{m=0}}}if(m>=12&&q.length==0){m=0}var s=null;if(m<12){if(m>=g){m=Math.max(0,g-1)}s=e[m]||null}else{if(r==u){m=Math.min(m,(q.length+11)%12+12)}s=q[m-12+(r-1)*12];if(!core.hasItem(s)){s=null}}core.status.event.selection=m;core.status.event.data.selectId=s;core.clearMap("ui",0,0,416,416);core.setAlpha("ui",0.85);core.fillRect("ui",0,0,416,416,"#000000");core.setAlpha("ui",1);core.setFillStyle("ui","#DDDDDD");core.setStrokeStyle("ui","#DDDDDD");core.canvas.ui.lineWidth=2;core.canvas.ui.strokeWidth=2;var v=20;core.canvas.ui.beginPath();core.canvas.ui.moveTo(0,130-v);core.canvas.ui.lineTo(416,130-v);core.canvas.ui.stroke();core.canvas.ui.beginPath();core.canvas.ui.moveTo(416,129-v);core.canvas.ui.lineTo(416,105-v);core.canvas.ui.lineTo(416-72,105-v);core.canvas.ui.lineTo(416-102,129-v);core.canvas.ui.fill();core.canvas.ui.beginPath();core.canvas.ui.moveTo(0,290-v);core.canvas.ui.lineTo(416,290-v);core.canvas.ui.stroke();core.canvas.ui.beginPath();core.canvas.ui.moveTo(416,289-v);core.canvas.ui.lineTo(416,265-v);core.canvas.ui.lineTo(416-72,265-v);core.canvas.ui.lineTo(416-102,289-v);core.canvas.ui.fill();core.canvas.ui.textAlign="right";core.fillText("ui","当前装备",411,124-v,"#333333","bold 16px Verdana");core.fillText("ui","拥有装备",411,284-v);core.canvas.ui.textAlign="left";if(core.isset(s)){var d=core.material.items[s];if(!core.isset(d.equip)){d.equip={type:0}}var h=d.equip.type;core.fillText("ui",d.name+"（"+(a[h]||"未知部位")+"）",10,32,"#FFD700","bold 20px Verdana");var t=d.text||"该装备暂无描述。";var o=core.splitLines("ui",t,406,"17px Verdana");core.fillText("ui",o[0],10,62,"#FFFFFF","17px Verdana");if(o.length==1){var b;if(m<12){b=core.compareEquipment(null,s)}else{b=core.compareEquipment(s,e[d.equip.type])}var c=10;[["攻击","atk"],["防御","def"],["魔防","mdef"]].forEach(function(C){var D=C[0],x=C[1];if(!core.isset(b[x])||b[x]==0){return}var i="#00FF00";if(b[x]<0){i="#FF0000"}var B=core.getStatus(x),z=B+b[x];if(core.flags.equipPercentage){var A=core.getFlag("equip_"+x+"_buff",1),y=A+b[x]/100;B=Math.floor(A*core.getStatus(x));z=Math.floor(y*core.getStatus(x))}var w=D+" "+B+"->";core.fillText("ui",w,c,89,"#CCCCCC","bold 14px Verdana");c+=core.canvas.ui.measureText(w).width;core.fillText("ui",z,c,89,i);c+=core.canvas.ui.measureText(z).width+15})}else{var n=t.substring(o[0].length);core.fillText("ui",n,10,89,"#FFFFFF","17px Verdana")}}core.canvas.ui.textAlign="right";var l=core.material.images.items;for(var j=0;j<g;j++){var f=e[j]||null;if(core.isset(f)){var k=core.material.icons.items[f];core.canvas.ui.drawImage(l,0,k*32,32,32,16*(8*(j%3)+5)+5,144+Math.floor(j/3)*54+5-v,32,32)}core.fillText("ui",a[j]||"未知",16*(8*(j%3)+1)+40,144+Math.floor(j/3)*54+32-v,"#FFFFFF","bold 16px Verdana");core.strokeRect("ui",16*(8*(j%3)+5)+1,144+Math.floor(j/3)*54+1-v,40,40,m==j?"#FFD700":"#FFFFFF")}for(var j=0;j<12;j++){var p=q[12*(r-1)+j];if(!core.isset(p)){continue}var k=core.material.icons.items[p];core.canvas.ui.drawImage(l,0,k*32,32,32,16*(4*(j%6)+1)+5,304+Math.floor(j/6)*54+5-v,32,32);if(core.itemCount(p)>1){core.fillText("ui",core.itemCount(p),16*(4*(j%6)+1)+40,304+Math.floor(j/6)*54+38-v,"#FFFFFF","bold 14px Verdana")}if(m>=12&&s==p){core.strokeRect("ui",16*(4*(j%6)+1)+1,304+Math.floor(j/6)*54+1-v,40,40,"#FFD700")}}this.drawPagination(r,u,12);core.canvas.ui.textAlign="center";core.fillText("ui","[道具栏]",370,25,"#DDDDDD","bold 15px Verdana");core.fillText("ui","返回游戏",370,403,"#DDDDDD","bold 15px Verdana")};ui.prototype.drawSLPanel=function(d,j){if(!core.isset(d)){d=1}if(d<0){d=0}var i=parseInt(d/10),h=d%10;var g=main.savePages||30;if(i>=g){i=g-1}if(h>5){h=5}d=10*i+h;var e=-1;if(core.isset(core.status.event.data)){e=parseInt(core.status.event.data/10)}core.status.event.data=d;if(!core.isset(core.status.event.ui)){core.status.event.ui=[]}var m=416/6,k=118;var l="#FFD700";if(core.status.event.selection){l="#FF6A6A"}var c=function(){core.clearMap("ui");core.setAlpha("ui",0.85);core.fillRect("ui",0,0,416,416,"#000000");core.setAlpha("ui",1);core.ui.drawPagination(i+1,g,12);core.canvas.ui.textAlign="center";core.fillText("ui","返回游戏",370,403,"#DDDDDD","bold 15px Verdana");if(core.status.event.selection){core.setFillStyle("ui","#FF6A6A")}if(core.status.event.id=="save"){core.fillText("ui","删除模式",48,403)}else{core.fillText("ui","输入编号",48,403)}};var a=function(n,o){var q=core.status.event.id=="save"?"存档":core.status.event.id=="load"?"读档":core.status.event.id=="replayLoad"?"回放":"";core.status.event.ui[o]=n;var p=5*i+o;if(o<3){core.fillText("ui",o==0?"自动存档":q+p,(2*o+1)*m,35,"#FFFFFF","bold 17px Verdana");core.strokeRect("ui",(2*o+1)*m-k/2,50,k,k,o==h?l:"#FFFFFF",o==h?6:2);if(core.isset(n)&&core.isset(n.floorId)){core.ui.drawThumbnail(n.floorId,"ui",core.maps.load(n.maps,n.floorId).blocks,(2*o+1)*m-k/2,50,k,n.hero.loc.x,n.hero.loc.y,n.hero.loc,n.hero.flags.heroIcon||"hero.png");core.fillText("ui",core.formatDate(new Date(n.time)),(2*o+1)*m,65+k,"#FFFFFF","10px Verdana")}else{core.fillRect("ui",(2*o+1)*m-k/2,50,k,k,"#333333",2);core.fillText("ui","空",(2*o+1)*m,117,"#FFFFFF","bold 30px Verdana")}}else{core.fillText("ui",q+p,(2*o-5)*m,230,"#FFFFFF","bold 17px Verdana");core.strokeRect("ui",(2*o-5)*m-k/2,245,k,k,o==h?l:"#FFFFFF",o==h?6:2);if(core.isset(n)&&core.isset(n.floorId)){core.ui.drawThumbnail(n.floorId,"ui",core.maps.load(n.maps,n.floorId).blocks,(2*o-5)*m-k/2,245,k,n.hero.loc.x,n.hero.loc.y,n.hero.loc,n.hero.flags.heroIcon||"hero.png");core.fillText("ui",core.formatDate(new Date(n.time)),(2*o-5)*m,260+k,"#FFFFFF","10px Verdana")}else{core.fillRect("ui",(2*o-5)*m-k/2,245,k,k,"#333333",2);core.fillText("ui","空",(2*o-5)*m,245+70,"#FFFFFF","bold 30px Verdana")}}};function f(o,n){if(o==6){n();return}core.getLocalForage(o==0?"autoSave":"save"+(5*i+o),null,function(p){core.status.event.ui[o]=p;f(o+1,n)},function(p){console.log(p)})}function b(){c();for(var n=0;n<6;n++){a(core.status.event.ui[n],n)}}if(j||i!=e){core.status.event.ui=[];f(0,b)}else{b()}};ui.prototype.drawThumbnail=function(j,g,f,B,C,v,h,i,m,l){var r=core.floors[j].width||13;var q=core.floors[j].height||13;var w=core.bigmap.tempCanvas;var A=r*32,z=q*32;w.canvas.width=A;w.canvas.height=z;w.clearRect(0,0,A,z);core.maps.drawBgFgMap(j,w,"bg");var o=[];if(core.isset((core.status.maps||core.floors)[j].images)){o=(core.status.maps||core.floors)[j].images;if(typeof o=="string"){o=[[0,0,o]]}}o.forEach(function(E){var b=parseInt(E[0]),x=parseInt(E[1]),D=E[2];if(core.isset(b)&&core.isset(x)&&!core.hasFlag("floorimg_"+j+"_"+b+"_"+x)&&core.isset(core.material.images.images[D])){var y=core.material.images.images[D];if(!E[3]){w.drawImage(y,32*b,32*x,y.width,y.height)}else{if(E[3]==2){w.drawImage(y,0,y.height-32,y.width,32,32*b,32*x+y.height-32,y.width,32)}}}});var p=core.maps.getMapArray(f,r,q);for(var a in f){var c=f[a];if(core.isset(c.event)&&!c.disable){if(c.event.cls=="autotile"){core.drawAutotile(w,p,c,32,0,0)}else{if(c.event.cls=="tileset"){var s=core.icons.getTilesetOffset(c.event.id);if(s!=null){w.drawImage(core.material.images.tilesets[s.image],32*s.x,32*s.y,32,32,32*c.x,32*c.y,32,32)}}else{if(c.id==17){if(core.isset(core.material.images.airwall)){w.drawImage(core.material.images.airwall,32*c.x,32*c.y)}}else{if(c.event.id!="none"){var d=core.material.icons[c.event.cls][c.event.id];var e=core.material.images[c.event.cls];var k=c.event.height||32;w.drawImage(e,0,d*k,32,k,32*c.x,32*c.y+32-k,32,k)}}}}}}if(core.isset(m)){if(!core.isset(core.material.images.images[l])){l="hero.png"}var n=core.material.icons.hero[m.direction];var k=core.material.images.images[l].height/4;w.drawImage(core.material.images.images[l],n.stop*32,n.loc*k,32,k,32*m.x,32*m.y+32-k,32,k)}core.maps.drawBgFgMap(j,w,"fg");o.forEach(function(E){var b=parseInt(E[0]),x=parseInt(E[1]),D=E[2];if(core.isset(b)&&core.isset(x)&&!core.hasFlag("floorimg_"+j+"_"+b+"_"+x)&&core.isset(core.material.images.images[D])){var y=core.material.images.images[D];if(E[3]==1){w.drawImage(y,32*b,32*x,y.width,y.height)}else{if(E[3]==2){w.drawImage(y,0,0,y.width,y.height-32,32*b,32*x,y.width,y.height-32)}}}});if(core.status.event.id=="viewMaps"&&(core.status.event.data||{}).damage){core.control.updateDamage(j,w)}core.clearMap(g,B,C,v,v);if(!core.isset(h)){h=parseInt(r/2)}if(!core.isset(i)){i=parseInt(q/2)}var t=core.clamp(h-6,0,r-13),u=core.clamp(i-6,0,q-13);core.canvas[g].drawImage(w.canvas,t*32,u*32,416,416,B,C,v,v)};ui.prototype.drawKeyBoard=function(){core.lockControl();core.status.event.id="keyBoard";core.clearMap("ui");var c=16,g=48,f=416-2*c,b=416-2*g;var a=core.canvas.ui.createPattern(core.material.ground,"repeat");core.fillRect("ui",c,g,f,b,a);core.strokeRect("ui",c-1,g-1,f+1,b+1,"#FFFFFF",2);core.canvas.ui.textAlign="center";core.fillText("ui","虚拟键盘",208,g+35,"#FFD700","bold 22px Verdana");core.setFont("ui","17px Verdana");core.setFillStyle("ui","#FFFFFF");var e=128-9;var d=[["F1","F2","F3","F4","F5","F6","F7","F8","F9","10","11"],["1","2","3","4","5","6","7","8","9","0"],["Q","W","E","R","T","Y","U","I","O","P"],["A","S","D","F","G","H","J","K","L"],["Z","X","C","V","B","N","M"],["-","=","[","]","\\",";","'",",",".","/","`"],["ES","TA","CA","SH","CT","AL","SP","BS","EN","DE"]];d.forEach(function(j){for(var h=0;h<j.length;h++){core.fillText("ui",j[h],48+32*h,e)}e+=32});core.canvas.ui.textAlign="center";core.fillText("ui","返回游戏",416-80,e-3,"#FFFFFF","bold 15px Verdana")};ui.prototype.drawStatistics=function(){var ids=this.uidata.drawStatistics();var obj={};ids.forEach(function(e){obj[e]=0});var total={monster:{count:0,money:0,experience:0,point:0,},count:obj,add:{hp:0,atk:0,def:0,mdef:0}};var current=core.clone(total);core.floorIds.forEach(function(floorId){var floor=core.status.maps[floorId];var blocks=core.status.maps[floorId].blocks;if(floor.cannotViewMap&&floorId!=core.status.floorId){return}blocks.forEach(function(block){if(!core.isset(block.event)||block.disable){return}var event=block.event;if(event.cls.indexOf("enemy")==0){var enemyId=event.id,enemy=core.material.enemys[enemyId];total.monster.money+=enemy.money||0;total.monster.experience+=enemy.experience||0;total.monster.point+=enemy.point||0;total.monster.count++;if(floorId==core.status.floorId){current.monster.money+=enemy.money||0;current.monster.experience+=enemy.experience||0;current.monster.point+=enemy.point||0;current.monster.count++}}else{var id=event.id;var temp=core.clone(core.status.hero);if(core.isset(total.count[id])){var hp=0,atk=0,def=0,mdef=0;if(core.isset(core.material.items[id])&&core.material.items[id].cls=="items"&&id!="superPotion"){var ratio=floor.item_ratio||1;if(core.isset(core.items.itemEffect[id])){eval(core.items.itemEffect[id])}hp=core.status.hero.hp-temp.hp;atk=core.status.hero.atk-temp.atk;def=core.status.hero.def-temp.def;mdef=core.status.hero.mdef-temp.mdef}else{if(id.indexOf("sword")==0&&core.isset(core.values[id])){var x=core.values[id];if(typeof x=="number"){x={atk:x}}atk+=x.atk||0;def+=x.def||0;mdef+=x.mdef||0}if(id.indexOf("shield")==0&&core.isset(core.values[id])){var x=core.values[id];if(typeof x=="number"){x={def:x}}atk+=x.atk||0;def+=x.def||0;mdef+=x.mdef||0}}core.status.hero=core.clone(temp);total.count[id]++;total.add.hp+=hp;total.add.atk+=atk;total.add.def+=def;total.add.mdef+=mdef;if(floorId==core.status.floorId){current.count[id]++;current.add.hp+=hp;current.add.atk+=atk;current.add.def+=def;current.add.mdef+=mdef}}}})});var getText=function(type,data){var text=type+"地图中：\n";text+="共有怪物"+data.monster.count+"个";if(core.flags.enableMoney){text+="，总金币数"+data.monster.money}if(core.flags.enableExperience){text+="，总经验数"+data.monster.experience}if(core.flags.enableAddPoint){text+="，总加点数"+data.monster.point}text+="。\n\n";Object.keys(data.count).forEach(function(key){var value=data.count[key];if(value>0){var name=null;if(key=="yellowDoor"){name="黄门"}else{if(key=="blueDoor"){name="蓝门"}else{if(key=="redDoor"){name="红门"}else{if(key=="greenDoor"){name="绿门"}else{if(key=="steelDoor"){name="铁门"}else{name=(core.material.items[key]||{}).name}}}}}if(core.isset(name)){text+=name+value+"个；"}}});text+="\n\n";text+="共加生命值"+core.formatBigNumber(data.add.hp)+"点，攻击"+core.formatBigNumber(data.add.atk)+"点，防御"+core.formatBigNumber(data.add.def)+"点，魔防"+core.formatBigNumber(data.add.mdef)+"点。";return text};var formatTime=function(time){return core.setTwoDigits(parseInt(time/3600000))+":"+core.setTwoDigits(parseInt(time/60000)%60)+":"+core.setTwoDigits(parseInt(time/1000)%60)};var statistics=core.status.hero.statistics;core.drawText([getText("全塔",total),getText("当前",current),"当前总步数："+core.status.hero.steps+"，当前游戏时长："+formatTime(statistics.currTime)+"，总游戏时长"+formatTime(statistics.totalTime)+"。\n瞬间移动次数："+statistics.moveDirectly+"，共计少走"+statistics.ignoreSteps+"步。\n\n总计通过血瓶恢复生命值为"+core.formatBigNumber(statistics.hp)+"点。\n\n总计打死了"+statistics.battle+"个怪物，受到的伤害为"+core.formatBigNumber(statistics.battleDamage+statistics.poisonDamage+statistics.extraDamage)+"，其中战斗伤害"+core.formatBigNumber(statistics.battleDamage)+"点"+(core.flags.enableDebuff?("，中毒伤害"+core.formatBigNumber(statistics.poisonDamage)+"点"):"")+"，领域/夹击/阻击/血网伤害"+core.formatBigNumber(statistics.extraDamage)+"点。","\t[说明]1. 地图数据统计的效果仅模拟当前立刻获得该道具的效果。\n2. 不会计算“不可被浏览地图”的隐藏层的数据。\n3. 不会计算任何通过事件得到的道具（显示事件、改变图块、或直接增加道具等）。\n4. 在自定义道具（例如其他宝石）后，需在ui.js的drawStatistics中注册，不然不会进行统计。\n5. 所有统计信息仅供参考，如有错误，概不负责。"])};ui.prototype.drawAbout=function(){return this.uidata.drawAbout()};ui.prototype.drawHelp=function(){core.drawText(["\t[键盘快捷键列表][CTRL] 跳过对话\n[Z] 转向\n[X] 打开/关闭怪物手册\n[G] 打开/关闭楼层传送器\n[A] 读取自动存档（回退）\n[S/D] 打开/关闭存/读档页面\n[K/V] 打开/关闭快捷商店选择列表\n[T] 打开/关闭工具栏\n[ESC] 打开/关闭系统菜单\n[B] 打开数据统计\n[H] 打开帮助页面\n[R] 回放\n[SPACE] 轻按（仅在轻按开关打开时有效）\n[PgUp/PgDn] 浏览地图\n[1] 快捷使用破墙镐\n[2] 快捷使用炸弹/圣锤\n[3] 快捷使用中心对称飞行器","\t[鼠标操作]点状态栏中图标： 进行对应的操作\n点任意块： 寻路并移动\n点任意块并拖动： 指定寻路路线\n双击空地： 瞬间移动\n单击勇士： 转向\n双击勇士： 轻按（仅在轻按开关打开时有效）\n长按任意位置：跳过剧情对话或打开虚拟键盘\n"])};