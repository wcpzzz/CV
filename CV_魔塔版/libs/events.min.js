function events(){this.init()}events.prototype.init=function(){this.eventdata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.events;this.events={battle:function(c,b,a){b.battle(c.event.id,c.x,c.y);if(b.isset(a)){a()}},getItem:function(c,b,a){b.getItem(c.event.id,1,c.x,c.y);if(b.isset(a)){a()}},openDoor:function(c,b,a){b.openDoor(c.event.id,c.x,c.y,true,function(){if(b.isset(a)){a()}b.replay()})},changeFloor:function(c,b,a){var d={};if(b.isset(c.event.data.loc)){d={x:c.event.data.loc[0],y:c.event.data.loc[1]}}if(b.isset(c.event.data.direction)){d.direction=c.event.data.direction}if(b.status.event.id!="action"){b.status.event.id=null}b.changeFloor(c.event.data.floorId,c.event.data.stair,d,c.event.data.time,function(){if(b.isset(a)){a()}b.replay()})},passNet:function(c,b,a){b.events.passNet(c);if(b.isset(a)){a()}},changeLight:function(c,b,a){b.events.changeLight(c.x,c.y);if(b.isset(a)){a()}},ski:function(c,b,a){b.events.ski();if(b.isset(a)){a()}},pushBox:function(c,b,a){b.events.pushBox(c);if(b.isset(a)){a()}},action:function(c,b,a){b.events.insertAction(c.event.data,c.x,c.y,a)}}};events.prototype.getEvents=function(a){if(!core.isset(a)){return this.events}return this.events[a]};events.prototype.initGame=function(){return this.eventdata.initGame()};events.prototype.startGame=function(a){if(core.status.isStarting){return}core.status.isStarting=true;core.hideStartAnimate(function(){core.drawText(core.clone(core.firstData.startText),function(){if(core.flags.showBattleAnimateConfirm){core.status.event.selection=core.flags.battleAnimate?0:1;core.ui.drawConfirmBox("你想开启战斗动画吗？\n之后可以在菜单栏中开启或关闭。\n（强烈建议新手开启此项）",function(){core.data.flags.battleAnimate=true;core.flags.battleAnimate=true;core.setLocalStorage("battleAnimate",true);core.startGame(a);core.utils.__init_seed();core.events.setInitData(a)},function(){core.data.flags.battleAnimate=false;core.flags.battleAnimate=false;core.setLocalStorage("battleAnimate",false);core.startGame(a);core.utils.__init_seed();core.events.setInitData(a)})}else{core.startGame(a);core.utils.__init_seed();core.events.setInitData(a)}})})};events.prototype.setInitData=function(a){return this.eventdata.setInitData(a)};events.prototype.win=function(b,a){core.status.gameOver=true;return this.eventdata.win(b,a)};events.prototype.lose=function(a){core.status.gameOver=true;return this.eventdata.lose(a)};events.prototype.gameOver=function(c,d,e){core.clearMap("animate");core.clearMap("image");core.clearMap("weather");core.dom.gif2.innerHTML="";core.animateFrame.weather.type=null;core.animateFrame.weather.level=0;core.animateFrame.weather.nodes=[];core.setFg(null,0);core.ui.closePanel();var a=function(){core.ui.closePanel();core.ui.drawConfirmBox("你想下载录像吗？",function(){var f={name:core.firstData.name,version:core.firstData.version,hard:core.status.hard,seed:core.getFlag("seed"),route:core.encodeRoute(core.status.route)};core.download(core.firstData.name+"_"+core.formatDate2(new Date())+".h5route",JSON.stringify(f));core.restart()},function(){core.restart()})};var b=function(){core.ui.closePanel();if(!core.isset(c)){a();return}var f=function(i){var h=core.status.hero.hp;if(i==undefined){h=1}var g=new FormData();g.append("type","score");g.append("name",core.firstData.name);g.append("version",core.firstData.version);g.append("platform",core.platform.isPC?"PC":core.platform.isAndroid?"Android":core.platform.isIOS?"iOS":"");g.append("hard",core.encodeBase64(core.status.hard));g.append("username",core.encodeBase64(i||""));g.append("ending",core.encodeBase64(c));g.append("lv",core.status.hero.lv);g.append("hp",Math.min(h,Math.pow(2,63)));g.append("atk",core.status.hero.atk);g.append("def",core.status.hero.def);g.append("mdef",core.status.hero.mdef);g.append("money",core.status.hero.money);g.append("experience",core.status.hero.experience);g.append("steps",core.status.hero.steps);g.append("norank",e||0);g.append("seed",core.getFlag("seed"));g.append("totalTime",Math.floor(core.status.hero.statistics.totalTime/1000));g.append("route",core.encodeRoute(core.status.route));g.append("base64",1);if(main.isCompetition){core.http("POST","/games/competition/upload.php",g)}else{core.http("POST","/games/upload.php",g)}setTimeout(function(){a()},150)};core.ui.drawConfirmBox("你想记录你的ID和成绩吗？",function(){if(main.isCompetition){f("")}else{f(prompt("请输入你的ID："))}},function(){if(main.isCompetition){a()}else{f(undefined)}});return};if(d){core.drawText("录像回放完毕！",function(){core.restart()})}else{if(core.isset(core.values.maxValidHp)&&core.status.hero.hp>core.values.maxValidHp){core.drawText("作弊可耻！",function(){core.restart()})}else{if(core.hasFlag("debug")){core.drawText("\t[系统提示]调试模式下无法上传成绩",function(){core.restart()})}else{b()}}}};events.prototype.afterChangeFloor=function(a,b){if(main.mode!="play"){return}return this.eventdata.afterChangeFloor(a,b)};events.prototype.doEvents=function(b,c,d,a){if(!core.isset(b)){return}if(!(b instanceof Array)){b=[b]}core.status.event={id:"action",data:{list:[{todo:core.clone(b),total:core.clone(b),condition:"false"}],x:c,y:d,callback:a}};core.waitHeroToStop(function(){core.lockControl();core.events.doAction()})};events.prototype.doAction=function(){core.status.boxAnimateObjs=[];clearInterval(core.status.event.interval);core.status.event.interval=null;core.clearMap("ui");core.setAlpha("ui",1);if(core.status.event.data.list.length==0){var callback=core.status.event.data.callback;core.ui.closePanel();if(core.isset(callback)){callback()}core.replay();return}var current=core.status.event.data.list[0];if(current.todo.length==0){if(core.calValue(current.condition)){current.todo=core.clone(current.total)}else{core.status.event.data.list.shift()}this.doAction();return}var data=current.todo.shift();core.status.event.data.current=data;var x=core.status.event.data.x,y=core.status.event.data.y;if(typeof data=="string"){core.status.event.data.type="text";if(core.status.replay.replaying){core.events.doAction()}else{core.ui.drawTextBox(data)}return}core.status.event.data.type=data.type;switch(data.type){case"text":if(core.status.replay.replaying){core.events.doAction()}else{core.ui.drawTextBox(data.text,data.showAll)}break;case"autoText":if(core.status.replay.replaying){core.events.doAction()}else{core.ui.drawTextBox(data.text);setTimeout(function(){core.events.doAction()},data.time||3000)}break;case"setText":if(data.position=="up"||data.position=="down"||data.position=="center"){core.status.textAttribute.position=data.position}["bold","titlefont","textfont","time"].forEach(function(t){if(core.isset(data[t])){core.status.textAttribute[t]=data[t]}});["background","title","text"].forEach(function(t){if(core.isset(data[t])&&(data[t] instanceof Array)&&data[t].length>=3){if(data[t].length==3){data[t].push(1)}core.status.textAttribute[t]=data[t]}});core.setFlag("textAttribute",core.status.textAttribute);core.events.doAction();break;case"tip":core.drawTip(core.replaceText(data.text));core.events.doAction();break;case"show":if(!core.isset(data.loc)){data.loc=[x,y]}if((typeof data.loc[0]=="number"||typeof data.loc[0]=="string")&&(typeof data.loc[1]=="number"||typeof data.loc[1]=="string")){data.loc=[[core.calValue(data.loc[0]),core.calValue(data.loc[1])]]}if(core.isset(data.time)&&data.time>0&&(!core.isset(data.floorId)||data.floorId==core.status.floorId)){core.animateBlock(data.loc,"show",data.time,function(){data.loc.forEach(function(t){core.showBlock(t[0],t[1],data.floorId)});core.events.doAction()})}else{data.loc.forEach(function(t){core.showBlock(t[0],t[1],data.floorId)});this.doAction()}break;case"hide":if(!core.isset(data.loc)){data.loc=[x,y]}if((typeof data.loc[0]=="number"||typeof data.loc[0]=="string")&&(typeof data.loc[1]=="number"||typeof data.loc[1]=="string")){data.loc=[[core.calValue(data.loc[0]),core.calValue(data.loc[1])]]}if(core.isset(data.time)&&data.time>0&&(!core.isset(data.floorId)||data.floorId==core.status.floorId)){data.loc.forEach(function(t){core.hideBlock(t[0],t[1],data.floorId)});core.animateBlock(data.loc,"hide",data.time,function(){data.loc.forEach(function(t){core.removeBlock(t[0],t[1],data.floorId)});core.events.doAction()})}else{data.loc.forEach(function(t){core.removeBlock(t[0],t[1],data.floorId)});this.doAction()}break;case"setBlock":if(core.isset(data.loc)){x=core.calValue(data.loc[0]);y=core.calValue(data.loc[1])}core.setBlock(data.number,x,y,data.floorId);this.doAction();break;case"showFloorImg":if(!core.isset(data.loc)){data.loc=[x,y]}if((typeof data.loc[0]=="number"||typeof data.loc[0]=="string")&&(typeof data.loc[1]=="number"||typeof data.loc[1]=="string")){data.loc=[[core.calValue(data.loc[0]),core.calValue(data.loc[1])]]}core.maps.setFloorImage("show",data.loc,data.floorId,function(){core.events.doAction()});break;case"hideFloorImg":if(!core.isset(data.loc)){data.loc=[x,y]}if((typeof data.loc[0]=="number"||typeof data.loc[0]=="string")&&(typeof data.loc[1]=="number"||typeof data.loc[1]=="string")){data.loc=[[core.calValue(data.loc[0]),core.calValue(data.loc[1])]]}core.maps.setFloorImage("hide",data.loc,data.floorId,function(){core.events.doAction()});break;case"showBgFgMap":if(!core.isset(data.loc)){data.loc=[x,y]}if((typeof data.loc[0]=="number"||typeof data.loc[0]=="string")&&(typeof data.loc[1]=="number"||typeof data.loc[1]=="string")){data.loc=[[core.calValue(data.loc[0]),core.calValue(data.loc[1])]]}core.maps.setBgFgMap("show",data.name,data.loc,data.floorId,function(){core.events.doAction()});break;case"hideBgFgMap":if(!core.isset(data.loc)){data.loc=[x,y]}if((typeof data.loc[0]=="number"||typeof data.loc[0]=="string")&&(typeof data.loc[1]=="number"||typeof data.loc[1]=="string")){data.loc=[[core.calValue(data.loc[0]),core.calValue(data.loc[1])]]}core.maps.setBgFgMap("hide",data.name,data.loc,data.floorId,function(){core.events.doAction()});break;case"setBgFgBlock":if(core.isset(data.loc)){x=core.calValue(data.loc[0]);y=core.calValue(data.loc[1])}core.setBgFgBlock(data.name,data.number,x,y,data.floorId);this.doAction();break;case"follow":if(core.isset(core.material.images.images[data.name])&&core.material.images.images[data.name].width==128){if(!core.isset(core.status.hero.followers)){core.status.hero.followers=[]}core.status.hero.followers.push({img:data.name});core.control.gatherFollowers();core.clearMap("hero");core.drawHero()}this.doAction();break;case"unfollow":if(core.isset(core.status.hero.followers)){var remove=false;if(!core.isset(data.name)&&core.status.hero.followers.length>0){core.status.hero.followers=[];remove=true}if(core.isset(data.name)){for(var i=0;i<core.status.hero.followers.length;i++){if(core.status.hero.followers[i].img==data.name){core.status.hero.followers.splice(i,1);remove=true;break}}}if(remove){core.control.gatherFollowers();core.clearMap("hero");core.drawHero()}}this.doAction();break;case"animate":if(core.isset(data.loc)){if(data.loc=="hero"){x=core.getHeroLoc("x");y=core.getHeroLoc("y")}else{if(data.loc instanceof Array){x=core.calValue(data.loc[0]);y=core.calValue(data.loc[1])}}}if(data.async){core.drawAnimate(data.name,x,y);core.events.doAction()}else{core.drawAnimate(data.name,x,y,function(){core.events.doAction()})}break;case"move":if(core.isset(data.loc)){x=core.calValue(data.loc[0]);y=core.calValue(data.loc[1])}core.moveBlock(x,y,data.steps,data.time,data.keep,function(){core.events.doAction()});break;case"moveHero":core.eventMoveHero(data.steps,data.time,function(){core.events.doAction()});break;case"jump":var sx=x,sy=y,ex=x,ey=y;if(core.isset(data.from)){sx=core.calValue(data.from[0]);sy=core.calValue(data.from[1])}if(core.isset(data.to)){ex=core.calValue(data.to[0]);ey=core.calValue(data.to[1])}core.jumpBlock(sx,sy,ex,ey,data.time,data.keep,function(){core.events.doAction()});break;case"jumpHero":var ex=core.status.hero.loc.x,ey=core.status.hero.loc.y;if(core.isset(data.loc)){ex=core.calValue(data.loc[0]);ey=core.calValue(data.loc[1])}core.jumpHero(ex,ey,data.time,function(){core.events.doAction()});break;case"changeFloor":var heroLoc={x:core.calValue(data.loc[0]),y:core.calValue(data.loc[1])};if(core.isset(data.direction)){heroLoc.direction=data.direction}core.changeFloor(data.floorId||core.status.floorId,null,heroLoc,data.time,function(){core.lockControl();core.events.doAction()});break;case"changePos":core.clearMap("hero");if(core.isset(data.loc)){core.setHeroLoc("x",core.calValue(data.loc[0]));core.setHeroLoc("y",core.calValue(data.loc[1]))}if(core.isset(data.direction)){core.setHeroLoc("direction",data.direction)}core.drawHero();this.doAction();break;case"showImage":if(core.isset(data.loc)&&core.isset(core.material.images.images[data.name])){core.canvas.image.drawImage(core.material.images.images[data.name],core.calValue(data.loc[0]),core.calValue(data.loc[1]))}else{core.clearMap("image")}this.doAction();break;case"animateImage":if(core.status.replay.replaying){this.doAction()}else{if(core.isset(data.loc)&&core.isset(core.material.images.images[data.name])&&(data.action=="show"||data.action=="hide")){if(data.async){core.events.animateImage(data.action,core.material.images.images[data.name],data.loc,data.time,data.keep);this.doAction()}else{core.events.animateImage(data.action,core.material.images.images[data.name],data.loc,data.time,data.keep,function(){core.events.doAction()})}}else{this.doAction()}}break;case"showGif":if(core.isset(data.loc)&&core.isset(core.material.images.images[data.name])){var gif=new Image();gif.src=core.material.images.images[data.name].src;gif.style.position="absolute";gif.style.left=(core.calValue(data.loc[0])*core.domStyle.scale)+"px";gif.style.top=(core.calValue(data.loc[1])*core.domStyle.scale)+"px";gif.style.width=core.material.images.images[data.name].width*core.domStyle.scale+"px";gif.style.height=core.material.images.images[data.name].height*core.domStyle.scale+"px";core.dom.gif2.appendChild(gif)}else{core.dom.gif2.innerHTML=""}this.doAction();break;case"moveImage":if(core.status.replay.replaying){this.doAction()}else{if(core.isset(data.from)&&core.isset(data.to)&&core.isset(core.material.images.images[data.name])){if(data.async){core.events.moveImage(core.material.images.images[data.name],data.from,data.to,data.time,data.keep);this.doAction()}else{core.events.moveImage(core.material.images.images[data.name],data.from,data.to,data.time,data.keep,function(){core.events.doAction()})}}else{this.doAction()}}break;case"setFg":if(data.async){core.setFg(data.color,data.time);core.setFlag("color",data.color||null);this.doAction()}else{core.setFg(data.color,data.time,function(){core.setFlag("color",data.color||null);core.events.doAction()})}break;case"setWeather":core.setWeather(data.name,data.level);if(core.isset(data.name)){core.setFlag("weather",[data.name,data.level])}else{core.setFlag("weather",null)}this.doAction();break;case"openDoor":if(core.isset(data.loc)){x=core.calValue(data.loc[0]);y=core.calValue(data.loc[1])}var floorId=data.floorId||core.status.floorId;var block=core.getBlock(x,y,floorId);if(block!=null){if(floorId==core.status.floorId){core.openDoor(block.block.event.id,block.block.x,block.block.y,false,function(){core.events.doAction()})}else{core.removeBlock(block.block.x,block.block.y,floorId);this.doAction()}break}this.doAction();break;case"openShop":if(core.status.replay.replaying){core.status.shops[data.id].visited=true;core.status.event.data.list=[];this.doAction()}else{core.events.openShop(data.id)}break;case"disableShop":core.events.disableQuickShop(data.id);this.doAction();break;case"battle":core.battle(data.id,null,null,true,function(){core.events.doAction()});break;case"trigger":var toX=core.calValue(data.loc[0]),toY=core.calValue(data.loc[1]);var block=core.getBlock(toX,toY);if(block!=null){block=block.block;if(core.isset(block.event)&&block.event.trigger=="action"){core.status.event.data.list=[{todo:core.clone(block.event.data),total:core.clone(block.event.data),condition:"false"}];core.status.event.data.x=block.x;core.status.event.data.y=block.y}}this.doAction();break;case"playSound":if(!core.status.replay.replaying){core.playSound(data.name)}this.doAction();break;case"playBgm":core.playBgm(data.name);this.doAction();break;case"pauseBgm":core.pauseBgm();this.doAction();break;case"resumeBgm":core.resumeBgm();this.doAction();break;case"setVolume":data.value=parseInt(data.value||0);if(data.value<0){data.value=0}if(data.value>100){data.value=100}if(data.async){this.setVolume(data.value/100,data.time);this.doAction()}else{this.setVolume(data.value/100,data.time,function(){core.events.doAction()})}break;case"setValue":try{var value=core.calValue(data.value);if(data.name.indexOf("status:")==0){value=parseFloat(value);core.setStatus(data.name.substring(7),value)}if(data.name.indexOf("item:")==0){value=parseInt(value);var itemId=data.name.substring(5);if(value>core.itemCount(itemId)){core.getItem(itemId,value-core.itemCount(itemId))}else{core.setItem(itemId,value)}}if(data.name.indexOf("flag:")==0){core.setFlag(data.name.substring(5),value)}}catch(e){console.log(e)}if(core.status.hero.hp<=0){core.status.hero.hp=0;core.updateStatusBar();core.events.lose()}else{core.updateStatusBar();this.doAction()}break;case"setFloor":core.status.maps[data.floorId||core.status.floorId][data.name]=core.calValue(data.value);core.updateStatusBar();this.doAction();break;case"setHeroIcon":this.setHeroIcon(data.name);this.doAction();break;case"input":var value;if(core.status.replay.replaying){var action=core.status.replay.toReplay.shift();if(action.indexOf("input:")==0){value=parseInt(action.substring(6))}else{core.stopReplay();core.drawTip("录像文件出错");return}}else{core.interval.onDownInterval="tmp";value=prompt(core.replaceText(data.text))}value=Math.abs(parseInt(value)||0);core.status.route.push("input:"+value);core.setFlag("input",value);this.doAction();break;case"input2":var value;if(core.status.replay.replaying){var action=core.status.replay.toReplay.shift();try{if(action.indexOf("input2:")!=0){throw new Error("Input2 Error. Current action: "+action)}value=core.decodeBase64(action.substring(7))}catch(e){console.log(e);core.stopReplay();core.drawTip("录像文件出错");return}}else{core.interval.onDownInterval="tmp";value=prompt(core.replaceText(data.text));if(!core.isset(value)){value=""}}core.status.route.push("input2:"+core.encodeBase64(value));core.setFlag("input",value);this.doAction();break;case"if":if(core.calValue(data.condition)){core.events.insertAction(data["true"])}else{core.events.insertAction(data["false"])}this.doAction();break;case"choices":if(core.status.replay.replaying){if(core.status.replay.toReplay.length==0){core.status.replay.replaying=false;core.drawTip("录像回放完毕")}else{var action=core.status.replay.toReplay.shift(),index;if(action=="turn"){action=core.status.replay.toReplay.shift()}if(action.indexOf("choices:")==0&&((index=parseInt(action.substring(8)))>=0)&&index<data.choices.length){core.status.event.selection=index;setTimeout(function(){core.status.route.push("choices:"+index);core.events.insertAction(data.choices[index].action);core.events.doAction()},750/Math.max(1,core.status.replay.speed))}else{core.stopReplay();core.drawTip("录像文件出错")}}}core.ui.drawChoices(data.text,data.choices);break;case"while":if(core.calValue(data.condition)){core.unshift(core.status.event.data.list,{todo:core.clone(data.data),total:core.clone(data.data),condition:data.condition})}this.doAction();break;case"break":core.status.event.data.list.shift();this.doAction();break;case"continue":if(core.calValue(core.status.event.data.list[0].condition)){core.status.event.data.list[0].todo=core.clone(core.status.event.data.list[0].total)}else{core.status.event.data.list.shift()}this.doAction();break;case"win":core.events.win(data.reason,data.norank);break;case"lose":core.events.lose(data.reason);break;case"function":var func=data["function"];if(core.isset(func)){if((typeof func=="string")&&func.indexOf("function")==0){eval("("+func+")()")}else{if(func instanceof Function){func()}}}this.doAction();break;case"update":core.updateStatusBar();this.doAction();break;case"updateEnemys":core.enemys.updateEnemys();core.updateStatusBar();this.doAction();break;case"viberate":if(data.async){core.events.vibrate(data.time);this.doAction()}else{core.events.vibrate(data.time,function(){core.events.doAction()})}break;case"sleep":if(core.status.replay.replaying){core.events.doAction()}else{setTimeout(function(){core.events.doAction()},data.time)}break;case"wait":if(core.status.replay.replaying){var code=core.status.replay.toReplay.shift();if(code.indexOf("input:")==0){var value=parseInt(code.substring(6));core.status.route.push("input:"+value);if(value>=10000){core.setFlag("type",1);core.setFlag("x",parseInt((value-10000)/100));core.setFlag("y",value%100)}else{core.setFlag("type",0);core.setFlag("keycode",value)}core.events.doAction()}else{core.stopReplay();core.drawTip("录像文件出错")}}break;case"revisit":var block=core.getBlock(x,y);if(block!=null){block=block.block;if(core.isset(block.event)&&block.event.trigger=="action"){core.status.event.data.list=[{todo:core.clone(block.event.data),total:core.clone(block.event.data),condition:"false"}]}}this.doAction();break;case"exit":core.status.event.data.list=[];core.events.doAction();break;default:core.status.event.data.type="text";core.ui.drawTextBox("\t[警告]出错啦！\n"+data.type+" 事件不被支持...")}return};events.prototype.insertAction=function(a,c,d,b){if(core.status.event.id!="action"){this.doEvents(a,c,d,b)}else{core.unshift(core.status.event.data.list[0].todo,a);if(core.isset(c)){core.status.event.data.x=c}if(core.isset(d)){core.status.event.data.y=d}if(core.isset(b)){core.status.event.data.callback=b}}};events.prototype.getNextItem=function(){if(!core.status.heroStop||!core.flags.enableGentleClick){return false}var f=core.getHeroLoc("x"),g=core.getHeroLoc("y"),c=core.getHeroLoc("direction");if(core.isset(core.floors[core.status.floorId].cannotMove)){var b=core.floors[core.status.floorId].cannotMove[f+","+g];if(core.isset(b)&&b instanceof Array&&b.indexOf(c)>=0){return false}}var d=core.nextX(),e=core.nextY();var a=core.getBlock(d,e);if(a==null){return false}if(a.block.event.trigger=="getItem"){core.getItem(a.block.event.id,1,d,e);core.status.route.push("getNext");return true}return false};events.prototype.getItem=function(c,d,e,f,a){d=d||1;core.playSound("item.mp3");var b=core.material.items[c].cls;core.items.getItemEffect(c,d);core.removeBlock(e,f);var g="获得 "+core.material.items[c].name;if(d>1){g+="x"+d}if(b==="items"){g+=core.items.getItemEffectTip(c)}core.drawTip(g,core.material.icons.items[c]);core.canvas.event.clearRect(e*32,f*32,32,32);core.updateStatusBar();this.eventdata.afterGetItem(c,e,f,a)};events.prototype.openDoor=function(d,i,j,f,a){if(core.interval.openDoorAnimate!=null){return}if(!core.terrainExists(i,j,d)&&d!="lava"&&d!="star"){if(core.isset(a)){a()}return}if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.status.automaticRoute.moveStepBeforeStop=core.status.automaticRoute.autoStepRoutes.slice(core.status.automaticRoute.autoStep-1,core.status.automaticRoute.autoStepRoutes.length);if(core.status.automaticRoute.moveStepBeforeStop.length>=1){core.status.automaticRoute.moveStepBeforeStop[0].step-=core.status.automaticRoute.movedStep}}core.stopAutomaticRoute();var g=30;var c=d;if(c.length<4||c.substring(c.length-4)!="Door"){c=c+"Door";g=70}if(!core.isset(core.material.icons.animates[c])){if(core.isset(a)){a()}return}var e=d.replace("Door","Key");if(f&&(e=="specialKey"||core.isset(core.material.items[e]))){var e=d.replace("Door","Key");if(!core.hasItem(e)){if(e!="specialKey"){core.drawTip("你没有"+core.material.items[e].name)}else{core.drawTip("无法开启此门")}core.clearContinueAutomaticRoute();return}core.autosave(true);core.removeItem(e)}core.playSound("door.mp3");var h=0;var b=core.material.icons.animates[c];core.status.replay.animate=true;core.removeGlobalAnimate(i,j);core.interval.openDoorAnimate=window.setInterval(function(){h++;if(h==4){clearInterval(core.interval.openDoorAnimate);core.interval.openDoorAnimate=null;core.removeBlock(i,j);core.status.replay.animate=false;core.events.afterOpenDoor(d,i,j,a);return}core.canvas.event.clearRect(32*i,32*j,32,32);core.canvas.event.drawImage(core.material.images.animates,32*h,32*b,32,32,32*i,32*j,32,32)},g/core.status.replay.speed)};events.prototype.battle=function(c,d,e,b,a){if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.status.automaticRoute.moveStepBeforeStop=core.status.automaticRoute.autoStepRoutes.slice(core.status.automaticRoute.autoStep-1,core.status.automaticRoute.autoStepRoutes.length);if(core.status.automaticRoute.moveStepBeforeStop.length>=1){core.status.automaticRoute.moveStepBeforeStop[0].step-=core.status.automaticRoute.movedStep}}core.stopHero();core.stopAutomaticRoute();if(!core.enemys.canBattle(c,d,e)&&!b&&!core.isset(core.status.event.id)){core.drawTip("你打不过此怪物！");core.clearContinueAutomaticRoute();return}if(!core.isset(core.status.event.id)){core.autosave(true)}if(core.flags.battleAnimate&&!core.status.replay.replaying){core.waitHeroToStop(function(){core.ui.drawBattleAnimate(c,function(){core.events.afterBattle(c,d,e,a)})})}else{core.events.afterBattle(c,d,e,a)}};events.prototype.trigger=function(g,h){core.status.isSkiing=false;var d=core.status.thisMap.blocks;var e;for(var a=0;a<d.length;a++){if(d[a].x==g&&d[a].y==h&&!d[a].disable){e=d[a].event&&d[a].event.noPass;if(e){core.clearAutomaticRouteNode(g,h)}if(core.isset(d[a].event)&&core.isset(d[a].event.trigger)){var f=d[a].event.trigger;if(f=="ski"){core.status.isSkiing=true}if(f=="changeFloor"&&!e){var c=core.flags.portalWithoutTrigger;if(core.isset(d[a].event.data)&&core.isset(d[a].event.data.portalWithoutTrigger)){c=d[a].event.data.portalWithoutTrigger}if(c){if(core.status.replay.replaying){if(core.status.replay.toReplay[0]=="no"){core.status.replay.toReplay.shift();core.status.route.push("no");continue}}else{if(core.status.automaticRoute.autoHeroMove||core.status.automaticRoute.autoStep<core.status.automaticRoute.autoStepRoutes.length){core.status.route.push("no");continue}}}}core.status.automaticRoute.moveDirectly=false;core.material.events[f](d[a],core,function(b){})}}}};events.prototype.setFloorName=function(a){a=a||core.status.floorId;var b=core.status.maps[a].name||"";if(typeof b=="number"){b=""+b}if(!core.isset(b)||b==""){b="&nbsp;"}if(core.statusBar.floor.innerHTML==b){return}core.statusBar.floor.innerHTML=b;if(/^[+-]?\d+$/.test(b)){core.statusBar.floor.style.fontStyle="italic";core.statusBar.floor.style.fontSize="1.1em"}else{core.statusBar.floor.style.fontStyle="normal";if(b.length<=5){core.statusBar.floor.style.fontSize="1.1em"}else{if(b.length==6){core.statusBar.floor.style.fontSize="0.9em"}else{core.statusBar.floor.style.fontSize="0.7em"}}}};events.prototype.changeFloor=function(d,j,f,k,b,e){if(!core.isset(d)){d=core.status.floorId}if(d==":before"){var h=core.floorIds.indexOf(core.status.floorId);if(h>0){d=core.floorIds[h-1]}else{d=core.status.floorId}}else{if(d==":next"){var h=core.floorIds.indexOf(core.status.floorId);if(h<core.floorIds.length-1){d=core.floorIds[h+1]}else{d=core.status.floorId}}}var c=(!core.isset(k)||k>=100)&&!core.status.replay.replaying;k=k||800;k/=20;core.lockControl();core.stopHero();core.stopAutomaticRoute();core.clearContinueAutomaticRoute();core.status.replay.animate=true;core.dom.floorNameLabel.innerHTML=core.status.maps[d].title;if(!core.isset(j)&&!core.isset(f)){f=core.status.hero.loc}if(core.isset(j)){if(!core.isset(f)){f={}}if(core.isset(core.status.maps[d][j])){f.x=core.status.maps[d][j][0];f.y=core.status.maps[d][j][1]}else{var a=core.status.maps[d].blocks;for(var g in a){if(core.isset(a[g].event)&&!a[g].disable&&a[g].event.id===j){f.x=a[g].x;f.y=a[g].y;break}}}if(!core.isset(f.x)){f.x=core.status.hero.loc.x;f.y=core.status.hero.loc.y}}if(core.status.maps[d].canFlyTo&&core.status.hero.flyRange.indexOf(d)<0){core.status.hero.flyRange.push(d);core.status.hero.flyRange.sort(function(i,l){return core.floorIds.indexOf(i)-core.floorIds.indexOf(l)})}window.setTimeout(function(){var i=function(){core.events.setFloorName(d);if(core.isset(core.status.maps[d].bgm)){var l=core.status.maps[d].bgm;if(l instanceof Array){l=l[0]}core.playBgm(l)}var m=core.getFlag("color",null);if(!core.isset(m)&&core.isset(core.status.maps[d].color)){m=core.status.maps[d].color}if(core.isset(m)){core.clearMap("curtain");if(core.isset(m[3])){core.setAlpha("curtain",m[3])}else{core.setAlpha("curtain",1)}core.fillRect("curtain",0,0,416,416,core.arrayToRGB(m));core.status.curtainColor=m}else{core.clearMap("curtain");core.setAlpha("curtain",0)}var n=core.getFlag("weather",null);if(!core.isset(n)&&core.isset(core.status.maps[d].weather)){n=core.status.maps[d].weather}if(core.isset(n)){core.setWeather(n[0],n[1])}else{core.setWeather()}core.dom.gif.innerHTML="";if(!core.isset(e)){core.status.maps[d].blocks.forEach(function(o){if(o.disable&&core.isset(o.event)&&o.event.cls.indexOf("enemy")==0&&core.enemys.hasSpecial(core.material.enemys[o.event.id].special,23)){o.disable=false}})}core.maps.resizeMap(d);core.drawMap(d,function(){if(core.isset(f.direction)){core.setHeroLoc("direction",f.direction)}core.setHeroLoc("x",f.x);core.setHeroLoc("y",f.y);core.clearMap("hero");core.drawHero();var o=function(){core.unLockControl();core.status.replay.animate=false;core.events.afterChangeFloor(d,e);if(core.isset(b)){b()}};if(c){core.hide(core.dom.floorMsgGroup,k/4,function(){o()})}else{o()}})};core.playSound("floor.mp3");if(c){core.show(core.dom.floorMsgGroup,k/2,function(){i()})}else{i()}},25)};events.prototype.animateImage=function(h,c,e,g,d,b){g=g||0;if((h!="show"&&h!="hide")||g<=0){if(core.isset(b)){b()}return}clearInterval(core.interval.tipAnimate);core.setAlpha("data",1);var f=0;if(h=="hide"){f=1}if(h=="hide"&&d){core.clearMap("image")}core.setOpacity("data",f);var i=core.calValue(e[0]),j=core.calValue(e[1]);core.canvas.data.drawImage(c,i,j);core.status.replay.animate=true;var a=setInterval(function(){if(h=="show"){f+=0.1}else{f-=0.1}core.setOpacity("data",f);if(f>=1||f<=0){clearInterval(a);if(h=="show"&&d){core.canvas.image.drawImage(c,i,j)}core.clearMap("data");core.setOpacity("data",1);core.status.replay.animate=false;if(core.isset(b)){b()}}},g/10)};events.prototype.moveImage=function(g,d,k,j,h,b){j=j||1000;clearInterval(core.interval.tipAnimate);core.setAlpha("data",1);core.setOpacity("data",1);if(h){core.clearMap("image")}core.status.replay.animate=true;var e=core.calValue(d[0]),f=core.calValue(d[1]),l=core.calValue(k[0]),m=core.calValue(k[1]);var i=0;var c=function(){core.clearMap("data");var n=parseInt(e+(l-e)*i/64);var o=parseInt(f+(m-f)*i/64);core.canvas.data.drawImage(g,n,o)};c();var a=setInterval(function(){i++;c();if(i>=64){clearInterval(a);core.clearMap("data");core.status.replay.animate=false;if(h){core.canvas.data.drawImage(g,l,m)}if(core.isset(b)){b()}}},j/64)};events.prototype.setVolume=function(g,f,a){var d=function(h){core.musicStatus.volume=h;if(core.isset(core.musicStatus.playingBgm)){core.material.bgms[core.musicStatus.playingBgm].volume=h}core.musicStatus.gainNode.gain.value=h};if(!core.isset(f)||f<100){d(g);if(core.isset(a)){a()}return}core.status.replay.animate=true;var b=core.musicStatus.volume;var e=0;var c=setInterval(function(){e++;var h=b+(g-b)*e/32;d(h);if(e>=32){clearInterval(c);core.status.replay.animate=false;if(core.isset(a)){a()}}},f/32)};events.prototype.vibrate=function(i,c){if(core.isset(core.status.replay)&&core.status.replay.replaying){if(core.isset(c)){c()}return}core.status.replay.animate=true;var a=function(p,q){for(var m=0,k;k=core.dom.gameCanvas[m];m++){var l=k.getAttribute("id");if(l=="ui"||l=="data"){continue}var n=p,o=q;if(core.bigmap.canvas.indexOf(l)>=0){n-=core.bigmap.offsetX;o-=core.bigmap.offsetY}core.control.setGameCanvasTranslate(l,n,o)}};if(!core.isset(i)||i<1000){i=1000}var f=i*3/50;var h=5;var g=5;var e=1;var d=0;var j=function(){if(f>=1||d!=0){var k=(g*h*e)/10;if(f<=1&&d*(d+k)<0){d=0}else{d+=k}if(d>g*2){e=-1}if(d<-g*2){e=1}if(f>=1){f-=1}}};var b=setInterval(function(){j();a(d,0);if(f===0){clearInterval(b);core.status.replay.animate=false;if(core.isset(c)){c()}}},50/3)};events.prototype.openShop=function(shopId,needVisited){var shop=core.status.shops[shopId];shop.times=shop.times||0;shop.visited=shop.visited||false;if(needVisited&&!shop.visited){if(shop.times==0){core.drawTip("该商店尚未开启")}else{core.drawTip("该商店已失效")}return}shop.visited=true;var selection=core.status.event.selection;var actions=[];if(core.isset(core.status.event.data)&&core.isset(core.status.event.data.actions)){actions=core.status.event.data.actions}var fromList;if(core.isset(core.status.event.data)&&core.isset(core.status.event.data.fromList)){fromList=core.status.event.data.fromList}core.ui.closePanel();core.lockControl();core.status.event.id="shop";core.status.event.data={id:shopId,shop:shop,actions:actions,fromList:fromList};core.status.event.selection=selection;var content="\t["+shop.name+","+shop.icon+"]";var times=shop.times,need=eval(shop.need);content=content+shop.text.replace(/\${([^}]+)}/g,function(word,value){return eval(value)});var use=shop.use=="experience"?"经验":"金币";var choices=[];for(var i=0;i<shop.choices.length;i++){var choice=shop.choices[i];var text=choice.text;if(core.isset(choice.need)){text+="（"+eval(choice.need)+use+"）"}choices.push(text)}choices.push("离开");core.ui.drawChoices(content,choices)};events.prototype.disableQuickShop=function(a){core.status.shops[a].visited=false};events.prototype.canUseQuickShop=function(a){return this.eventdata.canUseQuickShop(a)};events.prototype.setHeroIcon=function(a,b){if(core.isset(core.material.images.images[a])&&core.material.images.images[a].width==128){core.setFlag("heroIcon",a);core.material.images.hero.onload=function(){core.material.icons.hero.height=core.material.images.images[a].height/4;core.control.updateHeroIcon(a);if(!b){core.drawHero()}};core.material.images.hero.src=core.material.images.images[a].src}};events.prototype.checkLvUp=function(){if(!core.flags.enableLevelUp||!core.isset(core.firstData.levelUp)||core.status.hero.lv>=core.firstData.levelUp.length){return}var need=(core.firstData.levelUp[core.status.hero.lv]||{}).need;if(!core.isset(need)){return}if(core.status.hero.experience>=need){core.status.hero.lv++;var effect=core.firstData.levelUp[core.status.hero.lv-1].effect;if(typeof effect=="string"){if(effect.indexOf("function")==0){eval("("+effect+")()")}else{effect.split(";").forEach(function(t){core.doEffect(t)})}}else{if(effect instanceof Function){effect()}}this.checkLvUp()}};events.prototype.useItem=function(b){core.ui.closePanel();if(b=="book"){core.openBook(false);return}if(b=="fly"){core.useFly(false);return}if(b=="centerFly"){core.lockControl();core.status.event.id="centerFly";var a="rgba(255,0,0,0.5)";if(core.canUseItem("centerFly")){a="rgba(0,255,0,0.5)"}var e=core.bigmap.width-1-core.getHeroLoc("x"),f=core.bigmap.height-1-core.getHeroLoc("y");core.ui.drawThumbnail(core.status.floorId,"ui",core.status.thisMap.blocks,0,0,416,e,f,core.status.hero.loc,core.getFlag("heroIcon","hero.png"));var c=core.clamp(e-6,0,core.bigmap.width-13),d=core.clamp(f-6,0,core.bigmap.height-13);core.fillRect("ui",(e-c)*32,(f-d)*32,32,32,a);core.status.event.data={x:e,y:f,poxX:e-c,posY:f-d};core.drawTip("请确认当前中心对称飞行器的位置");return}if(core.canUseItem(b)){core.useItem(b)}else{core.drawTip("当前无法使用"+core.material.items[b].name)}};events.prototype.addPoint=function(a){return this.eventdata.addPoint(a)};events.prototype.afterBattle=function(b,c,d,a){return this.eventdata.afterBattle(b,c,d,a)};events.prototype.afterOpenDoor=function(b,c,d,a){return this.eventdata.afterOpenDoor(b,c,d,a)};events.prototype.passNet=function(a){if(core.hasItem("shoes")){return}if(a.event.id=="lavaNet"){}if(a.event.id=="poisonNet"){if(core.hasFlag("poison")){return}core.setFlag("poison",true)}if(a.event.id=="weakNet"){if(core.hasFlag("weak")){return}core.setFlag("weak",true);var d=core.values.weakValue;var b=d>=1?d:Math.floor(d*core.status.hero.atk);var c=d>=1?d:Math.floor(d*core.status.hero.def);core.setFlag("weakAtk",b);core.setFlag("weakDef",c);core.status.hero.atk-=b;core.status.hero.def-=c}if(a.event.id=="curseNet"){if(core.hasFlag("curse")){return}core.setFlag("curse",true)}core.updateStatusBar()};events.prototype.changeLight=function(c,d){var a=core.getBlock(c,d);if(a==null){return}var b=a.index;a=a.block;if(a.event.id!="light"){return}a.id=166;a.event={cls:"terrains",id:"darkLight",noPass:true};core.drawBlock(a);this.afterChangeLight(c,d)};events.prototype.afterChangeLight=function(a,b){return this.eventdata.afterChangeLight(a,b)};events.prototype.ski=function(a){if(!core.isset(a)){a=core.status.automaticRoute.lastDirection||core.getHeroLoc("direction")}if(core.status.event.id!="ski"){core.waitHeroToStop(function(){core.status.event.id="ski";core.events.ski(a)})}else{core.moveHero(a,function(){if(core.status.event.id=="ski"&&!core.status.isSkiing){core.status.event.id=null;core.unLockControl();core.replay()}})}};events.prototype.pushBox=function(b){if(b.event.id!="box"&&b.event.id!="boxed"){return}var f={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var c=core.getHeroLoc("direction"),d=b.x+f[c].x,e=b.y+f[c].y;if(d<0||d>=core.bigmap.width||e<0||e>=core.bigmap.height){return}var a=core.getBlock(d,e,null,true);if(a!=null&&!(core.isset(a.block.event)&&a.block.event.id=="flower")){return}if(a==null){core.status.thisMap.blocks.push(core.maps.initBlock(d,e,169));a=core.getBlock(d,e)}else{a.block.id=170;a.block.event=core.maps.initBlock(null,null,170).event}core.drawBlock(a.block);if(b.event.id=="box"){core.removeBlock(b.x,b.y)}else{b.id=168;b.event=core.maps.initBlock(null,null,168).event;core.drawBlock(b)}core.updateStatusBar();core.status.replay.animate=true;core.moveHero(c,function(){core.status.replay.animate=false;core.status.route.pop();core.events.afterPushBox();core.replay()})};events.prototype.afterPushBox=function(){return this.eventdata.afterPushBox()};events.prototype.afterUseBomb=function(){return this.eventdata.afterUseBomb()};events.prototype.beforeSaveData=function(a){return this.eventdata.beforeSaveData(a)};events.prototype.afterLoadData=function(a){return this.eventdata.afterLoadData(a)};events.prototype.uploadCurrent=function(b){var a=new FormData();a.append("type","score");a.append("name",core.firstData.name);a.append("version",core.firstData.version);a.append("platform",core.platform.isPC?"PC":core.platform.isAndroid?"Android":core.platform.isIOS?"iOS":"");a.append("hard",core.encodeBase64(core.status.hard));a.append("username",core.encodeBase64(b||"current"));a.append("lv",core.status.hero.lv);a.append("hp",Math.min(core.status.hero.hp,Math.pow(2,63)));a.append("atk",core.status.hero.atk);a.append("def",core.status.hero.def);a.append("mdef",core.status.hero.mdef);a.append("money",core.status.hero.money);a.append("experience",core.status.hero.experience);a.append("steps",core.status.hero.steps);a.append("seed",core.getFlag("seed"));a.append("totalTime",Math.floor(core.status.hero.statistics.totalTime/1000));a.append("route",core.encodeRoute(core.status.route));a.append("deler","current");a.append("base64",1);core.http("POST","/games/upload.php",a)};