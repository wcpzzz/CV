function maps(){this.init()}maps.prototype.init=function(){this.blocksInfo=maps_90f36752_8815_4be8_b32b_d7fad1d0542e};maps.prototype.loadFloor=function(c,d){var b=core.floors[c];if(!core.isset(d)){d=b.map}if(d instanceof Array){d={map:d}}var a={};["floorId","title","name","canFlyTo","canUseQuickShop","cannotViewMap","color","weather","defaultGround","images","item_ratio","upFloor","bgm","downFloor","underGround"].forEach(function(f){if(core.isset(d[f])){a[f]=core.clone(d[f])}else{a[f]=core.clone(b[f])}});d=d.map;var e=function(n,o,h,k){var g=[];var q=core.floors[k].width||13;var p=core.floors[k].height||13;for(var l=0;l<p;l++){for(var m=0;m<q;m++){var f=o.initBlock(m,l,(n[l]||[])[m]||0);o.addInfo(f);o.addEvent(f,m,l,h.events[m+","+l]);o.addChangeFloor(f,m,l,h.changeFloor[m+","+l]);if(core.isset(f.event)){g.push(f)}}}return g};if(main.mode=="editor"){main.editor.mapIntoBlocks=function(h,f,g){return e(h,core.maps,f,g)}}a.blocks=e(d,this,b,c);return a};maps.prototype.initBlock=function(e,f,b){var a=null;b=""+b;if(b.length>2){if(b.indexOf(":f")==b.length-2){b=b.substring(0,b.length-2);a=true}else{if(b.indexOf(":t")==b.length-2){b=b.substring(0,b.length-2);a=false}}}b=parseInt(b);var d={x:e,y:f,id:b};if(a!=null){d.disable=a}if(b==17){d.event={cls:"terrains",id:"airwall",noPass:true}}else{if(b in this.blocksInfo){d.event=JSON.parse(JSON.stringify(this.blocksInfo[b]))}else{var c=core.icons.getTilesetOffset(b);if(c!=null){d.event={cls:"tileset",id:"X"+b,noPass:true}}}}return d};maps.prototype.addInfo=function(a){if(core.isset(a.event)){if(a.event.cls.indexOf("enemy")==0&&!core.isset(a.event.trigger)){a.event.trigger="battle"}if(a.event.cls=="items"&&!core.isset(a.event.trigger)){a.event.trigger="getItem"}if(!core.isset(a.event.noPass)){if(a.event.cls.indexOf("enemy")==0||a.event.cls.indexOf("npc")==0||a.event.cls=="terrains"||a.event.cls=="autotile"){a.event.noPass=true}}if(!core.isset(a.event.animate)){if(a.event.cls=="enemys"||a.event.cls=="npcs"){a.event.animate=2}if(a.event.cls=="animates"||a.event.cls=="enemy48"||a.event.cls=="npc48"){a.event.animate=4}}a.event.height=32;if(a.event.cls=="enemy48"||a.event.cls=="npc48"){a.event.height=48}}};maps.prototype.addEvent=function(a,d,e,b){if(!core.isset(b)){return}if(!core.isset(a.event)){a.event={cls:"terrains",id:"none",noPass:false}}if(typeof b=="string"){b={data:[b]}}else{if(b instanceof Array){b={data:b}}}if(!core.isset(b.data)){b.data=[]}if(core.isset(b.noPass)){a.event.noPass=b.noPass}if(!core.isset(a.disable)&&core.isset(b.enable)){a.disable=!b.enable}if(!core.isset(a.event.trigger)){if(core.isset(b.trigger)){a.event.trigger=b.trigger}else{a.event.trigger="action"}}else{if(core.isset(b.trigger)&&b.trigger!="checkBlock"){a.event.trigger=b.trigger}}for(var c in b){if(c!="disable"&&c!="trigger"&&c!="noPass"&&core.isset(b[c])){a.event[c]=core.clone(b[c])}}};maps.prototype.addChangeFloor=function(a,d,e,b,c){if(!core.isset(b)){return}this.addEvent(a,d,e,{trigger:"changeFloor",data:b},c)};maps.prototype.initMaps=function(b){var d={};for(var c=0;c<b.length;c++){var a=b[c];d[a]=this.loadFloor(a)}return d};maps.prototype.save=function(e,b){if(!core.isset(b)){var d={};for(var c in e){d[c]=this.save(e,c)}return d}var h=core.clone(e[b]);var g=core.floors[b].width||13;var f=core.floors[b].height||13;var a=[];for(var i=0;i<f;i++){a[i]=[];for(var j=0;j<g;j++){a[i].push(0)}}h.blocks.forEach(function(k){if(core.isset(k.disable)){if(!k.disable){a[k.y][k.x]=k.id+":t"}else{a[k.y][k.x]=k.id+":f"}}else{a[k.y][k.x]=k.id}});delete h.blocks;h.map=a;return main.mode=="editor"?a:h};maps.prototype.resizeMap=function(c){c=c||core.status.floorId;core.bigmap.width=core.floors[c].width||13;core.bigmap.height=core.floors[c].height||13;var b=core.bigmap.width*32;var a=core.bigmap.height*32;core.bigmap.canvas.forEach(function(d){core.canvas[d].canvas.setAttribute("width",b);core.canvas[d].canvas.setAttribute("height",a);core.canvas[d].canvas.style.width=b*core.domStyle.scale+"px";core.canvas[d].canvas.style.height=a*core.domStyle.scale+"px";if(main.mode==="editor"&&editor.isMobile){core.canvas[d].canvas.style.width=core.bigmap.width*32/416*96+"vw";core.canvas[d].canvas.style.height=core.bigmap.height*32/416*96+"vw"}})};maps.prototype.load=function(a,b){if(b==undefined){var c={};core.floorIds.forEach(function(d){c[d]=core.maps.loadFloor(d,a[d])});return c}return this.loadFloor(b,a[b])};maps.prototype.getMapArray=function(a,d,c){d=d||13;c=c||13;var b=[];for(var e=0;e<c;e++){b[e]=[];for(var f=0;f<d;f++){b[e].push(0)}}a.forEach(function(g){if(!g.disable&&g.x<d&&g.y<c){b[g.y][g.x]=g.id}});return b};maps.prototype.canMoveHero=function(o,p,b,c){if(!core.isset(o)){o=core.getHeroLoc("x")}if(!core.isset(p)){p=core.getHeroLoc("y")}if(!core.isset(b)){b=core.getHeroLoc("direction")}if(!core.isset(c)){c=core.status.floorId}if(core.isset(core.floors[c].cannotMove)){var a=core.floors[c].cannotMove[o+","+p];if(core.isset(a)&&a instanceof Array&&a.indexOf(b)>=0){return false}}var i=core.getBlock(o,p,c);if(i!=null){var j=i.block.event.id;var k=j.slice(0,5).toLowerCase()=="arrow";if(k){var h=j.slice(5).toLowerCase();if(b!=h){return false}}}var n={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var l=o+n[b].x,m=p+n[b].y;var f=core.getBlock(l,m);if(f!=null){var g=f.block.event.id;var d=g.slice(0,5).toLowerCase()=="arrow";if(d){var e=g.slice(5).toLowerCase();if((n[b].x+n[e].x)==0&&(n[b].y+n[e].y)==0){return false}}}if(c==core.status.floorId&&core.status.hero.hp<=core.status.checkBlock.damage[l+core.bigmap.width*m]&&!core.flags.canGoDeadZone&&core.getBlock(l,m)==null){return false}return true};maps.prototype.canMoveDirectly=function(a,b){if(!core.flags.enableMoveDirectly){return -1}if(core.hasFlag("poison")){return -1}var e=core.getHeroLoc("x"),f=core.getHeroLoc("y");if(e==a&&f==b){return 0}var h=core.getBlockId(e,f);if((h!=null&&h!="upFloor"&&h!="downFloor"&&h!="portal"&&h!="upPortal"&&h!="leftPortal"&&h!="downPortal"&&h!="rightPortal")||core.status.checkBlock.damage[e+core.bigmap.width*f]>0){return -1}var n=[],m=[];n[e+core.bigmap.width*f]=0;m.push(e+core.bigmap.width*f);var d={left:[-1,0],up:[0,-1],right:[1,0],down:[0,1]};while(m.length>0){var g=m.shift(),i=parseInt(g%core.bigmap.width),j=parseInt(g/core.bigmap.width);for(var c in d){if(!core.canMoveHero(i,j,c)){continue}var k=i+d[c][0],l=j+d[c][1];if(k<0||k>=core.bigmap.width||l<0||l>=core.bigmap.height||n[k+core.bigmap.width*l]||core.getBlock(k,l)!=null||core.status.checkBlock.damage[k+core.bigmap.width*l]>0){continue}n[k+core.bigmap.width*l]=n[i+core.bigmap.width*j]+1;if(k==a&&l==b){return n[k+core.bigmap.width*l]}m.push(k+core.bigmap.width*l)}}return -1};maps.prototype.drawBlock=function(b,a,d,e){if(b.event.id=="none"){return}var c=b.event.cls,f=b.event.height||32;var g,i,j;if(c=="tileset"){var h=core.icons.getTilesetOffset(b.event.id);if(h==null){return}g=core.material.images.tilesets[h.image];i=h.x;j=h.y}else{if(c=="autotile"){return}else{if(b.id==17){if(!core.isset(core.material.images.airwall)){return}g=core.material.images.airwall;i=j=0}else{g=core.material.images[c];i=(a||0)%(b.event.animate||1);j=core.material.icons[c][b.event.id]}}}d=d||0;e=e||0;core.canvas.event.clearRect(b.x*32+d,b.y*32+e,32,32);core.canvas.event.drawImage(g,i*32,j*f+f-32,32,32,b.x*32+d,b.y*32+e,32,32);if(f>32){core.canvas.event2.clearRect(b.x*32+d,b.y*32+32-f+e,32,f-32);core.canvas.event2.drawImage(g,i*32,j*f,32,f-32,b.x*32+d,b.y*32+32-f+e,32,f-32)}};maps.prototype.drawBgFgMap=function(g,e,l){var n=core.floors[g].width||13;var j=core.floors[g].height||13;var i=(core.status.maps||core.floors)[g].defaultGround||"ground";var c=core.material.icons.terrains[i];var d=core.material.images.terrains;var h=function(r){var q=core.clone(core.floors[g][r+"map"]||[]);if(main.mode=="editor"){q=core.clone(editor[r+"map"])||q}for(var s=0;s<n;s++){for(var t=0;t<j;t++){q[t]=q[t]||[];if(core.hasFlag(r+"_"+g+"_"+s+"_"+t)){q[t][s]=0}else{q[t][s]=core.getFlag(r+"v_"+g+"_"+s+"_"+t,q[t][s]||0)}if(main.mode=="editor"){q[t][s]=q[t][s].idnum||q[t][s]||0}}}return q};var a=h(l);for(var o=0;o<n;o++){for(var p=0;p<j;p++){if(l=="bg"){e.drawImage(d,0,c*32,32,32,o*32,p*32,32,32)}if(a[p][o]>0){var b=core.maps.initBlock(o,p,a[p][o]);if(core.isset(b.event)){var k=b.event.id,f=b.event.cls;if(f=="autotile"){core.drawAutotile(e,a,b,32,0,0)}else{if(f=="tileset"){var m=core.icons.getTilesetOffset(k);if(m!=null){e.drawImage(core.material.images.tilesets[m.image],32*m.x,32*m.y,32,32,32*o,32*p,32,32)}}else{if(a[p][o]==17){if(core.isset(core.material.images.airwall)){e.drawImage(core.material.images.airwall,32*o,32*p)}}else{e.drawImage(core.material.images[f],0,core.material.icons[f][k]*32,32,32,o*32,p*32,32,32)}}}}}}}};maps.prototype.drawMap=function(d,a){d=d||core.status.floorId;core.clearMap("all");core.removeGlobalAnimate(null,null,true);var b=function(){core.maps.drawBgFgMap(d,core.canvas.bg,"bg");core.maps.drawBgFgMap(d,core.canvas.fg,"fg");var e=[];if(core.isset(core.status.maps[d].images)){e=core.status.maps[d].images;if(typeof e=="string"){e=[[0,0,e]]}}e.forEach(function(k){var f=parseInt(k[0]),g=parseInt(k[1]),j=k[2];if(core.isset(f)&&core.isset(g)&&!core.hasFlag("floorimg_"+d+"_"+f+"_"+g)&&core.isset(core.material.images.images[j])){var i=core.material.images.images[j];if(!k[3]){if(/.*\.gif/i.test(j)&&main.mode=="play"){core.dom.gif.innerHTML="";var h=new Image();h.src=core.material.images.images[j].src;h.style.position="absolute";h.style.left=(32*f*core.domStyle.scale)+"px";h.style.top=(32*g*core.domStyle.scale)+"px";h.style.width=core.material.images.images[j].width*core.domStyle.scale+"px";h.style.height=core.material.images.images[j].height*core.domStyle.scale+"px";core.dom.gif.appendChild(h)}else{core.canvas.bg.drawImage(i,32*f,32*g,i.width,i.height)}}else{if(k[3]==1){core.canvas.fg.drawImage(i,32*f,32*g,i.width,i.height)}else{if(k[3]==2){core.canvas.fg.drawImage(i,0,0,i.width,i.height-32,32*f,32*g,i.width,i.height-32);core.canvas.bg.drawImage(i,0,i.height-32,i.width,32,32*f,32*g+i.height-32,i.width,32)}}}}})};if(main.mode=="editor"){}else{b()}core.status.floorId=d;core.status.thisMap=core.status.maps[d];var c=function(){var i=core.status.maps[core.status.floorId];var h=i.blocks;var g=core.maps.getMapArray(h,core.bigmap.width,core.bigmap.height);for(var e=0;e<h.length;e++){var f=h[e];if(core.isset(f.event)&&!f.disable){if(f.event.cls=="autotile"){core.drawAutotile(core.canvas.event,g,f,32,0,0)}else{core.drawBlock(f);core.addGlobalAnimate(f)}}}};if(main.mode=="editor"){main.editor.updateMap=function(){core.removeGlobalAnimate(null,null,true);core.clearMap("bg");core.clearMap("event");core.clearMap("event2");core.clearMap("fg");b();c();core.setGlobalAnimate(core.values.animateSpeed)}}else{c();core.setGlobalAnimate(core.values.animateSpeed);core.drawHero();core.updateStatusBar()}if(core.isset(a)){a()}};maps.prototype.drawAutotile=function(c,n,a,p,m,q){var l=[[10,9,4,3],[10,9,4,13],[10,9,18,3],[10,9,16,15],[10,43,4,3],[10,31,4,25],[10,7,2,3],[10,31,16,5],[48,9,4,3],[8,9,4,1],[36,9,30,3],[36,9,6,15],[46,45,4,3],[46,11,4,25],[12,45,30,3],[34,33,28,27]];var d=function(t,u,v,i,w,x){var y=16*((w-1)%6),z=16*(~~((w-1)/6));t.drawImage(i,y,z,16,16,u,v,x/2,x/2)};var g=function(i,t,u){if(t<0||u<0||t>=n[0].length||u>=n.length){return 1}else{return n[u][t]==i?1:0}};var b=function(F,G){var v=n[G][F];var E=[];for(var w=0;w<4;w++){var u=0;var C=w%2,D=~~(w/2);for(var z=0;z<4;z++){var A=z%2,B=~~(z/2);var t=g(v,F+C+A-1,G+D+B-1);u+=t*(Math.pow(2,3-z))}E.push(u)}return E};var h=function(z,A){var v=[];var w=b(z,A);for(var u=0;u<4;u++){var t=l[w[u]];v.push(t[3-u])}return v};var r=a.x,s=a.y;var o=h(r,s);if(o[0]==13){if(o[1]==16){o[1]=14}if(o[2]==31){o[2]=19}}if(o[1]==18){if(o[0]==15){o[0]=17}if(o[3]==36){o[3]=24}}if(o[2]==43){if(o[0]==25){o[0]=37}if(o[3]==46){o[3]=44}}if(o[3]==48){if(o[1]==30){o[1]=42}if(o[2]==45){o[2]=47}}for(var j=0;j<4;j++){var k=o[j];var e=r*p+p/2*(j%2),f=s*p+p/2*(~~(j/2));d(c,e+m,f+q,core.material.images.autotile[a.event.id],k,p)}};maps.prototype.noPassExists=function(c,d,b){var a=core.getBlock(c,d,b);if(a==null){return false}return core.isset(a.block.event.noPass)&&a.block.event.noPass};maps.prototype.noPass=function(a,b){return a<0||a>=core.bigmap.width||b<0||b>=core.bigmap.height||this.noPassExists(a,b)};maps.prototype.npcExists=function(c,d,b){var a=this.getBlock(c,d,b);if(a==null){return false}return a.block.event.cls.indexOf("npc")==0};maps.prototype.terrainExists=function(d,e,c,b){var a=this.getBlock(d,e,b);if(a==null){return false}return a.block.event.cls=="terrains"&&(core.isset(c)?a.block.event.id==c:true)};maps.prototype.stairExists=function(c,d,b){var a=this.getBlock(c,d,b);if(a==null){return false}return a.block.event.cls=="terrains"&&(a.block.event.id=="upFloor"||a.block.event.id=="downFloor")};maps.prototype.nearStair=function(){var a=core.getHeroLoc("x"),b=core.getHeroLoc("y");return this.stairExists(a,b)||this.stairExists(a-1,b)||this.stairExists(a,b-1)||this.stairExists(a+1,b)||this.stairExists(a,b+1)};maps.prototype.enemyExists=function(d,e,c,b){var a=this.getBlock(d,e,b);if(a==null){return false}return a.block.event.cls.indexOf("enemy")==0&&(core.isset(c)?a.block.event.id==c:true)};maps.prototype.getBlock=function(e,f,b,d){if(!core.isset(b)){b=core.status.floorId}var a=core.status.maps[b].blocks;for(var c=0;c<a.length;c++){if(a[c].x==e&&a[c].y==f&&core.isset(a[c].event)){if(!d&&a[c].disable){return null}return{index:c,block:a[c]}}}return null};maps.prototype.getBlockId=function(d,e,b,c){var a=core.getBlock(d,e,b,c);if(a==null){return null}if(core.isset(a.block.event)){return a.block.event.id}return null};maps.prototype.getBlockCls=function(d,e,b,c){var a=core.getBlock(d,e,b,c);if(a==null){return null}if(core.isset(a.block.event)){return a.block.event.cls}return null};maps.prototype.moveBlock=function(v,w,t,u,l,h){u=u||500;core.clearMap("route");var e=core.getBlock(v,w);if(e==null){if(core.isset(h)){h()}return}var j=e.block.id;core.status.replay.animate=true;core.removeBlock(v,w);core.clearMap("ui");core.setAlpha("ui",1);e=e.block;var k,f,g,i=e.event.height||32;if(e.event.cls=="tileset"){var p=core.icons.getTilesetOffset(e.event.id);if(p==null){if(core.isset(h)){h()}return}f=p.x;g=p.y;k=core.material.images.tilesets[p.image]}else{if(e.event.cls=="autotile"){if(core.isset(h)){h()}return}else{if(e.id==17){if(core.isset(h)){h()}return}else{k=core.material.images[e.event.cls];f=0;g=core.material.icons[e.event.cls][e.event.id]}}}var q=1;core.setOpacity("route",q);core.canvas.route.drawImage(k,f*32,g*i,32,i,e.x*32,e.y*32+32-i,32,i);var m=[];t.forEach(function(x){if(typeof x=="string"){m.push(x)}else{if(!core.isset(x.value)){m.push(x.direction)}else{for(var y=0;y<x.value;y++){m.push(x.direction)}}}});var n=32*v,o=32*w,s=0;var r={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var d=e.event.animate||1;var b=0;var c=0;var a=window.setInterval(function(){c+=u/16/core.status.replay.speed;if(c>=core.values.animateSpeed){b++;c=0;if(b>=d){b=0}}if(e.event.cls=="tileset"){b=f}if(m.length==0){if(l){q=0}else{q-=0.06}core.setOpacity("route",q);core.clearMap("route",n,o-i+32,32,i);core.canvas.route.drawImage(k,b*32,g*i,32,i,n,o-i+32,32,i);if(q<=0){clearInterval(a);core.clearMap("route");core.setOpacity("route",1);if(l){core.setBlock(j,n/32,o/32);core.showBlock(n/32,o/32)}core.status.replay.animate=false;if(core.isset(h)){h()}}}else{s++;n+=r[m[0]].x*2;o+=r[m[0]].y*2;core.clearMap("route",n-32,o-32,96,96);core.canvas.route.drawImage(k,b*32,g*i,32,i,n,o-i+32,32,i);if(s==16){s=0;m.shift()}}},u/16/core.status.replay.speed)};maps.prototype.jumpBlock=function(z,A,p,q,B,w,h){B=B||500;core.clearMap("route");var e=core.getBlock(z,A);if(e==null){if(core.isset(h)){h()}return}var s=e.block.id;core.status.replay.animate=true;core.removeBlock(z,A);core.clearMap("ui");core.setAlpha("ui",1);e=e.block;var t,f,g,r=e.event.height||32;if(e.event.cls=="tileset"){var x=core.icons.getTilesetOffset(e.event.id);if(x==null){if(core.isset(h)){h()}return}f=x.x;g=x.y;t=core.material.images.tilesets[x.image]}else{if(e.event.cls=="autotile"){if(core.isset(h)){h()}return}else{if(e.id==17){if(core.isset(h)){h()}return}else{t=core.material.images[e.event.cls];f=0;g=core.material.icons[e.event.cls][e.event.id]}}}var y=1;core.setOpacity("route",y);core.canvas.route.drawImage(t,f*32,g*r,32,r,e.x*32,e.y*32+32-r,32,r);core.playSound("jump.mp3");var n=p-z,o=q-A,k=Math.round(Math.sqrt(n*n+o*o));var v=6+k,u=v*2;var i=z,j=A;var l=function(){return i*32};var m=function(){var E=j*32;if(u>=v){var D=u-v}else{var D=v-u}return E-(v*v-D*D)/2};var C=function(){u--;i=(i*u+p)/(u+1);j=(j*u+q)/(u+1)};var d=e.event.animate||1;var b=0;var c=0;var a=window.setInterval(function(){c+=B/16/core.status.replay.speed;if(c>=core.values.animateSpeed){b++;c=0;if(b>=d){b=0}}if(e.event.cls=="tileset"){b=f}if(u>0){core.clearMap("route",l(),m()-r+32,32,r);C();core.canvas.route.drawImage(t,b*32,g*r,32,r,l(),m()-r+32,32,r)}else{if(w){y=0}else{y-=0.06}core.setOpacity("route",y);core.clearMap("route",l(),m()-r+32,32,r);core.canvas.route.drawImage(t,b*32,g*r,32,r,l(),m()-r+32,32,r);if(y<=0){clearInterval(a);core.clearMap("route");core.setOpacity("route",1);if(w){core.setBlock(s,p,q);core.showBlock(p,q)}core.status.replay.animate=false;if(core.isset(h)){h()}}}},B/16/core.status.replay.speed)};maps.prototype.animateBlock=function(e,h,g,b){if(h!="hide"){h="show"}core.clearMap("route");if(typeof e[0]=="number"&&typeof e[1]=="number"){e=[e]}var d=[];e.forEach(function(o){var i=core.getBlock(o[0],o[1],null,true);if(i==null){return}i=i.block;var m,j,k,l=i.event.height||32;if(i.event.cls=="tileset"){var n=core.icons.getTilesetOffset(i.event.id);if(n==null){if(core.isset(b)){b()}return}j=n.x;k=n.y;m=core.material.images.tilesets[n.image]}else{if(i.event.cls=="autotile"){return}else{if(i.id==17){return}else{m=core.material.images[i.event.cls];j=0;k=core.material.icons[i.event.cls][i.event.id]}}}d.push({x:o[0],y:o[1],height:l,bx:j,by:k,image:m})});if(d.length==0){if(core.isset(b)){b()}return}core.status.replay.animate=true;var c=function(){d.forEach(function(i){core.canvas.route.drawImage(i.image,i.bx*32,i.by*i.height,32,i.height,i.x*32,i.y*32+32-i.height,32,i.height)})};var f=0;if(h=="hide"){f=1}core.setOpacity("route",f);c();var a=window.setInterval(function(){if(h=="show"){f+=0.1}else{f-=0.1}core.setOpacity("route",f);if(f>=1||f<=0){clearInterval(a);core.clearMap("route");core.setOpacity("route",1);core.status.replay.animate=false;if(core.isset(b)){b()}}},g/10/core.status.replay.speed)};maps.prototype.showBlock=function(c,d,b){b=b||core.status.floorId;var a=core.getBlock(c,d,b,true);if(a==null){return}a=a.block;if(a.disable){a.disable=false;if(b==core.status.floorId&&core.isset(a.event)){core.drawBlock(a);core.addGlobalAnimate(a);core.syncGlobalAnimate()}core.updateStatusBar()}};maps.prototype.hideBlock=function(d,e,b){b=b||core.status.floorId;var a=core.getBlock(d,e,b,true);if(a==null){return}if(b==core.status.floorId){core.removeGlobalAnimate(d,e);core.canvas.event.clearRect(d*32,e*32,32,32);var c=32;if(core.isset(a.block.event)){c=a.block.event.height||32}if(c>32){core.canvas.event2.clearRect(d*32,e*32+32-c,32,c-32)}}a.disable=true;core.updateStatusBar()};maps.prototype.removeBlock=function(e,f,b){b=b||core.status.floorId;var a=core.getBlock(e,f,b,true);if(a==null){return}var d=a.index;if(b==core.status.floorId){core.removeGlobalAnimate(e,f);core.canvas.event.clearRect(e*32,f*32,32,32);var c=32;if(core.isset(a.block.event)){c=a.block.event.height||32}if(c>32){core.canvas.event2.clearRect(e*32,f*32+32-c,32,c-32)}}core.removeBlockById(d,b);core.updateStatusBar()};maps.prototype.removeBlockById=function(e,d){var b=core.status.maps[d].blocks,a=b[e];var g=a.x,h=a.y;var c=core.floors[d].events[g+","+h];if(!core.isset(c)){c=core.floors[d].changeFloor[g+","+h]}var f=false;if(core.isset(a.event)&&a.event.cls.indexOf("enemy")==0&&core.enemys.hasSpecial(core.material.enemys[a.event.id].special,23)){f=true}if(!f&&!core.isset(c)){b.splice(e,1);return}a.disable=true};maps.prototype.removeBlockByIds=function(a,b){b.sort(function(c,d){return d-c}).forEach(function(c){core.removeBlockById(c,a)})};maps.prototype.setBlock=function(c,e,f,b){b=b||core.status.floorId;if(!core.isset(c)||!core.isset(e)||!core.isset(f)){return}if(e<0||e>=core.bigmap.width||f<0||f>=core.bigmap.height){return}var d=core.getBlock(e,f,b,true);var a=core.maps.initBlock(e,f,c);core.maps.addInfo(a);core.maps.addEvent(a,e,f,core.floors[b].events[e+","+f]);core.maps.addChangeFloor(a,e,f,core.floors[b].changeFloor[e+","+f]);if(core.isset(a.event)){if(d==null){core.status.maps[b].blocks.push(a)}else{d.block.id=c;d.block.event=a.event}if(b==core.status.floorId){core.drawMap(b)}}};maps.prototype.setBgFgBlock=function(b,c,d,e,a){a=a||core.status.floorId;if(!core.isset(c)||!core.isset(d)||!core.isset(e)){return}if(d<0||d>=core.bigmap.width||e<0||e>=core.bigmap.height){return}if(b!="bg"&&b!="fg"){return}core.setFlag(b+"v_"+a+"_"+d+"_"+e,c);if(a==core.status.floorId){core.drawMap(a)}};maps.prototype.addGlobalAnimate=function(a){if(main.mode=="editor"&&main.editor.disableGlobalAnimate){return}if(!core.isset(a.event)||!core.isset(a.event.animate)||a.event.animate==1){return}var c=core.clone(a);c.status=0;core.status.globalAnimateObjs.push(c)};maps.prototype.removeGlobalAnimate=function(c,d,a){if(main.mode=="editor"&&main.editor.disableGlobalAnimate){return}if(a){core.status.globalAnimateObjs=[];return}for(var b=0;b<core.status.globalAnimateObjs.length;b++){if(core.status.globalAnimateObjs[b].x==c&&core.status.globalAnimateObjs[b].y==d){core.status.globalAnimateObjs.splice(b,1);return}}};maps.prototype.setGlobalAnimate=function(a){if(main.mode=="editor"&&main.editor.disableGlobalAnimate){return}core.syncGlobalAnimate();core.animateFrame.speed=a;core.animateFrame.globalAnimate=true};maps.prototype.syncGlobalAnimate=function(){core.status.globalAnimateObjs.forEach(function(a){a.status=0})};maps.prototype.drawBoxAnimate=function(){for(var b=0;b<core.status.boxAnimateObjs.length;b++){var c=core.status.boxAnimateObjs[b];c.status=((c.status||0)+1)%c.animate;core.clearMap("ui",c.bgx,c.bgy,c.bgWidth,c.bgHeight);core.fillRect("ui",c.bgx,c.bgy,c.bgWidth,c.bgHeight,core.animateFrame.background);core.canvas.ui.drawImage(c.image,c.status*32,c.pos,32,c.height,c.x,c.y,32,c.height)}};maps.prototype.drawAnimateFrame=function(a,b,c,e){var d=a.frames[e];var f=a.ratio;d.forEach(function(l){var i=a.images[l.index];if(!core.isset(i)){return}var k=i.width*f*l.zoom/100;var j=i.height*f*l.zoom/100;core.setAlpha("animate",l.opacity/255);var g=b+l.x,h=c+l.y;if(!l.mirror&&!l.angle){core.canvas.animate.drawImage(i,g-k/2-core.bigmap.offsetX,h-j/2-core.bigmap.offsetY,k,j)}else{core.saveCanvas("animate");core.canvas.animate.translate(g,h);if(l.angle){core.canvas.animate.rotate(-l.angle*Math.PI/180)}if(l.mirror){core.canvas.animate.scale(-1,1)}core.canvas.animate.drawImage(i,-k/2-core.bigmap.offsetX,-j/2-core.bigmap.offsetY,k,j);core.loadCanvas("animate")}})};maps.prototype.drawAnimate=function(f,g,h,b){if(core.isset(core.status.replay)&&core.status.replay.replaying){if(core.isset(b)){b()}return}if(!core.isset(core.material.animates[f])||!core.isset(g)||!core.isset(h)){if(core.isset(b)){b()}return}clearInterval(core.interval.animateInterval);var a=core.material.animates[f],c=32*g+16,d=32*h+16;core.playSound(a.se);if(!core.isset(b)){core.status.animateObjs.push({animate:a,centerX:c,centerY:d,index:0});return}var e=0;core.clearMap("animate");core.maps.drawAnimateFrame(a,c,d,e++);core.interval.animateInterval=setInterval(function(i){if(e==a.frames.length){clearInterval(core.interval.animateInterval);core.clearMap("animate");core.setAlpha("animate",1);if(core.isset(b)){b()}return}core.clearMap("animate");core.maps.drawAnimateFrame(a,c,d,e++)},50)};maps.prototype.setFloorImage=function(d,c,b,a){if(d!="show"){d="hide"}if(typeof c[0]=="number"&&typeof c[1]=="number"){c=[c]}b=b||core.status.floorId;if(c.length==0){return}c.forEach(function(f){var g=f[0],h=f[1];var e="floorimg_"+b+"_"+g+"_"+h;core.setFlag(e,d=="show"?false:true)});if(b==core.status.floorId){core.drawMap(b,a)}else{if(core.isset(a)){a()}}};maps.prototype.setBgFgMap=function(e,d,c,b,a){if(e!="show"){e="hide"}if(d!="fg"){d="bg"}if(typeof c[0]=="number"&&typeof c[1]=="number"){c=[c]}b=b||core.status.floorId;if(c.length==0){return}c.forEach(function(g){var h=g[0],i=g[1];var f=d+"_"+b+"_"+h+"_"+i;core.setFlag(f,e=="show"?false:true)});if(b==core.status.floorId){core.drawMap(b,a)}else{if(core.isset(a)){a()}}};maps.prototype.resetMap=function(a){var a=a||core.status.floorId;core.status.maps[a]=this.loadFloor(a);if(a==core.status.floorId){this.drawMap(a,function(){core.drawTip("地图重置成功")})}else{core.drawTip(a+"地图重置成功")}};